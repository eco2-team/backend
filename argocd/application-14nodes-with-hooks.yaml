---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ecoeco-infrastructure-14nodes
  namespace: argocd
  labels:
    app.kubernetes.io/name: ecoeco-infrastructure
    app.kubernetes.io/part-of: ecoeco-platform
    architecture: 14-nodes
  annotations:
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: default
  
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Source: Git Repository
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  source:
    repoURL: https://github.com/SeSACTHON/backend
    targetRevision: main
    path: charts/ecoeco-backend
    helm:
      valueFiles:
        - values-14nodes.yaml
      
      parameters:
        - name: global.image.tag
          value: "latest"
  
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Destination: Kubernetes Cluster
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  destination:
    server: https://kubernetes.default.svc
    namespace: api
  
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Sync Policy
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - RespectIgnoreDifferences=true
    
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Ignore Differences
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ignoreDifferences:
    - group: apps
      kind: Deployment
      jsonPointers:
        - /spec/replicas  # HPAê°€ ê´€ë¦¬
  
  revisionHistoryLimit: 10
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# PreSync Hook: Ansible Bootstrap
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: batch/v1
kind: Job
metadata:
  name: ansible-bootstrap
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook: PreSync  # Sync ì „ ì‹¤í–‰
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation  # ì´ì „ Job ì‚­ì œ
    argocd.argoproj.io/sync-wave: "-1"  # ê°€ì¥ ë¨¼ì € ì‹¤í–‰
spec:
  ttlSecondsAfterFinished: 300  # 5ë¶„ í›„ ìë™ ì‚­ì œ
  backoffLimit: 3  # 3íšŒ ì¬ì‹œë„
  
  template:
    metadata:
      labels:
        app: ansible-bootstrap
    spec:
      restartPolicy: Never
      serviceAccountName: argocd-application-controller
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Init Container: Terraform Outputs í™•ì¸
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      initContainers:
        - name: wait-for-terraform-outputs
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "â³ Waiting for Terraform Outputs ConfigMap..."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # ConfigMapì´ ìƒì„±ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 5ë¶„)
              for i in {1..60}; do
                if kubectl get configmap terraform-outputs -n argocd &>/dev/null; then
                  echo "âœ… Terraform Outputs ConfigMap found"
                  
                  # ì¸ë²¤í† ë¦¬ íŒŒì¼ ì¡´ì¬ í™•ì¸
                  if kubectl get configmap terraform-outputs -n argocd -o jsonpath='{.data.ansible-inventory\.ini}' &>/dev/null; then
                    echo "âœ… Ansible Inventory exists in ConfigMap"
                    exit 0
                  fi
                fi
                
                echo "â³ Waiting... ($i/60)"
                sleep 5
              done
              
              echo "âŒ Timeout: Terraform Outputs not found"
              echo "   Please run Atlantis first to create infrastructure"
              exit 1
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Main Container: Ansible Playbook ì‹¤í–‰
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      containers:
        - name: ansible
          image: cytopia/ansible:2.15-tools
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸš€ Starting Ansible Bootstrap"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # Git Clone (Phase 3: ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°)
              echo "ğŸ“¥ Cloning repository..."
              git clone --depth 1 --branch main https://github.com/SeSACTHON/backend /workspace
              cd /workspace/ansible
              
              # Ansible Inventory ìƒì„± (ConfigMapì—ì„œ)
              echo "ğŸ“ Creating Ansible Inventory from ConfigMap..."
              kubectl get configmap terraform-outputs -n argocd \
                -o jsonpath='{.data.ansible-inventory\.ini}' > inventory/hosts.ini
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“‹ Ansible Inventory:"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              cat inventory/hosts.ini
              
              # SSH Key ì„¤ì •
              mkdir -p ~/.ssh
              chmod 700 ~/.ssh
              cp /ssh-key/ssh-privatekey ~/.ssh/k8s-cluster-key.pem
              chmod 600 ~/.ssh/k8s-cluster-key.pem
              
              # SSH Config
              cat > ~/.ssh/config <<EOF
              Host *
                StrictHostKeyChecking no
                UserKnownHostsFile /dev/null
                ServerAliveInterval 60
                ServerAliveCountMax 3
              EOF
              chmod 600 ~/.ssh/config
              
              # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ” Testing SSH connectivity..."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              ansible all -i inventory/hosts.ini -m ping --timeout=30 || {
                echo "âŒ SSH connectivity test failed"
                echo "   Please check:"
                echo "   1. EC2 instances are running"
                echo "   2. Security Group allows SSH (port 22)"
                echo "   3. SSH key is correct"
                exit 1
              }
              
              # Ansible Playbook ì‹¤í–‰
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âš™ï¸ Running Ansible site.yml..."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              ansible-playbook site.yml \
                -i inventory/hosts.ini \
                --timeout=300 \
                -v
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… Ansible Bootstrap Complete"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          volumeMounts:
            - name: ssh-key
              mountPath: /ssh-key
              readOnly: true
          
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
      
      volumes:
        - name: ssh-key
          secret:
            secretName: k8s-cluster-ssh-key
            defaultMode: 0600
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# PostSync Hook: Node Labeling
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: batch/v1
kind: Job
metadata:
  name: label-nodes
  namespace: argocd
  annotations:
    argocd.argoproj.io/hook: PostSync  # Sync í›„ ì‹¤í–‰
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "10"  # ë§ˆì§€ë§‰ì— ì‹¤í–‰
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  
  template:
    metadata:
      labels:
        app: label-nodes
    spec:
      restartPolicy: Never
      serviceAccountName: argocd-application-controller
      
      containers:
        - name: kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              set -e
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ·ï¸ Labeling Kubernetes Nodes"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # ëª¨ë“  ë…¸ë“œê°€ Ready ìƒíƒœì¸ì§€ í™•ì¸
              echo "â³ Waiting for all nodes to be Ready..."
              kubectl wait --for=condition=Ready nodes --all --timeout=300s
              
              # API ë…¸ë“œ ë¼ë²¨ë§ (Phase 1-3)
              echo "ğŸ”– Labeling API Nodes..."
              
              for node in k8s-api-auth k8s-api-my k8s-api-scan k8s-api-character k8s-api-location k8s-api-info k8s-api-chat; do
                if kubectl get node "$node" &>/dev/null; then
                  domain=$(echo "$node" | sed 's/k8s-api-//')
                  echo "  - $node (domain=$domain)"
                  
                  kubectl label node "$node" \
                    workload=api \
                    domain="$domain" \
                    tier=api \
                    node-role.kubernetes.io/api="$domain" \
                    --overwrite || echo "    âš ï¸  Failed to label $node"
                fi
              done
              
              # Worker ë…¸ë“œ ë¼ë²¨ë§ (Phase 4)
              echo "ğŸ”– Labeling Worker Nodes..."
              
              if kubectl get node k8s-worker-storage &>/dev/null; then
                echo "  - k8s-worker-storage"
                kubectl label node k8s-worker-storage \
                  workload=worker-storage \
                  worker-type=io-bound \
                  pool-type=eventlet \
                  domain=scan \
                  tier=worker \
                  node-role.kubernetes.io/worker=storage \
                  --overwrite
              fi
              
              if kubectl get node k8s-worker-ai &>/dev/null; then
                echo "  - k8s-worker-ai"
                kubectl label node k8s-worker-ai \
                  workload=worker-ai \
                  worker-type=network-bound \
                  pool-type=prefork \
                  domain=scan,chat \
                  tier=worker \
                  node-role.kubernetes.io/worker=ai \
                  --overwrite
              fi
              
              # Infrastructure ë…¸ë“œ ë¼ë²¨ë§
              echo "ğŸ”– Labeling Infrastructure Nodes..."
              
              for node in k8s-postgresql k8s-redis k8s-rabbitmq k8s-monitoring; do
                if kubectl get node "$node" &>/dev/null; then
                  workload=$(echo "$node" | sed 's/k8s-//')
                  echo "  - $node (workload=$workload)"
                  
                  kubectl label node "$node" \
                    workload="$workload" \
                    tier=infrastructure \
                    node-role.kubernetes.io/infrastructure="$workload" \
                    --overwrite || echo "    âš ï¸  Failed to label $node"
                  
                  # Infrastructure ë…¸ë“œì— Taint ì¶”ê°€
                  kubectl taint node "$node" \
                    node-role.kubernetes.io/infrastructure=true:NoSchedule \
                    --overwrite || echo "    âš ï¸  Failed to taint $node"
                fi
              done
              
              # ê²°ê³¼ í™•ì¸
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“Š Node Labels Summary:"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              kubectl get nodes --show-labels | grep -E "workload=|domain="
              
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… Node Labeling Complete"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# SSH Key Secret (ì‚¬ì „ ìƒì„± í•„ìš”)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# kubectl create secret generic k8s-cluster-ssh-key \
#   --from-file=ssh-privatekey=~/.ssh/k8s-cluster-key.pem \
#   --namespace=argocd

