# API Services ApplicationSet (Kustomize-based)
# Wave 3: API 서비스 배포 (Infrastructure 다음)
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: api-services
  namespace: argocd
  labels:
    app.kubernetes.io/name: api-services
    app.kubernetes.io/part-of: ecoeco-platform
    app.kubernetes.io/component: api-layer
  annotations:
    argocd.argoproj.io/sync-wave: "3"  # Wave 3: APIs
spec:
  generators:
    - list:
        elements:
          # Phase 1: Core APIs
          - domain: auth
            namespace: auth
            phase: "1"
          - domain: my
            namespace: my
            phase: "1"
          - domain: scan
            namespace: scan
            phase: "1"
          
          # Phase 2: Extended APIs
          - domain: character
            namespace: character
            phase: "2"
          - domain: location
            namespace: location
            phase: "2"
          
          # Phase 3: Advanced APIs
          - domain: info
            namespace: info
            phase: "3"
          - domain: chat
            namespace: chat
            phase: "3"
  
  template:
    metadata:
      name: 'api-{{domain}}'
      labels:
        app: 'api-{{domain}}'
        domain: '{{domain}}'
        phase: '{{phase}}'
        tier: business-logic
      annotations:
        argocd.argoproj.io/sync-wave: '{{phase}}'
    
    spec:
      project: default
      
      # Source: Kustomize overlay
      source:
        repoURL: https://github.com/SeSACTHON/backend
        targetRevision: develop
        path: k8s/overlays/{{domain}}
      
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{namespace}}'
      
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: false
        
        syncOptions:
          - CreateNamespace=true
          - PrunePropagationPolicy=foreground
          - PruneLast=true
        
        retry:
          limit: 3
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 1m
      
      revisionHistoryLimit: 5

