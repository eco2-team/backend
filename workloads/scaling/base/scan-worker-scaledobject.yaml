# KEDA ScaledObject for scan-worker
# RabbitMQ 큐 길이 기반 오토스케일링
# 트리거: scan.* 큐에 메시지가 쌓이면 worker pod 증가
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: scan-worker-scaledobject
  namespace: scan
  labels:
    app: scan-worker
spec:
  scaleTargetRef:
    name: scan-worker
    kind: Deployment
  # 스케일링 범위
  minReplicaCount: 1
  maxReplicaCount: 10
  # 쿨다운 기간 (스케일업 후 최소 대기 시간)
  cooldownPeriod: 120  # 30s → 120s (스케일링 진동 방지)
  # 폴링 간격
  pollingInterval: 15
  # 고급 설정
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300  # 120s → 300s (5분 안정화)
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
          - type: Pods
            value: 2
            periodSeconds: 30
  triggers:
  # RabbitMQ HTTP API 트리거 (scan.vision)
  # HTTP 프로토콜 사용: ready + unacked 메시지 수 모니터링
  - type: rabbitmq
    metadata:
      protocol: http
      host: http://admin:admin123@eco2-rabbitmq.rabbitmq.svc.cluster.local:15672
      queueName: scan.vision
      vhostName: eco2
      mode: QueueLength  # HTTP 모드에서는 messages (ready + unacked) 반환
      value: '10'
  # RabbitMQ HTTP API 트리거 (scan.answer)
  - type: rabbitmq
    metadata:
      protocol: http
      host: http://admin:admin123@eco2-rabbitmq.rabbitmq.svc.cluster.local:15672
      queueName: scan.answer
      vhostName: eco2
      mode: QueueLength
      value: '10'
  # RabbitMQ HTTP API 트리거 (scan.rule)
  - type: rabbitmq
    metadata:
      protocol: http
      host: http://admin:admin123@eco2-rabbitmq.rabbitmq.svc.cluster.local:15672
      queueName: scan.rule
      vhostName: eco2
      mode: QueueLength
      value: '20'
