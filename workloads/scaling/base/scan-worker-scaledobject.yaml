# KEDA ScaledObject for scan-worker
# RabbitMQ 큐 길이 기반 오토스케일링
# 트리거: scan.* 큐에 메시지가 쌓이면 worker pod 증가
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 리소스 계산 (k8s-worker-ai: t3.small, 2 vCPU, 3.7GB)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# - 노드 Allocatable: 2000m CPU, 3826Mi Memory
# - 시스템 Pods (DaemonSets): ~330m CPU, ~200Mi Memory
# - 기타 Pods (cert-manager 등): ~75m CPU, ~130Mi Memory
# - 가용 리소스: ~1595m CPU, ~3500Mi Memory
# - scan-worker 1개: 350m CPU (250m + 100m istio), 640Mi Memory
# - 최대 파드 수: min(1595/350, 3500/640) = min(4.5, 5.5) = 4개
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: scan-worker-scaledobject
  namespace: scan
  labels:
    app: scan-worker
spec:
  scaleTargetRef:
    name: scan-worker
    kind: Deployment
  # 스케일링 범위
  minReplicaCount: 2  # 기본 Worker 수 (메트릭 실패 시에도 유지)
  maxReplicaCount: 4  # 5 → 4 (노드 리소스 용량 기반)
  # 쿨다운 기간 (스케일다운 전 최소 대기 시간)
  cooldownPeriod: 300  # 120s → 300s (5분, stabilizationWindow와 일치)
  # 폴링 간격
  pollingInterval: 30  # 15s → 30s (메트릭 수집 안정화)
  # Fallback: 메트릭 실패 시 기본 replicas 유지
  fallback:
    failureThreshold: 3  # 3번 실패 후 fallback 발동
    replicas: 2  # fallback 시 유지할 replicas
  # 고급 설정
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300  # 120s → 300s (5분 안정화)
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
          - type: Pods
            value: 2
            periodSeconds: 30
  triggers:
  # RabbitMQ HTTP API 트리거 (scan.vision)
  # HTTP 프로토콜 사용: ready + unacked 메시지 수 모니터링
  - type: rabbitmq
    metadata:
      protocol: http
      host: http://admin:admin123@eco2-rabbitmq.rabbitmq.svc.cluster.local:15672
      queueName: scan.vision
      vhostName: eco2
      mode: QueueLength  # HTTP 모드에서는 messages (ready + unacked) 반환
      value: '10'
  # RabbitMQ HTTP API 트리거 (scan.answer)
  - type: rabbitmq
    metadata:
      protocol: http
      host: http://admin:admin123@eco2-rabbitmq.rabbitmq.svc.cluster.local:15672
      queueName: scan.answer
      vhostName: eco2
      mode: QueueLength
      value: '10'
  # RabbitMQ HTTP API 트리거 (scan.rule)
  - type: rabbitmq
    metadata:
      protocol: http
      host: http://admin:admin123@eco2-rabbitmq.rabbitmq.svc.cluster.local:15672
      queueName: scan.rule
      vhostName: eco2
      mode: QueueLength
      value: '20'
