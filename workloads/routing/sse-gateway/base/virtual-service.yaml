# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# SSE Gateway 외부 라우팅
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 라우팅:
# - GET /api/v1/stream?job_id=xxx → sse-gateway (레거시)
# - GET /api/v1/{service}/{id}/events → sse-gateway (RESTful)
#   예: /api/v1/scan/{job_id}/events, /api/v1/chat/{job_id}/events
#
# Event Router + Pub/Sub 아키텍처:
# - 어느 Pod에 연결되든 Redis Pub/Sub를 통해 동일 이벤트 수신
# - LEAST_REQUEST 로드밸런싱으로 연결 분산
#
# 참조: docs/blogs/async/34-sse-HA-architecture.md
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: sse-gateway-external
  namespace: default
  labels:
    app: sse-gateway
    tier: integration
spec:
  hosts:
  - api.growbin.app
  gateways:
  - istio-system/eco2-gateway
  http:
  # ======= RESTful SSE: /{service}/{id}/events (Canary) =======
  - name: sse-events-canary
    match:
    - headers:
        x-canary:
          exact: 'true'
      uri:
        regex: /api/v1/[^/]+/[^/]+/events
      method:
        exact: GET
    route:
    - destination:
        host: sse-gateway.sse-consumer.svc.cluster.local
        port:
          number: 8000
        subset: canary
    timeout: 86400s
    retries:
      attempts: 0
    headers:
      request:
        set:
          x-sse-gateway: 'true'
  # ======= RESTful SSE: /{service}/{id}/events (Stable) =======
  - name: sse-events
    match:
    - uri:
        regex: /api/v1/[^/]+/[^/]+/events
      method:
        exact: GET
    route:
    - destination:
        host: sse-gateway.sse-consumer.svc.cluster.local
        port:
          number: 8000
        subset: stable
    timeout: 86400s
    retries:
      attempts: 0
    headers:
      request:
        set:
          x-sse-gateway: 'true'
  # ======= 레거시 SSE: /stream (Canary) =======
  - name: sse-stream-canary
    match:
    - headers:
        x-canary:
          exact: 'true'
      uri:
        prefix: /api/v1/stream
      method:
        exact: GET
    route:
    - destination:
        host: sse-gateway.sse-consumer.svc.cluster.local
        port:
          number: 8000
        subset: canary
    timeout: 86400s
    retries:
      attempts: 0
    headers:
      request:
        set:
          x-sse-gateway: 'true'
  # ======= 레거시 SSE: /stream (Stable) =======
  - name: sse-stream
    match:
    - uri:
        prefix: /api/v1/stream
      method:
        exact: GET
    route:
    - destination:
        host: sse-gateway.sse-consumer.svc.cluster.local
        port:
          number: 8000
        subset: stable
    timeout: 86400s
    retries:
      attempts: 0
    headers:
      request:
        set:
          x-sse-gateway: 'true'
