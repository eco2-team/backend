# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Scan VirtualService
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 라우팅:
# - /api/v1/scan/stream/* → sse-gateway (SSE 스트리밍)
# - /api/v1/scan/* → scan-api (REST API)
#
# 참조: docs/blogs/async/31-sse-fanout-optimization.md
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: scan-vs
  namespace: scan
spec:
  hosts:
  - api.growbin.app
  gateways:
  - istio-system/eco2-gateway
  http:
    # SSE Stream → sse-gateway (우선순위 높음)
  - name: sse-stream
    match:
    - uri:
        prefix: /api/v1/scan/stream
    rewrite:
      uri: /api/v1/stream
    route:
    - destination:
        host: sse-gateway.sse-consumer.svc.cluster.local
        port:
          number: 8000
    timeout: 0s    # SSE는 long-lived connection
    retries:
      attempts: 0    # SSE는 재시도 불가
    # REST API → scan-api
  - name: scan-api
    match:
    - uri:
        prefix: /api/v1/scan
    route:
    - destination:
        host: scan-api.scan.svc.cluster.local
        port:
          number: 8000
