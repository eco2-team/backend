# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# EnvoyFilter: Cookie to Header + Query to Header
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 1. Cookie → Header 변환:
#    - s_access → Authorization: Bearer {token}
#    - s_refresh → X-Refresh-Token: Bearer {token}
#
# 2. Query → Header 변환 (SSE Consistent Hash용):
#    - /api/v1/stream?job_id=xxx → X-Job-Id: xxx
#    - Istio DestinationRule에서 X-Job-Id 기반 Consistent Hash 라우팅
#
# 참조: docs/blogs/async/32-sse-sharding-troubleshooting.md
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: cookie-to-header
  namespace: istio-system
spec:
  workloadSelector:
    labels:
      istio: ingressgateway
  configPatches:
  - applyTo: HTTP_FILTER
    match:
      context: GATEWAY
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
            subFilter:
              name: envoy.filters.http.ext_authz
    patch:
      operation: INSERT_BEFORE
      value:
        name: envoy.lua
        typed_config:
          '@type': type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
          inlineCode: |
            function envoy_on_request(request_handle)
              -- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
              -- 1. Cookie → Header 변환 (인증)
              -- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
              local cookie_header = request_handle:headers():get("cookie")
              if cookie_header then
                local function extract(name)
                  local pattern = name .. "=([^;]+)"
                  return string.match(cookie_header, pattern)
                end

                -- Access Token: s_access -> Authorization
                local access_token = extract("s_access")
                if access_token then
                  request_handle:headers():replace("Authorization", "Bearer " .. access_token)
                end

                -- Refresh Token: s_refresh -> X-Refresh-Token (header-based refresh flow)
                local refresh_token = extract("s_refresh")
                if refresh_token then
                  request_handle:headers():replace("X-Refresh-Token", "Bearer " .. refresh_token)
                end
              end

              -- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
              -- 2. Query → Header 변환 (SSE Consistent Hash 라우팅)
              -- ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
              -- /api/v1/stream?job_id=xxx → X-Job-Id: xxx
              local path = request_handle:headers():get(":path")
              if path and string.find(path, "/api/v1/stream") then
                local job_id = string.match(path, "job_id=([^&]+)")
                if job_id then
                  request_handle:headers():replace("X-Job-Id", job_id)
                end
              end
            end
