---
apiVersion: batch/v1
kind: Job
metadata:
  generateName: irsa-annotator-
  namespace: platform-system
  labels:
    app.sesacthon.io/name: irsa-annotator
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 1
  template:
    metadata:
      labels:
        app.sesacthon.io/name: irsa-annotator
    spec:
      serviceAccountName: irsa-annotator
      restartPolicy: Never
      containers:
        - name: irsa-annotator
          image: bitnami/kubectl:1.28
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -c
            - |
              set -euo pipefail

              wait_for_secret() {
                local namespace="$1"
                local name="$2"
                local deadline=$((SECONDS + 600))
                until kubectl -n "${namespace}" get secret "${name}" >/dev/null 2>&1; do
                  if [ ${SECONDS} -ge ${deadline} ]; then
                    echo "Timeout waiting for secret ${namespace}/${name}" >&2
                    exit 1
                  fi
                  echo "Waiting for secret ${namespace}/${name}..."
                  sleep 5
                done
              }

              annotate_sa() {
                local sa_namespace="$1"
                local sa_name="$2"
                local secret_namespace="$3"
                local secret_name="$4"

                wait_for_secret "${secret_namespace}" "${secret_name}"
                local role_b64
                role_b64=$(kubectl -n "${secret_namespace}" get secret "${secret_name}" -o jsonpath='{.data.role-arn}')
                if [ -z "${role_b64}" ]; then
                  echo "Secret ${secret_namespace}/${secret_name} does not contain role-arn" >&2
                  exit 1
                fi
                local role_arn
                role_arn=$(printf '%s' "${role_b64}" | base64 -d)
                echo "Annotating ${sa_namespace}/${sa_name} with ${role_arn}"
                kubectl -n "${sa_namespace}" annotate serviceaccount "${sa_name}" eks.amazonaws.com/role-arn="${role_arn}" --overwrite
                kubectl -n "${sa_namespace}" label serviceaccount "${sa_name}" sesacthon.io/irsa-injected=true --overwrite
              }

              annotate_sa platform-system external-secrets-sa platform-system external-secrets-sa-irsa-values
              annotate_sa data-system postgres-operator data-system postgres-sa-irsa-values
              annotate_sa kube-system aws-load-balancer-controller kube-system alb-sa-irsa-values
              annotate_sa platform-system external-dns platform-system external-dns-sa-irsa-values

