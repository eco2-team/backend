apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: info-worker-secret
  namespace: info
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-ssm-store
  data:
  # 네이버 검색 API (뉴스)
  - secretKey: naverClientId
    remoteRef:
      key: /sesacthon/prod/api/info/naver-client-id
  - secretKey: naverClientSecret
    remoteRef:
      key: /sesacthon/prod/api/info/naver-client-secret
  # NewsData.io API (해외 뉴스)
  - secretKey: newsDataApiKey
    remoteRef:
      key: /sesacthon/prod/api/info/newsdata-api-key
  # PostgreSQL (공통 비밀번호)
  - secretKey: dbPassword
    remoteRef:
      key: /sesacthon/prod/data/postgres-password
  # RabbitMQ
  - secretKey: rabbitmqPassword
    remoteRef:
      key: /sesacthon/prod/infra/rabbitmq/password
  target:
    name: info-worker-secret
    creationPolicy: Owner
    template:
      data:
        # API Keys
        INFO_WORKER_NAVER_CLIENT_ID: '{{ .naverClientId }}'
        INFO_WORKER_NAVER_CLIENT_SECRET: '{{ .naverClientSecret }}'
        INFO_WORKER_NEWSDATA_API_KEY: '{{ .newsDataApiKey }}'
        # Database (asyncpg for async)
        DATABASE_URL: postgresql+asyncpg://sesacthon:{{ .dbPassword | urlquery }}@prod-postgresql.postgres.svc.cluster.local:5432/ecoeco
        # Celery Broker
        CELERY_BROKER_URL: amqp://admin:{{ .rabbitmqPassword | urlquery }}@eco2-rabbitmq.rabbitmq.svc.cluster.local:5672/eco2
