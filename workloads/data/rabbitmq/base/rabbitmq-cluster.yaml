apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmq-main
  namespace: rabbitmq
  labels:
    app.sesacthon.io/name: rabbitmq-main
    app.sesacthon.io/part-of: ecoeco-backend
    tier: integration
    role: messaging
spec:
  secretBackend:
    externalSecret:
      name: rabbitmq-default-user
  rabbitmq:
    additionalPlugins:
      - rabbitmq_prometheus
    additionalConfig: |
      cluster_partition_handling = pause_minority
      disk_free_limit.relative = 1.0
      vm_memory_high_watermark.relative = 0.6
  service:
    type: ClusterIP
  override:
    statefulSet:
      spec:
        template:
          metadata:
            labels:
              workload: message-queue
              sesacthon.io/tier: integration
          spec:
            nodeSelector:
              sesacthon.io/infra-type: rabbitmq
            tolerations:
              - key: sesacthon.io/infrastructure
                operator: Equal
                value: "true"
                effect: NoSchedule
            affinity:
              podAntiAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 100
                    podAffinityTerm:
                      labelSelector:
                        matchLabels:
                          app.sesacthon.io/name: rabbitmq-main
                      topologyKey: sesacthon.io/hostname
            topologySpreadConstraints:
              - maxSkew: 1
                topologyKey: topology.sesacthon.io/zone
                whenUnsatisfiable: DoNotSchedule
                labelSelector:
                  matchLabels:
                    app.sesacthon.io/name: rabbitmq-main


