# Info Worker Celery Deployment
# 뉴스 수집 Worker (Naver, NewsData API → Postgres → Redis)
# Celery Beat 스케줄링: 5분 (Naver), 30분 (NewsData)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: info-worker
  namespace: info
  labels:
    app: info-worker
    version: v1
    tier: worker
    domain: info
spec:
  replicas: 1  # 단일 인스턴스 (중복 수집 방지)
  selector:
    matchLabels:
      app: info-worker
      version: v1
  template:
    metadata:
      labels:
        app: info-worker
        version: v1
        tier: worker
        domain: info
      annotations:
        proxy.istio.io/config: '{"holdApplicationUntilProxyStarts": true}'
    spec:
      initContainers:
      - name: init-ulimit
        image: busybox:1.36
        command: [sh, -c, ulimit -n || echo "ulimit check skipped"]
        securityContext:
          runAsUser: 0
      containers:
      - name: info-worker
        image: docker.io/mng990/eco2:info-worker-dev-latest
        imagePullPolicy: Always
        command: [/bin/sh, -c]
        args:
        - |
          ulimit -n 65536 2>/dev/null || echo "ulimit setting skipped"
          exec celery -A info_worker.setup.celery:celery_app worker \
            --loglevel=info \
            -E \
            -P gevent \
            -Q info.collect_news \
            -c 100 \
            --prefetch-multiplier=1
        env:
        # Celery Broker (RabbitMQ)
        - name: CELERY_BROKER_URL
          valueFrom:
            secretKeyRef:
              name: info-worker-secret
              key: CELERY_BROKER_URL
        # PostgreSQL (Source of Truth)
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: info-worker-secret
              key: DATABASE_URL
        # Redis Cache
        - name: REDIS_URL
          value: redis://rfr-cache-redis.redis.svc.cluster.local:6379/0
        # News Cache TTL (1시간)
        - name: NEWS_CACHE_TTL
          value: '3600'
        # Cache Warm Limit (최근 200개 기사)
        - name: CACHE_WARM_LIMIT
          value: '200'
        # Gevent Pool 설정
        - name: CELERY_WORKER_POOL
          value: gevent
        - name: CELERY_WORKER_PREFETCH_MULTIPLIER
          value: '1'
        # OpenTelemetry
        - name: OTEL_SERVICE_NAME
          value: info-worker
        - name: OTEL_TRACES_EXPORTER
          value: otlp
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: http://jaeger-collector-clusterip.istio-system.svc.cluster.local:4317
        - name: OTEL_METRICS_EXPORTER
          value: none
        - name: OTEL_LOGS_EXPORTER
          value: none
        - name: OTEL_PROPAGATORS
          value: b3,tracecontext,baggage
        # API Keys (from Secret)
        envFrom:
        - secretRef:
            name: info-worker-secret
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        startupProbe:
          exec:
            command:
            - celery
            - -A
            - info_worker.setup.celery:celery_app
            - inspect
            - ping
            - -t
            - '15'
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 20
          failureThreshold: 12
        livenessProbe:
          exec:
            command:
            - celery
            - -A
            - info_worker.setup.celery:celery_app
            - inspect
            - ping
            - -t
            - '15'
          initialDelaySeconds: 10
          periodSeconds: 30
          timeoutSeconds: 20
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - celery
            - -A
            - info_worker.setup.celery:celery_app
            - inspect
            - ping
            - -t
            - '15'
          initialDelaySeconds: 5
          periodSeconds: 20
          timeoutSeconds: 20
          failureThreshold: 3
      imagePullSecrets:
      - name: dockerhub-secret
      # info 노드에 배치
      nodeSelector:
        domain: info
      tolerations:
      - key: domain
        operator: Equal
        value: info
        effect: NoSchedule
