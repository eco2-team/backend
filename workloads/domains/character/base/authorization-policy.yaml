apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: character-access-policy
  namespace: character
spec:
  selector:
    matchLabels:
      app: character-api
  action: ALLOW
  rules:
  # 1. Ingress Gateway에서 오는 트래픽 허용 (외부 API 접근)
  - from:
    - source:
        principals: [cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account]
    to:
    - operation:
        paths: [/api/v1/*, /health, /metrics]

  # 2. Scan 서비스에서 오는 트래픽 허용 (내부 API 접근)
  - from:
    - source:
        principals: [cluster.local/ns/scan/sa/default]
    to:
    - operation:
        paths: [/api/v1/internal/characters/rewards]

  # 3. Prometheus 메트릭 수집 허용 (보통 별도 SA나 포트로 접근)
  - from:
    - source:
        principals: [cluster.local/ns/prometheus/sa/prometheus]   # 가정된 SA
    to:
    - operation:
        paths: [/metrics]
