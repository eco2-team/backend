---
# RabbitMQ Queues 정의
# Quorum Queue 사용 (내구성 + 가용성)
---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Scan Pipeline Queues (AI 파이프라인)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: scan-vision-queue
  namespace: rabbitmq
spec:
  name: scan.vision
  type: quorum  # Quorum Queue (복제 + 내구성)
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    # Dead Letter Exchange 연결
    x-dead-letter-exchange: dlx
    x-dead-letter-routing-key: dlq.scan.vision
    # 메시지 TTL: 1시간 (AI 타임아웃 대비)
    x-message-ttl: 3600000
    # 최대 재시도 횟수 (delivery-limit)
    x-delivery-limit: 3
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: scan-rule-queue
  namespace: rabbitmq
spec:
  name: scan.rule
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-dead-letter-exchange: dlx
    x-dead-letter-routing-key: dlq.scan.rule
    x-message-ttl: 300000  # 5분 (Rule-based는 빠름)
    x-delivery-limit: 3
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: scan-answer-queue
  namespace: rabbitmq
spec:
  name: scan.answer
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-dead-letter-exchange: dlx
    x-dead-letter-routing-key: dlq.scan.answer
    x-message-ttl: 3600000  # 1시간 (GPT 호출)
    x-delivery-limit: 3
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Scan Reward Queue (보상 판정 - scan-worker)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: scan-reward-queue
  namespace: rabbitmq
spec:
  name: scan.reward
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-dead-letter-exchange: dlx
    x-dead-letter-routing-key: dlq.scan.reward
    x-message-ttl: 3600000   # 1시간 (AI 처리 후)
    x-delivery-limit: 3      # 재시도 3회
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Character Reward Queue (character DB 저장 - character-worker)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: character-reward-queue
  namespace: rabbitmq
spec:
  name: character.reward
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-dead-letter-exchange: dlx
    x-dead-letter-routing-key: dlq.character.reward
    x-message-ttl: 86400000  # 24시간 (DB 저장 중요)
    x-delivery-limit: 5      # 재시도 5회
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# My Reward Queue (my DB 저장 - my-worker)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: my-reward-queue
  namespace: rabbitmq
spec:
  name: my.reward
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-dead-letter-exchange: dlx
    x-dead-letter-routing-key: dlq.my.reward
    x-message-ttl: 86400000  # 24시간 (DB 저장 중요)
    x-delivery-limit: 5      # 재시도 5회
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Dead Letter Queues (실패 메시지 보관)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: dlq-scan-vision
  namespace: rabbitmq
spec:
  name: dlq.scan.vision
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-message-ttl: 604800000  # 7일 보관
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: dlq-scan-rule
  namespace: rabbitmq
spec:
  name: dlq.scan.rule
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-message-ttl: 604800000
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: dlq-scan-answer
  namespace: rabbitmq
spec:
  name: dlq.scan.answer
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-message-ttl: 604800000
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: dlq-scan-reward
  namespace: rabbitmq
spec:
  name: dlq.scan.reward
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-message-ttl: 604800000  # 7일 보관
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: dlq-character-reward
  namespace: rabbitmq
spec:
  name: dlq.character.reward
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-message-ttl: 604800000  # 7일 보관
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: dlq-my-reward
  namespace: rabbitmq
spec:
  name: dlq.my.reward
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-message-ttl: 604800000  # 7일 보관
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Celery Default Queue
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: celery-default-queue
  namespace: rabbitmq
spec:
  name: celery
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-dead-letter-exchange: dlx
    x-dead-letter-routing-key: dlq.celery
    x-message-ttl: 3600000
    x-delivery-limit: 3
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
---
apiVersion: rabbitmq.com/v1beta1
kind: Queue
metadata:
  name: dlq-celery
  namespace: rabbitmq
spec:
  name: dlq.celery
  type: quorum
  durable: true
  autoDelete: false
  vhost: eco2
  arguments:
    x-message-ttl: 604800000
  rabbitmqClusterReference:
    name: eco2-rabbitmq
    namespace: rabbitmq
