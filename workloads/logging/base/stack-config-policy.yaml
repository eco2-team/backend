# ECK StackConfigPolicy - Elasticsearch/Kibana 설정을 GitOps로 관리
# https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-stack-config-policy.html
apiVersion: stackconfigpolicy.k8s.elastic.co/v1alpha1
kind: StackConfigPolicy
metadata:
  name: eco2-logging-policy
  namespace: logging
spec:
  # 적용 대상 선택
  resourceSelector:
    matchLabels:
      app.kubernetes.io/part-of: ecoeco-observability

  # Elasticsearch 설정
  elasticsearch:
    # ILM (Index Lifecycle Management) 정책
    indexLifecyclePolicies:
      # App 로그 정책 (14일 보존)
      logs-app-policy:
        phases:
          hot:
            min_age: 0ms
            actions:
              rollover:
                max_primary_shard_size: 30gb
                max_age: 1d
              set_priority:
                priority: 100
          warm:
            min_age: 3d
            actions:
              shrink:
                number_of_shards: 1
              forcemerge:
                max_num_segments: 1
              set_priority:
                priority: 50
          delete:
            min_age: 14d
            actions:
              delete: {}

      # Infra 로그 정책 (7일 보존)
      logs-infra-policy:
        phases:
          hot:
            min_age: 0ms
            actions:
              rollover:
                max_primary_shard_size: 30gb
                max_age: 1d
              set_priority:
                priority: 100
          warm:
            min_age: 1d
            actions:
              shrink:
                number_of_shards: 1
              forcemerge:
                max_num_segments: 1
              set_priority:
                priority: 50
          delete:
            min_age: 7d
            actions:
              delete: {}

    # Index Templates
    indexTemplates:
      composableIndexTemplates:
        # App 로그 템플릿
        logs-app-template:
          index_patterns:
          - logs-app-*
          template:
            settings:
              index.lifecycle.name: logs-app-policy
              index.lifecycle.rollover_alias: logs-app
              number_of_shards: 1
              number_of_replicas: 0
            mappings:
              properties:
                '@timestamp':
                  type: date
                message:
                  type: text
                log.level:
                  type: keyword
                service.name:
                  type: keyword
                service.version:
                  type: keyword
                service.environment:
                  type: keyword
                trace.id:
                  type: keyword
                span.id:
                  type: keyword
                ecs.version:
                  type: keyword
                kubernetes.namespace_name:
                  type: keyword
                kubernetes.pod_name:
                  type: keyword

        # Infra 로그 템플릿
        logs-infra-template:
          index_patterns:
          - logs-infra-*
          template:
            settings:
              index.lifecycle.name: logs-infra-policy
              index.lifecycle.rollover_alias: logs-infra
              number_of_shards: 1
              number_of_replicas: 0
            mappings:
              properties:
                '@timestamp':
                  type: date
                message:
                  type: text
                log.level:
                  type: keyword
                kubernetes.namespace_name:
                  type: keyword
                kubernetes.pod_name:
                  type: keyword

  # Kibana 설정 (기본 config)
  kibana:
    config:
      # 타임아웃 설정
      elasticsearch.requestTimeout: 60000
      # 로깅
      logging.root.level: info
