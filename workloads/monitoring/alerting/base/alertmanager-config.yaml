# AlertmanagerConfig CR for Slack integration
# Note: Slack webhook URL is provided via ExternalSecret (alertmanager-slack-webhook)
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: slack-alerts
  namespace: prometheus
  labels:
    alertmanagerConfig: slack
spec:
  route:
    groupBy:
    - alertname
    - namespace
    - severity
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: slack-warning
    routes:
    # Critical alerts - ì¦‰ì‹œ ì•Œë¦¼
    - receiver: slack-critical
      matchers:
      - name: severity
        value: critical
        matchType: =
      continue: false
    # Warning alerts
    - receiver: slack-warning
      matchers:
      - name: severity
        value: warning
        matchType: =
      continue: false
    # Watchdog ë¬´ì‹œ (null receiver)
    - receiver: 'null'
      matchers:
      - name: alertname
        value: Watchdog
        matchType: =
      continue: false

  receivers:
  - name: 'null'
  - name: slack-critical
    slackConfigs:
    - apiURL:
        name: alertmanager-slack-webhook
        key: webhook-url
      channel: '#alerts'
      sendResolved: true
      title: ðŸ”´ [CRITICAL] {{ .GroupLabels.alertname }}
      text: |
        *Cluster:* eco2-dev
        *Namespace:* {{ .GroupLabels.namespace }}
        *Severity:* {{ .GroupLabels.severity }}

        {{ range .Alerts }}
        *Alert:* {{ .Labels.alertname }}
        *Description:* {{ .Annotations.description }}
        *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
        {{ end }}
      color: '#ff0000'

  - name: slack-warning
    slackConfigs:
    - apiURL:
        name: alertmanager-slack-webhook
        key: webhook-url
      channel: '#alerts'
      sendResolved: true
      title: ðŸŸ  [WARNING] {{ .GroupLabels.alertname }}
      text: |
        *Cluster:* eco2-dev
        *Namespace:* {{ .GroupLabels.namespace }}
        *Severity:* {{ .GroupLabels.severity }}

        {{ range .Alerts }}
        *Alert:* {{ .Labels.alertname }}
        *Description:* {{ .Annotations.description }}
        {{ end }}
      color: '#ffa500'

  - name: slack-info
    slackConfigs:
    - apiURL:
        name: alertmanager-slack-webhook
        key: webhook-url
      channel: '#alerts'
      sendResolved: true
      title: ðŸŸ¡ [INFO] {{ .GroupLabels.alertname }}
      text: |
        *Cluster:* eco2-dev
        *Namespace:* {{ .GroupLabels.namespace }}

        {{ range .Alerts }}
        *Alert:* {{ .Labels.alertname }}
        *Description:* {{ .Annotations.description }}
        {{ end }}
      color: '#ffff00'
