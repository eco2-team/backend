---
# Pod Status Report CronJob
# ì¼ì • ì£¼ê¸°ë¡œ ëª¨ë“  Pod ìƒíƒœë¥¼ Slackìœ¼ë¡œ ë¦¬í¬íŠ¸
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pod-status-report
  namespace: prometheus
spec:
  schedule: 0 9,18 * * *    # ë§¤ì¼ 09:00, 18:00 (KST ê¸°ì¤€ ì¡°ì • í•„ìš”)
  timeZone: Asia/Seoul
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: pod-status-reporter
          restartPolicy: OnFailure
          containers:
          - name: reporter
            image: bitnami/kubectl:1.28
            env:
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: alertmanager-slack-webhook
                  key: webhook-url
            command:
            - /bin/bash
            - -c
            - |
              #!/bin/bash
              set -e

              # Namespace ëª©ë¡ (API ì„œë¹„ìŠ¤)
              NAMESPACES="auth character chat scan my location image"

              # í˜„ì¬ ì‹œê°„
              TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S KST')

              # Pod ìƒíƒœ ìˆ˜ì§‘
              generate_report() {
                echo "*ğŸ“Š Pod Status Report*"
                echo "*Time:* ${TIMESTAMP}"
                echo "*Cluster:* eco2-dev"
                echo ""

                total_pods=0
                running_pods=0

                for ns in $NAMESPACES; do
                  echo "*â”â”â” ${ns} â”â”â”*"

                  # Pod ì •ë³´ ìˆ˜ì§‘
                  pods=$(kubectl get pods -n $ns --no-headers 2>/dev/null || echo "")

                  if [ -z "$pods" ]; then
                    echo "No pods found"
                    echo ""
                    continue
                  fi

                  while IFS= read -r line; do
                    name=$(echo "$line" | awk '{print $1}')
                    ready=$(echo "$line" | awk '{print $2}')
                    status=$(echo "$line" | awk '{print $3}')
                    restarts=$(echo "$line" | awk '{print $4}')

                    # ìƒíƒœë³„ ì´ëª¨ì§€
                    case "$status" in
                      Running)
                        emoji="ğŸŸ¢"
                        ((running_pods++))
                        ;;
                      Pending|ContainerCreating)
                        emoji="ğŸŸ¡"
                        ;;
                      Error|CrashLoopBackOff|ImagePullBackOff)
                        emoji="ğŸ”´"
                        ;;
                      Completed)
                        emoji="âœ…"
                        ;;
                      *)
                        emoji="âšª"
                        ;;
                    esac

                    ((total_pods++))

                    # Pod ì´ë¦„ ì¶•ì•½ (ë„ˆë¬´ ê¸¸ë©´)
                    short_name=$(echo "$name" | sed 's/-[a-z0-9]\{8,10\}-[a-z0-9]\{5\}$//')

                    echo "${emoji} \`${short_name}\` ${ready} (${status}, restarts: ${restarts})"
                  done <<< "$pods"

                  echo ""
                done

                echo "*â”â”â” Summary â”â”â”*"
                echo "Total: ${total_pods} pods | Running: ${running_pods} | Issues: $((total_pods - running_pods))"
              }

              # Slack ë©”ì‹œì§€ ì „ì†¡
              REPORT=$(generate_report)

              # JSON escape
              REPORT_ESCAPED=$(echo "$REPORT" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

              curl -X POST "$SLACK_WEBHOOK_URL" \
                -H "Content-Type: application/json" \
                -d "{
                  \"blocks\": [
                    {
                      \"type\": \"section\",
                      \"text\": {
                        \"type\": \"mrkdwn\",
                        \"text\": \"${REPORT_ESCAPED}\"
                      }
                    }
                  ]
                }"

              echo "Report sent successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pod-status-reporter
  namespace: prometheus
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pod-status-reader
rules:
- apiGroups: ['']
  resources: [pods]
  verbs: [get, list]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pod-status-reporter-binding
subjects:
- kind: ServiceAccount
  name: pod-status-reporter
  namespace: prometheus
roleRef:
  kind: ClusterRole
  name: pod-status-reader
  apiGroup: rbac.authorization.k8s.io
