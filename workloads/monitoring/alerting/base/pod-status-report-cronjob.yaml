---
# Pod Status Report CronJob
# ÏùºÏ†ï Ï£ºÍ∏∞Î°ú Î™®Îì† Pod ÏÉÅÌÉúÎ•º SlackÏúºÎ°ú Î¶¨Ìè¨Ìä∏
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pod-status-report
  namespace: prometheus
spec:
  schedule: 0 9,18 * * *    # Îß§Ïùº 09:00, 18:00 (KST Í∏∞Ï§Ä Ï°∞Ï†ï ÌïÑÏöî)
  timeZone: Asia/Seoul
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            sidecar.istio.io/inject: 'false'  # CronJob doesn't need Istio sidecar
        spec:
          serviceAccountName: pod-status-reporter
          restartPolicy: OnFailure
          containers:
          - name: reporter
            image: alpine/k8s:1.28.4  # lightweight kubectl image
            env:
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: alertmanager-slack-webhook
                  key: webhook-url
            command:
            - /bin/bash
            - -c
            - |
              #!/bin/bash
              set -e

              # Namespace Î™©Î°ù
              API_NS="auth character chat scan my location image"
              INFRA_NS="istio-system prometheus logging argocd postgres redis"

              TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S KST')

              # NamespaceÎ≥Ñ ÏÉÅÌÉú ÏöîÏïΩ (Í∞ÑÍ≤∞ Î≤ÑÏ†Ñ)
              get_ns_summary() {
                local ns=$1
                local pods=$(kubectl get pods -n $ns --no-headers 2>/dev/null)
                [ -z "$pods" ] && echo "‚ö™ 0/0" && return

                local total=$(echo "$pods" | wc -l)
                local running=$(echo "$pods" | awk '$3=="Running" || $3=="Completed"' | wc -l)
                local issues=$((total - running))

                if [ $issues -eq 0 ]; then
                  echo "üü¢ ${running}/${total}"
                else
                  echo "üî¥ ${running}/${total}"
                fi
              }

              # Î¨∏Ï†ú PodÎßå ÏÉÅÏÑ∏ Ï∂úÎ†•
              get_problem_pods() {
                local ns=$1
                kubectl get pods -n $ns --no-headers 2>/dev/null | \
                  awk '$3!="Running" && $3!="Completed" {print "  ‚ö†Ô∏è "$1" ("$3")"}' | head -3
              }

              # Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
              generate_report() {
                echo "*üìä Cluster Status Report*"
                echo "*${TIMESTAMP}* | eco2-dev"
                echo ""
                echo "*üöÄ API Services*"
                for ns in $API_NS; do
                  summary=$(get_ns_summary $ns)
                  echo "${summary} \`${ns}\`"
                  get_problem_pods $ns
                done
                echo ""
                echo "*‚öôÔ∏è Infrastructure*"
                for ns in $INFRA_NS; do
                  summary=$(get_ns_summary $ns)
                  echo "${summary} \`${ns}\`"
                  get_problem_pods $ns
                done
              }

              REPORT=$(generate_report)
              REPORT_ESCAPED=$(echo "$REPORT" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

              curl -s -X POST "$SLACK_WEBHOOK_URL" \
                -H "Content-Type: application/json" \
                -d "{\"text\": \"${REPORT_ESCAPED}\"}"

              echo "Report sent successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pod-status-reporter
  namespace: prometheus
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pod-status-reader
rules:
- apiGroups: ['']
  resources: [pods]
  verbs: [get, list]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pod-status-reporter-binding
subjects:
- kind: ServiceAccount
  name: pod-status-reporter
  namespace: prometheus
roleRef:
  kind: ClusterRole
  name: pod-status-reader
  apiGroup: rbac.authorization.k8s.io
