# ============================================================================
# Cache Redis Failover - Celery Result Backend + 도메인 캐시
# ============================================================================
# 용도: Celery Result, Character/Location/Image Cache
# 정책: allkeys-lru (메모리 부족 시 LRU 기반 eviction)
#
# [Service 네이밍 규칙 - Spotahome Redis Operator]
#   - rfr-cache-redis.redis.svc.cluster.local:6379   (Redis Master)
#   - rfs-cache-redis.redis.svc.cluster.local:26379  (Sentinel)
#
# [DB 할당]
#   - DB 0: Celery Result Backend (all workers)
#   - DB 1: Celery Beat 스케줄러
#   - DB 5: Location 캐시
#   - DB 6: Image 캐시
#
# [환경변수]
#   - CELERY_RESULT_BACKEND=redis://rfr-cache-redis.redis.svc.cluster.local:6379/0
#   - IMAGE_REDIS_URL=redis://rfr-cache-redis.redis.svc.cluster.local:6379/6
# ============================================================================
apiVersion: databases.spotahome.com/v1
kind: RedisFailover
metadata:
  name: cache-redis
  namespace: redis
  labels:
    app: cache-redis
    tier: data
    purpose: cache
spec:
  # Sentinel 설정 (HA)
  sentinel:
    replicas: 3
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi
    customConfig:
    - down-after-milliseconds 5000
    - failover-timeout 10000
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: redis-cluster
              operator: In
              values:
              - cache
    tolerations:
    - key: domain
      operator: Equal
      value: data
      effect: NoSchedule

  # Redis 설정
  redis:
    replicas: 3
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 300m
        memory: 768Mi
    # 휘발성 캐시 데이터 (PVC 불필요, emptyDir 사용)
    storage:
      emptyDir: {}
    # Redis 설정
    customConfig:
    - maxmemory 512mb
    - maxmemory-policy allkeys-lru
    - tcp-keepalive 300
    - timeout 300  # idle 연결 5분 후 자동 정리 (연결 누수 방지)
    - appendonly no
    - save ""
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: redis-cluster
              operator: In
              values:
              - cache
    tolerations:
    - key: domain
      operator: Equal
      value: data
      effect: NoSchedule
    # Metrics Exporter
    exporter:
      enabled: true
      image: oliver006/redis_exporter:v1.62.0
      resources:
        requests:
          cpu: 25m
          memory: 32Mi
        limits:
          cpu: 100m
          memory: 128Mi
