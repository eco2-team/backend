---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-observability-ingress
  namespace: istio-system
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - kiali
      - jaeger
      - prometheus
  policyTypes:
  - Ingress
  ingress:
  # Ingress Gateway에서 UI 접근
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: istio-system
      podSelector:
        matchLabels:
          istio: ingressgateway
    ports:
    - port: 20001 # Kiali
      protocol: TCP
    - port: 16686 # Jaeger Query
      protocol: TCP
    - port: 9090  # Prometheus
      protocol: TCP
---
# Jaeger Collector: 앱 네임스페이스에서 OTLP trace 수신 허용
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-jaeger-otlp-ingress
  namespace: istio-system
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: jaeger
  policyTypes:
  - Ingress
  ingress:
  # 모든 앱 네임스페이스에서 OTLP 포트 접근 허용
  - from:
    - namespaceSelector:
        matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: In
          values:
          - auth
          - character
          - chat
          - scan
          - my
          - location
          - image
          - event-router
          - sse-gateway
    ports:
    - port: 4317  # OTLP gRPC
      protocol: TCP
    - port: 4318  # OTLP HTTP
      protocol: TCP
    - port: 14268 # Jaeger Thrift HTTP
      protocol: TCP
    - port: 14250 # Jaeger gRPC
      protocol: TCP
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-observability-collection
  namespace: auth # 각 앱 네임스페이스마다 필요하지만, 예시로 auth에 추가. 실제로는 모든 네임스페이스에 적용 필요.
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  # Istio system (Kiali, Jaeger, etc.) - sidecar metrics
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: istio-system
      podSelector:
        matchExpressions:
        - key: app
          operator: In
          values:
          - kiali
          - jaeger
          - prometheus
    ports:
    - port: 15020 # Istio metrics merging port
      protocol: TCP
    - port: 15090 # Envoy Prometheus telemetry
      protocol: TCP
  # Prometheus namespace - application metrics scraping
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: prometheus
    ports:
    - port: 8000 # API application metrics
      protocol: TCP
    - port: 9090 # ext-authz gRPC metrics
      protocol: TCP
