# Troubleshooting Log (v0.9.0 → v1.0.0)

이 문서는 v0.9.0에서 v1.0.0으로 이동하면서 재현·해결했던 대표 이슈를 정리한 자료입니다. 모든 사례는 `main` 반영 전에 develop 브랜치에서 검증되었으며, Scan/Chat 파이프라인이 동일한 Waste Pipeline을 사용하게 되면서 발생한 문제들입니다.

---

## 1. Chat 이미지 요청이 항상 Fallback 문구를 반환
- **증상**  
  - `/api/v1/chat/messages`에 `image_url`을 포함해 호출하면 `ChatService` 로그에 `Pipeline execution failed; using fallback answer.`가 출력되고, 사용자에게 “이미지가 인식되지 않았어요! 다시 시도해주세요.”만 응답.
  - Grafana의 `rest_client_request_duration_seconds`에 외부 호출이 기록되지 않음.
- **원인**  
  - 프론트엔드에서 만료되었거나 권한이 없는 이미지 URL을 전달해 Vision 단계에서 403/404가 발생했지만, Chat 서비스는 모든 예외를 동일한 fallback 경로로 처리해 원인을 즉시 파악하기 어려웠음.
- **해결**  
  1. Postman으로 동일한 `image_url`을 사용해 API를 호출해 재현하고, presigned URL 만료/권한 문제임을 확인.  
  2. 프론트엔드에서 업로드 직후 유효한 URL을 전달하도록 수정(필요 시 presigned 재요청).  
  3. 서버 로그에 URL과 상태 코드를 남기고, fallback 문구를 “이미지가 인식되지 않았어요! 다시 시도해주세요.”처럼 친절한 재시도 안내로 업데이트.  
  4. 장기적으로 Vision 오류 타입별 메시지를 구분해 사용자·개발자 모두 원인을 빠르게 파악할 수 있도록 개선 계획 수립.
- **관련 커밋/파일**  
  - `domains/chat/services/chat.py` (`_run_image_pipeline`, `_fallback_answer`)  
  - 프론트엔드 presigned URL 발급·전달 로직

---

## 2. Chat pytest 실패 (`test_render_answer_falls_back_when_missing`)
- **증상**  
  - GitHub Actions 또는 로컬에서 `pytest domains/chat/tests/test_chat_service.py` 실행 시  
    ```
    AssertionError: assert '원문 질문' in '이미지가 인식되지 않았어요! 다시 시도해주세요.'
    ```
- **원인**  
  - Redis/세션 의존성을 제거하는 과정에서 `ChatService._fallback_answer()` 문구를 변경했지만, 테스트는 여전히 질문 문자열이 포함된 이전 fallback을 기대함.
- **해결**  
  - 테스트를 fallback 문자열과 동기화하도록 수정.  
    ```python
    text = service._render_answer(result, "원문 질문")
    assert text == service._fallback_answer("원문 질문")
    ```
  - 변경 후 `PYTHONPATH=. pytest domains/chat/tests/test_chat_service.py`를 통해 회귀 테스트 진행.
- **관련 커밋/파일**  
  - `domains/chat/tests/test_chat_service.py` (`test_render_answer_falls_back_when_missing`)  
  - `domains/chat/services/chat.py` (`_fallback_answer`)

---

## 3. Waste Pipeline Prompt/Tag 변경 후 Scan·Chat 이미지가 이전 버전으로 응답
- **증상**  
  - Prompt/상황 태그를 수정한 뒤에도 Scan/Chat에서 예전 답변이 계속 반환되고, ArgoCD는 Sync 상태로 표시됨.
- **원인**  
  - `_shared/waste_pipeline`은 모듈형 파이썬 패키지라 문서 파일 업데이트만으로는 CI가 대상 도커 이미지를 재빌드하지 않음.
- **해결**  
  1. 프롬프트/태그 수정 시 README에 Waste Pipeline 변경 사항을 기록하고, CI 트리거용 커밋을 만들어 Scan/Chat 이미지를 재패키징.  
  2. `domains/_shared/waste_pipeline/README.md`에 파이프라인 구조 및 변경 로그를 추가해 운영 히스토리를 남김.  
  3. develop → main 머지 시 README의 “Troubleshooting” 섹션을 최신 사례로 유지해 릴리스 노트와 연동.
- **관련 커밋/파일**  
  - `domains/_shared/waste_pipeline/data/{prompts,situation_tags}.txt`  
  - `domains/_shared/waste_pipeline/README.md`  
  - `README.md` (Troubleshooting 섹션 링크)

---

## 4. 릴리스 테스트 중 Scan/Chat CI 트리거 회피
- **증상**  
  - v1.0.0 준비 과정에서 waste pipeline을 되돌린 뒤 CI가 다시 돌지 않아 Scan/Chat 이미지가 v0.9.0 기준으로 남음.
- **원인**  
  - `git revert` 이후 추가 커밋 없이 develop을 main에 머지하면 ci-services.yml이 실행되지 않음.
- **해결**  
  - README 또는 Docs에 경미한 갱신(예: Waste Pipeline README 작성, Troubleshooting log 업데이트)을 추가 커밋으로 만들어 Scan/Chat CI를 의도적으로 트리거.  
  - 필요 시 `gh workflow run ci-services.yml -f target_services=scan,chat`으로 수동 재실행.
- **관련 커밋/파일**  
  - `docs/troubleshooting/2025-12-02-v1.0.0.md` (본 문서)  
  - `ci/ci-services.yml`

---

## 참고 명령어
```bash
# Chat/Scan 도커 이미지 태그 확인
kubectl get deploy -n chat chat-api -o jsonpath='{.spec.template.spec.containers[0].image}'
kubectl get deploy -n scan scan-api -o jsonpath='{.spec.template.spec.containers[0].image}'

# develop → main 동기화 후 README만 main 버전을 유지하는 절차
git checkout -b release/v1.0.0
git checkout origin/main -- README.md
git commit -m "chore(release): keep main README"
```

위 사례는 v1.0.0 릴리스 문서와 연계해 유지되며, 새로운 이슈는 README의 Troubleshooting 섹션에 링크를 추가합니다.

