# Troubleshooting Log (v0.9.0 → v1.0.0)

이 문서는 v0.9.0에서 v1.0.0으로 이동하면서 재현·해결했던 대표 이슈를 정리한 자료입니다. 모든 사례는 `main` 반영 전에 develop 브랜치에서 검증되었으며, Scan/Chat 파이프라인이 동일한 Waste Pipeline을 사용하게 되면서 발생한 문제들입니다.

---

## 1. Chat 이미지 요청이 항상 Fallback 문구를 반환
- **증상**  
  - `/api/v1/chat/messages`에 `image_url`을 포함해 호출하면 `ChatService` 로그에 `Pipeline execution failed; using fallback answer.`가 출력되고, 사용자에게 “이미지가 인식되지 않았어요! 다시 시도해주세요.”만 응답.
  - Grafana의 `rest_client_request_duration_seconds`에 외부 호출이 기록되지 않음.
- **원인**  
  - `OPENAI_API_KEY`가 Pod 환경 변수에 주입되지 않아 `_shared/waste_pipeline.process_waste_classification()` 실행 중 `RuntimeError("OPENAI_API_KEY 환경 변수가 설정되지 않았습니다.")`가 발생.
  - `kubectl -n chat describe deployment chat-api`에서 Environment 섹션에 키가 보이지 않음. ExternalSecret `chat-secret`이 최신 `/sesacthon/{env}/api/chat/openai-api-key`를 읽지 못한 상태.
- **해결**  
  1. ExternalSecret 상태 점검  
     ```bash
     kubectl -n chat get externalsecret chat-secret -o wide
     kubectl -n chat describe externalsecret chat-secret
     ```
  2. AWS SSM 파라미터 존재 여부 확인  
     ```bash
     aws ssm get-parameter \
       --name /sesacthon/dev/api/chat/openai-api-key \
       --with-decryption
     ```
  3. Secret 동기화 후 Deployment 재시작  
     ```bash
     kubectl -n chat rollout restart deploy/chat-api
     ```
  4. Pod 안에서 실제 env 확인  
     ```bash
     POD=$(kubectl -n chat get pod -l app=chat-api -o jsonpath='{.items[0].metadata.name}')
     kubectl -n chat exec -it "$POD" -- printenv | grep OPENAI_API_KEY
     ```
- **관련 커밋/파일**  
  - `domains/chat/services/chat.py` (`_run_image_pipeline` 예외 처리)  
  - `workloads/secrets/external-secrets/{env}/chat-api-secrets.yaml`

---

## 2. Chat pytest 실패 (`test_render_answer_falls_back_when_missing`)
- **증상**  
  - GitHub Actions 또는 로컬에서 `pytest domains/chat/tests/test_chat_service.py` 실행 시  
    ```
    AssertionError: assert '원문 질문' in '이미지가 인식되지 않았어요! 다시 시도해주세요.'
    ```
- **원인**  
  - Redis/세션 의존성을 제거하는 과정에서 `ChatService._fallback_answer()` 문구를 변경했지만, 테스트는 여전히 질문 문자열이 포함된 이전 fallback을 기대함.
- **해결**  
  - 테스트를 fallback 문자열과 동기화하도록 수정.  
    ```python
    text = service._render_answer(result, "원문 질문")
    assert text == service._fallback_answer("원문 질문")
    ```
  - 변경 후 `PYTHONPATH=. pytest domains/chat/tests/test_chat_service.py`를 통해 회귀 테스트 진행.
- **관련 커밋/파일**  
  - `domains/chat/tests/test_chat_service.py` (`test_render_answer_falls_back_when_missing`)  
  - `domains/chat/services/chat.py` (`_fallback_answer`)

---

## 3. Waste Pipeline Prompt/Tag 변경 후 Scan·Chat 이미지가 이전 버전으로 응답
- **증상**  
  - Prompt/상황 태그를 수정한 뒤에도 Scan/Chat에서 예전 답변이 계속 반환되고, ArgoCD는 Sync 상태로 표시됨.
- **원인**  
  - `_shared/waste_pipeline`은 모듈형 파이썬 패키지라 문서 파일 업데이트만으로는 CI가 대상 도커 이미지를 재빌드하지 않음. README에 명시된 “Troubleshooting Highlight” 섹션도 최신 이슈를 반영하지 않아 변경 이력을 파악하기 어려웠음.
- **해결**  
  1. 프롬프트/태그 수정 시 README에 Waste Pipeline 변경 사항을 기록하고, CI 트리거용 커밋을 만들어 Scan/Chat 이미지를 재패키징.  
  2. `domains/_shared/waste_pipeline/README.md`에 파이프라인 구조 및 변경 로그를 추가해 운영 히스토리를 남김.  
  3. develop → main 머지 시 README의 “Troubleshooting” 섹션을 최신 사례로 유지해 릴리스 노트와 연동.
- **관련 커밋/파일**  
  - `domains/_shared/waste_pipeline/data/{prompts,situation_tags}.txt`  
  - `domains/_shared/waste_pipeline/README.md`  
  - `README.md` (Troubleshooting 섹션 링크)

---

## 4. 릴리스 테스트 중 Scan/Chat CI 트리거 회피
- **증상**  
  - v1.0.0 준비 과정에서 waste pipeline을 되돌린 뒤 CI가 다시 돌지 않아 Scan/Chat 이미지가 v0.9.0 기준으로 남음.
- **원인**  
  - `git revert` 이후 추가 커밋 없이 develop을 main에 머지하면 ci-services.yml이 실행되지 않음.
- **해결**  
  - README 또는 Docs에 경미한 갱신(예: Waste Pipeline README 작성, Troubleshooting log 업데이트)을 추가 커밋으로 만들어 Scan/Chat CI를 의도적으로 트리거.  
  - 필요 시 `gh workflow run ci-services.yml -f target_services=scan,chat`으로 수동 재실행.
- **관련 커밋/파일**  
  - `docs/troubleshooting/2025-12-02-v1.0.0.md` (본 문서)  
  - `ci/ci-services.yml`

---

## 참고 명령어
```bash
# Chat/Scan 도커 이미지 태그 확인
kubectl get deploy -n chat chat-api -o jsonpath='{.spec.template.spec.containers[0].image}'
kubectl get deploy -n scan scan-api -o jsonpath='{.spec.template.spec.containers[0].image}'

# develop → main 동기화 후 README만 main 버전을 유지하는 절차
git checkout -b release/v1.0.0
git checkout origin/main -- README.md
git commit -m "chore(release): keep main README"
```

위 사례는 v1.0.0 릴리스 문서와 연계해 유지되며, 새로운 이슈는 README의 Troubleshooting 섹션에 링크를 추가합니다.

