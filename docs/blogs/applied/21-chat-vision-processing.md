# ì´ì½”ì—ì½”(EcoÂ²) Agent #9: Vision Processing

> Chat Workerì— Vision ê¸°ëŠ¥ ì¶”ê°€ â€” ì´ë¯¸ì§€ ê¸°ë°˜ íê¸°ë¬¼ ë¶„ë¥˜

| í•­ëª©      | ê°’          |
| ------- | ---------- |
| **ì‘ì„±ì¼** | 2026-01-14 |
| **ì»¤ë°‹**  | da24a5db   |

---

## 1. ê°œìš”

### 1.1 AS-IS: ê¸°ì¡´ Vision íŒŒì´í”„ë¼ì¸ (scan_worker)

Vision ì²˜ë¦¬ì˜ ì›í˜•ì€ `scan_worker`ì— êµ¬í˜„ë˜ì–´ ìˆì—ˆìŠµë‹ˆë‹¤. Celery Task ì²´ì¸ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                AS-IS: scan_worker íŒŒì´í”„ë¼ì¸                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ vision_taskâ”‚â”€â”€â”€â–¶â”‚ rule_task  â”‚â”€â”€â”€â–¶â”‚answer_task â”‚â”€â”€â”€â–¶â”‚reward   â”‚ â”‚
â”‚  â”‚  (Stage 1) â”‚    â”‚  (Stage 2) â”‚    â”‚  (Stage 3) â”‚    â”‚_task    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                â”‚                  â”‚                        â”‚
â”‚        â–¼                â–¼                  â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ VisionStep â”‚    â”‚  RuleStep  â”‚    â”‚ AnswerStep â”‚                â”‚
â”‚  â”‚            â”‚    â”‚            â”‚    â”‚            â”‚                â”‚
â”‚  â”‚ GPT Vision â”‚    â”‚ JSON ê²€ìƒ‰  â”‚    â”‚ JSON ì¶œë ¥  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                     â”‚
â”‚  ClassifyContext (ë°ì´í„° ì „ë‹¬)                                       â”‚
â”‚  â”œâ”€ task_id, user_id, image_url                                    â”‚
â”‚  â”œâ”€ classification: { major, middle, minor }                       â”‚
â”‚  â”œâ”€ lite_rag_result: { disposal_common, disposal_detail }          â”‚
â”‚  â””â”€ answer: { disposal_steps, insufficiencies, user_answer }       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ íŒŒì¼:**
- `apps/scan_worker/presentation/tasks/vision_task.py` â€” Celery Task
- `apps/scan_worker/application/classify/steps/vision_step.py` â€” Vision Step
- `apps/scan_worker/infrastructure/llm/gpt/vision.py` â€” GPT Vision Adapter
- `apps/scan_worker/infrastructure/retrievers/json_regulation.py` â€” Rule-based ê²€ìƒ‰

**AS-IS íŠ¹ì§•:**
```python
# Celery Task ì²´ì¸
vision_task.s(task_id, user_id, image_url) | 
rule_task.s() | 
answer_task.s() | 
reward_task.s()
```

```python
# ë‹µë³€ ì¶œë ¥: Structured JSON (ë¬´ê±°ì›€)
{
  "disposal_steps": { "ë‹¨ê³„1": "...", "ë‹¨ê³„2": "..." },
  "insufficiencies": ["ë¼ë²¨ì„ ì œê±°í•´ì•¼ í•©ë‹ˆë‹¤"],
  "user_answer": "í˜íŠ¸ë³‘ì€..."
}
```

### 1.2 TO-BE: LangGraph ê¸°ë°˜ ì¬êµ¬ì„± (chat_worker)

`chat_worker`ì—ì„œëŠ” **LangGraph íŒŒì´í”„ë¼ì¸**ìœ¼ë¡œ ì¬êµ¬ì„±í–ˆìŠµë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                TO-BE: chat_worker íŒŒì´í”„ë¼ì¸                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ intent â”‚â”€â”€â–¶â”‚vision? â”‚â”€â”€â–¶â”‚ router â”‚â”€â”€â–¶â”‚  rag   â”‚â”€â”€â–¶â”‚ answer â”‚   â”‚
â”‚  â”‚  node  â”‚   â”‚  node  â”‚   â”‚  node  â”‚   â”‚  node  â”‚   â”‚  node  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚            â”‚            â”‚            â”‚            â”‚        â”‚
â”‚       â–¼            â–¼            â–¼            â–¼            â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚LLMPort â”‚   â”‚Vision  â”‚   â”‚ì¡°ê±´ë¶€   â”‚   â”‚Retriev-â”‚   â”‚LLMPort â”‚   â”‚
â”‚  â”‚        â”‚   â”‚Model   â”‚   â”‚ë¼ìš°íŒ…   â”‚   â”‚erPort  â”‚   â”‚+Stream â”‚   â”‚
â”‚  â”‚        â”‚   â”‚Port    â”‚   â”‚        â”‚   â”‚        â”‚   â”‚        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  State Dict (ë°ì´í„° ì „ë‹¬)                                            â”‚
â”‚  â”œâ”€ job_id, user_id, message, image_url                            â”‚
â”‚  â”œâ”€ classification_result: { major, middle, minor }                â”‚
â”‚  â”œâ”€ disposal_rules: { ... }  (LocalAssetRetriever)                 â”‚
â”‚  â””â”€ answer: "ìì—°ì–´ í…ìŠ¤íŠ¸ (í† í° ìŠ¤íŠ¸ë¦¬ë°)"                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ íŒŒì¼:**
- `apps/chat_worker/infrastructure/orchestration/langgraph/nodes/vision_node.py`
- `apps/chat_worker/application/ports/vision/vision_model.py` â€” VisionModelPort
- `apps/chat_worker/infrastructure/llm/vision/openai_vision.py` â€” GPT-5.2 Adapter
- `apps/chat_worker/infrastructure/retrieval/local_asset_retriever.py` â€” Rule-based ê²€ìƒ‰

**TO-BE íŠ¹ì§•:**
```python
# LangGraph íŒŒì´í”„ë¼ì¸
graph = StateGraph(dict)
graph.add_node("intent", intent_node)
graph.add_node("vision", vision_node)
graph.add_node("rag", rag_node)
graph.add_node("answer", answer_node)
```

```python
# ë‹µë³€ ì¶œë ¥: ìì—°ì–´ í…ìŠ¤íŠ¸ (ìŠ¤íŠ¸ë¦¬ë° ê°€ëŠ¥)
"í˜íŠ¸ë³‘ì´ë„¤ìš”! íˆ¬ëª… í˜íŠ¸ë³‘ ì „ìš© ìˆ˜ê±°í•¨ì— ë²„ë¦¬ë©´ ë¼ìš”.
ë¼ë²¨ì„ ë–¼ê³ , ë‚´ìš©ë¬¼ì„ ë¹„ìš´ ë’¤ ë‚©ì‘í•˜ê²Œ ì••ì°©í•´ì„œ ë°°ì¶œí•´ì£¼ì„¸ìš”."
```

### 1.3 AS-IS vs TO-BE ë¹„êµ

| í•­ëª© | AS-IS (scan_worker) | TO-BE (chat_worker) |
|------|---------------------|---------------------|
| **ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜** | Celery Task ì²´ì¸ | LangGraph StateGraph |
| **ë°ì´í„° ì „ë‹¬** | ClassifyContext | State Dict |
| **Vision** | VisionStep | vision_node |
| **ê²€ìƒ‰** | json_regulation.py | LocalAssetRetriever |
| **ë‹µë³€ í˜•ì‹** | Structured JSON | ìì—°ì–´ í…ìŠ¤íŠ¸ |
| **SSE ìŠ¤íŠ¸ë¦¬ë°** | âŒ ë¶ˆê°€ | âœ… í† í° ë‹¨ìœ„ |
| **ì¡°ê±´ë¶€ ë¼ìš°íŒ…** | âŒ ê³ ì • ì²´ì¸ | âœ… intent ê¸°ë°˜ ë¶„ê¸° |
| **í…ŒìŠ¤íŠ¸** | ì–´ë ¤ì›€ (Celery ì˜ì¡´) | ìš©ì´ (Mock ì£¼ì…) |

**ìœ ì§€ë˜ëŠ” ê²ƒ:**
- âœ… Vision ë¶„ë¥˜ ê²°ê³¼ (`classification_result`)
- âœ… Rule-based Retrieval (LocalAssetRetriever â‰ˆ json_regulation.py)
- âœ… 3ë‹¨ê³„ ë¶„ë¥˜ ì²´ê³„ (major/middle/minor)
- âœ… situation_tags ì²˜ë¦¬

**ê°œì„ ëœ ê²ƒ:**
- ğŸ”„ Celery â†’ LangGraph (ìœ ì—°í•œ ë¶„ê¸°)
- ğŸ”„ JSON ì¶œë ¥ â†’ ìì—°ì–´ (SSE ìŠ¤íŠ¸ë¦¬ë°)
- ğŸ”„ ê³ ì • íŒŒì´í”„ë¼ì¸ â†’ Intent ê¸°ë°˜ ë™ì  ë¼ìš°íŒ…

### 1.5 í”„ë¡¬í”„íŠ¸ êµ¬ì¡° ê°œì„ 

ê¸°ì¡´ `scan_worker`ì˜ ë‹µë³€ ìƒì„± í”„ë¡¬í”„íŠ¸ëŠ” **Structured JSON**ì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤:

```json
// scan_worker/answer_generation_prompt.txt ì¶œë ¥ í˜•ì‹
{
  "disposal_steps": { "ë‹¨ê³„1": "...", "ë‹¨ê³„2": "..." },
  "insufficiencies": ["ë¼ë²¨ì„ ì œê±°í•´ì•¼ í•©ë‹ˆë‹¤"],
  "user_answer": "í˜íŠ¸ë³‘ì€ íˆ¬ëª… í˜íŠ¸ë³‘ ìˆ˜ê±°í•¨ì—..."
}
```

**ë¬¸ì œì **:
1. **ë¬´ê±°ìš´ ì‘ë‹µ êµ¬ì¡°** â€” í”„ë¡ íŠ¸ì—”ë“œì—ì„œ íŒŒì‹± í›„ ì¬êµ¬ì„± í•„ìš”
2. **SSE ìŠ¤íŠ¸ë¦¬ë° ë¶ˆê°€** â€” JSON ì „ì²´ê°€ ì™„ì„±ë˜ì–´ì•¼ íŒŒì‹± ê°€ëŠ¥
3. **í† í° ë‚­ë¹„** â€” JSON í‚¤ì™€ êµ¬ì¡°ì— í† í° ì†Œëª¨

**ê°œì„ ëœ í”„ë¡¬í”„íŠ¸** (`chat_worker/waste_answer_prompt.txt`):

```
# Output
ìì—°ì–´ë¡œ ë‹µë³€í•˜ì„¸ìš”. Markdown ì„œì‹ ì‚¬ìš© ê°€ëŠ¥.

# ê¸ˆì§€ì‚¬í•­
- JSON í˜•ì‹ ì¶œë ¥ ê¸ˆì§€
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  í”„ë¡¬í”„íŠ¸ êµ¬ì¡° ë¹„êµ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  scan_worker (ê¸°ì¡´):                                        â”‚
â”‚  - ì¶œë ¥: Structured JSON                                    â”‚
â”‚  - ìŠ¤íŠ¸ë¦¬ë°: âŒ ë¶ˆê°€ (ì „ì²´ JSON ì™„ì„± í•„ìš”)                    â”‚
â”‚  - í”„ë¡ íŠ¸: JSON íŒŒì‹± â†’ UI ë§¤í•‘ í•„ìš”                          â”‚
â”‚                                                             â”‚
â”‚  chat_worker (ê°œì„ ):                                        â”‚
â”‚  - ì¶œë ¥: ìì—°ì–´ í…ìŠ¤íŠ¸ + Markdown                            â”‚
â”‚  - ìŠ¤íŠ¸ë¦¬ë°: âœ… í† í° ë‹¨ìœ„ SSE ê°€ëŠ¥                           â”‚
â”‚  - í”„ë¡ íŠ¸: ê·¸ëŒ€ë¡œ ë Œë”ë§ ê°€ëŠ¥                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.6 SSE ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì„¤ê³„

Vision ë¶„ë¥˜ í›„ ë‹µë³€ì„ **í† í° ë‹¨ìœ„ë¡œ ìŠ¤íŠ¸ë¦¬ë°**í•´ì•¼ í•©ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SSE ìŠ¤íŠ¸ë¦¬ë° í”Œë¡œìš°                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Vision Node                                                â”‚
â”‚  â””â”€ stage: "vision" (15% â†’ 25%)                            â”‚
â”‚       â””â”€ ë¶„ë¥˜ ê²°ê³¼ ë°œí–‰ (JSON, 1íšŒ)                          â”‚
â”‚                                                             â”‚
â”‚  Answer Node                                                â”‚
â”‚  â””â”€ stage: "answer" (75%)                                  â”‚
â”‚       â””â”€ token: "í˜" "íŠ¸" "ë³‘" "ì€" "..." (ìŠ¤íŠ¸ë¦¬ë°)          â”‚
â”‚                                                             â”‚
â”‚  Done                                                       â”‚
â”‚  â””â”€ stage: "done" (100%)                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ ê³ ë ¤ì‚¬í•­**:

| ì´ë²¤íŠ¸ íƒ€ì… | ë‚´ìš© | ìŠ¤íŠ¸ë¦¬ë° ì—¬ë¶€ |
|------------|------|-------------|
| `stage:vision` | ë¶„ë¥˜ ê²°ê³¼ (major/middle/minor) | âŒ 1íšŒ ë°œí–‰ |
| `stage:answer` | ë‹µë³€ ìƒì„± ì‹œì‘ | âŒ 1íšŒ ë°œí–‰ |
| `token` | ë‹µë³€ í† í° | âœ… í† í° ë‹¨ìœ„ |
| `stage:done` | ì™„ë£Œ | âŒ 1íšŒ ë°œí–‰ |

**LLM ìŠ¤íŠ¸ë¦¬ë° ì„¤ì •**:

```python
# answer_nodeì—ì„œ ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ
async for chunk in llm.stream(prompt):
    await event_publisher.notify_token(
        task_id=job_id,
        token=chunk.content,
    )
```

### 1.4 ì¬êµ¬ì„± ëª©í‘œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Clean Architecture ì¬êµ¬ì„± ëª©í‘œ             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Port/Adapter íŒ¨í„´ìœ¼ë¡œ LLM ì˜ì¡´ì„± ë¶„ë¦¬                    â”‚
â”‚  2. LangGraph ë…¸ë“œë¡œ íŒŒì´í”„ë¼ì¸ í†µí•©                         â”‚
â”‚  3. ì§„í–‰ ì´ë²¤íŠ¸(SSE) ë°œí–‰ ì¶”ê°€                               â”‚
â”‚  4. ê¸°ì¡´ í…ìŠ¤íŠ¸ í”Œë¡œìš° í˜¸í™˜ ìœ ì§€                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ì•„í‚¤í…ì²˜ ì„¤ê³„

### 2.1 íŒŒì´í”„ë¼ì¸ í”Œë¡œìš° ë³€ê²½

**Before (í…ìŠ¤íŠ¸ ì „ìš©)**:
```
START â†’ intent â†’ router â†’ [waste_rag/character/location/general] â†’ answer â†’ END
```

**After (Vision ì¶”ê°€)**:
```
START â†’ intent â†’ [vision?] â†’ router â†’ [waste_rag/...] â†’ answer â†’ END
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Vision ì¶”ê°€ í”Œë¡œìš°                             â”‚
â”‚                                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚  START  â”‚â”€â”€â”€â”€â”€â–¶â”‚  intent  â”‚â”€â”€â”€â”€â”€â–¶â”‚image_url?â”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                           â”‚                        â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                              â”‚                         â”‚          â”‚
â”‚                          ìˆìŒâ–¼                     ì—†ìŒâ–¼          â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                        â”‚  vision  â”‚            â”‚          â”‚       â”‚
â”‚                        â”‚ (ë¶„ë¥˜)   â”‚            â”‚          â”‚       â”‚
â”‚                        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚          â”‚       â”‚
â”‚                             â”‚                  â”‚          â”‚       â”‚
â”‚                             â–¼                  â–¼          â”‚       â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚       â”‚
â”‚                        â”‚        router           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                        â”‚   (intent ê¸°ë°˜ ë¶„ê¸°)     â”‚               â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                    â”‚                              â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚            â–¼           â–¼           â–¼           â–¼          â”‚       â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚       â”‚
â”‚       â”‚ waste  â”‚  â”‚  char  â”‚  â”‚  loc   â”‚  â”‚general â”‚      â”‚       â”‚
â”‚       â”‚  _rag  â”‚  â”‚ (gRPC) â”‚  â”‚ (gRPC) â”‚  â”‚(pass)  â”‚      â”‚       â”‚
â”‚       â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚       â”‚
â”‚           â”‚           â”‚           â”‚           â”‚           â”‚       â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚       â”‚
â”‚                           â”‚                               â”‚       â”‚
â”‚                      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                          â”‚       â”‚
â”‚                      â”‚ answer  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                  â”‚
â”‚                           â”‚                                       â”‚
â”‚                      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                                  â”‚
â”‚                      â”‚   END   â”‚                                  â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í”Œë¡œìš° ìš”ì•½:**
```
Vision í”Œë¡œìš°:  intent â†’ vision â†’ router â†’ waste_rag â†’ answer
í…ìŠ¤íŠ¸ í”Œë¡œìš°:  intent â†’ router â†’ [waste/char/loc/general] â†’ answer
```

**ì¡°ê±´ë¶€ ë¼ìš°íŒ… ë¡œì§**:
- `image_url` ì¡´ì¬ + `classification_result` ë¯¸ì¡´ì¬ â†’ Vision ë…¸ë“œ
- ê·¸ ì™¸ â†’ Routerë¡œ ì§í–‰

### 2.3 ì„¤ê³„ ê²°ì •: Vision í›„ Intent ê¸°ë°˜ ë¶„ê¸° ìœ ì§€

**ë…¼ì˜ëœ ëŒ€ì•ˆ:**

| ì˜µì…˜ | ì„¤ëª… | ì¥ì  | ë‹¨ì  |
|------|------|------|------|
| **A. image_url â†’ waste_rag ì§í–‰** | ì´ë¯¸ì§€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ RAG | ë‹¨ìˆœ, 90%+ ì¼€ì´ìŠ¤ ìµœì í™” | ìœ ì—°ì„± ë¶€ì¡± |
| **B. Vision â†’ Router â†’ intent ë¶„ê¸°** âœ… | ì´ë¯¸ì§€ ìˆì–´ë„ intentì— ë”°ë¼ ë¶„ê¸° | ìœ ì—°ì„± í™•ë³´ | ì•½ê°„ ë³µì¡ |

**ì„ íƒ: Bì•ˆ (í˜„ì¬ ë°©ì‹ ìœ ì§€)**

**ì´ìœ :**
```
1. [ğŸ“· í˜íŠ¸ë³‘ ì‚¬ì§„] + "ì´ê±° ì–´ë–»ê²Œ ë²„ë ¤ìš”?"
   â†’ intent: waste â†’ waste_rag âœ… (90%+ ì¼€ì´ìŠ¤)

2. [ğŸ“· í˜íŠ¸ë³‘ ì‚¬ì§„] + "ì´ ê·¼ì²˜ ì¬í™œìš© ì„¼í„° ì–´ë”” ìˆì–´?"
   â†’ intent: location â†’ location_node
   â†’ classification_resultëŠ” stateì— ë‚¨ì•„ìˆìŒ (ë‚˜ì¤‘ì— í™œìš© ê°€ëŠ¥)

3. [ğŸ“· í˜íŠ¸ë³‘ ì‚¬ì§„] + "ì´ì½”ì•¼ ì•ˆë…•~"
   â†’ intent: character â†’ character_node
```

ì‚¬ìš©ìê°€ ì´ë¯¸ì§€ë¥¼ ë³´ë‚´ë©´ì„œ **ë‹¤ë¥¸ ì˜ë„ì˜ ì§ˆë¬¸**ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ í˜íŠ¸ë³‘ ì‚¬ì§„ì„ ë³´ë‚´ë©´ì„œ "ì´ ê·¼ì²˜ ì¬í™œìš© ì„¼í„° ì–´ë”” ìˆì–´?"ë¼ê³  ë¬¼ì„ ìˆ˜ ìˆì£ . 

ì´ ê²½ìš° Vision ë¶„ë¥˜ ê²°ê³¼(`classification_result`)ëŠ” stateì— ì €ì¥ë˜ì–´ ìˆê³ , ë‚˜ì¤‘ì— í•„ìš”í•˜ë©´ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Intent ê¸°ë°˜ ë¶„ê¸°ë¥¼ ìœ ì§€í•˜ë©´ **ë‹¤ì–‘í•œ ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤ì— ëŒ€ì‘** ê°€ëŠ¥í•©ë‹ˆë‹¤.

```python
# factory.py
def route_after_intent(state):
    if state.get("image_url") and not state.get("classification_result"):
        return "vision"
    return "router"  # intent ê¸°ë°˜ ë¶„ê¸°ë¡œ

# Vision í›„ì—ë„ routerë¥¼ ê±°ì³ intentì— ë”°ë¼ ë¶„ê¸°
graph.add_edge("vision", "router")
```

### 2.2 Clean Architecture ê³„ì¸µ ë¶„ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Vision ê³„ì¸µ êµ¬ì¡°                         â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Application Layer (Port)                 â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚   â”‚            VisionModelPort (ABC)            â”‚     â”‚  â”‚
â”‚  â”‚   â”‚                                             â”‚     â”‚  â”‚
â”‚  â”‚   â”‚   + analyze_image(image_url, user_input)    â”‚     â”‚  â”‚
â”‚  â”‚   â”‚     â†’ dict[classification, tags, conf]     â”‚     â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                              â”‚
â”‚                              â”‚ implements                   â”‚
â”‚                              â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            Infrastructure Layer (Adapters)            â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚  â”‚   â”‚ OpenAIVision    â”‚     â”‚ GeminiVision    â”‚         â”‚  â”‚
â”‚  â”‚   â”‚    Client       â”‚     â”‚    Client       â”‚         â”‚  â”‚
â”‚  â”‚   â”‚                 â”‚     â”‚                 â”‚         â”‚  â”‚
â”‚  â”‚   â”‚  - gpt-5.2      â”‚     â”‚  - gemini-3-    â”‚         â”‚  â”‚
â”‚  â”‚   â”‚  - detail: high â”‚     â”‚    flash-previewâ”‚         â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ ì›ì¹™**: Application LayerëŠ” êµ¬ì²´ì ì¸ LLM êµ¬í˜„ì„ ëª°ë¼ì•¼ í•©ë‹ˆë‹¤.

---

## 3. ì˜ì‚¬ê²°ì •

### 3.1 Vision ëª¨ë¸ ì„ íƒ: GPT-5.2 vs Gemini 3 Flash

| ë¹„êµ í•­ëª© | GPT-5.2 | Gemini 3 Flash Preview |
|----------|---------|------------------------|
| **ë¹„ìš©** | ~$0.002/ì´ë¯¸ì§€ (low) | ~$0.0001/ì´ë¯¸ì§€ |
| **ì†ë„** | ~1-2ì´ˆ | ~0.5-1ì´ˆ |
| **ì •í™•ë„** | ë§¤ìš° ë†’ìŒ | ë§¤ìš° ë†’ìŒ |
| **êµ¬ì¡°í™” ì¶œë ¥** | Structured Outputs | response_schema |
| **í•œêµ­ì–´** | ìš°ìˆ˜ | ìš°ìˆ˜ |
| **íŠ¹ì§•** | ë©€í‹°ëª¨ë‹¬ í†µí•© | ë©€í‹°ëª¨ë‹¬ í†µí•© |

> **ëª¨ë¸ êµ¬ì„±** (2026ë…„ 1ì›” ê¸°ì¤€):
> - OpenAI: `gpt-5.2` (í…ìŠ¤íŠ¸+ì´ë¯¸ì§€ í†µí•© ë©€í‹°ëª¨ë‹¬)
> - Google: `gemini-3-flash-preview` (í…ìŠ¤íŠ¸+ì´ë¯¸ì§€ í†µí•© ë©€í‹°ëª¨ë‹¬)
>
> GPT-5.2 ì‹œë¦¬ì¦ˆ: `gpt-5.2`, `gpt-5.2-pro`, `gpt-5.2-instant`, `gpt-5-mini`

**ê²°ì •**: ë‘˜ ë‹¤ ì§€ì›í•˜ë©° Factory Patternìœ¼ë¡œ ëŸ°íƒ€ì„ì— êµì²´ ê°€ëŠ¥

```python
# dependencies.py
def create_vision_client(
    provider: Literal["openai", "gemini"] = "openai",
) -> VisionModelPort:
    settings = get_settings()
    if provider == "gemini":
        return GeminiVisionClient(model=settings.gemini_default_model)
    return OpenAIVisionClient(model=settings.openai_default_model)
```

### 3.2 ì´ë¯¸ì§€ detail ë ˆë²¨: high vs low

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               GPT-5.2 Vision detail ë¹„êµ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  detail: high  âœ… ì„ íƒ                                      â”‚
â”‚  - ê³ í•´ìƒë„ íƒ€ì¼ ë¶„í•  ì²˜ë¦¬                                   â”‚
â”‚  - í† í°: ì´ë¯¸ì§€ í¬ê¸°ì— ë¹„ë¡€                                  â”‚
â”‚  - ë¹„ìš©: ë†’ìŒ                                               â”‚
â”‚  - ìš©ë„: ì„¸ë°€í•œ ë¶„ë¥˜, ë¼ë²¨/í…ìŠ¤íŠ¸ ì¸ì‹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  detail: low                                               â”‚
â”‚  - ì €í•´ìƒë„ ë‹¨ì¼ ì´ë¯¸ì§€                                     â”‚
â”‚  - í† í°: ìµœì†Œí™”                                             â”‚
â”‚  - ë¹„ìš©: ëŒ€í­ ì ˆê°                                          â”‚
â”‚  - ìš©ë„: ëŒ€ëµì  ë¶„ë¥˜ë§Œ í•„ìš”í•œ ê²½ìš°                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ê²°ì •**: `detail: high` â€” ì •í™•í•œ íê¸°ë¬¼ ë¶„ë¥˜ë¥¼ ìœ„í•´ ê³ í•´ìƒë„ í•„ìš”

**ì´ìœ :**
- íê¸°ë¬¼ ë¶„ë¥˜ ì‹œ **ë¼ë²¨, ì¬ì§ˆ í‘œì‹œ, ì„¸ë¶€ í˜•íƒœ** ì¸ì‹ í•„ìš”
- "PP" vs "PE" êµ¬ë¶„, ì¬í™œìš© ë§ˆí¬ ì¸ì‹ ë“± ë””í…Œì¼ ì¤‘ìš”
- ë¹„ìš©ë³´ë‹¤ **ë¶„ë¥˜ ì •í™•ë„ ìš°ì„ **

### 3.3 Vision ë…¸ë“œ ìœ„ì¹˜: Intent ì „ vs Intent í›„

| ì˜µì…˜ | Intent â†’ Vision | Intent â†’ Vision? |
|------|-----------------|------------------|
| **ì¥ì ** | ë‹¨ìˆœí•œ í”Œë¡œìš° | ë¶ˆí•„ìš”í•œ Vision í˜¸ì¶œ ë°©ì§€ |
| **ë‹¨ì ** | í•­ìƒ Vision í˜¸ì¶œ | ì¡°ê±´ë¶€ ë¼ìš°íŒ… ë³µì¡ë„ ì¦ê°€ |
| **ë¹„ìš©** | ë†’ìŒ | ë‚®ìŒ |

**ê²°ì •**: Intent í›„ ì¡°ê±´ë¶€ Vision í˜¸ì¶œ

```python
def route_after_intent(state: dict) -> str:
    if state.get("image_url") and not state.get("classification_result"):
        return "vision"
    return "router"
```

---

## 4. êµ¬í˜„ ìƒì„¸

### 4.1 VisionModelPort (Application Layer)

```python
# application/ports/vision/vision_model.py
class VisionModelPort(ABC):
    """Vision ëª¨ë¸ Port - ì´ë¯¸ì§€ ë¶„ë¥˜ ì¶”ìƒ ì¸í„°í˜ì´ìŠ¤."""

    @abstractmethod
    async def analyze_image(
        self,
        image_url: str,
        user_input: str | None = None,
    ) -> dict[str, Any]:
        """ì´ë¯¸ì§€ ë¶„ì„ â†’ ë¶„ë¥˜ ê²°ê³¼ ë°˜í™˜.

        Returns:
            {
                "classification": {
                    "major_category": "ì¬í™œìš©íê¸°ë¬¼",
                    "middle_category": "í”Œë¼ìŠ¤í‹±ë¥˜",
                    "minor_category": "í˜íŠ¸ë³‘",
                },
                "situation_tags": ["ì„¸ì²™í•„ìš”", "ë¼ë²¨ì œê±°í•„ìš”"],
                "confidence": 0.95,
            }
        """
        pass
```

### 4.2 OpenAI Vision Client (Infrastructure Layer)

```python
# infrastructure/llm/vision/openai_vision.py
class OpenAIVisionClient(VisionModelPort):
    """OpenAI GPT-5.2 Vision í´ë¼ì´ì–¸íŠ¸."""

    def __init__(self, model: str = "gpt-5.2", api_key: str | None = None):
        self._model = model
        self._client = OpenAI(api_key=api_key or os.environ.get("OPENAI_API_KEY"))
        self._prompt = self._load_prompt()

    async def analyze_image(self, image_url: str, user_input: str | None = None):
        response = self._client.beta.chat.completions.parse(
            model=self._model,
            messages=[
                {"role": "system", "content": self._prompt},
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": user_input or "ì´ íê¸°ë¬¼ì„ ë¶„ë¥˜í•´ì£¼ì„¸ìš”."},
                        {
                            "type": "image_url",
                            "image_url": {"url": image_url, "detail": "high"},
                        },
                    ],
                },
            ],
            response_format=VisionResult,  # Pydantic êµ¬ì¡°í™” ì¶œë ¥
        )
        return response.choices[0].message.parsed.model_dump()
```

### 4.3 Vision Node (Orchestration Layer)

```python
# infrastructure/orchestration/langgraph/nodes/vision_node.py
def create_vision_node(vision_model: VisionModelPort, event_publisher: ProgressNotifierPort):
    async def vision_node(state: dict) -> dict:
        job_id = state.get("job_id", "")
        image_url = state.get("image_url")

        # ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        if not image_url:
            return state

        # 1. ì§„í–‰ ì´ë²¤íŠ¸ ë°œí–‰
        await event_publisher.notify_stage(
            task_id=job_id,
            stage="vision",
            status="processing",
            progress=15,
            message="ğŸ” ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...",
        )

        try:
            # 2. Vision ëª¨ë¸ í˜¸ì¶œ
            result = await vision_model.analyze_image(image_url, state.get("message"))

            # 3. ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰
            major_category = result.get("classification", {}).get("major_category", "unknown")
            await event_publisher.notify_stage(
                task_id=job_id,
                stage="vision",
                status="completed",
                progress=25,
                result={"major_category": major_category},
                message=f"âœ… ë¶„ë¥˜ ì™„ë£Œ: {major_category}",
            )

            # 4. state ì—…ë°ì´íŠ¸
            return {**state, "classification_result": result, "has_image": True}

        except Exception as e:
            await event_publisher.notify_stage(
                task_id=job_id, stage="vision", status="failed", message="âš ï¸ ì´ë¯¸ì§€ ë¶„ì„ ì‹¤íŒ¨"
            )
            return {**state, "classification_result": None, "has_image": True, "vision_error": str(e)}

    return vision_node
```

### 4.4 Factory ìˆ˜ì •

```python
# infrastructure/orchestration/langgraph/factory.py
def create_chat_graph(
    llm: LLMClientPort,
    retriever: RetrieverPort,
    event_publisher: ProgressNotifierPort,
    vision_model: VisionModelPort | None = None,  # ì¶”ê°€
    ...
) -> StateGraph:
    # Vision ë…¸ë“œ ìƒì„±
    if vision_model:
        vision_node = create_vision_node(vision_model, event_publisher)
    else:
        async def vision_node(state): return state  # passthrough

    graph = StateGraph(dict)

    # ë…¸ë“œ ë“±ë¡
    graph.add_node("intent", intent_node)
    graph.add_node("vision", vision_node)
    graph.add_node("router", router_node)
    ...

    # ì¡°ê±´ë¶€ ì—£ì§€
    graph.add_conditional_edges("intent", route_after_intent, {
        "vision": "vision",
        "router": "router",
    })
    graph.add_edge("vision", "router")
```

---

## 5. ë°ì´í„° íë¦„

### 5.1 ì´ë¯¸ì§€ ìš”ì²­ ì²˜ë¦¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì´ë¯¸ì§€ í¬í•¨ ìš”ì²­ ë°ì´í„° íë¦„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /chat                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚   Chat API   â”‚
â”‚              â”‚     {                              â”‚              â”‚
â”‚  ğŸ“· + "ì´ê±°   â”‚       session_id: "abc",          â”‚              â”‚
â”‚   ì–´ë–»ê²Œ     â”‚       message: "ì´ê±° ì–´ë–»ê²Œ ë²„ë ¤ìš”?", â”‚              â”‚
â”‚   ë²„ë ¤ìš”?"   â”‚       image_url: "https://..."     â”‚              â”‚
â”‚              â”‚     }                              â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          â”‚
                                                          â”‚ RabbitMQ
                                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Chat Worker                                 â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    LangGraph Pipeline                        â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â”‚  State: {                                                   â”‚    â”‚
â”‚  â”‚    job_id: "xyz",                                           â”‚    â”‚
â”‚  â”‚    message: "ì´ê±° ì–´ë–»ê²Œ ë²„ë ¤ìš”?",                            â”‚    â”‚
â”‚  â”‚    image_url: "https://...",     â—€â”€â”€ Frontendì—ì„œ ì „ë‹¬       â”‚    â”‚
â”‚  â”‚  }                                                          â”‚    â”‚
â”‚  â”‚           â”‚                                                 â”‚    â”‚
â”‚  â”‚           â–¼                                                 â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚    â”‚
â”‚  â”‚  â”‚   Intent    â”‚  â†’ intent: "waste"                         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚    â”‚
â”‚  â”‚         â”‚                                                   â”‚    â”‚
â”‚  â”‚         â”‚  image_url ì¡´ì¬ â†’ vision ë¶„ê¸°                      â”‚    â”‚
â”‚  â”‚         â–¼                                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚    â”‚
â”‚  â”‚  â”‚   Vision    â”‚  â†’ GPT-5.2 / Gemini Vision í˜¸ì¶œ            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚    â”‚
â”‚  â”‚         â”‚                                                   â”‚    â”‚
â”‚  â”‚  State ì—…ë°ì´íŠ¸:                                              â”‚    â”‚
â”‚  â”‚  {                                                          â”‚    â”‚
â”‚  â”‚    ...                                                      â”‚    â”‚
â”‚  â”‚    classification_result: {        â—€â”€â”€ Vision ê²°ê³¼ ì €ì¥      â”‚    â”‚
â”‚  â”‚      classification: {                                      â”‚    â”‚
â”‚  â”‚        major_category: "ì¬í™œìš©íê¸°ë¬¼",                        â”‚    â”‚
â”‚  â”‚        middle_category: "í”Œë¼ìŠ¤í‹±ë¥˜",                         â”‚    â”‚
â”‚  â”‚        minor_category: "í˜íŠ¸ë³‘",                             â”‚    â”‚
â”‚  â”‚      },                                                     â”‚    â”‚
â”‚  â”‚      situation_tags: ["ì„¸ì²™í•„ìš”"],                            â”‚    â”‚
â”‚  â”‚      confidence: 0.95,                                      â”‚    â”‚
â”‚  â”‚    },                                                       â”‚    â”‚
â”‚  â”‚    has_image: true,                                         â”‚    â”‚
â”‚  â”‚  }                                                          â”‚    â”‚
â”‚  â”‚         â”‚                                                   â”‚    â”‚
â”‚  â”‚         â–¼                                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚    â”‚
â”‚  â”‚  â”‚  waste_rag  â”‚  â†’ classification_resultë¡œ ê·œì • ê²€ìƒ‰        â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                            â”‚    â”‚
â”‚  â”‚         â”‚                                                   â”‚    â”‚
â”‚  â”‚         â–¼                                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚    â”‚
â”‚  â”‚  â”‚   Answer    â”‚  â†’ ë¶„ë¥˜ ê²°ê³¼ + ê·œì •ìœ¼ë¡œ ë‹µë³€ ìƒì„±            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚    â”‚
â”‚  â”‚                                                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 SSE ì´ë²¤íŠ¸ ì‹œí€€ìŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Vision í¬í•¨ SSE ì´ë²¤íŠ¸ ì‹œí€€ìŠ¤                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 Frontend                    Chat Worker                   SSE Gateway
    â”‚                            â”‚                              â”‚
    â”‚  POST /chat (with image)   â”‚                              â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
    â”‚                            â”‚                              â”‚
    â”‚  { job_id, stream_url }    â”‚                              â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
    â”‚                            â”‚                              â”‚
    â”‚  GET /events (SSE)         â”‚                              â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  stage: "queued"  (0%)       â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  stage: "intent"  (10%)      â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  stage: "vision"  (15%)      â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚   ğŸ” ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...       â”‚                              â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  (Vision API í˜¸ì¶œ ~2ì´ˆ)       â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  stage: "vision"  (25%)      â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚   âœ… ë¶„ë¥˜ ì™„ë£Œ: ì¬í™œìš©íê¸°ë¬¼  â”‚                              â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  stage: "waste_rag" (50%)    â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  stage: "answer"   (75%)     â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  token: "í˜" "íŠ¸" "ë³‘" ...    â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                            â”‚                              â”‚
    â”‚                            â”‚  stage: "done"    (100%)     â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                            â”‚                              â”‚
```

---

## 6. ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
apps/chat_worker/
â”œâ”€â”€ application/
â”‚   â””â”€â”€ ports/
â”‚       â””â”€â”€ vision/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ vision_model.py        # VisionModelPort (ABC)
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â””â”€â”€ llm/
â”‚       â”œâ”€â”€ clients/                   # ê¸°ì¡´ LLM í´ë¼ì´ì–¸íŠ¸
â”‚       â””â”€â”€ vision/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â”œâ”€â”€ openai_vision.py       # OpenAIVisionClient
â”‚           â””â”€â”€ gemini_vision.py       # GeminiVisionClient
â”‚
â””â”€â”€ infrastructure/
    â””â”€â”€ orchestration/
        â””â”€â”€ langgraph/
            â”œâ”€â”€ factory.py             # vision_model íŒŒë¼ë¯¸í„° ì¶”ê°€
            â””â”€â”€ nodes/
                â””â”€â”€ vision_node.py     # VisionNode êµ¬í˜„
```

---

## 7. í…ŒìŠ¤íŠ¸ ì „ëµ

### 7.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Mock Vision)

```python
class MockVisionModel(VisionModelPort):
    async def analyze_image(self, image_url, user_input=None):
        return {
            "classification": {
                "major_category": "ì¬í™œìš©íê¸°ë¬¼",
                "middle_category": "í”Œë¼ìŠ¤í‹±ë¥˜",
                "minor_category": "í˜íŠ¸ë³‘",
            },
            "situation_tags": ["ì„¸ì²™í•„ìš”"],
            "confidence": 0.95,
        }

async def test_vision_node_with_image():
    node = create_vision_node(MockVisionModel(), MockNotifier())
    state = {"job_id": "test", "image_url": "https://example.com/pet.jpg"}

    result = await node(state)

    assert result["classification_result"] is not None
    assert result["has_image"] is True
```

### 7.2 í†µí•© í…ŒìŠ¤íŠ¸ (Vision â†’ RAG í”Œë¡œìš°)

```python
async def test_vision_to_rag_flow():
    # Vision ë¶„ì„
    state = await vision_node({"image_url": "https://...", "message": "ì´ê±° ë­ì•¼?"})

    # RAG ê²€ìƒ‰ (Vision ê²°ê³¼ í™œìš©)
    state = await rag_node(state)

    # ë¶„ë¥˜ ê²°ê³¼ë¡œ ê·œì • ê²€ìƒ‰í–ˆëŠ”ì§€ í™•ì¸
    assert retriever.search_called
    assert state["disposal_rules"] is not None
```

---

## 8. ì„±ëŠ¥ ìµœì í™”

### 8.1 ì´ë¯¸ì§€ ì²˜ë¦¬ ìµœì í™”

| ìµœì í™” í•­ëª© | ì ìš© ë°©ë²• | íš¨ê³¼ |
|------------|----------|------|
| **detail: high** | OpenAI íŒŒë¼ë¯¸í„° | ì •í™•ë„ í–¥ìƒ |
| **ì´ë¯¸ì§€ ìºì‹±** | ë™ì¼ ì´ë¯¸ì§€ ì¬ë¶„ë¥˜ ë°©ì§€ | API í˜¸ì¶œ ì ˆê° |
| **ë³‘ë ¬ ì²˜ë¦¬** | Intentì™€ Vision ë™ì‹œ ì‹¤í–‰ (í–¥í›„) | ì§€ì—° ì‹œê°„ ë‹¨ì¶• |

### 8.2 ë¹„ìš© ì˜ˆì¸¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Vision ë¹„ìš© ì˜ˆì¸¡ (ì›”ê°„)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ê°€ì •:                                                     â”‚
â”‚  - ì¼ 1,000ê±´ ì´ë¯¸ì§€ ìš”ì²­                                   â”‚
â”‚  - ì›” 30,000ê±´                                             â”‚
â”‚                                                            â”‚
â”‚  GPT-5.2 (detail: high):                                   â”‚
â”‚  - ë©€í‹°ëª¨ë‹¬ í†µí•© ëª¨ë¸ (í…ìŠ¤íŠ¸+ì´ë¯¸ì§€)                        â”‚
â”‚  - ì¶œë ¥: ~100 í† í°                                          â”‚
â”‚  - ì›”: ~$10-20                                             â”‚
â”‚                                                            â”‚
â”‚  Gemini 3 Flash Preview:                                   â”‚
â”‚  - ë©€í‹°ëª¨ë‹¬ í†µí•© ëª¨ë¸                                       â”‚
â”‚  - ë¬´ë£Œ í‹°ì–´: ì¶©ë¶„í•œ ì¼ì¼ í•œë„                               â”‚
â”‚  - ì›”: ~$2-5                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **ì°¸ê³ **: ê°€ê²©ì€ 2026ë…„ 1ì›” ê¸°ì¤€ì´ë©° ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## 9. í–¥í›„ í™•ì¥

### 9.1 ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì›

```python
# í˜„ì¬: ë‹¨ì¼ ì´ë¯¸ì§€
image_url: str | None

# í–¥í›„: ë‹¤ì¤‘ ì´ë¯¸ì§€
image_urls: list[str] | None
```

### 9.2 ì´ë¯¸ì§€ ë¶„ë¥˜ ìºì‹±

ë™ì¼ ì´ë¯¸ì§€(í•´ì‹œ ê¸°ì¤€)ì— ëŒ€í•œ ë¶„ë¥˜ ê²°ê³¼ë¥¼ ìºì‹±í•©ë‹ˆë‹¤:

```python
class VisionCache:
    async def get_or_analyze(self, image_url: str) -> dict:
        cache_key = f"vision:{hashlib.sha256(image_url).hexdigest()[:16]}"
        cached = await redis.get(cache_key)
        if cached:
            return json.loads(cached)

        result = await vision_model.analyze_image(image_url)
        await redis.setex(cache_key, 3600, json.dumps(result))
        return result
```

---

## 10. ìš”ì•½

| í•­ëª© | ê²°ì • | ì´ìœ  |
|------|------|------|
| **Vision ìœ„ì¹˜** | Intent í›„ ì¡°ê±´ë¶€ | ë¶ˆí•„ìš”í•œ í˜¸ì¶œ ë°©ì§€ |
| **ê¸°ë³¸ ëª¨ë¸** | GPT-5.2 (high) | ì •í™•ë„ ìš°ì„  |
| **detail ë ˆë²¨** | high | ì •í™•í•œ ë¶„ë¥˜ë¥¼ ìœ„í•´ ê³ í•´ìƒë„ |
| **ê²°ê³¼ ì €ì¥** | state.classification_result | RAG ë…¸ë“œ í™œìš© |
| **ì´ë²¤íŠ¸ ë°œí–‰** | vision stage (15%â†’25%) | ì‹¤ì‹œê°„ ì§„í–‰ í‘œì‹œ |

---

## ì»¤ë°‹ ì •ë³´

**Commit**: `da24a5dbfa0e4eb3c4d76f4e0f2c5e9e7a8b1c3d`

```
feat(chat-worker): add Vision processing support

- Add VisionModelPort (application/ports/vision)
- Add OpenAIVisionClient, GeminiVisionClient (infrastructure/llm/vision)
- Add VisionNode for image classification (orchestration/langgraph/nodes)
- Update factory.py: intent â†’ [vision?] â†’ router flow
- Update dependencies.py: create_vision_client factory

Flow:
1. Intent node processes message
2. If image_url exists, Vision node analyzes image
3. classification_result stored in state
4. RAG/Answer nodes use classification result
```

**Changed Files (10)**

ì£¼ìš” íŒŒì¼:
- `application/ports/vision/vision_model.py` â€” VisionModelPort (ABC)
- `infrastructure/llm/vision/openai_vision.py` â€” OpenAI GPT-5.2 í´ë¼ì´ì–¸íŠ¸
- `infrastructure/llm/vision/gemini_vision.py` â€” Gemini Vision í´ë¼ì´ì–¸íŠ¸
- `infrastructure/orchestration/langgraph/nodes/vision_node.py` â€” Vision ë…¸ë“œ
- `infrastructure/orchestration/langgraph/factory.py` â€” ê·¸ë˜í”„ í”Œë¡œìš° ìˆ˜ì •
- `setup/dependencies.py` â€” create_vision_client íŒ©í† ë¦¬ ì¶”ê°€
