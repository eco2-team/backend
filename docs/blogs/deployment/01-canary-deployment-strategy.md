# ë°°í¬ ì „ëµ ì„ íƒ: ì™œ Canary ë°°í¬ë¥¼ ì„ íƒí–ˆëŠ”ê°€

> 2024-12-30 | ë¦¬íŒ©í† ë§ì„ ì•ë‘ê³  ì•ˆì „í•œ ë°°í¬ ì „ëµ ìˆ˜ë¦½

## TL;DR

- **ë¬¸ì œ**: ëŒ€ê·œëª¨ Clean Architecture ë¦¬íŒ©í† ë§ì„ ì•ˆì „í•˜ê²Œ ë°°í¬í•´ì•¼ í•¨
- **ì„ íƒì§€**: Rolling Update, Blue-Green, Canary
- **ê²°ì •**: Canary ë°°í¬ (í—¤ë” ê¸°ë°˜)
- **ì´ìœ **: ê¸°ì¡´ Istio ì¸í”„ë¼ í™œìš©, ë¹„ìš© íš¨ìœ¨ì„±, ì ì§„ì  ê²€ì¦ ê°€ëŠ¥

---

## 1. ë°°ê²½

### 1.1 í˜„ì¬ ìƒí™©

ë„ë©”ì¸ ì„œë¹„ìŠ¤ë“¤ì˜ **Clean Architecture ë¦¬íŒ©í† ë§**ì„ ì•ë‘ê³  ìˆë‹¤. Auth ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘ìœ¼ë¡œ ëª¨ë“  ë„ë©”ì¸ ì„œë¹„ìŠ¤ì— ë‹¤ìŒ ë³€ê²½ì´ ì˜ˆì •ë˜ì–´ ìˆë‹¤:

- ë””ë ‰í† ë¦¬ êµ¬ì¡° ì „ë©´ ê°œí¸ (`models/` â†’ `domain/entities/`, `services/` â†’ `application/commands/` ë“±)
- CQRS íŒ¨í„´ ë„ì… (Command/Query ë¶„ë¦¬)
- Repository ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€ (DIP ì ìš©)
- ì˜ì¡´ì„± ì£¼ì… ê°œì„ 

ì´ëŠ” ë‹¨ìˆœí•œ ë²„ê·¸ í”½ìŠ¤ê°€ ì•„ë‹ˆë¼ **ì½”ë“œë² ì´ìŠ¤ì˜ ê·¼ë³¸ì ì¸ ë³€ê²½**ì´ë‹¤. í”„ë¡œë•ì…˜ì— ì§ì ‘ ë°°í¬í•˜ê¸°ì—” ìœ„í—˜ì´ í¬ë‹¤.

### 1.2 ìš”êµ¬ì‚¬í•­

| ìš”êµ¬ì‚¬í•­ | ì„¤ëª… | ìš°ì„ ìˆœìœ„ |
|---------|------|:--------:|
| **ì ì§„ì  ê²€ì¦** | ì „ì²´ íŠ¸ë˜í”½ì— ì˜í–¥ ì—†ì´ ìƒˆ ë²„ì „ í…ŒìŠ¤íŠ¸ | ğŸ”´ í•„ìˆ˜ |
| **ë¹ ë¥¸ ë¡¤ë°±** | ë¬¸ì œ ë°œìƒ ì‹œ ì¦‰ì‹œ ë³µêµ¬ (< 1ë¶„) | ğŸ”´ í•„ìˆ˜ |
| **ë¹„ìš© íš¨ìœ¨ì„±** | ì¶”ê°€ ì¸í”„ë¼ ë¹„ìš© ìµœì†Œí™” | ğŸŸ¡ ì¤‘ìš” |
| **ê°œë°œì ì¹œí™”ì„±** | ì‰¬ìš´ í…ŒìŠ¤íŠ¸ í™˜ê²½ | ğŸŸ¢ ê¶Œì¥ |
| **ìë™í™” ê°€ëŠ¥ì„±** | CI/CD íŒŒì´í”„ë¼ì¸ í†µí•© | ğŸŸ¢ ê¶Œì¥ |

### 1.3 í˜„ì¬ ì¸í”„ë¼ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AWS EKS Cluster                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  auth node   â”‚  â”‚character nodeâ”‚  â”‚  scan node   â”‚  ...      â”‚
â”‚  â”‚  (2 CPU,4GB) â”‚  â”‚  (2 CPU,4GB) â”‚  â”‚  (2 CPU,4GB) â”‚           â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚           â”‚
â”‚  â”‚ - auth-api   â”‚  â”‚-character-apiâ”‚  â”‚ - scan-api   â”‚           â”‚
â”‚  â”‚ - ext-authz  â”‚  â”‚-character-   â”‚  â”‚ - scan-workerâ”‚           â”‚
â”‚  â”‚ - auth-relay â”‚  â”‚  worker      â”‚  â”‚              â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Istio Service Mesh                       â”‚ â”‚
â”‚  â”‚  - Gateway (ì™¸ë¶€ íŠ¸ë˜í”½ ì§„ì…ì )                              â”‚ â”‚
â”‚  â”‚  - VirtualService (ë¼ìš°íŒ… ê·œì¹™)                              â”‚ â”‚
â”‚  â”‚  - DestinationRule (íŠ¸ë˜í”½ ì •ì±…)                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    ArgoCD (GitOps)                          â”‚ â”‚
â”‚  â”‚  - ApplicationSetìœ¼ë¡œ ë„ë©”ì¸ë³„ ìë™ ë°°í¬                      â”‚ â”‚
â”‚  â”‚  - Kustomize ì˜¤ë²„ë ˆì´ (dev/prod)                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•µì‹¬ ì œì•½ì‚¬í•­:**
- ê° ë…¸ë“œëŠ” **2 CPU, ~4GB ë©”ëª¨ë¦¬**ë¡œ ì œí•œ
- ë„ë©”ì¸ë³„ ì „ìš© ë…¸ë“œë¡œ **Taint/Toleration** ì„¤ì •
- **ì¶”ê°€ ë…¸ë“œ í”„ë¡œë¹„ì €ë‹ ë¹„ìš©** ë¶€ë‹´

---

## 2. ë°°í¬ ì „ëµ ë¹„êµ

### 2.1 Rolling Update (ë¡¤ë§ ì—…ë°ì´íŠ¸)

Kubernetesì˜ ê¸°ë³¸ ë°°í¬ ì „ëµì´ë‹¤. Podë¥¼ í•˜ë‚˜ì”© ìˆœì°¨ì ìœ¼ë¡œ êµì²´í•œë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Rolling Update                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ì‹œê°„ â†’                                                          â”‚
â”‚                                                                  â”‚
â”‚  T0:  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                                   â”‚
â”‚       â”‚v1 â”‚ â”‚v1 â”‚ â”‚v1 â”‚ â”‚v1 â”‚  â† ëª¨ë‘ v1                        â”‚
â”‚       â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                                   â”‚
â”‚         â”‚                                                        â”‚
â”‚  T1:  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                                   â”‚
â”‚       â”‚v2 â”‚ â”‚v1 â”‚ â”‚v1 â”‚ â”‚v1 â”‚  â† ì²« ë²ˆì§¸ êµì²´ (v1+v2 í˜¼ì¬)      â”‚
â”‚       â””â”€â”¬â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                                   â”‚
â”‚         â”‚                                                        â”‚
â”‚  T2:  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                                   â”‚
â”‚       â”‚v2 â”‚ â”‚v2 â”‚ â”‚v1 â”‚ â”‚v1 â”‚  â† ë‘ ë²ˆì§¸ êµì²´                   â”‚
â”‚       â””â”€â”€â”€â”˜ â””â”€â”¬â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                                   â”‚
â”‚               â”‚                                                  â”‚
â”‚  ...          â–¼                                                  â”‚
â”‚                                                                  â”‚
â”‚  Tn:  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                                   â”‚
â”‚       â”‚v2 â”‚ â”‚v2 â”‚ â”‚v2 â”‚ â”‚v2 â”‚  â† ëª¨ë‘ v2                        â”‚
â”‚       â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ë™ì‘ ë°©ì‹

```yaml
# Kubernetes Deployment ê¸°ë³¸ ì„¤ì •
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # ëª©í‘œ replica ëŒ€ë¹„ ì´ˆê³¼ í—ˆìš© Pod ìˆ˜
      maxUnavailable: 0  # ìµœì†Œ ê°€ìš© Pod ë³´ì¥
```

#### ì¥ì 

| ì¥ì  | ì„¤ëª… |
|------|------|
| **Zero Config** | Kubernetes ê¸°ë³¸ ì „ëµ, ë³„ë„ ì„¤ì • ë¶ˆí•„ìš” |
| **ë¦¬ì†ŒìŠ¤ íš¨ìœ¨** | ì¶”ê°€ ë¦¬ì†ŒìŠ¤ ìµœì†Œí™” (`maxSurge: 1`ì´ë©´ 1ê°œë§Œ ì¶”ê°€) |
| **ìë™í™”** | `kubectl rollout` ëª…ë ¹ìœ¼ë¡œ ìƒíƒœ í™•ì¸/ë¡¤ë°± |

#### ë‹¨ì 

| ë‹¨ì  | ì‹¬ê°ë„ | ì„¤ëª… |
|------|:------:|------|
| **ë²„ì „ í˜¼ì¬** | ğŸ”´ | ë°°í¬ ì¤‘ v1/v2ê°€ ë™ì‹œì— ì„œë¹„ìŠ¤ â†’ API í˜¸í™˜ì„± ë¬¸ì œ |
| **ì˜í–¥ ë²”ìœ„** | ğŸ”´ | ì²« Pod êµì²´ ì‹œì ë¶€í„° ì‹¤ì œ ì‚¬ìš©ì ì˜í–¥ |
| **ê²€ì¦ ë¶ˆê°€** | ğŸŸ¡ | íŠ¹ì • ë²„ì „ë§Œ ì„ íƒì  í…ŒìŠ¤íŠ¸ ë¶ˆê°€ëŠ¥ |
| **ëŠë¦° ë¡¤ë°±** | ğŸŸ¡ | ë¡¤ë°±ë„ ë¡¤ë§ ë°©ì‹ (ì „ì²´ ë³µêµ¬ì— ì‹œê°„ ì†Œìš”) |

#### ë¦¬íŒ©í† ë§ì— ë¶€ì í•©í•œ ì´ìœ 

Clean Architecture ë¦¬íŒ©í† ë§ì€ ë‚´ë¶€ êµ¬ì¡°ê°€ ì™„ì „íˆ ë°”ë€Œì§€ë§Œ APIëŠ” ë™ì¼í•´ì•¼ í•œë‹¤. ë§Œì•½ ë¦¬íŒ©í† ë§ ê³¼ì •ì—ì„œ **ì˜ë„ì¹˜ ì•Šì€ ë™ì‘ ë³€ê²½**ì´ ë°œìƒí•˜ë©´:

1. Rolling Update ì‹œì‘ â†’ ì²« v2 Pod ìƒì„±
2. v2 Podê°€ íŠ¸ë˜í”½ ìˆ˜ì‹  ì‹œì‘ (ì´ë¯¸ ì¼ë¶€ ì‚¬ìš©ì ì˜í–¥)
3. ì—ëŸ¬ ë°œê²¬ â†’ ë¡¤ë°± ì‹œì‘
4. ë¡¤ë°±ë„ ë¡¤ë§ ë°©ì‹ìœ¼ë¡œ ì§„í–‰ â†’ ë³µêµ¬ì— ìˆ˜ ë¶„ ì†Œìš”

**ê²°ë¡ : ë¦¬íŒ©í† ë§ ê°™ì€ ëŒ€ê·œëª¨ ë³€ê²½ì—ëŠ” ë¶€ì í•©**

---

### 2.2 Blue-Green Deployment (ë¸”ë£¨-ê·¸ë¦° ë°°í¬)

ë‘ ê°œì˜ ë™ì¼í•œ í™˜ê²½ì„ ìœ ì§€í•˜ê³ , ë¼ìš°í„° ì „í™˜ìœ¼ë¡œ ì¦‰ì‹œ ë°°í¬í•œë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Blue-Green Deployment                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚           â”‚            Load Balancer            â”‚               â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                             â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚              â”‚                             â”‚                     â”‚
â”‚              â–¼                             â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚    Blue (Active)    â”‚     â”‚   Green (Standby)   â”‚            â”‚
â”‚  â”‚                     â”‚     â”‚                     â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”‚     â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”‚            â”‚
â”‚  â”‚  â”‚v1 â”‚ â”‚v1 â”‚ â”‚v1 â”‚ â”‚     â”‚  â”‚v2 â”‚ â”‚v2 â”‚ â”‚v2 â”‚ â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚     â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚            â”‚
â”‚  â”‚                     â”‚     â”‚                     â”‚            â”‚
â”‚  â”‚  â† 100% íŠ¸ë˜í”½      â”‚     â”‚  â† 0% (ëŒ€ê¸°)        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                     ì „í™˜ í›„ (Switch)                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Blue (Standby)    â”‚     â”‚   Green (Active)    â”‚            â”‚
â”‚  â”‚                     â”‚     â”‚                     â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”‚     â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”‚            â”‚
â”‚  â”‚  â”‚v1 â”‚ â”‚v1 â”‚ â”‚v1 â”‚ â”‚     â”‚  â”‚v2 â”‚ â”‚v2 â”‚ â”‚v2 â”‚ â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚     â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚            â”‚
â”‚  â”‚                     â”‚     â”‚                     â”‚            â”‚
â”‚  â”‚  â† 0% (ë¡¤ë°± ëŒ€ê¸°)   â”‚     â”‚  â† 100% íŠ¸ë˜í”½      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ë™ì‘ ë°©ì‹

```yaml
# Serviceë¥¼ selector ë³€ê²½ìœ¼ë¡œ ì „í™˜
# ì „í™˜ ì „
spec:
  selector:
    app: my-app
    version: blue  # v1

# ì „í™˜ í›„
spec:
  selector:
    app: my-app
    version: green  # v2
```

ë˜ëŠ” Istio VirtualService weight ì¡°ì •:

```yaml
http:
- route:
  - destination:
      host: my-app
      subset: blue
    weight: 0     # ì „í™˜ í›„
  - destination:
      host: my-app
      subset: green
    weight: 100   # ì „í™˜ í›„
```

#### ì¥ì 

| ì¥ì  | ì„¤ëª… |
|------|------|
| **ì¦‰ì‹œ ì „í™˜** | ë¼ìš°í„° ë³€ê²½ í•œ ë²ˆìœ¼ë¡œ ì™„ë£Œ (< 1ì´ˆ) |
| **ì¦‰ì‹œ ë¡¤ë°±** | ë¬¸ì œ ì‹œ ë‹¤ì‹œ Blueë¡œ ì „í™˜ (< 1ì´ˆ) |
| **ì™„ì „í•œ ê²©ë¦¬** | í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ í”„ë¡œë•ì…˜ê³¼ ë™ì¼ |
| **ì¼ê´€ì„±** | í•­ìƒ ë‹¨ì¼ ë²„ì „ë§Œ ì„œë¹„ìŠ¤ |

#### ë‹¨ì 

| ë‹¨ì  | ì‹¬ê°ë„ | ì„¤ëª… |
|------|:------:|------|
| **2ë°° ë¦¬ì†ŒìŠ¤** | ğŸ”´ | Blue + Green ëª¨ë‘ í”„ë¡œë¹„ì €ë‹ í•„ìš” |
| **ìœ íœ´ ë¹„ìš©** | ğŸ”´ | Standby í™˜ê²½ì´ í•­ìƒ ëŒ€ê¸° ìƒíƒœ |
| **DB ìŠ¤í‚¤ë§ˆ** | ğŸŸ¡ | ì–‘ìª½ í™˜ê²½ì´ ë™ì¼ DB ì‚¬ìš© ì‹œ ìŠ¤í‚¤ë§ˆ ë³€ê²½ ë³µì¡ |
| **ìƒíƒœ ë™ê¸°í™”** | ğŸŸ¡ | ì„¸ì…˜, ìºì‹œ ë“± ìƒíƒœ ê´€ë¦¬ í•„ìš” |

#### ë¹„ìš© ë¶„ì„

í˜„ì¬ ì¸í”„ë¼ ê¸°ì¤€ Blue-Green ì ìš© ì‹œ:

```
í˜„ì¬ ë¹„ìš© (Stableë§Œ):
  - auth ë…¸ë“œ: $X/ì›”
  - character ë…¸ë“œ: $X/ì›”
  - scan ë…¸ë“œ: $X/ì›”
  - ... (ì´ Nê°œ ë…¸ë“œ)
  = $NX/ì›”

Blue-Green ì ìš© ì‹œ:
  - Blue í™˜ê²½: $NX/ì›”
  - Green í™˜ê²½: $NX/ì›”
  = $2NX/ì›” (100% ì¦ê°€)
```

**ìš°ë¦¬ í™˜ê²½ì—ì„œëŠ” ë¹„ìš©ì´ 2ë°°ê°€ ë˜ë¯€ë¡œ í˜„ì‹¤ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥.**

---

### 2.3 Canary Deployment (ì¹´ë‚˜ë¦¬ ë°°í¬)

ì†Œìˆ˜ì˜ "ì¹´ë‚˜ë¦¬" Podë¡œ ìƒˆ ë²„ì „ì„ ë¨¼ì € ê²€ì¦í•˜ê³ , ë¬¸ì œ ì—†ìœ¼ë©´ ì ì§„ì ìœ¼ë¡œ í™•ëŒ€í•œë‹¤.

> ì´ë¦„ì˜ ìœ ë˜: ê´‘ì‚°ì—ì„œ ìœ ë… ê°€ìŠ¤ ê°ì§€ë¥¼ ìœ„í•´ ì¹´ë‚˜ë¦¬ì•„ ìƒˆë¥¼ ì‚¬ìš©í•œ ê²ƒì—ì„œ ìœ ë˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Canary Deployment                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚           â”‚         Istio VirtualService        â”‚               â”‚
â”‚           â”‚   (Header-based / Weight-based)     â”‚               â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                             â”‚                                    â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚            â”‚                                 â”‚                   â”‚
â”‚            â–¼                                 â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚    Stable (v1)        â”‚     â”‚    Canary (v2)        â”‚        â”‚
â”‚  â”‚                       â”‚     â”‚                       â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â”‚     â”‚       â”Œâ”€â”€â”€â”          â”‚        â”‚
â”‚  â”‚  â”‚v1 â”‚ â”‚v1 â”‚ â”‚v1 â”‚   â”‚     â”‚       â”‚v2 â”‚          â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â”‚     â”‚       â””â”€â”€â”€â”˜          â”‚        â”‚
â”‚  â”‚                       â”‚     â”‚                       â”‚        â”‚
â”‚  â”‚  ì¼ë°˜ íŠ¸ë˜í”½ (95%)    â”‚     â”‚  í…ŒìŠ¤íŠ¸ íŠ¸ë˜í”½ (5%)   â”‚        â”‚
â”‚  â”‚  ë˜ëŠ”                 â”‚     â”‚  ë˜ëŠ”                 â”‚        â”‚
â”‚  â”‚  X-Canary í—¤ë” ì—†ìŒ   â”‚     â”‚  X-Canary: true       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                    ì ì§„ì  í™•ëŒ€ ë‹¨ê³„                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                  â”‚
â”‚  Phase 1: í—¤ë” ê¸°ë°˜ (ê°œë°œìë§Œ)     0% weight, í—¤ë”ë¡œ ì ‘ê·¼        â”‚
â”‚      â†“                                                           â”‚
â”‚  Phase 2: 5% íŠ¸ë˜í”½               ì¼ë°˜ ì‚¬ìš©ì 5% ë…¸ì¶œ            â”‚
â”‚      â†“                                                           â”‚
â”‚  Phase 3: 20% íŠ¸ë˜í”½              ì—ëŸ¬ìœ¨/ë ˆì´í„´ì‹œ ëª¨ë‹ˆí„°ë§       â”‚
â”‚      â†“                                                           â”‚
â”‚  Phase 4: 50% íŠ¸ë˜í”½              ëŒ€ê·œëª¨ ê²€ì¦                    â”‚
â”‚      â†“                                                           â”‚
â”‚  Phase 5: 100% íŠ¸ë˜í”½             Canary â†’ Stable ì „í™˜           â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ë¼ìš°íŒ… ë°©ì‹

**ë°©ì‹ 1: í—¤ë” ê¸°ë°˜ (Header-based)**

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
spec:
  http:
  # X-Canary: true í—¤ë”ê°€ ìˆìœ¼ë©´ Canaryë¡œ
  - match:
    - headers:
        x-canary:
          exact: 'true'
    route:
    - destination:
        subset: canary

  # ê·¸ ì™¸ëŠ” Stableë¡œ
  - route:
    - destination:
        subset: stable
```

**ë°©ì‹ 2: ê°€ì¤‘ì¹˜ ê¸°ë°˜ (Weight-based)**

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
spec:
  http:
  - route:
    - destination:
        subset: stable
      weight: 95
    - destination:
        subset: canary
      weight: 5
```

**ë°©ì‹ 3: í•˜ì´ë¸Œë¦¬ë“œ (ìš°ë¦¬ê°€ ì„ íƒí•œ ë°©ì‹)**

```yaml
http:
# 1ìˆœìœ„: í—¤ë”ê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ Canary
- match:
  - headers:
      x-canary:
        exact: 'true'
  route:
  - destination:
      subset: canary

# 2ìˆœìœ„: ë‚˜ë¨¸ì§€ëŠ” Stable (ë‚˜ì¤‘ì— weight ì¶”ê°€ ê°€ëŠ¥)
- route:
  - destination:
      subset: stable
```

#### ì¥ì 

| ì¥ì  | ì„¤ëª… |
|------|------|
| **ìµœì†Œ ë¦¬ì†ŒìŠ¤** | Canary Pod 1-2ê°œë§Œ ì¶”ê°€ (+10~15% ë¹„ìš©) |
| **ì ì§„ì  ê²€ì¦** | ë‹¨ê³„ë³„ íŠ¸ë˜í”½ í™•ëŒ€ë¡œ ìœ„í—˜ ìµœì†Œí™” |
| **ì„ íƒì  í…ŒìŠ¤íŠ¸** | í—¤ë” ê¸°ë°˜ìœ¼ë¡œ ê°œë°œìë§Œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ |
| **ë¹ ë¥¸ ë¡¤ë°±** | Canary Pod ì œê±° ë˜ëŠ” weight 0ìœ¼ë¡œ ì¦‰ì‹œ ë³µêµ¬ |
| **ì‹¤ì œ íŠ¸ë˜í”½** | í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì‹¤ì œ ì‚¬ìš©ì íŒ¨í„´ìœ¼ë¡œ ê²€ì¦ |

#### ë‹¨ì 

| ë‹¨ì  | ì‹¬ê°ë„ | ì„¤ëª… |
|------|:------:|------|
| **ì„¤ì • ë³µì¡ë„** | ğŸŸ¡ | VirtualService, DestinationRule ì´í•´ í•„ìš” |
| **ëª¨ë‹ˆí„°ë§ í•„ìš”** | ğŸŸ¡ | ë²„ì „ë³„ ë©”íŠ¸ë¦­ ë¶„ë¦¬ ë° ë¹„êµ í•„ìš” |
| **ë””ë²„ê¹… ë³µì¡** | ğŸŸ¢ | ë‘ ë²„ì „ ë™ì‹œ ìš´ì˜ ì‹œ ë¡œê·¸ ì¶”ì  ë³µì¡ |

#### ë¹„ìš© ë¶„ì„

```
í˜„ì¬ ë¹„ìš© (Stableë§Œ):
  - Nê°œ ë…¸ë“œ, ê° ë…¸ë“œì— Pod 2-3ê°œ
  = ê¸°ì¤€ ë¹„ìš© $B/ì›”

Canary ì ìš© ì‹œ:
  - ê¸°ì¡´ Stable Pod ìœ ì§€
  - ì„œë¹„ìŠ¤ë‹¹ Canary Pod 1ê°œ ì¶”ê°€
  - ì¶”ê°€ ë¦¬ì†ŒìŠ¤: CPU 0.2ì½”ì–´, ë©”ëª¨ë¦¬ 256MB (ë…¸ë“œë‹¹)
  = $B Ã— 1.1~1.15/ì›” (10~15% ì¦ê°€)
```

---

## 3. ìµœì¢… ì„ íƒ: Canary (í—¤ë” ê¸°ë°˜)

### 3.1 ê²°ì • ë§¤íŠ¸ë¦­ìŠ¤

| ê¸°ì¤€ | ê°€ì¤‘ì¹˜ | Rolling | Blue-Green | Canary | ë¹„ê³  |
|------|:------:|:-------:|:----------:|:------:|------|
| ì ì§„ì  ê²€ì¦ | 30% | 1 | 2 | **5** | Canaryë§Œ ë‹¨ê³„ë³„ ê²€ì¦ ê°€ëŠ¥ |
| ë¹ ë¥¸ ë¡¤ë°± | 25% | 2 | **5** | **5** | BG/Canary ëª¨ë‘ ì¦‰ì‹œ ê°€ëŠ¥ |
| ë¹„ìš© íš¨ìœ¨ì„± | 25% | **5** | 1 | **4** | BGëŠ” 2ë°° ë¹„ìš© |
| ì„¤ì • ìš©ì´ì„± | 10% | **5** | 3 | 2 | Rollingì´ ê°€ì¥ ê°„ë‹¨ |
| ê¸°ì¡´ ì¸í”„ë¼ í™œìš© | 10% | 3 | 2 | **5** | Istio ì´ë¯¸ êµ¬ì¶•ë¨ |
| **ì´ì ** | 100% | 2.8 | 2.4 | **4.5** | |

### 3.2 Istio í™œìš© ì´ì 

ìš°ë¦¬ í´ëŸ¬ìŠ¤í„°ì—ëŠ” ì´ë¯¸ **Istio Service Mesh**ê°€ êµ¬ì¶•ë˜ì–´ ìˆë‹¤:

```yaml
# ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¦¬ì†ŒìŠ¤ë“¤
- Gateway: istio-system/eco2-gateway
- VirtualService: ê° ë„ë©”ì¸ë³„ ë¼ìš°íŒ… ê·œì¹™
- DestinationRule: ì¼ë¶€ ì„œë¹„ìŠ¤ì— ì¡´ì¬ (character, my, ext-authz)
```

Canary ë°°í¬ë¥¼ ìœ„í•´ ì¶”ê°€ë¡œ í•„ìš”í•œ ê²ƒ:

```yaml
# ì¶”ê°€/ìˆ˜ì •ì´ í•„ìš”í•œ ë¦¬ì†ŒìŠ¤
1. DestinationRule: stable/canary subset ì •ì˜ (ì‹ ê·œ ë˜ëŠ” ìˆ˜ì •)
2. VirtualService: X-Canary í—¤ë” ë§¤ì¹­ ê·œì¹™ ì¶”ê°€ (ìˆ˜ì •)
3. Deployment: Canary ë²„ì „ (version: v2 ë¼ë²¨) ì¶”ê°€ (ì‹ ê·œ)
```

**í•µì‹¬: ìƒˆë¡œìš´ ì¸í”„ë¼ êµ¬ì„± ìš”ì†Œ ì—†ì´ ê¸°ì¡´ Istioë¡œ êµ¬í˜„ ê°€ëŠ¥**

### 3.3 êµ¬í˜„ ê²°ì •ì‚¬í•­

#### ë¼ìš°íŒ… ì „ëµ: í—¤ë” ê¸°ë°˜ ìš°ì„ 

ì²˜ìŒì—ëŠ” **ê°€ì¤‘ì¹˜ ê¸°ë°˜**ì´ ì•„ë‹Œ **í—¤ë” ê¸°ë°˜**ìœ¼ë¡œ ì‹œì‘:

```yaml
# Phase 1: ê°œë°œì í…ŒìŠ¤íŠ¸ (í—¤ë” ê¸°ë°˜)
http:
- match:
  - headers:
      x-canary:
        exact: 'true'
  route:
  - destination:
      subset: canary
- route:
  - destination:
      subset: stable
```

**ì´ìœ :**
1. ë¦¬íŒ©í† ë§ ì´ˆê¸°ì—ëŠ” ê°œë°œìë§Œ í…ŒìŠ¤íŠ¸
2. ì•ˆì •ì„± í™•ì¸ í›„ ê°€ì¤‘ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì „í™˜
3. ê°€ì¤‘ì¹˜ ì „í™˜ì€ YAML ìˆ˜ì •ë§Œìœ¼ë¡œ ê°€ëŠ¥

#### ë²„ì „ ë¼ë²¨ë§ ì „ëµ

```yaml
# Stable Deployment
metadata:
  labels:
    app: auth-api
    version: v1    # â† subset ë§¤ì¹­ì— ì‚¬ìš©

# Canary Deployment  
metadata:
  labels:
    app: auth-api
    version: v2    # â† subset ë§¤ì¹­ì— ì‚¬ìš©
    release: canary
```

#### ì´ë¯¸ì§€ íƒœê·¸ ì „ëµ

```
Stable: mng990/eco2:{service}-dev-latest
Canary: mng990/eco2:{service}-dev-canary
```

CI/CDì—ì„œ `-canary` íƒœê·¸ë¡œ ë¹Œë“œí•˜ë©´ ìë™ìœ¼ë¡œ Canary Deploymentì— ì ìš©.

---

## 4. êµ¬í˜„ ìƒì„¸

### 4.1 ì ìš© ë²”ìœ„

#### API ì„œë¹„ìŠ¤ (9ê°œ)

| ì„œë¹„ìŠ¤ | ë„¤ì„ìŠ¤í˜ì´ìŠ¤ | VirtualService | DestinationRule | Canary Deploy |
|--------|-------------|:--------------:|:---------------:|:-------------:|
| auth-api | auth | âœ… | âœ… (ì‹ ê·œ) | âœ… |
| character-api | character | âœ… | âœ… (ìˆ˜ì •) | âœ… |
| chat-api | chat | âœ… | âœ… (ì‹ ê·œ) | âœ… |
| image-api | image | âœ… | âœ… (ì‹ ê·œ) | âœ… |
| location-api | location | âœ… | âœ… (ì‹ ê·œ) | âœ… |
| my-api | my | âœ… | âœ… (ìˆ˜ì •) | âœ… |
| scan-api | scan | âœ… | âœ… (ì‹ ê·œ) | âœ… |
| sse-gateway | sse-consumer | âœ… | âœ… (ì‹ ê·œ) | âœ… |
| ext-authz | auth | - (gRPC) | âœ… (ìˆ˜ì •) | âœ… |

#### Worker ì„œë¹„ìŠ¤ (4ê°œ)

HTTP ë¼ìš°íŒ…ì´ ë¶ˆí•„ìš”í•˜ë¯€ë¡œ Canary Deploymentë§Œ ì¶”ê°€:

| ì„œë¹„ìŠ¤ | ë„¤ì„ìŠ¤í˜ì´ìŠ¤ | Canary Deploy |
|--------|-------------|:-------------:|
| auth-relay | auth | âœ… |
| character-worker | character | âœ… |
| scan-worker | scan | âœ… |
| my-worker | my | âœ… |

### 4.2 íŒŒì¼ êµ¬ì¡°

```
workloads/
â”œâ”€â”€ domains/{service}/base/
â”‚   â”œâ”€â”€ deployment.yaml           # Stable (version: v1)
â”‚   â”œâ”€â”€ deployment-canary.yaml    # Canary (version: v2) â† ì‹ ê·œ
â”‚   â”œâ”€â”€ destination-rule.yaml     # stable/canary subset â† ì‹ ê·œ/ìˆ˜ì •
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â””â”€â”€ kustomization.yaml        # canary ë¦¬ì†ŒìŠ¤ í¬í•¨ â† ìˆ˜ì •
â”‚
â””â”€â”€ routing/{service}/base/
    â””â”€â”€ virtual-service.yaml      # X-Canary í—¤ë” ë¼ìš°íŒ… â† ìˆ˜ì •
```

### 4.3 ë°°í¬ ì›Œí¬í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Canary ë°°í¬ ì›Œí¬í”Œë¡œìš°                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. ì½”ë“œ ë³€ê²½                                                    â”‚
â”‚     â””â”€â†’ feature/xxx ë¸Œëœì¹˜ì—ì„œ ì‘ì—…                              â”‚
â”‚                                                                  â”‚
â”‚  2. Canary ì´ë¯¸ì§€ ë¹Œë“œ                                           â”‚
â”‚     â””â”€â†’ docker build -t mng990/eco2:{service}-dev-canary        â”‚
â”‚     â””â”€â†’ docker push mng990/eco2:{service}-dev-canary            â”‚
â”‚                                                                  â”‚
â”‚  3. ArgoCD ìë™ ë°°í¬                                             â”‚
â”‚     â””â”€â†’ Canary Deploymentê°€ ìƒˆ ì´ë¯¸ì§€ë¡œ ì—…ë°ì´íŠ¸                 â”‚
â”‚     â””â”€â†’ Canary Pod ìƒì„± (version: v2)                           â”‚
â”‚                                                                  â”‚
â”‚  4. ê°œë°œì í…ŒìŠ¤íŠ¸ (í—¤ë” ê¸°ë°˜)                                     â”‚
â”‚     â””â”€â†’ curl -H "X-Canary: true" https://api.growbin.app/...    â”‚
â”‚     â””â”€â†’ ë¡œê·¸/ë©”íŠ¸ë¦­ í™•ì¸                                         â”‚
â”‚                                                                  â”‚
â”‚  5. ë¬¸ì œ ë°œê²¬ ì‹œ                                                 â”‚
â”‚     â””â”€â†’ ì½”ë“œ ìˆ˜ì • í›„ 2ë²ˆë¶€í„° ë°˜ë³µ                                â”‚
â”‚     â””â”€â†’ ë˜ëŠ” Canary Pod ìŠ¤ì¼€ì¼ 0ìœ¼ë¡œ ë¹„í™œì„±í™”                    â”‚
â”‚                                                                  â”‚
â”‚  6. í…ŒìŠ¤íŠ¸ í†µê³¼                                                  â”‚
â”‚     â””â”€â†’ ì˜µì…˜ A: ê°€ì¤‘ì¹˜ ê¸°ë°˜ìœ¼ë¡œ ì „í™˜ (5% â†’ 20% â†’ 50% â†’ 100%)    â”‚
â”‚     â””â”€â†’ ì˜µì…˜ B: Stable ì´ë¯¸ì§€ë¥¼ Canaryë¡œ êµì²´                    â”‚
â”‚                                                                  â”‚
â”‚  7. ì™„ì „ ì „í™˜                                                    â”‚
â”‚     â””â”€â†’ Canary ì´ë¯¸ì§€ë¥¼ latest íƒœê·¸ë¡œ ì¬íƒœê¹…                     â”‚
â”‚     â””â”€â†’ Stable Deployment ì—…ë°ì´íŠ¸                               â”‚
â”‚     â””â”€â†’ Canary Pod ìŠ¤ì¼€ì¼ ë‹¤ìš´                                   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ì‚¬ìš© ê°€ì´ë“œ

### 5.1 Canary ë²„ì „ í…ŒìŠ¤íŠ¸

```bash
# cURL
curl -H "X-Canary: true" https://api.growbin.app/api/v1/auth/me

# HTTPie
http https://api.growbin.app/api/v1/auth/me X-Canary:true

# ë¸Œë¼ìš°ì €: ModHeader í™•ì¥ í”„ë¡œê·¸ë¨ ì‚¬ìš©
```

### 5.2 ë¡œê·¸ í™•ì¸

```bash
# Canary Pod ë¡œê·¸
kubectl logs -n auth -l version=v2 --tail=100 -f

# Stable Pod ë¡œê·¸
kubectl logs -n auth -l version=v1 --tail=100 -f
```

### 5.3 ë©”íŠ¸ë¦­ êµ¬ë¶„

Jaeger/Grafanaì—ì„œ ì„œë¹„ìŠ¤ëª…ìœ¼ë¡œ êµ¬ë¶„:
- Stable: `auth-api`
- Canary: `auth-api-canary`

### 5.4 ë¡¤ë°±

```bash
# ì¦‰ì‹œ ë¡¤ë°±: Canary Pod ì œê±°
kubectl scale deployment auth-api-canary --replicas=0 -n auth

# ë˜ëŠ” VirtualServiceì—ì„œ canary route ì œê±°
```

---

## 6. ê²°ë¡ 

### ì„ íƒ ìš”ì•½

| í•­ëª© | ê²°ì • |
|------|------|
| **ë°°í¬ ì „ëµ** | Canary Deployment |
| **ë¼ìš°íŒ… ë°©ì‹** | í—¤ë” ê¸°ë°˜ (X-Canary: true) |
| **êµ¬í˜„ ê¸°ìˆ ** | Istio VirtualService + DestinationRule |
| **ì ìš© ë²”ìœ„** | API ì„œë¹„ìŠ¤ 9ê°œ + Worker 4ê°œ |
| **ë¹„ìš© ì¦ê°€** | ~10-15% (Pod 1ê°œ/ì„œë¹„ìŠ¤ ì¶”ê°€) |

### ê¸°ëŒ€ íš¨ê³¼

1. **ì•ˆì „í•œ ë¦¬íŒ©í† ë§**: ì‹¤ì œ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ê²€ì¦ í›„ ì „í™˜
2. **ë¹ ë¥¸ í”¼ë“œë°±**: ë¬¸ì œ ë°œê²¬ ì‹œ ì¦‰ì‹œ ë¡¤ë°± ê°€ëŠ¥
3. **ê°œë°œì ê²½í—˜ í–¥ìƒ**: í—¤ë” í•˜ë‚˜ë¡œ ìƒˆ ë²„ì „ í…ŒìŠ¤íŠ¸
4. **ë¹„ìš© íš¨ìœ¨ì„±**: Blue-Green ëŒ€ë¹„ 85% ë¹„ìš© ì ˆê°

---

## ê´€ë ¨ ì»¤ë°‹

- `4efee1e2` - feat(canary): add header-based canary deployment for auth service
- `d3a67f61` - feat(canary): add header-based canary deployment for all workloads

## ì°¸ê³  ìë£Œ

- [Istio Traffic Management](https://istio.io/latest/docs/concepts/traffic-management/)
- [Canary Deployments using Istio](https://istio.io/latest/blog/2017/0.1-canary/)
- [Kubernetes Deployment Strategies](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/)
- [Argo Rollouts](https://argoproj.github.io/argo-rollouts/) (í–¥í›„ ìë™í™” ê³ ë ¤)
