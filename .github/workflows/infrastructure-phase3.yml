name: Infrastructure as Code - Phase 3 (ArgoCD Hooks)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Phase 3: Atlantis + ArgoCD Hooksê°€ ëŒ€ë¶€ë¶„ ì²˜ë¦¬
# GitHub ActionsëŠ” ìµœì†Œí•œì˜ ì—­í• ë§Œ ìˆ˜í–‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
on:
  pull_request:
    types: [closed]  # PR Merge ì‹œì—ë§Œ ì‹¤í–‰
    branches:
      - main
    paths:
      - 'terraform/**'
      - 'ansible/**'
      - 'k8s/**'
      - 'charts/**'

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ (ArgoCD Sync íŠ¸ë¦¬ê±°)
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'sync'
        type: choice
        options:
          - sync
          - refresh

env:
  AWS_REGION: ap-northeast-2

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: ArgoCD Sync Trigger (PR Merge í›„)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  argocd-sync-trigger:
    name: ðŸ”„ Trigger ArgoCD Sync
    runs-on: ubuntu-latest
    
    # PRì´ Mergeë˜ì—ˆê³  Terraform/Ansible/K8s íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš°ë§Œ
    if: |
      github.event.pull_request.merged == true ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: ðŸ”§ Setup ArgoCD CLI
        run: |
          curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd
          argocd version --client
      
      - name: ðŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ðŸ”‘ Setup Kubeconfig
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          MASTER_NODE_IP: ${{ secrets.MASTER_NODE_IP }}
        run: |
          # Terraform Outputsì—ì„œ Master IP ê°€ì ¸ì˜¤ê¸°
          # (S3ì— ì €ìž¥ëœ Outputs ì‚¬ìš© - Atlantisê°€ ì €ìž¥)
          if aws s3 ls s3://sesacthon-terraform-state/outputs/latest.json 2>/dev/null; then
            aws s3 cp s3://sesacthon-terraform-state/outputs/latest.json /tmp/tf-outputs.json
            MASTER_IP=$(jq -r '.master_public_ip.value' /tmp/tf-outputs.json)
          else
            echo "âš ï¸  Terraform Outputs not found in S3"
            echo "   Using GitHub Secrets fallback"
            # MASTER_NODE_IPëŠ” ì„ íƒì  Secret (ì—†ì„ ìˆ˜ ìžˆìŒ)
            MASTER_IP="${MASTER_NODE_IP:-}"
            if [ -z "$MASTER_IP" ]; then
              echo "âŒ MASTER_NODE_IP not found in secrets"
              echo "   Please set MASTER_NODE_IP secret or ensure Terraform Outputs are in S3"
              exit 1
            fi
          fi
          
          echo "Master IP: $MASTER_IP"
          
          # SSH Key ì„¤ì •
          mkdir -p ~/.ssh
          # SSH_PRIVATE_KEYëŠ” í•„ìˆ˜ Secret
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "âŒ SSH_PRIVATE_KEY not found in secrets"
            exit 1
          fi
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/k8s-cluster-key.pem
          chmod 600 ~/.ssh/k8s-cluster-key.pem
          
          # Master ë…¸ë“œì—ì„œ kubeconfig ê°€ì ¸ì˜¤ê¸°
          scp -o StrictHostKeyChecking=no \
            -i ~/.ssh/k8s-cluster-key.pem \
            ubuntu@$MASTER_IP:/home/ubuntu/.kube/config \
            ~/.kube/config || {
              echo "âŒ Failed to fetch kubeconfig"
              exit 1
            }
          
          kubectl config current-context
          kubectl get nodes
      
      - name: ðŸ”„ ArgoCD Login
        run: |
          # ArgoCD ì ‘ì† ì •ë³´
          ARGOCD_SERVER=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "localhost")
          
          if [ "$ARGOCD_SERVER" = "localhost" ]; then
            # LoadBalancerê°€ ì—†ìœ¼ë©´ Port Forward
            kubectl port-forward svc/argocd-server -n argocd 8080:443 &
            sleep 5
            ARGOCD_SERVER="localhost:8080"
          fi
          
          # ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          
          # Login
          argocd login $ARGOCD_SERVER \
            --username admin \
            --password $ARGOCD_PASSWORD \
            --insecure
      
      - name: ðŸ“ Create/Update ArgoCD Application
        run: |
          # Applicationì´ ì—†ìœ¼ë©´ ìƒì„± (Phase 3: Hooks í¬í•¨)
          APP_NAME="ecoeco-infrastructure-14nodes"
          if ! argocd app get "$APP_NAME" 2>/dev/null; then
            echo "ðŸ“ Creating ArgoCD Application with Hooks..."
            kubectl apply -f argocd/application-14nodes-with-hooks.yaml
            echo "âœ… Application created: $APP_NAME"
          else
            echo "âœ… Application already exists: $APP_NAME"
            echo "ðŸ”„ Updating Application..."
            kubectl apply -f argocd/application-14nodes-with-hooks.yaml
          fi
      
      - name: ðŸ”„ Sync ArgoCD Application
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”„ Syncing ArgoCD Application"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“Œ Note: ArgoCD will run:"
          echo "   1. PreSync Hook: Ansible Bootstrap (from ConfigMap)"
          echo "   2. Sync: Deploy Kubernetes Resources"
          echo "   3. PostSync Hook: Label Kubernetes Nodes"
          echo ""
          
          APP_NAME="ecoeco-infrastructure-14nodes"
          argocd app sync "$APP_NAME" \
            --prune \
            --force \
            --timeout 1800  # 30ë¶„ (Ansible í¬í•¨)
          
          echo ""
          echo "â³ Waiting for sync to complete..."
          argocd app wait "$APP_NAME" \
            --health \
            --timeout 1800
      
      - name: ðŸ“Š ArgoCD Application Status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š ArgoCD Application Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          APP_NAME="ecoeco-infrastructure-14nodes"
          argocd app get "$APP_NAME"
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸŽ¯ What just happened:"
          echo "   1. Atlantis: Terraform Apply (triggered by PR comment)"
          echo "   2. Atlantis: Saved Outputs to ConfigMap"
          echo "   3. ArgoCD PreSync: Ran Ansible Bootstrap"
          echo "   4. ArgoCD Sync: Deployed K8s Resources"
          echo "   5. ArgoCD PostSync: Labeled Nodes"
          echo ""
          echo "ðŸ”— Next Steps:"
          echo "   - Check cluster: kubectl get nodes"
          echo "   - Check pods: kubectl get pods --all-namespaces"
          echo "   - Access ArgoCD: https://argocd.sesacthon.com"
          echo "   - Access Grafana: https://grafana.sesacthon.com"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Deployment Summary
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: argocd-sync-trigger
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "# ðŸš€ Infrastructure Deployment Summary (Phase 3)" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Deployment Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```mermaid" >> $GITHUB_STEP_SUMMARY
          echo "graph TD" >> $GITHUB_STEP_SUMMARY
          echo "    A[PR Created] --> B[Atlantis: terraform plan]" >> $GITHUB_STEP_SUMMARY
          echo "    B --> C[Team Review & Approve]" >> $GITHUB_STEP_SUMMARY
          echo "    C --> D[Comment: atlantis apply]" >> $GITHUB_STEP_SUMMARY
          echo "    D --> E[Atlantis: terraform apply]" >> $GITHUB_STEP_SUMMARY
          echo "    E --> F[Save Outputs to ConfigMap]" >> $GITHUB_STEP_SUMMARY
          echo "    F --> G[PR Auto-Merge]" >> $GITHUB_STEP_SUMMARY
          echo "    G --> H[GitHub Actions: Trigger ArgoCD]" >> $GITHUB_STEP_SUMMARY
          echo "    H --> I[ArgoCD PreSync: Ansible]" >> $GITHUB_STEP_SUMMARY
          echo "    I --> J[ArgoCD Sync: K8s Deploy]" >> $GITHUB_STEP_SUMMARY
          echo "    J --> K[ArgoCD PostSync: Label Nodes]" >> $GITHUB_STEP_SUMMARY
          echo "    K --> L[Complete]" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Phase 3 Improvements" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Atlantis**: Terraform Plan/Apply (PR ê¸°ë°˜)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ArgoCD Hooks**: Ansible Bootstrap (PreSync)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ArgoCD Hooks**: Node Labeling (PostSync)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **GitHub Actions**: ìµœì†Œí™” (ArgoCD Triggerë§Œ)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **ConfigMap**: Terraform Outputs ìžë™ ì „ë‹¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD Sync Trigger | ${{ needs.argocd-sync-trigger.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY

