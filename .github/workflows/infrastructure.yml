name: Infrastructure as Code - Phase 1

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# íŠ¸ë¦¬ê±°: Terraform/Ansible ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'terraform/**'
      - 'ansible/**'
      - '.github/workflows/infrastructure.yml'
  
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'terraform/**'
      - 'ansible/**'

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# í™˜ê²½ ë³€ìˆ˜
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
env:
  AWS_REGION: ap-northeast-2
  TF_VERSION: 1.5.0
  WORKING_DIR: terraform

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Jobs
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: Terraform Plan (PR ë˜ëŠ” Push ì‹œ)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  terraform-plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    
    # PR ë˜ëŠ” workflow_dispatch(plan)ì¼ ë•Œë§Œ ì‹¤í–‰
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
    
    permissions:
      contents: read
      pull-requests: write  # PRì— ì½”ë©˜íŠ¸ ì‘ì„± ê¶Œí•œ
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: ğŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸ¨ Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ${{ env.WORKING_DIR }}
        continue-on-error: true
      
      - name: ğŸš€ Terraform Init
        id: init
        run: terraform init
        working-directory: ${{ env.WORKING_DIR }}
      
      - name: âœ… Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: ${{ env.WORKING_DIR }}
      
      - name: ğŸ“‹ Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -out=tfplan | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        working-directory: ${{ env.WORKING_DIR }}
        continue-on-error: true
      
      - name: ğŸ’¬ Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/plan_output.txt', 'utf8');
            const truncatedPlan = plan.length > 65000 ? plan.substring(0, 65000) + '\n...(truncated)' : plan;
            
            const output = `### ğŸ“‹ Terraform Plan Results
            
            #### Format Check ğŸ¨
            \`${{ steps.fmt.outcome }}\`
            
            #### Initialization âš™ï¸
            \`${{ steps.init.outcome }}\`
            
            #### Validation âœ…
            \`${{ steps.validate.outcome }}\`
            
            #### Plan ğŸ“Š
            \`${{ steps.plan.outcome }}\`
            
            <details>
            <summary>Show Plan</summary>
            
            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            **Pushed by:** @${{ github.actor }}
            **Action:** \`${{ github.event_name }}\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
      
      - name: ğŸ“¤ Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: ${{ env.WORKING_DIR }}/tfplan
          retention-days: 5

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Terraform Apply (Main/Develop Branch Push ì‹œ)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  terraform-apply:
    name: ğŸš€ Terraform Apply
    runs-on: ubuntu-latest
    
    # Main/Develop ë¸Œëœì¹˜ì— Pushë˜ê±°ë‚˜ workflow_dispatch(apply)ì¼ ë•Œë§Œ ì‹¤í–‰
    if: |
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    
    outputs:
      terraform_outputs: ${{ steps.outputs.outputs }}
      ansible_inventory: ${{ steps.outputs.inventory }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false  # Outputì„ ì •í™•íˆ ê°€ì ¸ì˜¤ê¸° ìœ„í•´
      
      - name: ğŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸš€ Terraform Init
        run: terraform init
        working-directory: ${{ env.WORKING_DIR }}
      
      - name: ğŸ¯ Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve -no-color | tee apply_output.txt
        working-directory: ${{ env.WORKING_DIR }}
      
      - name: ğŸ“Š Export Terraform Outputs
        id: outputs
        run: |
          # JSON í˜•ì‹ìœ¼ë¡œ ëª¨ë“  outputs ì €ì¥
          terraform output -json > /tmp/tf-outputs.json
          
          # Ansible Inventory ì¶”ì¶œ
          terraform output -raw ansible_inventory > /tmp/ansible-inventory.ini
          
          # GitHub Outputsì— ì €ì¥ (ë‹¤ìŒ Jobì—ì„œ ì‚¬ìš©)
          echo "outputs<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/tf-outputs.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "inventory<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/ansible-inventory.ini >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        working-directory: ${{ env.WORKING_DIR }}
      
      - name: ğŸ“¤ Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: |
            /tmp/tf-outputs.json
            /tmp/ansible-inventory.ini
          retention-days: 30
      
      - name: ğŸ’¾ Save Outputs to S3 (Optional)
        run: |
          # S3 ë²„í‚·ì´ ìˆë‹¤ë©´ ì €ì¥ (ì„ íƒì‚¬í•­)
          if aws s3 ls s3://sesacthon-terraform-state 2>/dev/null; then
            aws s3 cp /tmp/tf-outputs.json \
              s3://sesacthon-terraform-state/outputs/$(date +%Y%m%d-%H%M%S).json
            
            aws s3 cp /tmp/tf-outputs.json \
              s3://sesacthon-terraform-state/outputs/latest.json
          fi
        continue-on-error: true
      
      - name: âœ… Terraform Apply Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Terraform Apply Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Cluster Info:"
          terraform output -json cluster_info | jq '.'
          echo ""
          echo "ğŸ”— Next Step: Ansible Bootstrap will run automatically"
        working-directory: ${{ env.WORKING_DIR }}

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: Ansible Bootstrap (Terraform Apply í›„ ìë™ ì‹¤í–‰)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ansible-bootstrap:
    name: âš™ï¸ Ansible Bootstrap
    runs-on: ubuntu-latest
    needs: terraform-apply
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          ansible --version
      
      - name: ğŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/k8s-cluster-key.pem
          chmod 600 ~/.ssh/k8s-cluster-key.pem
          
          # SSH Config ì„¤ì •
          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
      
      - name: ğŸ“ Create Ansible Inventory
        run: |
          # Terraform Outputì—ì„œ ìƒì„±ëœ ì¸ë²¤í† ë¦¬ ì‚¬ìš©
          cp /tmp/ansible-inventory.ini ansible/inventory/hosts.ini
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Ansible Inventory:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat ansible/inventory/hosts.ini
      
      - name: ğŸ” Test SSH Connectivity
        run: |
          cd ansible
          ansible all -i inventory/hosts.ini -m ping --timeout=30
      
      - name: âš™ï¸ Run Ansible Playbook (site.yml)
        run: |
          cd ansible
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Starting Ansible Bootstrap"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ansible-playbook site.yml \
            -i inventory/hosts.ini \
            --timeout=300 \
            -v
      
      - name: ğŸ·ï¸ Label Kubernetes Nodes
        run: |
          cd ansible
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ·ï¸ Labeling Kubernetes Nodes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ansible-playbook playbooks/label-nodes.yml \
            -i inventory/hosts.ini \
            -v
      
      - name: âœ… Ansible Bootstrap Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Ansible Bootstrap Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ”— Next Step: ArgoCD Application Sync"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 4: ArgoCD Sync (Ansible ì™„ë£Œ í›„ ìë™ ì‹¤í–‰)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  argocd-sync:
    name: ğŸ”„ ArgoCD Sync
    runs-on: ubuntu-latest
    needs: ansible-bootstrap
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp
      
      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: ğŸ”§ Setup ArgoCD CLI
        run: |
          curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x /usr/local/bin/argocd
          argocd version --client
      
      - name: ğŸ”‘ Get Master Node IP
        id: master
        run: |
          MASTER_IP=$(cat /tmp/tf-outputs.json | jq -r '.master_public_ip.value')
          echo "master_ip=$MASTER_IP" >> $GITHUB_OUTPUT
      
      - name: ğŸ”‘ Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          
          # SSH Key ì„¤ì •
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/k8s-cluster-key.pem
          chmod 600 ~/.ssh/k8s-cluster-key.pem
          
          # Master ë…¸ë“œì—ì„œ kubeconfig ê°€ì ¸ì˜¤ê¸°
          scp -o StrictHostKeyChecking=no \
            -i ~/.ssh/k8s-cluster-key.pem \
            ubuntu@${{ steps.master.outputs.master_ip }}:/home/ubuntu/.kube/config \
            ~/.kube/config
          
          # Context í™•ì¸
          kubectl config current-context
          kubectl get nodes
      
      - name: ğŸ”„ ArgoCD Login
        run: |
          # ArgoCD ì ‘ì† ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          ARGOCD_SERVER=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          # ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          
          # Login
          argocd login $ARGOCD_SERVER \
            --username admin \
            --password $ARGOCD_PASSWORD \
            --insecure
      
      - name: ğŸ“ Create/Update ArgoCD Application
        run: |
          # Applicationì´ ì—†ìœ¼ë©´ ìƒì„±
          if ! argocd app get sesacthon-infrastructure 2>/dev/null; then
            kubectl apply -f argocd/application-14nodes.yaml
          fi
      
      - name: ğŸ”„ Sync ArgoCD Application
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Syncing ArgoCD Application"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          argocd app sync sesacthon-infrastructure \
            --prune \
            --force \
            --timeout 600
          
          argocd app wait sesacthon-infrastructure \
            --health \
            --timeout 600
      
      - name: ğŸ“Š ArgoCD Application Status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ArgoCD Application Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          argocd app get sesacthon-infrastructure
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 5: Deployment Summary (ìµœì¢… ìš”ì•½)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [terraform-apply, ansible-bootstrap, argocd-sync]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "# ğŸš€ Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Apply | ${{ needs.terraform-apply.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ansible Bootstrap | ${{ needs.ansible-bootstrap.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD Sync | ${{ needs.argocd-sync.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Check cluster status: \`kubectl get nodes\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check pods: \`kubectl get pods --all-namespaces\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Access ArgoCD: \`https://argocd.sesacthon.com\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Access Grafana: \`https://grafana.sesacthon.com\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> $GITHUB_STEP_SUMMARY

