# GitOps Infrastructure Deployment
# 
# ë°°í¬ ì „ëµ:
# 1. Terraform: Atlantis (PR ê¸°ë°˜ GitOps)
# 2. Kubernetes: Ansible Bootstrap (í•œ ë²ˆë§Œ) â†’ ArgoCD (ì§€ì†ì  ê´€ë¦¬)
# 3. Applications: ArgoCD App of Apps

name: Infrastructure Bootstrap

on:
  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš© (ì´ˆê¸° ë¶€íŠ¸ìŠ¤íŠ¸ë©ìš©)
  workflow_dispatch:
    inputs:
      action:
        description: 'Bootstrap action'
        required: true
        default: 'bootstrap'
        type: choice
        options:
          - bootstrap  # Terraform ìƒíƒœ í™•ì¸ + Root App ì ìš©

env:
  AWS_REGION: ap-northeast-2

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: Terraform State í™•ì¸ (Atlantisê°€ ê´€ë¦¬)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  terraform-check:
    name: ğŸ” Terraform State Check
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'bootstrap'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: ğŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸš€ Terraform Init
        run: terraform init
        working-directory: terraform
      
      - name: ğŸ“Š Export Terraform Outputs
        id: outputs
        run: |
          # Terraform Stateê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if terraform output -json > /tmp/tf-outputs.json 2>/dev/null; then
            echo "âœ… Terraform State exists (managed by Atlantis)"
            
            # Ansible Inventory ì¶”ì¶œ
            terraform output -raw ansible_inventory > /tmp/ansible-inventory.ini
            
            echo "state_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No Terraform State found!"
            echo "âš ï¸  Please use Atlantis to create infrastructure:"
            echo "   1. Create PR with terraform/ changes"
            echo "   2. Comment: atlantis plan"
            echo "   3. Comment: atlantis apply"
            exit 1
          fi
        working-directory: terraform
      
      - name: ğŸ“¤ Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: |
            /tmp/tf-outputs.json
            /tmp/ansible-inventory.ini
          retention-days: 1

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Manual Bootstrap ì•ˆë‚´ (Ansible â†’ ë¬¸ì„œ ê¸°ë°˜)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  bootstrap-guide:
    name: ğŸ“˜ Manual Bootstrap Guide
    runs-on: ubuntu-latest
    needs: terraform-check
    if: github.event.inputs.action == 'bootstrap'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“„ Print bootstrap guide
        run: |
          echo "Refer to docs/deployment/LOCAL_CLUSTER_BOOTSTRAP.md for the manual Terraform â†’ Ansible â†’ ArgoCD steps."
          echo ""
          sed -n '1,160p' docs/deployment/LOCAL_CLUSTER_BOOTSTRAP.md

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: ArgoCD Root Application ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  argocd-deploy:
    name: ğŸ”„ ArgoCD Root App
    runs-on: ubuntu-latest
    needs: bootstrap-guide
    if: github.event.inputs.action == 'bootstrap'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp
      
      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: ğŸ”‘ Setup Kubeconfig
        run: |
          # SSH ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.kube ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/sesacthon.pem
          chmod 600 ~/.ssh/sesacthon.pem
          
          # SSH ì—ì´ì „íŠ¸ ì‹œì‘
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/sesacthon.pem
          
          # Master IP ì¶”ì¶œ
          MASTER_IP=$(cat /tmp/tf-outputs.json | jq -r '.master_public_ip.value')
          
          # Master ë…¸ë“œì—ì„œ kubeconfig ê°€ì ¸ì˜¤ê¸°
          scp -o StrictHostKeyChecking=no \
            -i ~/.ssh/sesacthon.pem \
            ubuntu@${MASTER_IP}:/home/ubuntu/.kube/config \
            ~/.kube/config
          
          # Context í™•ì¸
          kubectl config current-context
          kubectl get nodes
      
      - name: ğŸš€ Deploy Root Application
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Deploying ArgoCD Root Application (App of Apps)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Root Application ë°°í¬
          kubectl apply -f argocd/root-app.yaml
          
          # ë™ê¸°í™” ëŒ€ê¸°
          sleep 10
          
          # ìƒíƒœ í™•ì¸
          kubectl get applications -n argocd
      
      - name: ğŸ“Š GitOps Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GitOps Architecture Deployed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Deployed Applications:"
          kubectl get applications -n argocd -o wide
          echo ""
          echo "ğŸ”— Access:"
          echo "  - ArgoCD: https://argocd.sesacthon.com"
          echo "  - Atlantis: https://atlantis.sesacthon.com"
          echo "  - Grafana: https://grafana.sesacthon.com"

