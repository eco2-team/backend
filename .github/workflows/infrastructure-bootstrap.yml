# GitOps Infrastructure Deployment
# 
# ë°°í¬ ì „ëµ:
# 1. Terraform: Atlantis (PR ê¸°ë°˜ GitOps)
# 2. Kubernetes: Ansible Bootstrap (í•œ ë²ˆë§Œ) â†’ ArgoCD (ì§€ì†ì  ê´€ë¦¬)
# 3. Applications: ArgoCD App of Apps

name: Infrastructure Bootstrap

on:
  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš© (ì´ˆê¸° ë¶€íŠ¸ìŠ¤íŠ¸ë©ìš©)
  workflow_dispatch:
    inputs:
      action:
        description: 'Bootstrap action'
        required: true
        default: 'bootstrap'
        type: choice
        options:
          - bootstrap  # ì „ì²´ ì´ˆê¸°í™”
          - ansible-only  # Ansibleë§Œ ì¬ì‹¤í–‰

env:
  AWS_REGION: ap-northeast-2

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 1: Terraform State í™•ì¸ (Atlantisê°€ ê´€ë¦¬)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  terraform-check:
    name: ğŸ” Terraform State Check
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'bootstrap'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: ğŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: ğŸš€ Terraform Init
        run: terraform init
        working-directory: terraform
      
      - name: ğŸ“Š Export Terraform Outputs
        id: outputs
        run: |
          # Terraform Stateê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if terraform output -json > /tmp/tf-outputs.json 2>/dev/null; then
            echo "âœ… Terraform State exists (managed by Atlantis)"
            
            # Ansible Inventory ì¶”ì¶œ
            terraform output -raw ansible_inventory > /tmp/ansible-inventory.ini
            
            echo "state_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No Terraform State found!"
            echo "âš ï¸  Please use Atlantis to create infrastructure:"
            echo "   1. Create PR with terraform/ changes"
            echo "   2. Comment: atlantis plan"
            echo "   3. Comment: atlantis apply"
            exit 1
          fi
        working-directory: terraform
      
      - name: ğŸ“¤ Upload Terraform Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: |
            /tmp/tf-outputs.json
            /tmp/ansible-inventory.ini
          retention-days: 1

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 2: Ansible Bootstrap (Kubernetes ì„¤ì¹˜ + ArgoCD ì„¤ì¹˜)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ansible-bootstrap:
    name: âš™ï¸ Ansible Bootstrap
    runs-on: ubuntu-latest
    needs: terraform-check
    if: |
      always() &&
      (github.event.inputs.action == 'bootstrap' || github.event.inputs.action == 'ansible-only')
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Terraform Outputs
        if: github.event.inputs.action == 'bootstrap'
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible
          ansible --version
      
      - name: ğŸ”‘ Setup SSH Key
        run: |
          # SSH ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/sesacthon.pem
          chmod 600 ~/.ssh/sesacthon.pem
          
          # SSH ì—ì´ì „íŠ¸ ì‹œì‘ ë° í‚¤ ì¶”ê°€
          echo "ğŸ” Starting SSH Agent"
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/sesacthon.pem
          
          # SSH Config ì„¤ì •
          cat >> ~/.ssh/config <<EOF
          Host *
            IdentityFile ~/.ssh/sesacthon.pem
            IdentitiesOnly yes
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ServerAliveInterval 60
            ServerAliveCountMax 3
            AddKeysToAgent yes
          EOF
          
          chmod 600 ~/.ssh/config
      
      - name: ğŸ“ Create Ansible Inventory
        if: github.event.inputs.action == 'bootstrap'
        run: |
          # Terraform Outputì—ì„œ ìƒì„±ëœ ì¸ë²¤í† ë¦¬ ì‚¬ìš©
          cp /tmp/ansible-inventory.ini ansible/inventory/hosts.ini
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Ansible Inventory:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          cat ansible/inventory/hosts.ini
      
      - name: âš™ï¸ Run Ansible Playbook (site.yml)
        env:
          ANSIBLE_CONFIG: ${{ github.workspace }}/ansible/ansible.cfg
        run: |
          cd ansible
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Starting Ansible Bootstrap"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ansible-playbook site.yml \
            -i inventory/hosts.ini \
            --timeout=300 \
            -v
      
      - name: âœ… Bootstrap Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Infrastructure Bootstrap Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š GitOps Architecture:"
          echo "  1. âœ… Terraform: Managed by Atlantis (PR-based)"
          echo "  2. âœ… Kubernetes: Installed by Ansible"
          echo "  3. âœ… ArgoCD: Installed and ready"
          echo "  4. âœ… Atlantis: Ready for Terraform PRs"
          echo ""
          echo "ğŸ”— Next Steps:"
          echo "  1. Deploy Root App: kubectl apply -f argocd/root-app.yaml"
          echo "  2. Verify: argocd app get root-app"
          echo "  3. Atlantis URL: https://atlantis.sesacthon.com"
          echo ""
          echo "ğŸ“ Terraform Changes:"
          echo "  - Create PR with terraform/ changes"
          echo "  - Comment: atlantis plan"
          echo "  - Review and approve"
          echo "  - Comment: atlantis apply"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Job 3: ArgoCD Root Application ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  argocd-deploy:
    name: ğŸ”„ ArgoCD Root App
    runs-on: ubuntu-latest
    needs: ansible-bootstrap
    if: github.event.inputs.action == 'bootstrap'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs
          path: /tmp
      
      - name: ğŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: ğŸ”‘ Setup Kubeconfig
        run: |
          # SSH ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.kube ~/.ssh
          chmod 700 ~/.ssh
          
          # SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/sesacthon.pem
          chmod 600 ~/.ssh/sesacthon.pem
          
          # SSH ì—ì´ì „íŠ¸ ì‹œì‘
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/sesacthon.pem
          
          # Master IP ì¶”ì¶œ
          MASTER_IP=$(cat /tmp/tf-outputs.json | jq -r '.master_public_ip.value')
          
          # Master ë…¸ë“œì—ì„œ kubeconfig ê°€ì ¸ì˜¤ê¸°
          scp -o StrictHostKeyChecking=no \
            -i ~/.ssh/sesacthon.pem \
            ubuntu@${MASTER_IP}:/home/ubuntu/.kube/config \
            ~/.kube/config
          
          # Context í™•ì¸
          kubectl config current-context
          kubectl get nodes
      
      - name: ğŸš€ Deploy Root Application
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Deploying ArgoCD Root Application (App of Apps)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Root Application ë°°í¬
          kubectl apply -f argocd/root-app.yaml
          
          # ë™ê¸°í™” ëŒ€ê¸°
          sleep 10
          
          # ìƒíƒœ í™•ì¸
          kubectl get applications -n argocd
      
      - name: ğŸ“Š GitOps Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GitOps Architecture Deployed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Deployed Applications:"
          kubectl get applications -n argocd -o wide
          echo ""
          echo "ğŸ”— Access:"
          echo "  - ArgoCD: https://argocd.sesacthon.com"
          echo "  - Atlantis: https://atlantis.sesacthon.com"
          echo "  - Grafana: https://grafana.sesacthon.com"

