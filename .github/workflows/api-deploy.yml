name: Deploy API Services (GitOps Complete)

on:
  push:
    branches: [main, develop]
    paths:
      - 'services/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'services/**'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: sesacthon
  HELM_VALUES_PATH: charts/ecoeco-backend/values.yaml

jobs:
  # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.changes.outputs.auth }}
      my: ${{ steps.changes.outputs.my }}
      scan: ${{ steps.changes.outputs.scan }}
      character: ${{ steps.changes.outputs.character }}
      location: ${{ steps.changes.outputs.location }}
      info: ${{ steps.changes.outputs.info }}
      chat: ${{ steps.changes.outputs.chat }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            auth:
              - 'services/auth/**'
            my:
              - 'services/my/**'
            scan:
              - 'services/scan/**'
            character:
              - 'services/character/**'
            location:
              - 'services/location/**'
            info:
              - 'services/info/**'
            chat:
              - 'services/chat/**'

  # Matrix ì „ëµìœ¼ë¡œ ëª¨ë“  ë„ë©”ì¸ ë¹Œë“œ
  build-and-deploy:
    needs: detect-changes
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    strategy:
      matrix:
        service: [auth, my, scan, character, location, info, chat]
    # ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ
    if: |
      (matrix.service == 'auth' && needs.detect-changes.outputs.auth == 'true') ||
      (matrix.service == 'my' && needs.detect-changes.outputs.my == 'true') ||
      (matrix.service == 'scan' && needs.detect-changes.outputs.scan == 'true') ||
      (matrix.service == 'character' && needs.detect-changes.outputs.character == 'true') ||
      (matrix.service == 'location' && needs.detect-changes.outputs.location == 'true') ||
      (matrix.service == 'info' && needs.detect-changes.outputs.info == 'true') ||
      (matrix.service == 'chat' && needs.detect-changes.outputs.chat == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Lint & Test
        run: |
          cd services/${{ matrix.service }}
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov pycodestyle black isort flake8
          
          echo "::group::PEP 8 ê²€ì‚¬"
          pycodestyle . --max-line-length=100 --statistics || echo "âš ï¸ PEP 8 ê²½ê³ "
          echo "::endgroup::"
          
          echo "::group::Black í¬ë§· ê²€ì‚¬"
          black --check . || echo "âš ï¸ Black ê²½ê³ "
          echo "::endgroup::"
          
          echo "::group::isort Import ì •ë ¬ ê²€ì‚¬"
          isort --check-only . || echo "âš ï¸ isort ê²½ê³ "
          echo "::endgroup::"
          
          echo "::group::Flake8 ë¦°íŠ¸"
          flake8 . --statistics || echo "âš ï¸ Flake8 ê²½ê³ "
          echo "::endgroup::"
          
          echo "::group::pytest í…ŒìŠ¤íŠ¸"
          if [ -d tests/ ]; then
            pytest tests/ -v --cov=. --cov-report=term || echo "âš ï¸ í…ŒìŠ¤íŠ¸ ê²½ê³ "
          else
            echo "â„¹ï¸ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi
          echo "::endgroup::"
        continue-on-error: true
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,format=short
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
      
      - name: Update Helm values (GitOps Trigger)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ GitOps: Helm Values ì—…ë°ì´íŠ¸ ì¤‘..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ì„œë¹„ìŠ¤: ${{ matrix.service }}"
          echo "ì´ë¯¸ì§€ íƒœê·¸: sha-${SHORT_SHA}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Helm values íŒŒì¼ ì—…ë°ì´íŠ¸
          sed -i "s|tag: .*  # ${{ matrix.service }}-auto|tag: sha-${SHORT_SHA}  # ${{ matrix.service }}-auto|" \
            ${{ env.HELM_VALUES_PATH }}
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --quiet ${{ env.HELM_VALUES_PATH }}; then
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            exit 0
          fi
          
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit & Push
          git add ${{ env.HELM_VALUES_PATH }}
          git commit -m "chore(gitops): Update ${{ matrix.service }} image to sha-${SHORT_SHA}

Automated image tag update by GitHub Actions
- Service: ${{ matrix.service }}
- Image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:sha-${SHORT_SHA}}
- Triggered by: ${{ github.event.head_commit.message }}

This will trigger ArgoCD to sync and deploy to Kubernetes."
          
          # Push with retry
          for i in {1..3}; do
            if git push; then
              echo "âœ… Helm values ì—…ë°ì´íŠ¸ ì™„ë£Œ"
              exit 0
            fi
            echo "âš ï¸ Push ì‹¤íŒ¨, ì¬ì‹œë„ ($i/3)..."
            git pull --rebase
            sleep 2
          done
          
          echo "âŒ Helm values ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"
          exit 1
