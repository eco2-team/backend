name: CI Quality Gate

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: ci-quality-gate-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"

jobs:
  commit-filter:
    name: üõÇ Commit Filter
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      reason: ${{ steps.detect.outputs.reason }}
      commit_type: ${{ steps.detect.outputs.commit_type }}
    steps:
      - name: Detect conventional commit type
        id: detect
        run: |
          set -euo pipefail
          EVENT_NAME="${{ github.event_name }}"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            REF_TEXT="${{ github.event.pull_request.title }}"
          else
            REF_TEXT="${{ github.event.head_commit.message }}"
          fi
          REF_TEXT="${REF_TEXT:-none}"
          TYPE=$(echo "$REF_TEXT" | sed -n 's/^\([A-Za-z0-9_-]\+\):.*/\1/p' | tr '[:upper:]' '[:lower:]')
          if [[ "$TYPE" =~ ^(chore|docs)$ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Commit type '$TYPE' is configured to bypass CI quality gates" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=" >> "$GITHUB_OUTPUT"
          fi
          if [ -z "$TYPE" ]; then
            TYPE="unknown"
          fi
          echo "commit_type=$TYPE" >> "$GITHUB_OUTPUT"

  skip-notice:
    name: ‚è≠Ô∏è CI Skipped
    needs: commit-filter
    if: needs.commit-filter.outputs.skip == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Publish skip summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## ‚è≠Ô∏è CI Skipped
          - Reason: ${{ needs.commit-filter.outputs.reason }}
          - Commit type: `${{ needs.commit-filter.outputs.commit_type }}`
          EOF

  terraform:
    name: üèóÔ∏è Terraform Validate
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform fmt & validate
        working-directory: terraform
        run: |
          set -euo pipefail
          terraform fmt -check -recursive
          terraform init -backend=false -input=false
          terraform validate -no-color

      - name: Publish summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## üèóÔ∏è Terraform Validate
          - terraform fmt -check
          - terraform validate (backend disabled)
          EOF

  helm-tests:
    name: ‚õµ Helm Template Tests
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Render Helm charts (dev/prod)
        run: |
          rm -rf ci-artifacts/helm
          scripts/ci/helm-template.sh

      - name: Upload Helm manifests
        uses: actions/upload-artifact@v4
        with:
          name: helm-manifests
          path: ci-artifacts/helm
          if-no-files-found: error

  kustomize-validate:
    name: üß± Kustomize + Kubeconform
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: 5.2.1

      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.6/kubeconform-linux-amd64.tar.gz \
            | tar -C /tmp -xz
          sudo install /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Build & validate overlays
        env:
          KUBECONFORM_BIN: kubeconform
        run: |
          rm -rf ci-artifacts/kustomize
          scripts/ci/kustomize-validate.sh

      - name: Upload Kustomize manifests
        uses: actions/upload-artifact@v4
        with:
          name: kustomize-manifests
          path: ci-artifacts/kustomize
          if-no-files-found: error

  render-parity:
    name: üß© Render Parity (Helm‚ÜíKustomize)
    runs-on: ubuntu-latest
    needs:
      - helm-tests
      - kustomize-validate
    if: needs.helm-tests.result == 'success' && needs.kustomize-validate.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Helm manifests
        uses: actions/download-artifact@v4
        with:
          name: helm-manifests
          path: ci-artifacts/helm

      - name: Download Kustomize manifests
        uses: actions/download-artifact@v4
        with:
          name: kustomize-manifests
          path: ci-artifacts/kustomize

      - name: Assemble rendered manifests
        run: |
          rm -rf ci-artifacts/render
          scripts/ci/render-like-argocd.sh

      - name: Upload combined manifests
        uses: actions/upload-artifact@v4
        with:
          name: rendered-manifests
          path: ci-artifacts/render
          if-no-files-found: error

  server-dry-run:
    name: üåê Server-side Dry Run
    runs-on: ubuntu-latest
    needs:
      - render-parity
    if: needs.render-parity.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download rendered manifests
        uses: actions/download-artifact@v4
        with:
          name: rendered-manifests
          path: ci-artifacts/render

      - name: Create kind cluster
        uses: helm/kind-action@v1

      - name: Server-side dry run
        run: |
          scripts/ci/server-dry-run.sh

  appset-verify:
    name: üìã ApplicationSet Generate
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Argo CD CLI
        run: |
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v2.10.5/argocd-linux-amd64
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: Generate ApplicationSet manifests (dev/prod)
        run: |
          argocd appset generate -f clusters/dev/apps/60-apis-appset.yaml > /tmp/appset-dev.yaml
          argocd appset generate -f clusters/prod/apps/60-apis-appset.yaml > /tmp/appset-prod.yaml
          cat /tmp/appset-dev.yaml /tmp/appset-prod.yaml >/tmp/appset-all.yaml
          echo "Generated Application resources:"
          cat /tmp/appset-all.yaml

  detect-api-changes:
    name: üîç Detect API Changes
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    outputs:
      has_changes: ${{ steps.prepare.outputs.has_changes }}
      services: ${{ steps.prepare.outputs.services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Changed files
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            services/**

      - name: Prepare service matrix
        id: prepare
        run: |
          if [ "${{ steps.changes.outputs.any_changed }}" != "true" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo 'services=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          python3 <<'PYEOF'
          import json
          import os
          
          files = os.environ.get("CHANGED_FILES", "").split()
          services = []
          
          for path in files:
              parts = path.split("/")
              if len(parts) >= 2 and parts[0] == "services":
                  svc = parts[1]
                  service_path = os.path.join("services", svc)
                  if not os.path.isdir(service_path):
                      continue
                  if svc and svc not in services:
                      services.append(svc)
          
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              if not services:
                  out.write("has_changes=false\n")
                  out.write("services=[]\n")
              else:
                  out.write("has_changes=true\n")
                  out.write(f"services={json.dumps(services)}\n")
          PYEOF
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.all_changed_files }}

  api-quality:
    name: üß™ API Lint & Test
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-api-changes
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-api-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-api-changes.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install black==24.4.2 ruff==0.6.9 pytest==8.3.3
          pip install -r services/${{ matrix.service }}/requirements.txt

      - name: Black (format check)
        run: black --check services/${{ matrix.service }}

      - name: Ruff lint
        run: ruff check services/${{ matrix.service }}

      - name: Pytest
        working-directory: services/${{ matrix.service }}
        env:
          PYTHONPATH: ${{ github.workspace }}/services/${{ matrix.service }}
        run: pytest

  api-build-push:
    name: üì¶ Build & Push API Images
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-api-changes
      - api-quality
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-api-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-api-changes.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: services/${{ matrix.service }}
          file: services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ghcr.io/sesacthon/${{ matrix.service }}-api:${{ github.sha }}
            ghcr.io/sesacthon/${{ matrix.service }}-api:latest

