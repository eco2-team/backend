name: CI Services Quality Gate

on:
  push:
    branches:
      - main
      - develop
      - refactor/gitops-sync-wave
    paths:
      - "services/**"
      - "scripts/**"
      - ".github/workflows/ci-services.yml"
  pull_request:
    branches:
      - main
      - develop
      - refactor/gitops-sync-wave
    paths:
      - "services/**"
      - "scripts/**"
      - ".github/workflows/ci-services.yml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: ci-services-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  commit-filter:
    name: üõÇ Commit Filter
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      reason: ${{ steps.detect.outputs.reason }}
      commit_type: ${{ steps.detect.outputs.commit_type }}
    steps:
      - name: Detect conventional commit type
        id: detect
        run: |
          set -euo pipefail
          EVENT_NAME="${{ github.event_name }}"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            REF_TEXT="${{ github.event.pull_request.title }}"
          else
            REF_TEXT="${{ github.event.head_commit.message }}"
          fi
          REF_TEXT="${REF_TEXT:-none}"
          TYPE=$(echo "$REF_TEXT" | sed -n 's/^\([A-Za-z0-9_-]\+\):.*/\1/p' | tr '[:upper:]' '[:lower:]')
          if [[ "$TYPE" =~ ^(docs)$ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Commit type '$TYPE' is configured to bypass service CI" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=" >> "$GITHUB_OUTPUT"
          fi
          if [ -z "$TYPE" ]; then
            TYPE="unknown"
          fi
          echo "commit_type=$TYPE" >> "$GITHUB_OUTPUT"

  skip-notice:
    name: ‚è≠Ô∏è CI Skipped
    needs: commit-filter
    if: needs.commit-filter.outputs.skip == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Publish skip summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## ‚è≠Ô∏è Service CI Skipped
          - Reason: ${{ needs.commit-filter.outputs.reason }}
          - Commit type: `${{ needs.commit-filter.outputs.commit_type }}`
          EOF

  detect-api-changes:
    name: üîç Detect API Changes
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    outputs:
      has_changes: ${{ steps.prepare.outputs.has_changes }}
      services: ${{ steps.prepare.outputs.services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Changed files
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            services/**

      - name: Prepare service matrix
        id: prepare
        run: |
          if [ "${{ steps.changes.outputs.any_changed }}" != "true" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo 'services=[]' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          python3 <<'PYEOF'
          import json
          import os

          files = os.environ.get("CHANGED_FILES", "").split()
          services = []

          for path in files:
              parts = path.split("/")
              if len(parts) >= 2 and parts[0] == "services":
                  svc = parts[1]
                  service_path = os.path.join("services", svc)
                  if not os.path.isdir(service_path):
                      continue
                  if svc and svc not in services:
                      services.append(svc)

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              if not services:
                  out.write("has_changes=false\n")
                  out.write("services=[]\n")
              else:
                  out.write("has_changes=true\n")
                  out.write(f"services={json.dumps(services)}\n")
          PYEOF
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.all_changed_files }}

  api-quality:
    name: üß™ API Lint & Test
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-api-changes
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-api-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-api-changes.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install black==24.4.2 ruff==0.6.9 pytest==8.3.3
          pip install -r services/${{ matrix.service }}/requirements.txt

      - name: Black (format check)
        run: black --check services/${{ matrix.service }}

      - name: Ruff lint
        run: ruff check services/${{ matrix.service }}

      - name: Pytest
        working-directory: services/${{ matrix.service }}
        env:
          PYTHONPATH: ${{ github.workspace }}/services/${{ matrix.service }}
        run: pytest

  api-build-push:
    name: üì¶ Build & Push API Images
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-api-changes
      - api-quality
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-api-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-api-changes.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare image tags
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          SERVICE="${{ matrix.service }}"
          REGISTRY="docker.io/eco2"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            IS_PR=true
            BASE_REF="${{ github.event.pull_request.base.ref }}"
          else
            IS_PR=false
            BASE_REF="${GITHUB_REF##*/}"
          fi
          VERSION=$(cat VERSION)
          if [ "$BASE_REF" = "main" ] && [ "$IS_PR" = "false" ]; then
            UNIQUE_TAG="${SERVICE}-${VERSION}-${SHORT_SHA}"
            {
              echo "tags<<TAGS"
              echo "${REGISTRY}/${SERVICE}-api:${UNIQUE_TAG}"
              echo "${REGISTRY}/${SERVICE}-api:prod-latest"
              echo "${REGISTRY}/${SERVICE}-api:latest"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "tags<<TAGS"
              echo "${REGISTRY}/${SERVICE}-api:dev-${SHORT_SHA}"
              echo "${REGISTRY}/${SERVICE}-api:dev-latest"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: services/${{ matrix.service }}
          file: services/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}


