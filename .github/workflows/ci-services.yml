name: CI Services Quality Gate

on:
  push:
    branches:
      - main
      - develop
    paths:
      # FastAPI API ì„œë¹„ìŠ¤ (apps/ Clean Architecture)
      - "apps/auth/**"
      - "apps/users/**"
      - "apps/character/**"
      - "apps/location/**"
      - "apps/scan/**"
      - "apps/images/**"
      # ë ˆê±°ì‹œ ì„œë¹„ìŠ¤ (ì•„ì§ ë§ˆì´ê·¸ë ˆì´ì…˜ ì•ˆ ë¨)
      - "domains/chat/**"
      - "domains/_shared/**"
      # Kubernetes manifests
      - "workloads/domains/auth/**"
      - "workloads/domains/users/**"
      - "workloads/domains/character/**"
      - "workloads/domains/location/**"
      - "workloads/domains/scan/**"
      - "workloads/domains/chat/**"
      - "workloads/domains/image/**"
      # WorkerëŠ” ë³„ë„ íŒŒì´í”„ë¼ì¸ â†’ ci-workers.yml
      # ext-authzëŠ” Go â†’ ci-ext-authz.yml
      # sse-gateway, event-routerëŠ” â†’ ci-sse-components.yml
  pull_request:
    branches:
      - main
      - develop
    paths:
      # FastAPI API ì„œë¹„ìŠ¤ (apps/ Clean Architecture)
      - "apps/auth/**"
      - "apps/users/**"
      - "apps/character/**"
      - "apps/location/**"
      - "apps/scan/**"
      - "apps/images/**"
      # ë ˆê±°ì‹œ ì„œë¹„ìŠ¤ (ì•„ì§ ë§ˆì´ê·¸ë ˆì´ì…˜ ì•ˆ ë¨)
      - "domains/chat/**"
      - "domains/_shared/**"
      # Kubernetes manifests
      - "workloads/domains/auth/**"
      - "workloads/domains/users/**"
      - "workloads/domains/character/**"
      - "workloads/domains/location/**"
      - "workloads/domains/scan/**"
      - "workloads/domains/chat/**"
      - "workloads/domains/image/**"
      # WorkerëŠ” ë³„ë„ íŒŒì´í”„ë¼ì¸ â†’ ci-workers.yml
      # ext-authzëŠ” Go â†’ ci-ext-authz.yml
      # sse-gateway, event-routerëŠ” â†’ ci-sse-components.yml
  workflow_dispatch:
    inputs:
      force_all:
        description: "ëª¨ë“  API ì„œë¹„ìŠ¤ë¥¼ ê°•ì œë¡œ ë¹Œë“œ/í‘¸ì‹œ"
        type: boolean
        default: false
      target_services:
        description: "ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ì„œë¹„ìŠ¤ ì´ë¦„ ëª©ë¡ (ì˜ˆ: auth,users,chat)"
        required: false

permissions:
  contents: write
  packages: write

concurrency:
  group: ci-services-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  commit-filter:
    name: ğŸ›‚ Commit Filter
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      reason: ${{ steps.detect.outputs.reason }}
      commit_type: ${{ steps.detect.outputs.commit_type }}
      is_canary_merge: ${{ steps.detect.outputs.is_canary_merge }}
    steps:
      - name: Detect conventional commit type
        id: detect
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          GITHUB_ACTOR: ${{ github.actor }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          
          # ê¸°ë³¸ê°’ ì„¤ì •
          echo "is_canary_merge=false" >> "$GITHUB_OUTPUT"
          
          if [ "${GITHUB_ACTOR}" = "github-actions[bot]" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Triggered by github-actions bot (manifest bump)" >> "$GITHUB_OUTPUT"
            echo "commit_type=bot" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          if [ "$EVENT_NAME" = "pull_request" ]; then
            REF_TEXT="$PR_TITLE"
          else
            # ì²« ë²ˆì§¸ ì¤„ë§Œ ì‚¬ìš© (ë©€í‹°ë¼ì¸ ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ë³¸ë¬¸ ì œì™¸)
            # printf | head ì¡°í•©ì€ pipefail í™˜ê²½ì—ì„œ SIGPIPE ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥
            REF_TEXT="${COMMIT_MSG%%$'\n'*}"
            
            # Push ì´ë²¤íŠ¸: canary PR ë¨¸ì§€ì¸ì§€ í™•ì¸
            PR_NUM=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | head -1 | tr -d '#' || true)
            if [ -n "$PR_NUM" ]; then
              LABELS=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUM" --jq '.labels[].name' 2>/dev/null || true)
              if echo "$LABELS" | grep -q "^canary$"; then
                echo "is_canary_merge=true" >> "$GITHUB_OUTPUT"
                echo "skip=true" >> "$GITHUB_OUTPUT"
                echo "reason=Canary PR merge - stable build handled by ci-canary.yml" >> "$GITHUB_OUTPUT"
                echo "commit_type=canary" >> "$GITHUB_OUTPUT"
                echo "ğŸ¤ Canary PR #$PR_NUM merge detected - skipping stable build"
                exit 0
              fi
            fi
          fi
          
          REF_TEXT="${REF_TEXT:-none}"
          TYPE=$(printf '%s\n' "$REF_TEXT" | sed -n 's/^\([A-Za-z0-9_-]\+\):.*/\1/p' | tr '[:upper:]' '[:lower:]')
          if [[ "$TYPE" =~ ^(docs)$ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Commit type '$TYPE' is configured to bypass service CI" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=" >> "$GITHUB_OUTPUT"
          fi
          if [ -z "$TYPE" ]; then
            TYPE="unknown"
          fi
          echo "commit_type=$TYPE" >> "$GITHUB_OUTPUT"

  skip-notice:
    name: â­ï¸ CI Skipped
    needs: commit-filter
    if: needs.commit-filter.outputs.skip == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Publish skip summary
        env:
          IS_CANARY: ${{ needs.commit-filter.outputs.is_canary_merge }}
        run: |
          cat <<EOF >> "$GITHUB_STEP_SUMMARY"
          ## â­ï¸ Service CI Skipped
          - Reason: ${{ needs.commit-filter.outputs.reason }}
          - Commit type: \`${{ needs.commit-filter.outputs.commit_type }}\`
          EOF
          
          if [ "$IS_CANARY" = "true" ]; then
            cat <<'CANARY' >> "$GITHUB_STEP_SUMMARY"
          
          ### ğŸ¤ Canary Deployment
          
          Canary PR ë¨¸ì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. Stable ë¹Œë“œëŠ” ê±´ë„ˆë›°ê³  **ci-canary.yml**ì—ì„œ canary ì´ë¯¸ì§€ë§Œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
          
          ArgoCD Image Updaterê°€ canary ì´ë¯¸ì§€ ë³€ê²½ì„ ê°ì§€í•˜ë©´ ìë™ìœ¼ë¡œ canary deploymentê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
          
          **í…ŒìŠ¤íŠ¸ ë°©ë²•:**
          \`\`\`bash
          curl -H "X-Canary: true" https://api.growbin.app/api/v1/<service>/health
          \`\`\`
          CANARY
          fi

  detect-api-changes:
    name: ğŸ” Detect API Changes
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    outputs:
      has_changes: ${{ steps.prepare.outputs.has_changes }}
      services: ${{ steps.prepare.outputs.services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Changed files
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            apps/auth/**
            apps/users/**
            apps/character/**
            apps/location/**
            apps/scan/**
            apps/images/**
            domains/chat/**
            workloads/domains/auth/**
            workloads/domains/users/**
            workloads/domains/character/**
            workloads/domains/location/**
            workloads/domains/scan/**
            workloads/domains/chat/**
            workloads/domains/image/**

      - name: Prepare service matrix
        id: prepare
        run: |
          python3 <<'PYEOF'
          import json
          import os
          import sys
          from collections import OrderedDict

          files = os.environ.get("CHANGED_FILES", "").split()
          any_changed = os.environ.get("ANY_CHANGED", "false").lower() == "true"
          event_name = os.environ.get("EVENT_NAME", "")
          force_all = os.environ.get("FORCE_ALL", "false").lower() == "true"
          
          # FastAPI API ì„œë¹„ìŠ¤ ëª©ë¡
          # - apps/: Clean Architecture (ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ)
          # - domains/chat: ë ˆê±°ì‹œ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì •)
          # ext-authzëŠ” Go â†’ ci-ext-authz.yml
          # sse-gateway, event-router â†’ ci-sse-components.yml
          SERVICES = [
              "auth",      # apps/auth
              "users",     # apps/users (êµ¬ domains/my)
              "character", # apps/character
              "location",  # apps/location
              "scan",      # apps/scan
              "images",    # apps/images (êµ¬ domains/image)
              "chat",      # domains/chat (ë ˆê±°ì‹œ)
          ]
          
          alias_map = {
              "info": "images",
              "image": "images",  # ë ˆê±°ì‹œ alias
          }

          def normalize(service: str) -> str:
              return alias_map.get(service, service)

          raw_targets = [
              s.strip()
              for s in os.environ.get("TARGET_SERVICES", "").split(",")
              if s.strip()
          ]
          target_services = [normalize(s) for s in raw_targets]

          services = []
          all_services = sorted(SERVICES)

          if event_name == "workflow_dispatch":
              if force_all:
                  services = all_services
              elif target_services:
                  invalid = [svc for svc in target_services if svc not in all_services]
                  if invalid:
                      sys.stderr.write(f"Unknown services: {', '.join(invalid)}\n")
                      sys.exit(1)
                  services = list(OrderedDict.fromkeys(target_services))

          if not services and any_changed:
              for path in files:
                  parts = path.split("/")
                  # apps/<service>/ ê²½ë¡œ ê°ì§€ (Clean Architecture)
                  if len(parts) >= 2 and parts[0] == "apps":
                      svc = normalize(parts[1])
                      if svc and svc in all_services and svc not in services:
                          services.append(svc)
                  # domains/<service>/ ê²½ë¡œ ê°ì§€ (ë ˆê±°ì‹œ: chat, image)
                  elif len(parts) >= 2 and parts[0] == "domains":
                      svc = normalize(parts[1])
                      if svc and svc in all_services and svc not in services:
                          services.append(svc)
                  # workloads/domains/<service>/ ê²½ë¡œ ê°ì§€
                  elif len(parts) >= 3 and parts[0] == "workloads" and parts[1] == "domains":
                      svc = normalize(parts[2])
                      if svc and svc in all_services and svc not in services:
                          services.append(svc)

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              if services:
                  out.write("has_changes=true\n")
                  out.write(f"services={json.dumps(services)}\n")
              else:
                  out.write("has_changes=false\n")
                  out.write("services=[]\n")
          PYEOF
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.all_changed_files }}
          ANY_CHANGED: ${{ steps.changes.outputs.any_changed }}
          EVENT_NAME: ${{ github.event_name }}
          FORCE_ALL: ${{ github.event.inputs.force_all || 'false' }}
          TARGET_SERVICES: ${{ github.event.inputs.target_services || '' }}

  api-quality:
    name: ğŸ§ª API Lint & Test
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-api-changes
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-api-changes.outputs.has_changes == 'true'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-api-changes.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Determine source path
        id: source
        run: |
          SERVICE="${{ matrix.service }}"
          if [ -d "apps/${SERVICE}" ]; then
            echo "path=apps/${SERVICE}" >> "$GITHUB_OUTPUT"
            # apps/ ì„œë¹„ìŠ¤: apps ë””ë ‰í† ë¦¬ê°€ PYTHONPATH (from images.*, from scan.* ë“±)
            echo "pythonpath=${{ github.workspace }}/apps" >> "$GITHUB_OUTPUT"
            echo "is_legacy=false" >> "$GITHUB_OUTPUT"
          else
            # ë ˆê±°ì‹œ ì„œë¹„ìŠ¤ (chat) - í…ŒìŠ¤íŠ¸ skip
            echo "path=domains/${SERVICE}" >> "$GITHUB_OUTPUT"
            echo "pythonpath=${{ github.workspace }}/domains/${SERVICE}" >> "$GITHUB_OUTPUT"
            echo "is_legacy=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install black==24.4.2 ruff==0.6.9 pytest==8.3.3 pytest-asyncio==0.24.0
          pip install -r ${{ steps.source.outputs.path }}/requirements.txt

      - name: Black (format check)
        run: black --check ${{ steps.source.outputs.path }}

      - name: Ruff lint
        run: ruff check ${{ steps.source.outputs.path }}

      - name: Pytest
        if: steps.source.outputs.is_legacy != 'true'
        working-directory: ${{ steps.source.outputs.path }}
        env:
          PYTHONPATH: ${{ steps.source.outputs.pythonpath }}
        run: pytest

  api-build-push:
    name: ğŸ“¦ Build & Push API Images
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-api-changes
      - api-quality
    # PRì—ì„œëŠ” í…ŒìŠ¤íŠ¸ë§Œ, push ë˜ëŠ” workflow_dispatch ì‹œì—ë§Œ ë¹Œë“œ/í‘¸ì‹œ
    if: >
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-api-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        service: ${{ fromJson(needs.detect-api-changes.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare image tags
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          SERVICE="${{ matrix.service }}"
          IMAGE_REPO="docker.io/mng990/eco2"
          # sse-gatewayëŠ” ì´ë¯¸ ì´ë¦„ì— ì—­í• ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ -api suffix ì œì™¸
          if [[ "$SERVICE" == *"-gateway"* ]]; then
            SERVICE_SLUG="${SERVICE}"
          else
            SERVICE_SLUG="${SERVICE}-api"
          fi
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            IS_PR=true
            BASE_REF="${{ github.event.pull_request.base.ref }}"
          else
            IS_PR=false
            BASE_REF="${GITHUB_REF##*/}"
          fi
          VERSION=$(cat VERSION)
          if [ "$BASE_REF" = "main" ] && [ "$IS_PR" = "false" ]; then
            UNIQUE_TAG="${SERVICE_SLUG}-${VERSION}-${SHORT_SHA}"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${UNIQUE_TAG}"
              echo "${IMAGE_REPO}:${SERVICE_SLUG}-prod-latest"
              echo "${IMAGE_REPO}:${SERVICE_SLUG}-latest"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "tag_name=${UNIQUE_TAG}" >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${UNIQUE_TAG}" >> "$GITHUB_OUTPUT"
          else
            DEV_TAG="${SERVICE_SLUG}-dev-${SHORT_SHA}"
            DEV_LATEST_TAG="${SERVICE_SLUG}-dev-latest"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${DEV_TAG}"
              echo "${IMAGE_REPO}:${DEV_LATEST_TAG}"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "tag_name=${DEV_TAG}" >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${DEV_LATEST_TAG}" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine Dockerfile path
        id: dockerfile
        run: |
          SERVICE="${{ matrix.service }}"
          # Clean Architecture ë¦¬íŒ©í† ë§ëœ ì„œë¹„ìŠ¤ëŠ” apps/ ê²½ë¡œ ì‚¬ìš©
          if [ -f "apps/${SERVICE}/Dockerfile" ]; then
            echo "path=apps/${SERVICE}/Dockerfile" >> "$GITHUB_OUTPUT"
          else
            echo "path=domains/${SERVICE}/Dockerfile" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dockerfile.outputs.path }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Sync manifest branch
        if: >
          (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          git fetch origin "${BRANCH_NAME}"
          git checkout -B "${BRANCH_NAME}"
          git pull --rebase origin "${BRANCH_NAME}"

      - name: Update dev manifest tag
        if: >
          github.ref == 'refs/heads/develop'
        id: update_dev
        env:
          KUSTOMIZE_FILE: workloads/domains/${{ matrix.service }}/dev/kustomization.yaml
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
        run: |
          python -m pip install --upgrade pip pyyaml
          python scripts/ci/update_kustomize_image.py \
            --file "$KUSTOMIZE_FILE" \
            --image docker.io/mng990/eco2 \
            --tag "$TAG_NAME"
          if git diff --quiet -- "$KUSTOMIZE_FILE"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "file=$KUSTOMIZE_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Update prod manifest tag
        if: >
          github.ref == 'refs/heads/main'
        id: update_prod
        env:
          KUSTOMIZE_FILE: workloads/domains/${{ matrix.service }}/prod/kustomization.yaml
          TAG_NAME: ${{ steps.meta.outputs.tag_name }}
        run: |
          python -m pip install --upgrade pip pyyaml
          python scripts/ci/update_kustomize_image.py \
            --file "$KUSTOMIZE_FILE" \
            --image docker.io/mng990/eco2 \
            --tag "$TAG_NAME"
          if git diff --quiet -- "$KUSTOMIZE_FILE"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "file=$KUSTOMIZE_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit manifest updates
        if: >
          (steps.update_dev.outputs.changed == 'true') ||
          (steps.update_prod.outputs.changed == 'true')
        env:
          DEV_FILE: ${{ steps.update_dev.outputs.file }}
          PROD_FILE: ${{ steps.update_prod.outputs.file }}
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
          SERVICE: ${{ matrix.service }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "${DEV_FILE}" ]; then git add "${DEV_FILE}"; fi
          if [ -n "${PROD_FILE}" ]; then git add "${PROD_FILE}"; fi
          git commit -m "chore(${SERVICE}): bump image tag to ${TAG_NAME} [skip ci]"
          git push origin HEAD:${GITHUB_REF_NAME}

  # ============================================================================
  # Base Image Build (ê³µí†µ ì˜ì¡´ì„±)
  # ============================================================================
  base-build-push:
    name: ğŸ—ï¸ Build & Push Base Image
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-api-changes
    if: >
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Check for base changes
        id: check
        run: |
          # Base ì´ë¯¸ì§€ ë³€ê²½ ì—¬ë¶€ í™•ì¸ (ê°„ì†Œí™”ëœ ë¡œì§)
          echo "should_build=true" >> "$GITHUB_OUTPUT"

      - name: Checkout
        if: steps.check.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: steps.check.outputs.should_build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: steps.check.outputs.should_build == 'true'
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare base image tags
        if: steps.check.outputs.should_build == 'true'
        id: meta
        run: |
          IMAGE_REPO="docker.io/mng990/eco2"
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "tags=${IMAGE_REPO}:base-prod-latest,${IMAGE_REPO}:base-latest" >> "$GITHUB_OUTPUT"
          else
            echo "tags=${IMAGE_REPO}:base-dev-latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push base image
        if: steps.check.outputs.should_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: domains/_base/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Worker Image Build â†’ ci-workers.ymlë¡œ ë¶„ë¦¬ë¨
  # ============================================================================
