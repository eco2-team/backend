name: CI Infra Quality Gate

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "terraform/**"
      - "argocd/**"
      - "clusters/**"
      - "platform/helm/**"
      - "workloads/**"
      - "scripts/ci/**"
      - "docs/networking/**"
      - ".github/workflows/ci-infra.yml"
      - ".github/ct-config.yaml"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "terraform/**"
      - "argocd/**"
      - "clusters/**"
      - "platform/helm/**"
      - "workloads/**"
      - "scripts/ci/**"
      - "docs/networking/**"
      - ".github/workflows/ci-infra.yml"
      - ".github/ct-config.yaml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: ci-infra-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  TF_IN_AUTOMATION: "true"

jobs:
  commit-filter:
    name: üõÇ Commit Filter
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      reason: ${{ steps.detect.outputs.reason }}
      commit_type: ${{ steps.detect.outputs.commit_type }}
    steps:
      - name: Detect conventional commit type
        id: detect
        env:
          EVENT_NAME: ${{ github.event_name }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          set -euo pipefail
          if [ "$EVENT_NAME" = "pull_request" ]; then
            REF_TEXT="$PR_TITLE"
          else
            REF_TEXT="$COMMIT_MSG"
          fi
          REF_TEXT="${REF_TEXT:-none}"
          TYPE=$(echo "$REF_TEXT" | sed -n 's/^\([A-Za-z0-9_-]\+\):.*/\1/p' | tr '[:upper:]' '[:lower:]')
          if [[ "$TYPE" =~ ^(docs)$ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Commit type '$TYPE' is configured to bypass infra CI" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=" >> "$GITHUB_OUTPUT"
          fi
          if [ -z "$TYPE" ]; then
            TYPE="unknown"
          fi
          echo "commit_type=$TYPE" >> "$GITHUB_OUTPUT"

  skip-notice:
    name: ‚è≠Ô∏è CI Skipped
    needs: commit-filter
    if: needs.commit-filter.outputs.skip == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Publish skip summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## ‚è≠Ô∏è Infra CI Skipped
          - Reason: ${{ needs.commit-filter.outputs.reason }}
          - Commit type: `${{ needs.commit-filter.outputs.commit_type }}`
          EOF

  terraform:
    name: üèóÔ∏è Terraform Validate
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform fmt & validate
        working-directory: terraform
        run: |
          set -euo pipefail
          terraform fmt -check -recursive
          terraform init -backend=false -input=false
          terraform validate -no-color

      - name: Publish summary
        run: |
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          ## üèóÔ∏è Terraform Validate
          - terraform fmt -check
          - terraform validate (backend disabled)
          EOF

  helm-tests:
    name: ‚õµ Helm Template Tests
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Render Helm charts (dev/prod)
        run: |
          rm -rf ci-artifacts/helm
          scripts/ci/helm-template.sh

      - name: Upload Helm manifests
        uses: actions/upload-artifact@v4
        with:
          name: helm-manifests
          path: ci-artifacts/helm
          if-no-files-found: error

  helm-ct:
    name: üß™ Helm Chart Testing
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Helm chart changes
        id: helm_changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            platform/helm/**
            scripts/ci/helm-template.sh
            scripts/ci/generate-ct-charts.sh
            .github/ct-config.yaml

      - name: Skip Helm chart tests
        if: steps.helm_changes.outputs.any_changed != 'true'
        run: echo "No Helm chart changes detected."

      - name: Generate stub charts for ct
        if: steps.helm_changes.outputs.any_changed == 'true'
        run: scripts/ci/generate-ct-charts.sh

      - name: Install chart-testing (ct)
        if: steps.helm_changes.outputs.any_changed == 'true'
        uses: helm/chart-testing-action@v2.6.1

      - name: Lint charts (ct)
        if: steps.helm_changes.outputs.any_changed == 'true'
        run: ct lint --config .github/ct-config.yaml

      - name: Create kind cluster (ct)
        if: steps.helm_changes.outputs.any_changed == 'true'
        uses: helm/kind-action@v1

      - name: Install charts in kind (ct)
        if: steps.helm_changes.outputs.any_changed == 'true'
        run: ct install --config .github/ct-config.yaml

  kustomize-validate:
    name: üß± Kustomize + Kubeconform
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: 5.2.1

      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.6/kubeconform-linux-amd64.tar.gz \
            | tar -C /tmp -xz
          sudo install /tmp/kubeconform /usr/local/bin/kubeconform

      - name: Build & validate overlays
        env:
          KUBECONFORM_BIN: kubeconform
        run: |
          rm -rf ci-artifacts/kustomize
          scripts/ci/kustomize-validate.sh

      - name: Upload Kustomize manifests
        uses: actions/upload-artifact@v4
        with:
          name: kustomize-manifests
          path: ci-artifacts/kustomize
          if-no-files-found: error

  render-parity:
    name: üß© Render Parity (Helm‚ÜíKustomize)
    runs-on: ubuntu-latest
    needs:
      - helm-tests
      - kustomize-validate
    if: needs.helm-tests.result == 'success' && needs.kustomize-validate.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Helm manifests
        uses: actions/download-artifact@v4
        with:
          name: helm-manifests
          path: ci-artifacts/helm

      - name: Download Kustomize manifests
        uses: actions/download-artifact@v4
        with:
          name: kustomize-manifests
          path: ci-artifacts/kustomize

      - name: Assemble rendered manifests
        run: |
          rm -rf ci-artifacts/render
          scripts/ci/render-like-argocd.sh

      - name: Upload combined manifests
        uses: actions/upload-artifact@v4
        with:
          name: rendered-manifests
          path: ci-artifacts/render
          if-no-files-found: error

