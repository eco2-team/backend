name: CI Canary Build

# PRÏóê 'canary' ÎùºÎ≤®Ïù¥ Î∂ôÏúºÎ©¥ canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
# PR Î®∏ÏßÄ ÏãúÏóêÎèÑ canary Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
on:
  pull_request:
    types: [labeled, synchronize]
    branches:
      - develop
      - main
  push:
    branches:
      - develop
      - main
    paths:
      - "apps/**"
      # Î†àÍ±∞Ïãú ÏÑúÎπÑÏä§ (ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò ÎåÄÍ∏∞)
      - "domains/chat/**"
      - "domains/_shared/**"

permissions:
  contents: write
  packages: write
  pull-requests: read

concurrency:
  group: ci-canary-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Canary ÎùºÎ≤® Ï≤¥ÌÅ¨
  # ============================================================================
  check-canary-label:
    name: üè∑Ô∏è Check Canary Label
    runs-on: ubuntu-latest
    outputs:
      is_canary: ${{ steps.check.outputs.is_canary }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check for canary label
        id: check
        env:
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels.*.name) }}
          EVENT_NAME: ${{ github.event_name }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "$EVENT_NAME" = "pull_request" ]; then
            # PR Ïù¥Î≤§Ìä∏: ÏßÅÏ†ë ÎùºÎ≤® Ï≤¥ÌÅ¨
            if echo "$PR_LABELS" | jq -e 'contains(["canary"])' > /dev/null; then
              echo "is_canary=true" >> "$GITHUB_OUTPUT"
              echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
              echo "‚úÖ Canary label detected (PR event)"
            else
              echo "is_canary=false" >> "$GITHUB_OUTPUT"
              echo "‚ÑπÔ∏è No canary label - skipping"
            fi
          else
            # Push Ïù¥Î≤§Ìä∏: Ïª§Î∞ã Î©îÏãúÏßÄÏóêÏÑú PR Î≤àÌò∏ Ï∂îÏ∂ú ÌõÑ ÎùºÎ≤® ÌôïÏù∏
            # Squash merge: "Title (#123)" ÎòêÎäî Merge commit: "Merge pull request #123"
            PR_NUM=$(echo "$COMMIT_MSG" | grep -oE '#[0-9]+' | head -1 | tr -d '#' || true)
            
            if [ -n "$PR_NUM" ]; then
              echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
              echo "üìå Found PR #$PR_NUM from commit message"
              
              # GitHub APIÎ°ú PR ÎùºÎ≤® ÌôïÏù∏
              LABELS=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUM" --jq '.labels[].name' 2>/dev/null || true)
              
              if echo "$LABELS" | grep -q "^canary$"; then
                echo "is_canary=true" >> "$GITHUB_OUTPUT"
                echo "‚úÖ Canary label detected (from merged PR #$PR_NUM)"
              else
                echo "is_canary=false" >> "$GITHUB_OUTPUT"
                echo "‚ÑπÔ∏è PR #$PR_NUM has no canary label - skipping"
              fi
            else
              echo "is_canary=false" >> "$GITHUB_OUTPUT"
              echo "‚ÑπÔ∏è No PR number in commit - skipping"
            fi
          fi

  # ============================================================================
  # Î≥ÄÍ≤ΩÎêú ÏÑúÎπÑÏä§ Í∞êÏßÄ
  # ============================================================================
  detect-changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    needs: check-canary-label
    if: needs.check-canary-label.outputs.is_canary == 'true'
    outputs:
      api_services: ${{ steps.prepare.outputs.api_services }}
      has_api_changes: ${{ steps.prepare.outputs.has_api_changes }}
      worker_services: ${{ steps.prepare.outputs.worker_services }}
      has_worker_changes: ${{ steps.prepare.outputs.has_worker_changes }}
      has_ext_authz: ${{ steps.prepare.outputs.has_ext_authz }}
      has_auth_relay: ${{ steps.prepare.outputs.has_auth_relay }}
      has_auth_worker: ${{ steps.prepare.outputs.has_auth_worker }}
      has_users_worker: ${{ steps.prepare.outputs.has_users_worker }}
      has_sse_gateway: ${{ steps.prepare.outputs.has_sse_gateway }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Changed files
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            apps/**
            domains/**
            workloads/domains/**

      - name: Prepare service matrix
        id: prepare
        run: |
          python3 <<'PYEOF'
          import json
          import os

          files = os.environ.get("CHANGED_FILES", "").split()
          any_changed = os.environ.get("ANY_CHANGED", "false").lower() == "true"
          
          # API ÏÑúÎπÑÏä§ (apps/ Clean Architecture + Î†àÍ±∞Ïãú chat)
          API_SERVICES = ["auth", "users", "character", "location", "scan", "images", "chat"]
          
          # apps Í≤ΩÎ°úÎ™Ö ‚Üí Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏Î™Ö Îß§Ìïë
          app_to_image_slug = {
              "images": "image",  # apps/images ‚Üí image-api
              "sse_gateway": "sse-gateway",
              "event_router": "event-router",
              "ext_authz": "ext-authz",
          }
          
          # Worker ÏÑúÎπÑÏä§ (apps/ Clean Architecture)
          WORKER_MAP = {
              "character_worker": "character-worker",
              "scan_worker": "scan-worker",
          }
          
          api_services = []
          worker_services = []
          has_ext_authz = False
          has_auth_relay = False
          has_auth_worker = False
          has_users_worker = False
          has_sse_gateway = False
          
          if any_changed:
              for path in files:
                  parts = path.split("/")
                  
                  # apps/<service>/ Í≤ΩÎ°ú Í∞êÏßÄ (Clean Architecture)
                  if len(parts) >= 2 and parts[0] == "apps":
                      svc = parts[1]
                      
                      # API ÏÑúÎπÑÏä§
                      if svc in API_SERVICES and svc not in api_services:
                          api_services.append(svc)
                      # Worker ÏÑúÎπÑÏä§
                      if svc in WORKER_MAP:
                          worker_slug = WORKER_MAP[svc]
                          if worker_slug not in worker_services:
                              worker_services.append(worker_slug)
                      # ÌäπÏàò ÏÑúÎπÑÏä§
                      if svc == "auth_relay":
                          has_auth_relay = True
                      if svc == "auth_worker":
                          has_auth_worker = True
                      if svc == "users_worker":
                          has_users_worker = True
                      if svc == "ext_authz":
                          has_ext_authz = True
                      if svc == "sse_gateway":
                          has_sse_gateway = True
                  
                  # domains/<service>/ Í≤ΩÎ°ú Í∞êÏßÄ (Î†àÍ±∞Ïãú: chat)
                  elif len(parts) >= 2 and parts[0] == "domains":
                      svc = parts[1]
                      
                      if svc == "chat" and svc not in api_services:
                          api_services.append(svc)
                  
                  # workloads/domains/<service>/ Í≤ΩÎ°ú Í∞êÏßÄ
                  elif len(parts) >= 3 and parts[0] == "workloads" and parts[1] == "domains":
                      svc = parts[2]
                      if svc in API_SERVICES and svc not in api_services:
                          api_services.append(svc)
          
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"api_services={json.dumps(api_services)}\n")
              out.write(f"has_api_changes={'true' if api_services else 'false'}\n")
              out.write(f"worker_services={json.dumps(worker_services)}\n")
              out.write(f"has_worker_changes={'true' if worker_services else 'false'}\n")
              out.write(f"has_ext_authz={'true' if has_ext_authz else 'false'}\n")
              out.write(f"has_auth_relay={'true' if has_auth_relay else 'false'}\n")
              out.write(f"has_auth_worker={'true' if has_auth_worker else 'false'}\n")
              out.write(f"has_users_worker={'true' if has_users_worker else 'false'}\n")
              out.write(f"has_sse_gateway={'true' if has_sse_gateway else 'false'}\n")
          PYEOF
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.all_changed_files }}
          ANY_CHANGED: ${{ steps.changes.outputs.any_changed }}

  # ============================================================================
  # API Canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  # ============================================================================
  api-canary-build:
    name: üì¶ Build API Canary - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs:
      - check-canary-label
      - detect-changes
    if: >
      needs.check-canary-label.outputs.is_canary == 'true' &&
      needs.detect-changes.outputs.has_api_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.api_services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare canary tags
        id: meta
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE_REPO="docker.io/mng990/eco2"
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          
          # canary ÌÉúÍ∑∏ ÏÉùÏÑ±
          CANARY_TAG="${SERVICE}-api-dev-canary"
          CANARY_SHA_TAG="${SERVICE}-api-dev-canary-${SHORT_SHA}"
          
          {
            echo "tags<<TAGS"
            echo "${IMAGE_REPO}:${CANARY_TAG}"
            echo "${IMAGE_REPO}:${CANARY_SHA_TAG}"
            echo "TAGS"
          } >> "$GITHUB_OUTPUT"
          echo "canary_tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

      - name: Determine Dockerfile path
        id: dockerfile
        run: |
          SERVICE="${{ matrix.service }}"
          # Clean Architecture Î¶¨Ìå©ÌÜ†ÎßÅÎêú ÏÑúÎπÑÏä§Îäî apps/ Í≤ΩÎ°ú ÏÇ¨Ïö©
          if [ -f "apps/${SERVICE}/Dockerfile" ]; then
            echo "path=apps/${SERVICE}/Dockerfile" >> "$GITHUB_OUTPUT"
          else
            echo "path=domains/${SERVICE}/Dockerfile" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push canary image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dockerfile.outputs.path }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          cat <<EOF >> "$GITHUB_STEP_SUMMARY"
          ## üê§ Canary Image Built: ${{ matrix.service }}
          
          | Tag | Value |
          |-----|-------|
          | Canary | \`${{ steps.meta.outputs.canary_tag }}\` |
          | Full | \`${{ steps.meta.outputs.tags }}\` |
          
          ### ÌÖåÏä§Ìä∏ Î∞©Î≤ï
          \`\`\`bash
          curl -H "X-Canary: true" https://api.growbin.app/api/v1/${{ matrix.service }}/health
          \`\`\`
          EOF

  # ============================================================================
  # Worker Canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  # ============================================================================
  worker-canary-build:
    name: üì¶ Build Worker Canary - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs:
      - check-canary-label
      - detect-changes
    if: >
      needs.check-canary-label.outputs.is_canary == 'true' &&
      needs.detect-changes.outputs.has_worker_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.worker_services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare canary tags
        id: meta
        run: |
          SERVICE="${{ matrix.service }}"
          IMAGE_REPO="docker.io/mng990/eco2"
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          
          CANARY_TAG="${SERVICE}-dev-canary"
          CANARY_SHA_TAG="${SERVICE}-dev-canary-${SHORT_SHA}"
          
          {
            echo "tags<<TAGS"
            echo "${IMAGE_REPO}:${CANARY_TAG}"
            echo "${IMAGE_REPO}:${CANARY_SHA_TAG}"
            echo "TAGS"
          } >> "$GITHUB_OUTPUT"
          echo "canary_tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

      - name: Determine Dockerfile path
        id: dockerfile
        run: |
          SERVICE="${{ matrix.service }}"
          case "$SERVICE" in
            character-worker)
              echo "path=apps/character_worker/Dockerfile" >> "$GITHUB_OUTPUT"
              ;;
            scan-worker)
              echo "path=apps/scan_worker/Dockerfile" >> "$GITHUB_OUTPUT"
              ;;
            *)
              # chat, imageÎäî ÏïÑÏßÅ domains/ Î†àÍ±∞Ïãú
              if [ "$SERVICE" = "chat" ] || [ "$SERVICE" = "image" ]; then
              echo "path=domains/${SERVICE}/Dockerfile" >> "$GITHUB_OUTPUT"
              else
                echo "path=apps/${SERVICE}/Dockerfile" >> "$GITHUB_OUTPUT"
              fi
              ;;
          esac

      - name: Build and push canary image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dockerfile.outputs.path }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # ext-authz Canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  # ============================================================================
  ext-authz-canary-build:
    name: üì¶ Build ext-authz Canary
    runs-on: ubuntu-latest
    needs:
      - check-canary-label
      - detect-changes
    if: >
      needs.check-canary-label.outputs.is_canary == 'true' &&
      needs.detect-changes.outputs.has_ext_authz == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare canary tags
        id: meta
        run: |
          IMAGE_REPO="docker.io/mng990/eco2"
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          
          CANARY_TAG="ext-authz-dev-canary"
          CANARY_SHA_TAG="ext-authz-dev-canary-${SHORT_SHA}"
          
          {
            echo "tags<<TAGS"
            echo "${IMAGE_REPO}:${CANARY_TAG}"
            echo "${IMAGE_REPO}:${CANARY_SHA_TAG}"
            echo "TAGS"
          } >> "$GITHUB_OUTPUT"
          echo "canary_tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

      - name: Build and push canary image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/ext_authz/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # auth-relay Canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  # ============================================================================
  auth-relay-canary-build:
    name: üì¶ Build auth-relay Canary
    runs-on: ubuntu-latest
    needs:
      - check-canary-label
      - detect-changes
    if: >
      needs.check-canary-label.outputs.is_canary == 'true' &&
      needs.detect-changes.outputs.has_auth_relay == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare canary tags
        id: meta
        run: |
          IMAGE_REPO="docker.io/mng990/eco2"
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          
          CANARY_TAG="auth-relay-dev-canary"
          CANARY_SHA_TAG="auth-relay-dev-canary-${SHORT_SHA}"
          
          {
            echo "tags<<TAGS"
            echo "${IMAGE_REPO}:${CANARY_TAG}"
            echo "${IMAGE_REPO}:${CANARY_SHA_TAG}"
            echo "TAGS"
          } >> "$GITHUB_OUTPUT"
          echo "canary_tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

      - name: Determine Dockerfile path
        id: dockerfile
        run: |
          # Clean Architecture (apps/auth_relay/)
          echo "path=apps/auth_relay/Dockerfile" >> "$GITHUB_OUTPUT"

      - name: Build and push canary image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.dockerfile.outputs.path }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # auth-worker Canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  # ============================================================================
  auth-worker-canary-build:
    name: üì¶ Build auth-worker Canary
    runs-on: ubuntu-latest
    needs:
      - check-canary-label
      - detect-changes
    if: >
      needs.check-canary-label.outputs.is_canary == 'true' &&
      needs.detect-changes.outputs.has_auth_worker == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare canary tags
        id: meta
        run: |
          IMAGE_REPO="docker.io/mng990/eco2"
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          
          CANARY_TAG="auth-worker-dev-canary"
          CANARY_SHA_TAG="auth-worker-dev-canary-${SHORT_SHA}"
          
          {
            echo "tags<<TAGS"
            echo "${IMAGE_REPO}:${CANARY_TAG}"
            echo "${IMAGE_REPO}:${CANARY_SHA_TAG}"
            echo "TAGS"
          } >> "$GITHUB_OUTPUT"
          echo "canary_tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

      - name: Build and push canary image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/auth_worker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # users-worker Canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  # ============================================================================
  users-worker-canary-build:
    name: üì¶ Build users-worker Canary
    runs-on: ubuntu-latest
    needs:
      - check-canary-label
      - detect-changes
    if: >
      needs.check-canary-label.outputs.is_canary == 'true' &&
      needs.detect-changes.outputs.has_users_worker == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare canary tags
        id: meta
        run: |
          IMAGE_REPO="docker.io/mng990/eco2"
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          
          CANARY_TAG="users-worker-dev-canary"
          CANARY_SHA_TAG="users-worker-dev-canary-${SHORT_SHA}"
          
          {
            echo "tags<<TAGS"
            echo "${IMAGE_REPO}:${CANARY_TAG}"
            echo "${IMAGE_REPO}:${CANARY_SHA_TAG}"
            echo "TAGS"
          } >> "$GITHUB_OUTPUT"
          echo "canary_tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

      - name: Build and push canary image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/users_worker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # sse-gateway Canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
  # ============================================================================
  sse-gateway-canary-build:
    name: üì¶ Build sse-gateway Canary
    runs-on: ubuntu-latest
    needs:
      - check-canary-label
      - detect-changes
    if: >
      needs.check-canary-label.outputs.is_canary == 'true' &&
      needs.detect-changes.outputs.has_sse_gateway == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare canary tags
        id: meta
        run: |
          IMAGE_REPO="docker.io/mng990/eco2"
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          
          CANARY_TAG="sse-gateway-dev-canary"
          CANARY_SHA_TAG="sse-gateway-dev-canary-${SHORT_SHA}"
          
          {
            echo "tags<<TAGS"
            echo "${IMAGE_REPO}:${CANARY_TAG}"
            echo "${IMAGE_REPO}:${CANARY_SHA_TAG}"
            echo "TAGS"
          } >> "$GITHUB_OUTPUT"
          echo "canary_tag=${CANARY_TAG}" >> "$GITHUB_OUTPUT"

      - name: Build and push canary image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/sse_gateway/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Canary ÎπåÎìú ÏôÑÎ£å ÏïåÎ¶º
  # ============================================================================
  canary-summary:
    name: üìã Canary Build Summary
    runs-on: ubuntu-latest
    needs:
      - check-canary-label
      - detect-changes
      - api-canary-build
      - worker-canary-build
      - ext-authz-canary-build
      - auth-relay-canary-build
      - auth-worker-canary-build
      - users-worker-canary-build
      - sse-gateway-canary-build
    if: always() && needs.check-canary-label.outputs.is_canary == 'true'
    steps:
      - name: Generate summary
        env:
          API_SERVICES: ${{ needs.detect-changes.outputs.api_services }}
          WORKER_SERVICES: ${{ needs.detect-changes.outputs.worker_services }}
          HAS_EXT_AUTHZ: ${{ needs.detect-changes.outputs.has_ext_authz }}
          HAS_AUTH_RELAY: ${{ needs.detect-changes.outputs.has_auth_relay }}
          HAS_AUTH_WORKER: ${{ needs.detect-changes.outputs.has_auth_worker }}
          HAS_USERS_WORKER: ${{ needs.detect-changes.outputs.has_users_worker }}
          HAS_SSE_GATEWAY: ${{ needs.detect-changes.outputs.has_sse_gateway }}
        run: |
          cat <<EOF >> "$GITHUB_STEP_SUMMARY"
          # üê§ Canary Build Summary
          
          ## ÎπåÎìúÎêú ÏÑúÎπÑÏä§
          
          | Ïπ¥ÌÖåÍ≥†Î¶¨ | ÏÑúÎπÑÏä§ | ÌÉúÍ∑∏ |
          |---------|--------|------|
          EOF
          
          # API Services
          if [ -n "$API_SERVICES" ] && [ "$API_SERVICES" != "[]" ]; then
            for svc in $(echo "$API_SERVICES" | jq -r '.[]'); do
              echo "| API | $svc | \`${svc}-api-dev-canary\` |" >> "$GITHUB_STEP_SUMMARY"
            done
          fi
          
          # Worker Services
          if [ -n "$WORKER_SERVICES" ] && [ "$WORKER_SERVICES" != "[]" ]; then
            for svc in $(echo "$WORKER_SERVICES" | jq -r '.[]'); do
              echo "| Worker | $svc | \`${svc}-dev-canary\` |" >> "$GITHUB_STEP_SUMMARY"
            done
          fi
          
          # Special Services
          if [ "$HAS_EXT_AUTHZ" = "true" ]; then
            echo "| Special | ext-authz | \`ext-authz-dev-canary\` |" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "$HAS_AUTH_RELAY" = "true" ]; then
            echo "| Special | auth-relay | \`auth-relay-dev-canary\` |" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "$HAS_AUTH_WORKER" = "true" ]; then
            echo "| Special | auth-worker | \`auth-worker-dev-canary\` |" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "$HAS_USERS_WORKER" = "true" ]; then
            echo "| Special | users-worker | \`users-worker-dev-canary\` |" >> "$GITHUB_STEP_SUMMARY"
          fi
          if [ "$HAS_SSE_GATEWAY" = "true" ]; then
            echo "| Special | sse-gateway | \`sse-gateway-dev-canary\` |" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          cat <<'EOF' >> "$GITHUB_STEP_SUMMARY"
          
          ## ÌÖåÏä§Ìä∏ Î∞©Î≤ï
          
          ```bash
          # Canary Î≤ÑÏ†ÑÏúºÎ°ú ÏöîÏ≤≠
          curl -H "X-Canary: true" https://api.growbin.app/api/v1/auth/health
          
          # Stable Î≤ÑÏ†ÑÏúºÎ°ú ÏöîÏ≤≠ (Í∏∞Î≥∏)
          curl https://api.growbin.app/api/v1/auth/health
          ```
          
          ## Îã§Ïùå Îã®Í≥Ñ
          
          1. ‚úÖ Canary Ïù¥ÎØ∏ÏßÄ ÎπåÎìú ÏôÑÎ£å
          2. ‚è≥ ArgoCDÍ∞Ä ÏûêÎèôÏúºÎ°ú canary deployment ÏóÖÎç∞Ïù¥Ìä∏
          3. üß™ `X-Canary: true` Ìó§ÎçîÎ°ú ÌÖåÏä§Ìä∏
          4. üöÄ PR Î®∏ÏßÄ Ïãú stable Ïù¥ÎØ∏ÏßÄÎ°ú Î∞∞Ìè¨
          EOF

