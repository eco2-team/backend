name: CI Workers Quality Gate

on:
  push:
    branches:
      - main
      - develop
    paths:
      # Worker ÏÜåÏä§ ÏΩîÎìú (domains/ Î†àÍ±∞Ïãú)
      - "domains/scan/tasks/**"
      - "domains/scan/celery_app.py"
      - "domains/scan/Dockerfile.worker"
      - "domains/scan/requirements-worker.txt"
      - "domains/character/tasks/**"
      - "domains/character/celery_app.py"
      - "domains/character/Dockerfile.worker"
      - "domains/character/requirements-worker.txt"
      - "domains/my/tasks/**"
      - "domains/my/celery_app.py"
      - "domains/my/Dockerfile.worker"
      - "domains/my/requirements-worker.txt"
      # Worker ÏÜåÏä§ ÏΩîÎìú (apps/ Clean Architecture)
      - "apps/auth_worker/**"
      # Í≥µÌÜµ ÏùòÏ°¥ÏÑ±
      - "domains/_shared/celery/**"
      - "domains/_shared/waste_pipeline/**"
      - "domains/_shared/events/**"
      # Worker Kubernetes manifests
      - "workloads/domains/scan-worker/**"
      - "workloads/domains/character-worker/**"
      - "workloads/domains/character-match-worker/**"
      - "workloads/domains/my-worker/**"
      - "workloads/domains/auth-worker/**"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "domains/scan/tasks/**"
      - "domains/scan/celery_app.py"
      - "domains/scan/Dockerfile.worker"
      - "domains/scan/requirements-worker.txt"
      - "domains/character/tasks/**"
      - "domains/character/celery_app.py"
      - "domains/character/Dockerfile.worker"
      - "domains/character/requirements-worker.txt"
      - "domains/my/tasks/**"
      - "domains/my/celery_app.py"
      - "domains/my/Dockerfile.worker"
      - "domains/my/requirements-worker.txt"
      - "apps/auth_worker/**"
      - "domains/_shared/celery/**"
      - "domains/_shared/waste_pipeline/**"
      - "domains/_shared/events/**"
      - "workloads/domains/scan-worker/**"
      - "workloads/domains/character-worker/**"
      - "workloads/domains/character-match-worker/**"
      - "workloads/domains/my-worker/**"
      - "workloads/domains/auth-worker/**"
  workflow_dispatch:
    inputs:
      force_all:
        description: "Î™®Îì† WorkerÎ•º Í∞ïÏ†úÎ°ú ÎπåÎìú/Ìë∏Ïãú"
        type: boolean
        default: false
      target_workers:
        description: "ÏΩ§ÎßàÎ°ú Íµ¨Î∂ÑÎêú Worker Ïù¥Î¶Ñ Î™©Î°ù (Ïòà: scan,character)"
        required: false

permissions:
  contents: write
  packages: write

concurrency:
  group: ci-workers-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  commit-filter:
    name: üõÇ Commit Filter
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      reason: ${{ steps.detect.outputs.reason }}
    steps:
      - name: Detect conventional commit type
        id: detect
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          if [ "${GITHUB_ACTOR}" = "github-actions[bot]" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Triggered by github-actions bot" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          REF_TEXT="${COMMIT_MSG%%$'\n'*}"
          TYPE=$(printf '%s\n' "$REF_TEXT" | sed -n 's/^\([A-Za-z0-9_-]\+\):.*/\1/p' | tr '[:upper:]' '[:lower:]')
          if [[ "$TYPE" =~ ^(docs)$ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Commit type '$TYPE' bypasses worker CI" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

  detect-worker-changes:
    name: üîç Detect Worker Changes
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    outputs:
      has_changes: ${{ steps.prepare.outputs.has_changes }}
      workers: ${{ steps.prepare.outputs.workers }}
      has_clean_changes: ${{ steps.prepare.outputs.has_clean_changes }}
      clean_workers: ${{ steps.prepare.outputs.clean_workers }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Changed files
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            domains/scan/tasks/**
            domains/scan/celery_app.py
            domains/scan/Dockerfile.worker
            domains/scan/requirements-worker.txt
            domains/character/tasks/**
            domains/character/celery_app.py
            domains/character/Dockerfile.worker
            domains/character/requirements-worker.txt
            domains/my/tasks/**
            domains/my/celery_app.py
            domains/my/Dockerfile.worker
            domains/my/requirements-worker.txt
            apps/auth_worker/**
            domains/_shared/celery/**
            domains/_shared/waste_pipeline/**
            domains/_shared/events/**
            workloads/domains/scan-worker/**
            workloads/domains/character-worker/**
            workloads/domains/character-match-worker/**
            workloads/domains/my-worker/**
            workloads/domains/auth-worker/**

      - name: Prepare worker matrix
        id: prepare
        run: |
          python3 <<'PYEOF'
          import json
          import os

          files = os.environ.get("CHANGED_FILES", "").split()
          any_changed = os.environ.get("ANY_CHANGED", "false").lower() == "true"
          force_all = os.environ.get("FORCE_ALL", "false").lower() == "true"
          event_name = os.environ.get("EVENT_NAME", "")

          # Legacy Worker Î™©Î°ù (domains/ Íµ¨Ï°∞, Celery Í∏∞Î∞ò)
          LEGACY_WORKERS = ["scan", "character", "my"]
          
          # Clean Architecture Worker Î™©Î°ù (apps/ Íµ¨Ï°∞)
          CLEAN_WORKERS = ["auth_worker"]

          # Í≥µÌÜµ ÏùòÏ°¥ÏÑ± ‚Üí Legacy Worker Ïû¨ÎπåÎìú
          SHARED_TRIGGERS = [
              "domains/_shared/celery",
              "domains/_shared/waste_pipeline",
              "domains/_shared/events",
          ]

          raw_targets = [
              w.strip()
              for w in os.environ.get("TARGET_WORKERS", "").split(",")
              if w.strip()
          ]

          workers = []  # Legacy workers
          clean_workers = []  # Clean Architecture workers

          if event_name == "workflow_dispatch":
              if force_all:
                  workers = LEGACY_WORKERS.copy()
                  clean_workers = CLEAN_WORKERS.copy()
              elif raw_targets:
                  workers = [w for w in raw_targets if w in LEGACY_WORKERS]
                  clean_workers = [w for w in raw_targets if w in CLEAN_WORKERS]

          if any_changed:
              # Í≥µÌÜµ ÏùòÏ°¥ÏÑ± Î≥ÄÍ≤Ω Ïãú Legacy Worker ÎπåÎìú
              if not workers:
                  for path in files:
                      for trigger in SHARED_TRIGGERS:
                          if path.startswith(trigger):
                              workers = LEGACY_WORKERS.copy()
                              break
                      if workers:
                          break

              # Í∞úÎ≥Ñ Legacy Worker Î≥ÄÍ≤Ω Í∞êÏßÄ
              if not workers:
                  for path in files:
                      for worker in LEGACY_WORKERS:
                          if (
                              path.startswith(f"domains/{worker}/tasks") or
                              path.startswith(f"domains/{worker}/celery_app") or
                              path.startswith(f"domains/{worker}/Dockerfile.worker") or
                              path.startswith(f"domains/{worker}/requirements-worker") or
                              path.startswith(f"workloads/domains/{worker}-worker")
                          ):
                              if worker not in workers:
                                  workers.append(worker)
              
              # Clean Architecture Worker Î≥ÄÍ≤Ω Í∞êÏßÄ
              for path in files:
                  for worker in CLEAN_WORKERS:
                      # apps/auth_worker/** ÎòêÎäî workloads/domains/auth-worker/**
                      worker_hyphen = worker.replace("_", "-")
                      if (
                          path.startswith(f"apps/{worker}") or
                          path.startswith(f"workloads/domains/{worker_hyphen}")
                      ):
                          if worker not in clean_workers:
                              clean_workers.append(worker)

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              # Legacy workers
              if workers:
                  out.write("has_changes=true\n")
                  out.write(f"workers={json.dumps(workers)}\n")
              else:
                  out.write("has_changes=false\n")
                  out.write("workers=[]\n")
              
              # Clean Architecture workers
              if clean_workers:
                  out.write("has_clean_changes=true\n")
                  out.write(f"clean_workers={json.dumps(clean_workers)}\n")
              else:
                  out.write("has_clean_changes=false\n")
                  out.write("clean_workers=[]\n")
          PYEOF
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.all_changed_files }}
          ANY_CHANGED: ${{ steps.changes.outputs.any_changed }}
          EVENT_NAME: ${{ github.event_name }}
          FORCE_ALL: ${{ github.event.inputs.force_all || 'false' }}
          TARGET_WORKERS: ${{ github.event.inputs.target_workers || '' }}

  worker-quality:
    name: üß™ Worker Lint & Test
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-worker-changes
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-worker-changes.outputs.has_changes == 'true'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    strategy:
      fail-fast: false
      matrix:
        worker: ${{ fromJson(needs.detect-worker-changes.outputs.workers) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black==24.4.2 ruff==0.6.9 pytest==8.3.3 pytest-asyncio==0.24.0
          pip install -r domains/${{ matrix.worker }}/requirements.txt
          if [ -f "domains/${{ matrix.worker }}/requirements-worker.txt" ]; then
            pip install -r domains/${{ matrix.worker }}/requirements-worker.txt
          fi

      - name: Black (format check)
        run: black --check domains/${{ matrix.worker }}/tasks

      - name: Ruff lint
        run: ruff check domains/${{ matrix.worker }}/tasks

      - name: Pytest (worker tasks)
        working-directory: domains/${{ matrix.worker }}
        env:
          PYTHONPATH: ${{ github.workspace }}/domains/${{ matrix.worker }}
        run: |
          if [ -d "tests/unit" ]; then
            pytest tests/unit -v
          else
            echo "No unit tests found, skipping..."
          fi

  worker-build-push:
    name: üì¶ Build & Push Worker Images
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-worker-changes
      - worker-quality
    if: >
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-worker-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        worker: ${{ fromJson(needs.detect-worker-changes.outputs.workers) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare worker image tags
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          WORKER="${{ matrix.worker }}"
          IMAGE_REPO="docker.io/mng990/eco2"
          WORKER_SLUG="${WORKER}-worker"
          VERSION=$(cat VERSION)

          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            UNIQUE_TAG="${WORKER_SLUG}-${VERSION}-${SHORT_SHA}"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${UNIQUE_TAG}"
              echo "${IMAGE_REPO}:${WORKER_SLUG}-prod-latest"
              echo "${IMAGE_REPO}:${WORKER_SLUG}-latest"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${UNIQUE_TAG}" >> "$GITHUB_OUTPUT"
          else
            DEV_TAG="${WORKER_SLUG}-dev-${SHORT_SHA}"
            DEV_LATEST_TAG="${WORKER_SLUG}-dev-latest"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${DEV_TAG}"
              echo "${IMAGE_REPO}:${DEV_LATEST_TAG}"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${DEV_LATEST_TAG}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: domains/${{ matrix.worker }}/Dockerfile.worker
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Sync manifest branch
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        run: |
          git fetch origin "${{ github.ref_name }}"
          git checkout -B "${{ github.ref_name }}"
          git pull --rebase origin "${{ github.ref_name }}"

      - name: Update worker manifest tag
        id: update_manifest
        env:
          WORKER: ${{ matrix.worker }}
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            KUSTOMIZE_FILE="workloads/domains/${WORKER}-worker/prod/kustomization.yaml"
          else
            KUSTOMIZE_FILE="workloads/domains/${WORKER}-worker/dev/kustomization.yaml"
          fi

          if [ ! -f "$KUSTOMIZE_FILE" ]; then
            mkdir -p "$(dirname $KUSTOMIZE_FILE)"
            cat > "$KUSTOMIZE_FILE" << EOF
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - ../base
          images:
            - name: docker.io/mng990/eco2
              newTag: ${TAG_NAME}
          EOF
          else
            python -m pip install --upgrade pip pyyaml
            python scripts/ci/update_kustomize_image.py \
              --file "$KUSTOMIZE_FILE" \
              --image docker.io/mng990/eco2 \
              --tag "$TAG_NAME"
          fi

          if git diff --quiet -- "$KUSTOMIZE_FILE" 2>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "file=$KUSTOMIZE_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit worker manifest updates
        if: steps.update_manifest.outputs.changed == 'true'
        env:
          KUSTOMIZE_FILE: ${{ steps.update_manifest.outputs.file }}
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
          WORKER: ${{ matrix.worker }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${KUSTOMIZE_FILE}"
          git commit -m "chore(${WORKER}-worker): bump image tag to ${TAG_NAME} [skip ci]"
          git push origin HEAD:${{ github.ref_name }}

  # ============================================================================
  # Clean Architecture Worker Build & Push (apps/ Íµ¨Ï°∞)
  # ============================================================================
  clean-worker-build-push:
    name: üì¶ Build & Push Clean Worker - ${{ matrix.worker }}
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-worker-changes
    if: >
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-worker-changes.outputs.has_clean_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        worker: ${{ fromJson(needs.detect-worker-changes.outputs.clean_workers) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare worker image tags
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          WORKER="${{ matrix.worker }}"
          IMAGE_REPO="docker.io/mng990/eco2"
          # auth_worker ‚Üí auth-worker
          WORKER_SLUG="${WORKER//_/-}"
          VERSION=$(cat VERSION)

          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            UNIQUE_TAG="${WORKER_SLUG}-${VERSION}-${SHORT_SHA}"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${UNIQUE_TAG}"
              echo "${IMAGE_REPO}:${WORKER_SLUG}-prod-latest"
              echo "${IMAGE_REPO}:${WORKER_SLUG}-latest"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${UNIQUE_TAG}" >> "$GITHUB_OUTPUT"
          else
            DEV_TAG="${WORKER_SLUG}-dev-${SHORT_SHA}"
            DEV_LATEST_TAG="${WORKER_SLUG}-dev-latest"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${DEV_TAG}"
              echo "${IMAGE_REPO}:${DEV_LATEST_TAG}"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${DEV_LATEST_TAG}" >> "$GITHUB_OUTPUT"
          fi
          echo "worker_slug=${WORKER_SLUG}" >> "$GITHUB_OUTPUT"

      - name: Build and push worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.worker }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Sync manifest branch
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        run: |
          git fetch origin "${{ github.ref_name }}"
          git checkout -B "${{ github.ref_name }}"
          git pull --rebase origin "${{ github.ref_name }}"

      - name: Update worker manifest tag
        id: update_manifest
        env:
          WORKER_SLUG: ${{ steps.meta.outputs.worker_slug }}
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            KUSTOMIZE_FILE="workloads/domains/${WORKER_SLUG}/prod/kustomization.yaml"
          else
            KUSTOMIZE_FILE="workloads/domains/${WORKER_SLUG}/dev/kustomization.yaml"
          fi

          if [ ! -f "$KUSTOMIZE_FILE" ]; then
            mkdir -p "$(dirname $KUSTOMIZE_FILE)"
            cat > "$KUSTOMIZE_FILE" << EOF
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - ../base
          images:
            - name: docker.io/mng990/eco2
              newTag: ${TAG_NAME}
          EOF
          else
            python -m pip install --upgrade pip pyyaml
            python scripts/ci/update_kustomize_image.py \
              --file "$KUSTOMIZE_FILE" \
              --image docker.io/mng990/eco2 \
              --tag "$TAG_NAME"
          fi

          if git diff --quiet -- "$KUSTOMIZE_FILE" 2>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "file=$KUSTOMIZE_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit worker manifest updates
        if: steps.update_manifest.outputs.changed == 'true'
        env:
          KUSTOMIZE_FILE: ${{ steps.update_manifest.outputs.file }}
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
          WORKER_SLUG: ${{ steps.meta.outputs.worker_slug }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${KUSTOMIZE_FILE}"
          git commit -m "chore(${WORKER_SLUG}): bump image tag to ${TAG_NAME} [skip ci]"
          git push origin HEAD:${{ github.ref_name }}

