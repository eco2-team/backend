name: CI Workers Quality Gate

on:
  push:
    branches:
      - main
      - develop
    paths:
      # Worker ÏÜåÏä§ ÏΩîÎìú (apps/ Clean Architecture)
      - "apps/auth_worker/**"
      - "apps/users_worker/**"
      - "apps/scan_worker/**"
      - "apps/character_worker/**"
      - "apps/info_worker/**"
      # Worker Kubernetes manifests
      - "workloads/domains/scan-worker/**"
      - "workloads/domains/character-worker/**"
      - "workloads/domains/character-match-worker/**"
      - "workloads/domains/auth-worker/**"
      - "workloads/domains/users-worker/**"
      - "workloads/domains/info-worker/**"
  pull_request:
    branches:
      - main
      - develop
    paths:
      # Worker ÏÜåÏä§ ÏΩîÎìú (apps/ Clean Architecture)
      - "apps/auth_worker/**"
      - "apps/users_worker/**"
      - "apps/scan_worker/**"
      - "apps/character_worker/**"
      - "apps/info_worker/**"
      # Worker Kubernetes manifests
      - "workloads/domains/scan-worker/**"
      - "workloads/domains/character-worker/**"
      - "workloads/domains/character-match-worker/**"
      - "workloads/domains/auth-worker/**"
      - "workloads/domains/users-worker/**"
      - "workloads/domains/info-worker/**"
  workflow_dispatch:
    inputs:
      force_all:
        description: "Î™®Îì† WorkerÎ•º Í∞ïÏ†úÎ°ú ÎπåÎìú/Ìë∏Ïãú"
        type: boolean
        default: false
      target_workers:
        description: "ÏΩ§ÎßàÎ°ú Íµ¨Î∂ÑÎêú Worker Ïù¥Î¶Ñ Î™©Î°ù (Ïòà: scan,character)"
        required: false

permissions:
  contents: write
  packages: write

concurrency:
  group: ci-workers-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  commit-filter:
    name: üõÇ Commit Filter
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.detect.outputs.skip }}
      reason: ${{ steps.detect.outputs.reason }}
    steps:
      - name: Detect conventional commit type
        id: detect
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          if [ "${GITHUB_ACTOR}" = "github-actions[bot]" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Triggered by github-actions bot" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          REF_TEXT="${COMMIT_MSG%%$'\n'*}"
          TYPE=$(printf '%s\n' "$REF_TEXT" | sed -n 's/^\([A-Za-z0-9_-]\+\):.*/\1/p' | tr '[:upper:]' '[:lower:]')
          if [[ "$TYPE" =~ ^(docs)$ ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=Commit type '$TYPE' bypasses worker CI" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

  detect-worker-changes:
    name: üîç Detect Worker Changes
    runs-on: ubuntu-latest
    needs: commit-filter
    if: needs.commit-filter.outputs.skip != 'true'
    outputs:
      has_changes: ${{ steps.prepare.outputs.has_changes }}
      workers: ${{ steps.prepare.outputs.workers }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Changed files
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            apps/auth_worker/**
            apps/users_worker/**
            apps/scan_worker/**
            apps/character_worker/**
            apps/info_worker/**
            workloads/domains/scan-worker/**
            workloads/domains/character-worker/**
            workloads/domains/character-match-worker/**
            workloads/domains/auth-worker/**
            workloads/domains/users-worker/**
            workloads/domains/info-worker/**

      - name: Prepare worker matrix
        id: prepare
        run: |
          python3 <<'PYEOF'
          import json
          import os

          files = os.environ.get("CHANGED_FILES", "").split()
          any_changed = os.environ.get("ANY_CHANGED", "false").lower() == "true"
          force_all = os.environ.get("FORCE_ALL", "false").lower() == "true"
          event_name = os.environ.get("EVENT_NAME", "")

          # Worker Î™©Î°ù (apps/ Clean Architecture)
          # workloads/domains Îß§Ìïë: auth_worker ‚Üí auth-worker
          WORKERS = ["auth_worker", "users_worker", "scan_worker", "character_worker", "info_worker"]

          raw_targets = [
              w.strip()
              for w in os.environ.get("TARGET_WORKERS", "").split(",")
              if w.strip()
          ]

          workers = []

          if event_name == "workflow_dispatch":
              if force_all:
                  workers = WORKERS.copy()
              elif raw_targets:
                  workers = [w for w in raw_targets if w in WORKERS]

          if any_changed and not workers:
              # Í∞úÎ≥Ñ Worker Î≥ÄÍ≤Ω Í∞êÏßÄ
              for path in files:
                  for worker in WORKERS:
                      # apps/auth_worker/** ÎòêÎäî workloads/domains/auth-worker/**
                      worker_hyphen = worker.replace("_", "-")
                      if (
                          path.startswith(f"apps/{worker}") or
                          path.startswith(f"workloads/domains/{worker_hyphen}")
                      ):
                          if worker not in workers:
                              workers.append(worker)

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              if workers:
                  out.write("has_changes=true\n")
                  out.write(f"workers={json.dumps(workers)}\n")
              else:
                  out.write("has_changes=false\n")
                  out.write("workers=[]\n")
          PYEOF
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.all_changed_files }}
          ANY_CHANGED: ${{ steps.changes.outputs.any_changed }}
          EVENT_NAME: ${{ github.event_name }}
          FORCE_ALL: ${{ github.event.inputs.force_all || 'false' }}
          TARGET_WORKERS: ${{ github.event.inputs.target_workers || '' }}

  # ============================================================================
  # Kubernetes Manifest Validation
  # ============================================================================
  manifest-validation:
    name: üîç Manifest Validation
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-worker-changes
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-worker-changes.outputs.has_changes == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.3.0"

      - name: Validate all worker manifests
        run: |
          echo "üîç Validating all worker manifests..."
          for worker in auth-worker users-worker character-worker scan-worker info-worker; do
            if [ -d "workloads/domains/${worker}/dev" ]; then
              echo "  - ${worker}/dev"
              kustomize build "workloads/domains/${worker}/dev" > /dev/null || exit 1
            fi
          done
          echo "‚úÖ All worker manifests are valid"

  # ============================================================================
  # Worker Quality Gate (apps/ Clean Architecture)
  # ============================================================================
  worker-quality:
    name: üß™ Worker Lint & Test - ${{ matrix.worker }}
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-worker-changes
      - manifest-validation
    if: >
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-worker-changes.outputs.has_changes == 'true'
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    strategy:
      fail-fast: false
      matrix:
        worker: ${{ fromJson(needs.detect-worker-changes.outputs.workers) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black==24.4.2 ruff==0.6.9 pytest==8.3.3 pytest-asyncio==0.24.0
          if [ -f "apps/${{ matrix.worker }}/requirements.txt" ]; then
            pip install -r apps/${{ matrix.worker }}/requirements.txt
          fi

      - name: Black (format check)
        run: black --check apps/${{ matrix.worker }}

      - name: Ruff lint
        run: ruff check apps/${{ matrix.worker }}

      - name: Pytest (unit tests)
        env:
          PYTHONPATH: ${{ github.workspace }}
          REDIS_STREAMS_URL: redis://localhost:6379/0
          REDIS_CACHE_URL: redis://localhost:6379/0
          CELERY_BROKER_URL: redis://localhost:6379/0
          CELERY_RESULT_BACKEND: redis://localhost:6379/0
        run: |
          if [ -d "apps/${{ matrix.worker }}/tests" ]; then
            pytest apps/${{ matrix.worker }}/tests -v --ignore=apps/${{ matrix.worker }}/tests/integration
          else
            echo "No tests found, skipping..."
          fi

  # ============================================================================
  # Worker Build & Push (apps/ Clean Architecture)
  # ============================================================================
  worker-build-push:
    name: üì¶ Build & Push Worker - ${{ matrix.worker }}
    runs-on: ubuntu-latest
    needs:
      - commit-filter
      - detect-worker-changes
      - worker-quality
    if: >
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.commit-filter.outputs.skip != 'true' &&
      needs.detect-worker-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        worker: ${{ fromJson(needs.detect-worker-changes.outputs.workers) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare worker image tags
        id: meta
        run: |
          set -euo pipefail
          SHORT_SHA=$(git rev-parse --short=6 HEAD)
          WORKER="${{ matrix.worker }}"
          IMAGE_REPO="docker.io/mng990/eco2"
          # auth_worker ‚Üí auth-worker
          WORKER_SLUG="${WORKER//_/-}"
          VERSION=$(cat VERSION)

          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            UNIQUE_TAG="${WORKER_SLUG}-${VERSION}-${SHORT_SHA}"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${UNIQUE_TAG}"
              echo "${IMAGE_REPO}:${WORKER_SLUG}-prod-latest"
              echo "${IMAGE_REPO}:${WORKER_SLUG}-latest"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${UNIQUE_TAG}" >> "$GITHUB_OUTPUT"
          else
            DEV_TAG="${WORKER_SLUG}-dev-${SHORT_SHA}"
            DEV_LATEST_TAG="${WORKER_SLUG}-dev-latest"
            {
              echo "tags<<TAGS"
              echo "${IMAGE_REPO}:${DEV_TAG}"
              echo "${IMAGE_REPO}:${DEV_LATEST_TAG}"
              echo "TAGS"
            } >> "$GITHUB_OUTPUT"
            echo "manifest_tag=${DEV_LATEST_TAG}" >> "$GITHUB_OUTPUT"
          fi
          echo "worker_slug=${WORKER_SLUG}" >> "$GITHUB_OUTPUT"

      - name: Build and push worker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.worker }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Sync manifest branch
        if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
        run: |
          git fetch origin "${{ github.ref_name }}"
          git checkout -B "${{ github.ref_name }}"
          git pull --rebase origin "${{ github.ref_name }}"

      - name: Update worker manifest tag
        id: update_manifest
        env:
          WORKER_SLUG: ${{ steps.meta.outputs.worker_slug }}
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            KUSTOMIZE_FILE="workloads/domains/${WORKER_SLUG}/prod/kustomization.yaml"
          else
            KUSTOMIZE_FILE="workloads/domains/${WORKER_SLUG}/dev/kustomization.yaml"
          fi

          if [ ! -f "$KUSTOMIZE_FILE" ]; then
            mkdir -p "$(dirname $KUSTOMIZE_FILE)"
            cat > "$KUSTOMIZE_FILE" << EOF
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - ../base
          images:
            - name: docker.io/mng990/eco2
              newTag: ${TAG_NAME}
          EOF
          else
            python -m pip install --upgrade pip pyyaml
            python scripts/ci/update_kustomize_image.py \
              --file "$KUSTOMIZE_FILE" \
              --image docker.io/mng990/eco2 \
              --tag "$TAG_NAME"
          fi

          if git diff --quiet -- "$KUSTOMIZE_FILE" 2>/dev/null; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "file=$KUSTOMIZE_FILE" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit worker manifest updates
        if: steps.update_manifest.outputs.changed == 'true'
        env:
          KUSTOMIZE_FILE: ${{ steps.update_manifest.outputs.file }}
          TAG_NAME: ${{ steps.meta.outputs.manifest_tag }}
          WORKER_SLUG: ${{ steps.meta.outputs.worker_slug }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${KUSTOMIZE_FILE}"
          git commit -m "chore(${WORKER_SLUG}): bump image tag to ${TAG_NAME} [skip ci]"
          git push origin HEAD:${{ github.ref_name }}

