name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 수동 배포 허용

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 변경된 파일 확인
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docker: ${{ steps.filter.outputs.docker }}
      infra: ${{ steps.filter.outputs.infra }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 변경된 파일 감지
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            code:
              - 'app/**'
              - 'services/**'
              - '*.py'
            docker:
              - 'Dockerfile*'
              - 'docker-compose*.yml'
            infra:
              - 'terraform/**'
              - 'ansible/**'
            docs:
              - 'docs/**'
              - '*.md'
              - '.github/PULL_REQUEST_TEMPLATE.md'

  deploy:
    runs-on: ubuntu-latest
    needs: detect-changes
    # 코드, Docker, 인프라 변경이 있을 때만 배포
    # workflow_dispatch로 수동 실행 시 항상 실행
    if: |
      github.event_name == 'workflow_dispatch' || 
      (needs.detect-changes.outputs.code == 'true' || 
       needs.detect-changes.outputs.docker == 'true' || 
       needs.detect-changes.outputs.infra == 'true')
    environment: production  # GitHub Environments 사용

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      # EC2 배포 (Docker Compose 사용)
      - name: EC2 서버에 배포
        uses: appleboy/ssh-action@v1.0.0
        if: secrets.EC2_HOST != '' && secrets.EC2_USER != ''
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          IMAGE_TAG: ${{ github.sha }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 30s
          envs: REGISTRY,IMAGE_NAME,IMAGE_TAG
          script: |
            # 프로젝트 디렉토리로 이동
            cd /home/ubuntu/sesacthon-backend
            
            # 최신 코드 가져오기
            git pull origin main
            
            # GitHub Container Registry 로그인
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 최신 이미지 가져오기
            docker pull ${REGISTRY}/${IMAGE_NAME}:latest
            
            # Docker Compose로 재배포
            docker-compose down
            docker-compose up -d
            
            # 사용하지 않는 이미지 정리
            docker image prune -f
            
            # 배포 확인
            sleep 10
            curl -f http://localhost:8000/ || exit 1
            
            echo "✅ 배포 완료!"

      - name: Slack 알림 (선택)
        uses: 8398a7/action-slack@v3
        if: always() && secrets.SLACK_WEBHOOK_URL != ''
        with:
          status: ${{ job.status }}
          text: '배포가 ${{ job.status }}되었습니다!'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

