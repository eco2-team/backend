# SeSACTHON Backend Project Rules

## ìì£¼ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´

### SSH ì ‘ì†
```bash
# Master ë…¸ë“œ ì ‘ì†
./scripts/utilities/connect-ssh.sh master

# Worker ë…¸ë“œ ì ‘ì†
./scripts/utilities/connect-ssh.sh worker-1
./scripts/utilities/connect-ssh.sh worker-2

# Storage ë…¸ë“œ ì ‘ì†
./scripts/utilities/connect-ssh.sh storage
```

### Kubectl ëª…ë ¹ì–´

#### Pod ê´€ë¦¬
```bash
# íŠ¹ì • namespaceì˜ pod í™•ì¸
kubectl get pods -n auth -o wide
kubectl get pods -n character -o wide
kubectl get pods -n chat -o wide

# Pod ë¡œê·¸ í™•ì¸
kubectl logs -n auth -l app=auth-api --tail=100 -f

# Pod ë‚´ë¶€ ì ‘ì†
kubectl exec -it <pod-name> -n auth -- /bin/bash
kubectl exec -it <pod-name> -n auth -- /bin/sh

# Pod ë‚´ë¶€ì—ì„œ API í…ŒìŠ¤íŠ¸ (Python ì‚¬ìš©)
kubectl exec -it <pod-name> -n auth -- python3 -c "
import urllib.request
response = urllib.request.urlopen('http://localhost:8000/health')
print(f'Status: {response.status}')
print(f'Body: {response.read().decode()}')
"
```

#### Deployment ê´€ë¦¬
```bash
# Deployment ì¬ì‹œì‘
kubectl rollout restart deployment/auth-api -n auth
kubectl rollout restart deployment/character-api -n character

# Deployment ìƒíƒœ í™•ì¸
kubectl rollout status deployment/auth-api -n auth

# Deployment í™•ì¸
kubectl get deployment -n auth
kubectl describe deployment auth-api -n auth
```

#### Service & Ingress
```bash
# Service í™•ì¸
kubectl get svc -n auth
kubectl get svc -n default

# Ingress í™•ì¸
kubectl get ingress -n default
kubectl get ingress -n argocd

# Endpoints í™•ì¸
kubectl get endpoints -n default
```

#### ArgoCD ê´€ë¦¬
```bash
# ArgoCD Applications í™•ì¸
kubectl get applications -n argocd

# íŠ¹ì • Application ìƒíƒœ
kubectl describe application dev-api-auth -n argocd

# ArgoCD refresh & sync
kubectl -n argocd annotate application dev-api-auth argocd.argoproj.io/refresh=hard --overwrite
kubectl -n argocd patch application dev-api-auth --type merge -p '{"operation":{"sync":{"prune":true}}}'

# ëª¨ë“  Application ë™ê¸°í™”
./scripts/sync-argocd-refresh-all.sh dev
```

#### Secrets & ConfigMaps
```bash
# ConfigMap í™•ì¸
kubectl get configmap -n auth
kubectl describe configmap auth-config -n auth

# Secret í™•ì¸
kubectl get secret -n auth
kubectl get secret auth-secret -n auth -o yaml

# External Secret ìƒíƒœ
kubectl get externalsecret -n auth
kubectl describe externalsecret auth-secret -n auth
```

#### ë¡œê·¸ í™•ì¸
```bash
# íŠ¹ì • ì„œë¹„ìŠ¤ ë¡œê·¸
kubectl logs -n auth deployment/auth-api --tail=100 -f

# ArgoCD ì„œë²„ ë¡œê·¸
kubectl logs -n argocd deployment/argocd-server --tail=100 -f

# ëª¨ë“  pod ë¡œê·¸ (label selector)
kubectl logs -n auth -l app=auth-api --all-containers --tail=50
```

#### Port Forward
```bash
# ë¡œì»¬ì—ì„œ pod ì ‘ê·¼
kubectl port-forward -n auth deployment/auth-api 8000:8000

# ArgoCD UI ì ‘ê·¼
kubectl port-forward -n argocd svc/argocd-server 8080:80

# PostgreSQL ì ‘ê·¼
kubectl port-forward -n postgres svc/dev-postgresql 5432:5432

# Redis ì ‘ê·¼
kubectl port-forward -n redis svc/dev-redis 6379:6379
```

#### ë””ë²„ê¹…
```bash
# Events í™•ì¸
kubectl get events -n auth --sort-by='.lastTimestamp'

# Pod describe (ë¬¸ì œ ì›ì¸ ì°¾ê¸°)
kubectl describe pod <pod-name> -n auth

# Node ìƒíƒœ í™•ì¸
kubectl get nodes -o wide
kubectl describe node k8s-api-auth

# Resource ì‚¬ìš©ëŸ‰
kubectl top nodes
kubectl top pods -n auth
```

## Docker ëª…ë ¹ì–´

### ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
```bash
# íŠ¹ì • ì„œë¹„ìŠ¤ ë¹Œë“œ
docker build -t mng990/eco2:auth-api-latest -f domains/auth/Dockerfile .
docker build -t mng990/eco2:character-api-latest -f domains/character/Dockerfile .

# ì´ë¯¸ì§€ í‘¸ì‹œ
docker push mng990/eco2:auth-api-latest

# ëª¨ë“  íƒœê·¸ í™•ì¸
docker images mng990/eco2
```

### ë¡œì»¬ í…ŒìŠ¤íŠ¸
```bash
# docker-composeë¡œ ë¡œì»¬ ì‹¤í–‰
cd domains/auth
docker-compose -f docker-compose.auth-local.yml up --build -d
docker-compose -f docker-compose.auth-local.yml logs -f auth

# ì¤‘ì§€
docker-compose -f docker-compose.auth-local.yml down
```

## Git ì›Œí¬í”Œë¡œìš°

### ì¼ë°˜ì ì¸ ì‘ì—…
```bash
# ìƒíƒœ í™•ì¸
git status

# ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
git add <file>
git add -A  # ëª¨ë“  ë³€ê²½ì‚¬í•­

# ì»¤ë°‹
git commit -m "feat: <message>"
git commit -m "fix: <message>"
git commit -m "refactor: <message>"

# Push
git push origin develop
```

### ë¸Œëœì¹˜ ê´€ë¦¬
```bash
# ë¸Œëœì¹˜ ëª©ë¡
git branch -a

# ìƒˆ ë¸Œëœì¹˜ ìƒì„±
git checkout -b feature/new-feature

# ë¸Œëœì¹˜ ì „í™˜
git checkout develop
```

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
backend/
â”œâ”€â”€ domains/              # ë„ë©”ì¸ë³„ API ì†ŒìŠ¤ì½”ë“œ
â”‚   â”œâ”€â”€ auth/            # ì¸ì¦/ì¸ê°€ ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ character/       # ìºë¦­í„° ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ chat/            # ì±—ë´‡ ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ info/            # ì •ë³´ ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ location/        # ìœ„ì¹˜ ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ my/              # ë§ˆì´í˜ì´ì§€ ì„œë¹„ìŠ¤
â”‚   â””â”€â”€ scan/            # ìŠ¤ìº” ì„œë¹„ìŠ¤
â”œâ”€â”€ workloads/           # Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸
â”‚   â”œâ”€â”€ domains/         # API deployment, service, configmap
â”‚   â”œâ”€â”€ ingress/         # Ingress ì„¤ì •
â”‚   â”œâ”€â”€ namespaces/      # Namespace ì •ì˜
â”‚   â”œâ”€â”€ network-policies/ # Network Policy
â”‚   â”œâ”€â”€ rbac-storage/    # RBAC & Storage
â”‚   â””â”€â”€ secrets/         # External Secrets
â”œâ”€â”€ clusters/            # ArgoCD Applications
â”‚   â”œâ”€â”€ dev/
â”‚   â””â”€â”€ prod/
â”œâ”€â”€ terraform/           # Infrastructure as Code
â””â”€â”€ scripts/            # ìœ í‹¸ë¦¬í‹° ìŠ¤í¬ë¦½íŠ¸
```

## ìì£¼ ë°œìƒí•˜ëŠ” ì´ìŠˆ í•´ê²°

### ImagePullBackOff
```bash
# Secret í™•ì¸
kubectl get secret dockerhub-secret -n auth

# Pod events í™•ì¸
kubectl describe pod <pod-name> -n auth

# Deployment ì¬ì‹œì‘
kubectl rollout restart deployment/auth-api -n auth
```

### CrashLoopBackOff
```bash
# ë¡œê·¸ í™•ì¸
kubectl logs <pod-name> -n auth --previous

# ConfigMap & Secret í™•ì¸
kubectl get configmap auth-config -n auth -o yaml
kubectl get secret auth-secret -n auth -o yaml
```

### ArgoCD Out of Sync
```bash
# Hard refresh
kubectl -n argocd annotate application dev-api-auth argocd.argoproj.io/refresh=hard --overwrite

# Sync
kubectl -n argocd patch application dev-api-auth --type merge -p '{"operation":{"sync":{"prune":true}}}'
```

## ê°œë°œ ê°€ì´ë“œ

### ìƒˆ API ì¶”ê°€ ì‹œ
1. `domains/<service>/` ì— ì½”ë“œ ì‘ì„±
2. `domains/<service>/Dockerfile` ì‘ì„± (auth ì°¸ê³ )
3. `workloads/domains/<service>/` ì— K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„±
4. `clusters/dev/apps/60-apis-appset.yaml` ì— ì„œë¹„ìŠ¤ ì¶”ê°€

### API ë°°í¬ í”Œë¡œìš°
1. ì½”ë“œ ìˆ˜ì • (domains/<service>/)
2. Git commit & push
3. GitHub Actions CIê°€ ìë™ ë¹Œë“œ & í‘¸ì‹œ
4. ArgoCDê°€ ìë™ sync & ë°°í¬

### ê¸´ê¸‰ ë°°í¬
```bash
# íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ê°•ì œ ë¹Œë“œ
gh workflow run ci-services.yml -f target_services=auth

# ArgoCD ìˆ˜ë™ sync
./scripts/sync-argocd-all.sh
```

## âš ï¸ ì½”ë“œ ë³€ê²½ ì „ í•„ìˆ˜ ê²€ì¦ ì ˆì°¨

**ì»¤ë°‹ ì „ì— ë°˜ë“œì‹œ ë‹¤ìŒ ê²€ì¦ì„ ìˆ˜í–‰í•˜ì—¬ CI ì‹¤íŒ¨ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.**

### Python ì½”ë“œ ë³€ê²½ ì‹œ
```bash
# 1. Black í¬ë§¤íŒ… (í•„ìˆ˜)
black <ë³€ê²½ëœ_íŒŒì¼_ë˜ëŠ”_ë””ë ‰í† ë¦¬>

# 2. Ruff ë¦°íŠ¸ ê²€ì‚¬ (í•„ìˆ˜)
ruff check <ë³€ê²½ëœ_íŒŒì¼_ë˜ëŠ”_ë””ë ‰í† ë¦¬> --fix

# 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê¶Œì¥)
pytest <ë³€ê²½ëœ_ì„œë¹„ìŠ¤>/tests/ -v

# ì˜ˆì‹œ: character ì„œë¹„ìŠ¤ ì „ì²´ ê²€ì¦
black apps/character
ruff check apps/character --fix
pytest apps/character/tests/ -v
```

### ì „ì²´ ê²€ì¦ (ì»¤ë°‹ ì§ì „)
```bash
# ë³€ê²½ëœ ì„œë¹„ìŠ¤ì— ëŒ€í•´ ì‹¤í–‰
black --check apps/<service>
ruff check apps/<service>
pytest apps/<service>/tests/ -v
```

### CI ì²´í¬ í•­ëª©
1. **black --check**: ì½”ë“œ í¬ë§¤íŒ… ê²€ì‚¬
2. **ruff check**: ë¦°íŠ¸ ê²€ì‚¬
3. **pytest**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

> ğŸ’¡ **íŒ**: pre-commit hookì´ black/ruffë¥¼ ìë™ ì‹¤í–‰í•˜ì§€ë§Œ, í…ŒìŠ¤íŠ¸ëŠ” ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
