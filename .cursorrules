# SeSACTHON Backend Project Rules

## 자주 사용하는 명령어

### SSH 접속
```bash
# Master 노드 접속
./scripts/utilities/connect-ssh.sh master

# Worker 노드 접속
./scripts/utilities/connect-ssh.sh worker-1
./scripts/utilities/connect-ssh.sh worker-2

# Storage 노드 접속
./scripts/utilities/connect-ssh.sh storage
```

### Kubectl 명령어

#### Pod 관리
```bash
# 특정 namespace의 pod 확인
kubectl get pods -n auth -o wide
kubectl get pods -n character -o wide
kubectl get pods -n chat -o wide

# Pod 로그 확인
kubectl logs -n auth -l app=auth-api --tail=100 -f

# Pod 내부 접속
kubectl exec -it <pod-name> -n auth -- /bin/bash
kubectl exec -it <pod-name> -n auth -- /bin/sh

# Pod 내부에서 API 테스트 (Python 사용)
kubectl exec -it <pod-name> -n auth -- python3 -c "
import urllib.request
response = urllib.request.urlopen('http://localhost:8000/health')
print(f'Status: {response.status}')
print(f'Body: {response.read().decode()}')
"
```

#### Deployment 관리
```bash
# Deployment 재시작
kubectl rollout restart deployment/auth-api -n auth
kubectl rollout restart deployment/character-api -n character

# Deployment 상태 확인
kubectl rollout status deployment/auth-api -n auth

# Deployment 확인
kubectl get deployment -n auth
kubectl describe deployment auth-api -n auth
```

#### Service & Ingress
```bash
# Service 확인
kubectl get svc -n auth
kubectl get svc -n default

# Ingress 확인
kubectl get ingress -n default
kubectl get ingress -n argocd

# Endpoints 확인
kubectl get endpoints -n default
```

#### ArgoCD 관리
```bash
# ArgoCD Applications 확인
kubectl get applications -n argocd

# 특정 Application 상태
kubectl describe application dev-api-auth -n argocd

# ArgoCD refresh & sync
kubectl -n argocd annotate application dev-api-auth argocd.argoproj.io/refresh=hard --overwrite
kubectl -n argocd patch application dev-api-auth --type merge -p '{"operation":{"sync":{"prune":true}}}'

# 모든 Application 동기화
./scripts/sync-argocd-refresh-all.sh dev
```

#### Secrets & ConfigMaps
```bash
# ConfigMap 확인
kubectl get configmap -n auth
kubectl describe configmap auth-config -n auth

# Secret 확인
kubectl get secret -n auth
kubectl get secret auth-secret -n auth -o yaml

# External Secret 상태
kubectl get externalsecret -n auth
kubectl describe externalsecret auth-secret -n auth
```

#### 로그 확인
```bash
# 특정 서비스 로그
kubectl logs -n auth deployment/auth-api --tail=100 -f

# ArgoCD 서버 로그
kubectl logs -n argocd deployment/argocd-server --tail=100 -f

# 모든 pod 로그 (label selector)
kubectl logs -n auth -l app=auth-api --all-containers --tail=50
```

#### Port Forward
```bash
# 로컬에서 pod 접근
kubectl port-forward -n auth deployment/auth-api 8000:8000

# ArgoCD UI 접근
kubectl port-forward -n argocd svc/argocd-server 8080:80

# PostgreSQL 접근
kubectl port-forward -n postgres svc/dev-postgresql 5432:5432

# Redis 접근
kubectl port-forward -n redis svc/dev-redis 6379:6379
```

#### 디버깅
```bash
# Events 확인
kubectl get events -n auth --sort-by='.lastTimestamp'

# Pod describe (문제 원인 찾기)
kubectl describe pod <pod-name> -n auth

# Node 상태 확인
kubectl get nodes -o wide
kubectl describe node k8s-api-auth

# Resource 사용량
kubectl top nodes
kubectl top pods -n auth
```

## Docker 명령어

### 이미지 빌드 & 푸시
```bash
# 특정 서비스 빌드
docker build -t mng990/eco2:auth-api-latest -f domains/auth/Dockerfile .
docker build -t mng990/eco2:character-api-latest -f domains/character/Dockerfile .

# 이미지 푸시
docker push mng990/eco2:auth-api-latest

# 모든 태그 확인
docker images mng990/eco2
```

### 로컬 테스트
```bash
# docker-compose로 로컬 실행
cd domains/auth
docker-compose -f docker-compose.auth-local.yml up --build -d
docker-compose -f docker-compose.auth-local.yml logs -f auth

# 중지
docker-compose -f docker-compose.auth-local.yml down
```

## Git 워크플로우

### 일반적인 작업
```bash
# 상태 확인
git status

# 변경사항 스테이징
git add <file>
git add -A  # 모든 변경사항

# 커밋
git commit -m "feat: <message>"
git commit -m "fix: <message>"
git commit -m "refactor: <message>"

# Push
git push origin develop
```

### 브랜치 관리
```bash
# 브랜치 목록
git branch -a

# 새 브랜치 생성
git checkout -b feature/new-feature

# 브랜치 전환
git checkout develop
```

## 프로젝트 구조

```
backend/
├── domains/              # 도메인별 API 소스코드
│   ├── auth/            # 인증/인가 서비스
│   ├── character/       # 캐릭터 서비스
│   ├── chat/            # 챗봇 서비스
│   ├── info/            # 정보 서비스
│   ├── location/        # 위치 서비스
│   ├── my/              # 마이페이지 서비스
│   └── scan/            # 스캔 서비스
├── workloads/           # Kubernetes 매니페스트
│   ├── domains/         # API deployment, service, configmap
│   ├── ingress/         # Ingress 설정
│   ├── namespaces/      # Namespace 정의
│   ├── network-policies/ # Network Policy
│   ├── rbac-storage/    # RBAC & Storage
│   └── secrets/         # External Secrets
├── clusters/            # ArgoCD Applications
│   ├── dev/
│   └── prod/
├── terraform/           # Infrastructure as Code
└── scripts/            # 유틸리티 스크립트
```

## 자주 발생하는 이슈 해결

### ImagePullBackOff
```bash
# Secret 확인
kubectl get secret dockerhub-secret -n auth

# Pod events 확인
kubectl describe pod <pod-name> -n auth

# Deployment 재시작
kubectl rollout restart deployment/auth-api -n auth
```

### CrashLoopBackOff
```bash
# 로그 확인
kubectl logs <pod-name> -n auth --previous

# ConfigMap & Secret 확인
kubectl get configmap auth-config -n auth -o yaml
kubectl get secret auth-secret -n auth -o yaml
```

### ArgoCD Out of Sync
```bash
# Hard refresh
kubectl -n argocd annotate application dev-api-auth argocd.argoproj.io/refresh=hard --overwrite

# Sync
kubectl -n argocd patch application dev-api-auth --type merge -p '{"operation":{"sync":{"prune":true}}}'
```

## 개발 가이드

### 새 API 추가 시
1. `domains/<service>/` 에 코드 작성
2. `domains/<service>/Dockerfile` 작성 (auth 참고)
3. `workloads/domains/<service>/` 에 K8s 매니페스트 작성
4. `clusters/dev/apps/60-apis-appset.yaml` 에 서비스 추가

### API 배포 플로우
1. 코드 수정 (domains/<service>/)
2. Git commit & push
3. GitHub Actions CI가 자동 빌드 & 푸시
4. ArgoCD가 자동 sync & 배포

### 긴급 배포
```bash
# 특정 서비스만 강제 빌드
gh workflow run ci-services.yml -f target_services=auth

# ArgoCD 수동 sync
./scripts/sync-argocd-all.sh
```
