# Namespace management
namespace:
  create: true
  name: atlantis

replicaCount: 1

image:
  repository: ghcr.io/runatlantis/atlantis
  tag: v0.27.0
  pullPolicy: IfNotPresent

serviceAccount:
  create: true
  name: atlantis
  annotations: {}

secretName: atlantis-secrets

aws:
  region: ap-northeast-2

atlantis:
  url: https://atlantis.growbin.app
  repoAllowlist: github.com/SeSACTHON/*
  githubUser: SeSACTHON
  hidePrevPlanComments: true
  port: 4141
  dataDir: /atlantis-data
  pathEnv: "/usr/local/bin:/usr/local/sbin:/shared/bin:/usr/sbin:/usr/bin:/sbin:/bin"

repoConfig: |-
  repos:
    - id: github.com/SeSACTHON/.*
      workflow: infrastructure-workflow
      apply_requirements:
        - approved
        - mergeable
      allow_custom_workflows: true
  workflows:
    infrastructure-workflow:
      plan:
        steps:
          - env:
              name: SETUP_ENV
              command: 'echo "Setting up environment..."'
          - init
          - run: terraform validate
          - plan:
              extra_args:
                - -lock-timeout=5m
                - -var-file=terraform.tfvars
          - run: |
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âœ… Terraform Plan Complete"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      apply:
        steps:
          - env:
              name: SETUP_ENV
              command: 'echo "Setting up environment..."'
          - init
          - apply:
              extra_args:
                - -lock-timeout=5m
                - -var-file=terraform.tfvars
          - run: |
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“Š Exporting Terraform Outputs (Phase 3)..."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              terraform output -json > /tmp/tf-outputs.json
              terraform output -raw ansible_inventory > /tmp/ansible-inventory.ini
              if command -v kubectl &> /dev/null; then
                kubectl get namespace argocd &>/dev/null || kubectl create namespace argocd
                kubectl create configmap terraform-outputs \
                  --from-file=tf-outputs.json=/tmp/tf-outputs.json \
                  --from-file=ansible-inventory.ini=/tmp/ansible-inventory.ini \
                  --namespace=argocd \
                  --dry-run=client -o yaml | kubectl apply -f -
                echo "âœ… Terraform Outputs saved to ConfigMap (namespace: argocd)"
                kubectl get configmap terraform-outputs -n argocd
                echo "ğŸ”„ ArgoCD PreSync Hookì´ ì´ ConfigMapì„ ì½ì–´ì„œ Ansibleì„ ì‹¤í–‰í•©ë‹ˆë‹¤"
              else
                echo "âš ï¸  kubectl not found, skipping ConfigMap creation"
          - run: |
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ”— Triggering Post-Apply Actions..."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "Terraform Apply Complete!"

initKubectl:
  enabled: true
  image: bitnami/kubectl:latest

service:
  type: NodePort
  port: 80
  targetPort: 4141
  nodePort: 32141

persistence:
  enabled: true
  storageClassName: gp3
  size: 20Gi

resources:
  requests:
    cpu: 250m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 2Gi

nodeSelector: {}

tolerations:
  - key: node-role.kubernetes.io/infrastructure
    operator: Equal
    value: "true"
    effect: NoSchedule

affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - k8s-monitoring

