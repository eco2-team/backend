# Ecoeco Backend - Helm Chart Values
# 전체 서비스 설정 (6 API + 5 Celery Workers)

# Global 설정
global:
  image:
    registry: ghcr.io
    repository: your-org/ecoeco-backend
    tag: latest
    pullPolicy: Always
  
  domain: ecoeco.app
  
  # 환경 변수
  env:
    - name: ENVIRONMENT
      value: "production"
    - name: LOG_LEVEL
      value: "info"

# Namespace 설정
namespaces:
  api: api
  workers: workers
  data: data
  messaging: messaging

# 외부 서비스 연결
externalServices:
  postgresql:
    host: postgresql.data.svc.cluster.local
    port: 5432
    database: ecoeco
  
  redis:
    host: redis.data.svc.cluster.local
    port: 6379
  
  rabbitmq:
    host: rabbitmq.messaging.svc.cluster.local
    port: 5672
    managementPort: 15672

# Secrets (실제 값은 Sealed Secrets 또는 External Secrets로 관리)
secrets:
  postgresql:
    username: admin
    password: changeme  # 실제로는 secret으로 관리
  
  redis:
    password: ""  # Redis는 비밀번호 없음 (내부 통신)
  
  rabbitmq:
    username: admin
    password: changeme
  
  openai:
    apiKey: sk-xxx  # 실제로는 secret으로 관리
  
  jwt:
    secretKey: your-jwt-secret-key
  
  kakao:
    apiKey: your-kakao-api-key

#############################################
# API Services
#############################################

api:
  namespace: api
  
  # 공통 설정
  common:
    serviceAccount: api-sa
    nodeSelector:
      workload: api
    imagePullSecrets: []
  
  # Ingress 설정
  ingress:
    enabled: true
    className: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: instance
      alb.ingress.kubernetes.io/healthcheck-path: /health
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
      alb.ingress.kubernetes.io/ssl-redirect: '443'
    host: api.ecoeco.app
  
  # 1. Waste API (메인)
  waste:
    enabled: true
    replicas: 3
    port: 8000
    path: /api/v1/waste
    
    image:
      repository: ghcr.io/your-org/waste-api
      tag: latest
    
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1024Mi
    
    env:
      - name: SERVICE_NAME
        value: "waste-api"
      - name: CELERY_ENABLED
        value: "true"
    
    livenessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 30
      periodSeconds: 10
    
    readinessProbe:
      httpGet:
        path: /ready
        port: 8000
      initialDelaySeconds: 10
      periodSeconds: 5
  
  # 2. Auth API
  auth:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/auth
    
    image:
      repository: ghcr.io/your-org/auth-api
      tag: latest
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "auth-api"
      - name: JWT_SECRET
        valueFrom:
          secretKeyRef:
            name: jwt-secrets
            key: secret-key
  
  # 3. User Info API
  userinfo:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/users
    
    image:
      repository: ghcr.io/your-org/userinfo-api
      tag: latest
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "userinfo-api"
  
  # 4. Location API
  location:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/locations
    
    image:
      repository: ghcr.io/your-org/location-api
      tag: latest
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "location-api"
      - name: KAKAO_API_KEY
        valueFrom:
          secretKeyRef:
            name: kakao-secrets
            key: api-key
  
  # 5. Recycle Info API
  recycleInfo:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/recycle
    
    image:
      repository: ghcr.io/your-org/recycle-info-api
      tag: latest
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "recycle-info-api"
  
  # 6. Chat LLM API
  chatLlm:
    enabled: true
    replicas: 3
    port: 8000
    path: /api/v1/chat
    
    image:
      repository: ghcr.io/your-org/chat-llm-api
      tag: latest
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "chat-llm-api"
      - name: OPENAI_API_KEY
        valueFrom:
          secretKeyRef:
            name: openai-secrets
            key: api-key

#############################################
# Celery Workers
#############################################

workers:
  namespace: workers
  
  # 공통 설정
  common:
    serviceAccount: workers-sa
    imagePullSecrets: []
    
    env:
      - name: CELERY_BROKER_URL
        value: "amqp://admin:password@rabbitmq.messaging.svc.cluster.local:5672//"
      - name: CELERY_RESULT_BACKEND
        value: "redis://redis.data.svc.cluster.local:6379/0"
  
  # 1. Image Uploader
  imageUploader:
    enabled: true
    replicas: 3
    queue: q.image_upload
    
    image:
      repository: ghcr.io/your-org/ecoeco-backend
      tag: latest
    
    command:
      - celery
      - -A
      - workers.image_uploader
      - worker
      - --loglevel=info
      - --queues=q.image_upload
      - --concurrency=8
      - --pool=processes
      - --prefetch-multiplier=4
    
    nodeSelector:
      workload: async-workers
    
    resources:
      requests:
        cpu: 300m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 512Mi
    
    env:
      - name: AWS_S3_BUCKET
        value: "ecoeco-waste-images"
      - name: AWS_REGION
        value: "ap-northeast-2"
  
  # 2. GPT-5 Analyzer
  gpt5Analyzer:
    enabled: true
    replicas: 5
    queue: q.gpt5_analysis
    
    image:
      repository: ghcr.io/your-org/ecoeco-backend
      tag: latest
    
    command:
      - celery
      - -A
      - workers.gpt5_analyzer
      - worker
      - --loglevel=info
      - --queues=q.gpt5_analysis
      - --concurrency=20
      - --pool=gevent
      - --prefetch-multiplier=1
    
    nodeSelector:
      workload: async-workers
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: OPENAI_API_KEY
        valueFrom:
          secretKeyRef:
            name: openai-secrets
            key: api-key
  
  # 3. Rule Retriever
  ruleRetriever:
    enabled: true
    replicas: 2
    queue: q.rule_retrieval
    
    image:
      repository: ghcr.io/your-org/ecoeco-backend
      tag: latest
    
    command:
      - celery
      - -A
      - workers.rule_retriever
      - worker
      - --loglevel=info
      - --queues=q.rule_retrieval
      - --concurrency=4
      - --pool=processes
      - --prefetch-multiplier=4
    
    nodeSelector:
      workload: async-workers
    
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 800m
        memory: 512Mi
  
  # 4. Response Generator
  responseGenerator:
    enabled: true
    replicas: 3
    queue: q.response_generation
    
    image:
      repository: ghcr.io/your-org/ecoeco-backend
      tag: latest
    
    command:
      - celery
      - -A
      - workers.response_generator
      - worker
      - --loglevel=info
      - --queues=q.response_generation
      - --concurrency=10
      - --pool=gevent
      - --prefetch-multiplier=2
    
    nodeSelector:
      workload: async-workers
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: OPENAI_API_KEY
        valueFrom:
          secretKeyRef:
            name: openai-secrets
            key: api-key
  
  # 5. Task Scheduler (Celery Beat)
  taskScheduler:
    enabled: true
    replicas: 1  # ⚠️ 반드시 1개만!
    
    image:
      repository: ghcr.io/your-org/ecoeco-backend
      tag: latest
    
    command:
      - celery
      - -A
      - workers.task_scheduler
      - beat
      - --loglevel=info
      - --scheduler=celery.beat:PersistentScheduler
    
    nodeSelector:
      workload: async-workers
    
    strategy:
      type: Recreate  # RollingUpdate 금지 (중복 실행 방지)
    
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
    
    volumeMounts:
      - name: beat-schedule
        mountPath: /tmp
    
    volumes:
      - name: beat-schedule
        emptyDir: {}

#############################################
# Monitoring
#############################################

monitoring:
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
  
  prometheusRule:
    enabled: true
    rules:
      - alert: HighPodCPU
        expr: sum(rate(container_cpu_usage_seconds_total{namespace="api"}[5m])) by (pod) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.pod }}"
      
      - alert: HighPodMemory
        expr: container_memory_working_set_bytes{namespace="api"} / container_spec_memory_limit_bytes{namespace="api"} > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.pod }}"

