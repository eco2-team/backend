# Ecoeco Backend - 13-Node Microservices Architecture
# Values for Helm Chart

global:
  imageRegistry: ghcr.io/sesacthon
  imagePullPolicy: IfNotPresent
  
# API Services (6개 도메인별 노드)
api:
  waste:
    enabled: true
    name: waste-api
    replicas: 2
    image:
      repository: waste-api
      tag: latest
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    nodeSelector:
      domain: waste
    service:
      type: ClusterIP
      port: 8000
  
  auth:
    enabled: true
    name: auth-api
    replicas: 2
    image:
      repository: auth-api
      tag: latest
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 300m
        memory: 256Mi
    nodeSelector:
      domain: auth
    service:
      type: ClusterIP
      port: 8000
  
  userinfo:
    enabled: true
    name: userinfo-api
    replicas: 2
    image:
      repository: userinfo-api
      tag: latest
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 300m
        memory: 256Mi
    nodeSelector:
      domain: userinfo
    service:
      type: ClusterIP
      port: 8000
  
  location:
    enabled: true
    name: location-api
    replicas: 2
    image:
      repository: location-api
      tag: latest
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 300m
        memory: 256Mi
    nodeSelector:
      domain: location
    service:
      type: ClusterIP
      port: 8000
  
  recycleInfo:
    enabled: true
    name: recycle-info-api
    replicas: 2
    image:
      repository: recycle-info-api
      tag: latest
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 300m
        memory: 256Mi
    nodeSelector:
      domain: recycle-info
    service:
      type: ClusterIP
      port: 8000
  
  chatLlm:
    enabled: true
    name: chat-llm-api
    replicas: 2
    image:
      repository: chat-llm-api
      tag: latest
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    nodeSelector:
      domain: chat-llm
    service:
      type: ClusterIP
      port: 8000

# Worker Services (2개 워크로드별 노드)
worker:
  storage:
    enabled: true
    name: storage-worker
    replicas: 2
    image:
      repository: storage-worker
      tag: latest
    resources:
      requests:
        cpu: 250m      # 최적화: 500m → 250m
        memory: 512Mi
      limits:
        cpu: 1000m     # 최적화: 2000m → 1000m
        memory: 1Gi    # 최적화: 2Gi → 1Gi
    nodeSelector:
      workload: worker-storage
      worker-type: io-bound
    poolType: eventlet
    concurrency: 1000
    env:
      - name: CELERY_POOL
        value: "eventlet"
      - name: CELERY_CONCURRENCY
        value: "1000"
  
  ai:
    enabled: true
    name: ai-worker
    replicas: 2
    image:
      repository: ai-worker
      tag: latest
    resources:
      requests:
        cpu: 500m      # 최적화: 1000m → 500m
        memory: 1Gi    # 최적화: 2Gi → 1Gi
      limits:
        cpu: 2000m     # 최적화: 4000m → 2000m
        memory: 2Gi    # 최적화: 4Gi → 2Gi
    nodeSelector:
      workload: worker-ai
      worker-type: network-bound
    poolType: prefork
    concurrency: 4
    env:
      - name: CELERY_POOL
        value: "prefork"
      - name: CELERY_CONCURRENCY
        value: "4"

# Ingress Configuration
ingress:
  enabled: true
  className: alb
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/group.name: ecoeco-alb
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
  host: api.ecoeco.app
  paths:
    - path: /api/v1/waste
      pathType: Prefix
      backend: waste-api
    - path: /api/v1/auth
      pathType: Prefix
      backend: auth-api
    - path: /api/v1/users
      pathType: Prefix
      backend: userinfo-api
    - path: /api/v1/locations
      pathType: Prefix
      backend: location-api
    - path: /api/v1/recycle
      pathType: Prefix
      backend: recycle-info-api
    - path: /api/v1/chat
      pathType: Prefix
      backend: chat-llm-api

# Common Environment Variables
env:
  common:
    - name: ENVIRONMENT
      value: "production"
    - name: LOG_LEVEL
      value: "INFO"
  
  database:
    - name: POSTGRES_HOST
      value: "k8s-postgresql"
    - name: POSTGRES_PORT
      value: "5432"
  
  cache:
    - name: REDIS_HOST
      value: "k8s-redis"
    - name: REDIS_PORT
      value: "6379"
  
  queue:
    - name: RABBITMQ_HOST
      value: "k8s-rabbitmq"
    - name: RABBITMQ_PORT
      value: "5672"

# ConfigMaps
configMaps:
  app:
    data:
      APP_NAME: "Ecoeco"
      API_VERSION: "v1"

# Secrets (placeholder - actual values in sealed-secrets or external secrets)
secrets:
  database:
    POSTGRES_USER: "ecoeco"
    POSTGRES_PASSWORD: "REPLACE_ME"
  
  aws:
    AWS_ACCESS_KEY_ID: "REPLACE_ME"
    AWS_SECRET_ACCESS_KEY: "REPLACE_ME"
    S3_BUCKET: "ecoeco-images"
  
  openai:
    OPENAI_API_KEY: "REPLACE_ME"

