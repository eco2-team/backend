# Ecoeco Backend - Helm Chart Values
# 14-Node 아키텍처: 7 API + 5 Celery Workers + 2 Data (PostgreSQL, Redis)

# Global 설정
global:
  image:
    registry: ghcr.io
    repository: sesacthon
    pullPolicy: Always
  
  domain: growbin.app

# Namespace 설정
namespaces:
  api: api
  workers: workers
  db: db
  monitoring: monitoring

# 외부 서비스 연결
externalServices:
  postgresql:
    host: postgresql.db.svc.cluster.local
    port: 5432
    database: ecoeco
  
  redis:
    host: redis.db.svc.cluster.local
    port: 6379
  
  rabbitmq:
    host: rabbitmq.db.svc.cluster.local
    port: 5672
    managementPort: 15672
  
  s3:
    bucket: sesacthon-images
    region: ap-northeast-2

#############################################
# API Services (7개 도메인별 전용 노드)
#############################################

api:
  namespace: api
  
  # 공통 설정
  common:
    serviceAccount: api-sa
    imagePullSecrets: []
  
  # Ingress 설정
  ingress:
    enabled: true
    className: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: instance
      alb.ingress.kubernetes.io/healthcheck-path: /health
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
      alb.ingress.kubernetes.io/ssl-redirect: '443'
    host: api.growbin.app
  
  # 1. Auth API (인증/인가 - JWT Blacklist)
  auth:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/auth
    
    image:
      repository: ghcr.io/sesacthon/auth
      tag: latest  # auto
    
    nodeSelector:
      domain: auth
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "auth-api"
      - name: REDIS_HOST
        value: "redis.db.svc.cluster.local"
      - name: GITOPS_TEST_VERSION
        value: "v0.7.0-test-2025-11-11"
      - name: GITOPS_TEST_MESSAGE
        value: "Testing ArgoCD Auto-Sync from develop branch"
    
    livenessProbe:
      httpGet:
        path: /health
        port: 8000
      initialDelaySeconds: 30
      periodSeconds: 10
    
    readinessProbe:
      httpGet:
        path: /ready
        port: 8000
      initialDelaySeconds: 10
      periodSeconds: 5
  
  # 2. My API (마이페이지)
  my:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/my
    
    image:
      repository: ghcr.io/sesacthon/my
      tag: latest  # auto
    
    nodeSelector:
      domain: my
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "my-api"
  
  # 3. Scan API (쓰레기 분류 - 고트래픽)
  scan:
    enabled: true
    replicas: 3
    port: 8000
    path: /api/v1/scan
    
    image:
      repository: ghcr.io/sesacthon/scan
      tag: latest  # auto
    
    nodeSelector:
      domain: scan
    
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1024Mi
    
    env:
      - name: SERVICE_NAME
        value: "scan-api"
      - name: CELERY_ENABLED
        value: "true"
  
  # 4. Character API (캐릭터)
  character:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/character
    
    image:
      repository: ghcr.io/sesacthon/character
      tag: latest  # auto
    
    nodeSelector:
      domain: character
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "character-api"
  
  # 5. Location API (위치 기반)
  location:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/location
    
    image:
      repository: ghcr.io/sesacthon/location
      tag: latest  # auto
    
    nodeSelector:
      domain: location
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "location-api"
      - name: KAKAO_API_KEY
        valueFrom:
          secretKeyRef:
            name: kakao-secrets
            key: api-key
  
  # 6. Info API (재활용 정보)
  info:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/info
    
    image:
      repository: ghcr.io/sesacthon/info
      tag: latest  # auto
    
    nodeSelector:
      domain: info
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "info-api"
  
  # 7. Chat API (AI 챗봇 - WebSocket)
  chat:
    enabled: true
    replicas: 2
    port: 8000
    path: /api/v1/chat
    
    image:
      repository: ghcr.io/sesacthon/chat
      tag: latest  # auto
    
    nodeSelector:
      domain: chat
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
    
    env:
      - name: SERVICE_NAME
        value: "chat-api"
      - name: OPENAI_API_KEY
        valueFrom:
          secretKeyRef:
            name: openai-secrets
            key: api-key

#############################################
# Celery Workers (5개)
#############################################

workers:
  namespace: workers
  
  # 공통 설정
  common:
    serviceAccount: workers-sa
    imagePullSecrets: []
    
    env:
      - name: CELERY_BROKER_URL
        value: "amqp://admin:password@rabbitmq.db.svc.cluster.local:5672//"
      - name: CELERY_RESULT_BACKEND
        value: "redis://redis.db.svc.cluster.local:6379/0"
  
  # 1. Task Scheduler
  taskScheduler:
    enabled: true
    replicas: 1
    queue: q.scheduler
    
    image:
      repository: ghcr.io/sesacthon/ecoeco-backend
      tag: latest
    
    nodeSelector:
      workload: workers
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  
  # 2. Image Uploader
  imageUploader:
    enabled: true
    replicas: 3
    queue: q.image_upload
    
    image:
      repository: ghcr.io/sesacthon/ecoeco-backend
      tag: latest
    
    nodeSelector:
      workload: workers
    
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1024Mi
  
  # 3. Rule Retriever
  ruleRetriever:
    enabled: true
    replicas: 2
    queue: q.rule_retriever
    
    image:
      repository: ghcr.io/sesacthon/ecoeco-backend
      tag: latest
    
    nodeSelector:
      workload: workers
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  
  # 4. GPT5 Analyzer
  gpt5Analyzer:
    enabled: true
    replicas: 2
    queue: q.gpt5_analyzer
    
    image:
      repository: ghcr.io/sesacthon/ecoeco-backend
      tag: latest
    
    nodeSelector:
      workload: workers
    
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1024Mi
  
  # 5. Response Generator
  responseGenerator:
    enabled: true
    replicas: 2
    queue: q.response_generator
    
    image:
      repository: ghcr.io/sesacthon/ecoeco-backend
      tag: latest
    
    nodeSelector:
      workload: workers
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

#############################################
# Monitoring (Prometheus, Grafana)
#############################################

monitoring:
  prometheus:
    enabled: true
    nodeSelector:
      workload: monitoring
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi
  
  grafana:
    enabled: true
    nodeSelector:
      workload: monitoring
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

