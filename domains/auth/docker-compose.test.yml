# ============================================================================
# Auth Service Test Docker Compose
#
# Usage:
#   docker-compose -f docker-compose.test.yml build
#   docker-compose -f docker-compose.test.yml run --rm test
#
# With coverage:
#   docker-compose -f docker-compose.test.yml run --rm test-coverage
# ============================================================================
services:
  test:
    build:
      context: ../..
      dockerfile: domains/auth/Dockerfile.test
    container_name: auth-test
    environment:
      # 테스트용 환경 변수
      AUTH_DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/test
      AUTH_REDIS_BLACKLIST_URL: redis://localhost:6379/0
      AUTH_REDIS_OAUTH_STATE_URL: redis://localhost:6379/3
      AUTH_JWT_SECRET_KEY: test-secret-key-for-testing
      AUTH_JWT_ALGORITHM: HS256
      AUTH_JWT_ISSUER: sesacthon-auth
      AUTH_JWT_AUDIENCE: sesacthon-clients
      PYTHONDONTWRITEBYTECODE: '1'
    volumes:
      # 코드 변경 시 재빌드 없이 테스트 가능
    - ../../domains/auth:/app/domains/auth:ro
    command: [python, -m, pytest, domains/auth/tests/, -v, --tb=short]

  test-coverage:
    build:
      context: ../..
      dockerfile: domains/auth/Dockerfile.test
    container_name: auth-test-coverage
    environment:
      AUTH_DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/test
      AUTH_REDIS_BLACKLIST_URL: redis://localhost:6379/0
      AUTH_REDIS_OAUTH_STATE_URL: redis://localhost:6379/3
      AUTH_JWT_SECRET_KEY: test-secret-key-for-testing
      AUTH_JWT_ALGORITHM: HS256
      AUTH_JWT_ISSUER: sesacthon-auth
      AUTH_JWT_AUDIENCE: sesacthon-clients
      PYTHONDONTWRITEBYTECODE: '1'
    volumes:
    - ../../domains/auth:/app/domains/auth:ro
    - ./coverage:/app/coverage
    command: >
      python -m pytest domains/auth/tests/ -v --tb=short
      --cov=domains.auth
      --cov-report=term-missing
      --cov-report=html:coverage/html
      --cov-report=xml:coverage/coverage.xml

  test-unit:
    build:
      context: ../..
      dockerfile: domains/auth/Dockerfile.test
    container_name: auth-test-unit
    environment:
      AUTH_DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/test
      AUTH_REDIS_BLACKLIST_URL: redis://localhost:6379/0
      AUTH_REDIS_OAUTH_STATE_URL: redis://localhost:6379/3
      AUTH_JWT_SECRET_KEY: test-secret-key-for-testing
      AUTH_JWT_ALGORITHM: HS256
      AUTH_JWT_ISSUER: sesacthon-auth
      AUTH_JWT_AUDIENCE: sesacthon-clients
      PYTHONDONTWRITEBYTECODE: '1'
    volumes:
    - ../../domains/auth:/app/domains/auth:ro
    command: [python, -m, pytest, domains/auth/tests/unit/, -v, --tb=short]
