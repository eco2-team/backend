services:
  db:
    image: postgres:16
    container_name: location-local-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: location
      POSTGRES_PASSWORD: location
      POSTGRES_DB: location
    ports:
    - 5434:5432
    volumes:
    - location-db-data:/var/lib/postgresql/data
    - ./init-extensions.sh:/docker-entrypoint-initdb.d/10-extensions.sh:ro
    healthcheck:
      test: [CMD-SHELL, pg_isready -U location -d location]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7
    container_name: location-local-redis
    command: [redis-server, --appendonly, no]
    ports:
    - 6381:6379

  normalized-import:
    build:
      context: ../..
      dockerfile: domains/location/Dockerfile
    container_name: location-local-normalized-import
    restart: no
    command: [python, -m, domains.location.jobs.import_common_locations, --csv-path, /app/domains/location/data/location_common_dataset.csv.gz]
    environment:
      LOCATION_DATABASE_URL: postgresql+asyncpg://location:location@db:5432/location
    depends_on:
      db:
        condition: service_healthy

  api:
    build:
      context: ../..
      dockerfile: domains/location/Dockerfile
    container_name: location-local-api
    environment:
      LOCATION_DATABASE_URL: postgresql+asyncpg://location:location@db:5432/location
      LOCATION_REDIS_URL: redis://redis:6379/5
      LOCATION_AUTH_DISABLED: ${LOCATION_AUTH_DISABLED:-false}
    ports:
    - 8010:8000
    depends_on:
      redis:
        condition: service_started
      normalized-import:
        condition: service_completed_successfully

volumes:
  location-db-data:
    driver: local
