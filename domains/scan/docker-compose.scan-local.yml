x-shared:
  postgres_url: &postgres_url postgresql+asyncpg://sesacthon:sesacthon@local-db:5432/ecoeco
  redis_blacklist_url: &redis_blacklist_url redis://local-redis:6379/0
  redis_oauth_url: &redis_oauth_url redis://local-redis:6379/3
  rabbitmq_url: &rabbitmq_url amqp://guest:guest@local-rabbitmq:5672/
  shared_jwt_secret: &shared_jwt_secret ${SHARED_JWT_SECRET:-local-shared-secret}

services:
  local-db:
    image: postgres:16
    container_name: scan-local-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: sesacthon
      POSTGRES_PASSWORD: sesacthon
      POSTGRES_DB: ecoeco
    ports:
    - 5436:5432
    volumes:
    - local-db-data:/var/lib/postgresql/data
    healthcheck:
      test: [CMD-SHELL, pg_isready -U sesacthon -d ecoeco]
      interval: 5s
      timeout: 5s
      retries: 10

  local-redis:
    image: redis:7
    container_name: scan-local-redis
    command: [redis-server, --appendonly, no]
    ports:
    - 6380:6379

  local-rabbitmq:
    image: rabbitmq:3.12-management
    container_name: scan-local-rabbitmq
    ports:
    - 5672:5672
    - 15672:15672  # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: [CMD, rabbitmq-diagnostics, check_port_connectivity]
      interval: 5s
      timeout: 5s
      retries: 10

  character-seed:
    build:
      context: ../..
      dockerfile: domains/character/Dockerfile
    container_name: character-local-seed
    restart: no
    command: [python, -m, domains.character.jobs.import_character_catalog]
    environment:
      CHARACTER_DATABASE_URL: *postgres_url
      CHARACTER_SCHEMA_RESET_ENABLED: 'true'
    depends_on:
      local-db:
        condition: service_healthy

  auth-db-bootstrap:
    build:
      context: ../..
      dockerfile: domains/auth/Dockerfile
    container_name: scan-local-auth-bootstrap
    restart: no
    command: [python, -m, domains.auth.jobs.init_db]
    environment:
      AUTH_DATABASE_URL: *postgres_url
    depends_on:
      local-db:
        condition: service_healthy

  auth-api:
    build:
      context: ../..
      dockerfile: domains/auth/Dockerfile
    container_name: scan-local-auth-api
    restart: unless-stopped
    ports:
    - 8000:8000
    environment:
      AUTH_DATABASE_URL: *postgres_url
      AUTH_REDIS_BLACKLIST_URL: *redis_blacklist_url
      AUTH_REDIS_OAUTH_STATE_URL: *redis_oauth_url
      AUTH_COOKIE_DOMAIN: localhost
      AUTH_FRONTEND_URL: http://localhost:3000
      AUTH_JWT_SECRET_KEY: *shared_jwt_secret
      AUTH_CHARACTER_API_BASE_URL: http://character-api:8000
      AUTH_ACCESS_COOKIE_NAME: ${AUTH_ACCESS_COOKIE_NAME:-s_access}
      AUTH_KAKAO_CLIENT_ID: ${AUTH_KAKAO_CLIENT_ID:?AUTH_KAKAO_CLIENT_ID is required}
      AUTH_GOOGLE_CLIENT_ID: ${AUTH_GOOGLE_CLIENT_ID:?AUTH_GOOGLE_CLIENT_ID is required}
      AUTH_GOOGLE_CLIENT_SECRET: ${AUTH_GOOGLE_CLIENT_SECRET:?AUTH_GOOGLE_CLIENT_SECRET is required}
      AUTH_NAVER_CLIENT_ID: ${AUTH_NAVER_CLIENT_ID:?AUTH_NAVER_CLIENT_ID is required}
      AUTH_NAVER_CLIENT_SECRET: ${AUTH_NAVER_CLIENT_SECRET:?AUTH_NAVER_CLIENT_SECRET is required}
    depends_on:
      local-redis:
        condition: service_started
      auth-db-bootstrap:
        condition: service_completed_successfully
      character-api:
        condition: service_started

  my-schema-reset:
    build:
      context: ../..
      dockerfile: domains/my/Dockerfile
    container_name: scan-local-my-schema
    restart: no
    command:
    - python
    - -m
    - domains.my.jobs.reset_user_data
    environment:
      MY_DATABASE_URL: *postgres_url
      MY_SCHEMA_RESET_ENABLED: 'true'
    depends_on:
      local-db:
        condition: service_healthy

  my-api:
    build:
      context: ../..
      dockerfile: domains/my/Dockerfile
    container_name: scan-local-my-api
    restart: unless-stopped
    ports:
    - 8002:8000
    environment:
      MY_DATABASE_URL: *postgres_url
      MY_AUTH_DISABLED: ${MY_AUTH_DISABLED:-true}
      MY_JWT_SECRET_KEY: *shared_jwt_secret
      CHARACTER_DATABASE_URL: *postgres_url
    depends_on:
      my-schema-reset:
        condition: service_completed_successfully
      character-seed:
        condition: service_completed_successfully

  character-api:
    build:
      context: ../..
      dockerfile: domains/character/Dockerfile
    container_name: scan-local-character-api
    restart: unless-stopped
    ports:
    - 8004:8000
    env_file:
    - .env.character.local
    environment:
      CHARACTER_DATABASE_URL: *postgres_url
      CHARACTER_AUTH_DISABLED: ${CHARACTER_AUTH_DISABLED:-true}
      CHARACTER_SCHEMA_RESET_ENABLED: 'false'
      CHARACTER_JWT_SECRET_KEY: *shared_jwt_secret
    depends_on:
      character-seed:
        condition: service_completed_successfully

  image-api:
    build:
      context: ../..
      dockerfile: domains/image/Dockerfile
    container_name: scan-local-image-api
    restart: unless-stopped
    ports:
    - 8005:8000
    environment:
      IMAGE_AWS_REGION: ${IMAGE_AWS_REGION:-ap-northeast-2}
      IMAGE_S3_BUCKET: ${IMAGE_S3_BUCKET:-dev-sesacthon-dev-images}
      IMAGE_CDN_DOMAIN: ${IMAGE_CDN_DOMAIN:-https://images.dev.growbin.app}
      IMAGE_PRESIGN_EXPIRES: ${IMAGE_PRESIGN_EXPIRES:-900}
      IMAGE_UPLOAD_STATE_TTL: ${IMAGE_UPLOAD_STATE_TTL:-900}
      IMAGE_REDIS_URL: ${IMAGE_REDIS_URL:-redis://local-redis:6379/6}
      IMAGE_AUTH_DISABLED: ${IMAGE_AUTH_DISABLED:-true}
      IMAGE_JWT_SECRET_KEY: *shared_jwt_secret
      IMAGE_JWT_ALGORITHM: ${IMAGE_JWT_ALGORITHM:-HS256}
      IMAGE_JWT_ISSUER: ${IMAGE_JWT_ISSUER:-sesacthon-auth}
      IMAGE_JWT_AUDIENCE: ${IMAGE_JWT_AUDIENCE:-sesacthon-clients}
      IMAGE_ACCESS_COOKIE_NAME: ${IMAGE_ACCESS_COOKIE_NAME:-s_access}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN:-}
    depends_on:
      local-redis:
        condition: service_started
      auth-api:
        condition: service_started

  scan-api:
    build:
      context: ../..
      dockerfile: domains/scan/Dockerfile
    container_name: scan-local-api
    restart: unless-stopped
    ports:
    - 8003:8000
    # 선택: 환경변수를 .env.scan-local 파일로 관리하고 싶다면 현재 디렉터리에 생성하세요.
    env_file:
    - .env.scan.local
    environment:
      # Vision 파이프라인이 실행되려면 필수입니다.
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}

      # 로컬 개발 편의용. 필요 시 false 로 바꾼 뒤 Auth 스택을 함께 띄우세요.
      SCAN_AUTH_DISABLED: ${SCAN_AUTH_DISABLED:-true}

      # Character API가 없으면 false 로 두고, 로컬 Character 서비스를 사용할 경우 true + BASE_URL 수정
      SCAN_REWARD_FEATURE_ENABLED: ${SCAN_REWARD_FEATURE_ENABLED:-true}
      SCAN_CHARACTER_API_BASE_URL: ${SCAN_CHARACTER_API_BASE_URL:-http://character-api:8000}
      SCAN_CHARACTER_API_TIMEOUT_SECONDS: ${SCAN_CHARACTER_API_TIMEOUT_SECONDS:-5.0}
      SCAN_CHARACTER_API_TOKEN: ${SCAN_CHARACTER_API_TOKEN:-}

      # JWT 설정은 Auth와 동일 값 사용. 기본값은 develop 브랜치 디폴트.
      SCAN_JWT_SECRET_KEY: *shared_jwt_secret
      SCAN_JWT_ALGORITHM: ${SCAN_JWT_ALGORITHM:-HS256}
      SCAN_JWT_ISSUER: ${SCAN_JWT_ISSUER:-sesacthon-auth}
      SCAN_JWT_AUDIENCE: ${SCAN_JWT_AUDIENCE:-sesacthon-clients}

    depends_on:
      character-api:
        condition: service_started
      auth-api:
        condition: service_started
    command:
    - uvicorn
    - domains.scan.main:app
    - --host
    - 0.0.0.0
    - --port
    - '8000'

  scan-worker:
    build:
      context: ../..
      dockerfile: domains/scan/Dockerfile.worker
    container_name: scan-local-worker
    restart: unless-stopped
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY:?OPENAI_API_KEY is required}
      CELERY_BROKER_URL: *rabbitmq_url
      CELERY_RESULT_BACKEND: rpc://
      SCAN_CHARACTER_API_BASE_URL: http://character-api:8000
    depends_on:
      local-rabbitmq:
        condition: service_healthy
      character-api:
        condition: service_started
    command:
    - celery
    - -A
    - domains.scan.celery_app
    - worker
    - --loglevel=info
    - -P
    - gevent  # Gevent pool (높은 동시성 I/O)
    - -Q
    - scan.vision,scan.rule,scan.answer,scan.reward
    - -c
    - '50'  # 로컬 테스트용 동시 greenlet

volumes:
  local-db-data:
    driver: local
