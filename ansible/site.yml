# Kubernetes 클러스터 전체 설정
---
- name: Prerequisites - OS 설정
  hosts: k8s_cluster
  become: yes
  gather_facts: yes
  roles:
    - common

- name: Docker 설치
  hosts: k8s_cluster
  become: yes
  roles:
    - docker

- name: Kubernetes 패키지 설치
  hosts: k8s_cluster
  become: yes
  roles:
    - kubernetes

- name: Master 초기화
  hosts: masters
  become: yes
  tasks:
    - import_tasks: playbooks/02-master-init.yml

- name: Workers 조인 (All Worker Nodes)
  hosts: workers,api_nodes,rabbitmq,postgresql,redis,monitoring
  become: yes
  tasks:
    - import_tasks: playbooks/03-worker-join.yml
  # ⚠️ Worker join 실패 시 여기서 중단됨

- name: Worker 노드 Provider ID 설정 (ALB Controller 필수)
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - import_tasks: playbooks/03-1-set-provider-id.yml

- name: CNI 플러그인 설치 및 클러스터 검증 (AWS VPC CNI)
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - include_tasks: playbooks/04-cni-install-vpc.yml
      when: cni_plugin == 'vpc-cni'
  # ⚠️ 노드 Ready 실패 시 여기서 중단됨
  
- name: CNI 플러그인 설치 및 클러스터 검증 (Calico)
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - include_tasks: playbooks/04-cni-install.yml
      when: cni_plugin != 'vpc-cni'

- import_playbook: playbooks/label-nodes.yml

- name: Add-ons 설치 (Cert-manager, Metrics)
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - import_tasks: playbooks/05-addons.yml
    - import_tasks: playbooks/06-cert-manager-issuer.yml

- name: AWS EBS CSI Driver 및 StorageClass 설정
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - import_tasks: playbooks/05-1-ebs-csi-driver.yml

- name: AWS Load Balancer Controller 설치
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - import_tasks: playbooks/07-alb-controller.yml

- name: IngressClass 리소스 생성 (Kubernetes v1.22+ 표준)
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - import_tasks: playbooks/07-1-ingress-class.yml

- name: ArgoCD 설치
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  roles:
    - argocd

- name: Monitoring 설치 (Prometheus Operator - ServiceMonitor CRD 제공)
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - import_tasks: playbooks/08-monitoring.yml

- name: "RabbitMQ 설치 (Tier 3: Message Queue)"
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  roles:
    - rabbitmq

- name: "Redis 설치 (Tier 4: Persistence - Cache & State)"
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  roles:
    - redis

- name: "PostgreSQL 설치 (Tier 4: Persistence - Database)"
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  roles:
    - postgresql

- name: Ingress 리소스 생성 (ALB 자동 생성)
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - import_tasks: playbooks/07-ingress-resources.yml

- name: etcd 백업 설정
  hosts: masters
  become: yes
  tasks:
    - import_tasks: playbooks/09-etcd-backup.yml

- name: 클러스터 정보 출력
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  tasks:
    - name: Get nodes
      command: kubectl get nodes -o wide
      register: nodes_output
    
    - name: Display nodes
      debug:
        msg: "{{ nodes_output.stdout_lines }}"
    
    - name: etcd 상태 확인
      shell: |
        ETCDCTL_API=3 etcdctl endpoint health \
          --endpoints=https://127.0.0.1:2379 \
          --cacert=/etc/kubernetes/pki/etcd/ca.crt \
          --cert=/etc/kubernetes/pki/etcd/server.crt \
          --key=/etc/kubernetes/pki/etcd/server.key
      register: etcd_health
      changed_when: false
      failed_when: false
    
    - name: etcd 상태 출력
      debug:
        msg: "{{ etcd_health.stdout_lines if etcd_health.rc == 0 else 'etcd health check failed' }}"
    
    - name: Get ArgoCD initial password
      shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      ignore_errors: yes
    
    - name: Display ArgoCD info
      debug:
        msg:
          - "ArgoCD URL: https://{{ ansible_host }}:8080"
          - "Username: admin"
          - "Password: {{ argocd_password.stdout }}"
      when: argocd_password is succeeded

# Route53 A 레코드 업데이트 (ALB 연결)
- name: Route53 업데이트 (ALB 연결)
  hosts: localhost
  connection: local
  become: no
  gather_facts: no
  vars:
    aws_region: "{{ lookup('pipe', 'cd ../terraform && terraform output -raw aws_region') }}"
    domain_name: "{{ lookup('pipe', 'cd ../terraform && terraform output -json dns_records | jq -r .apex_domain | sed \"s|https://||\"') }}"
  tasks:
    - import_tasks: playbooks/09-route53-update.yml

