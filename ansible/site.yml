---
# Ansible Playbook: 전체 배포 (13 Node 구조)
- name: Setup Kubernetes Cluster (13 Nodes)
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Display cluster info
      debug:
        msg: "Setting up 13-node Kubernetes cluster: 1 Master + 6 API + 2 Workers + 4 Infrastructure"
      run_once: true

# Master 노드 설정
- name: Initialize Kubernetes Master
  import_playbook: roles/master/tasks/main.yml
  when: "'masters' in group_names"

# Worker 노드 Join
- name: Join Worker Nodes
  import_playbook: roles/worker/tasks/main.yml
  when: "'masters' not in group_names"

# 노드 라벨링
- name: Label All Nodes
  import_playbook: label-nodes.yml

# Helm 설치
- name: Install Helm
  import_playbook: roles/helm/tasks/main.yml
  when: "'masters' in group_names"

# ArgoCD 설치
- name: Install ArgoCD
  import_playbook: roles/argocd/tasks/main.yml
  when: "'masters' in group_names"

# Monitoring 설치
- name: Install Prometheus & Grafana
  import_playbook: roles/monitoring/tasks/main.yml
  when: "'monitoring' in group_names"

# RabbitMQ 설치
- name: Install RabbitMQ
  import_playbook: roles/rabbitmq/tasks/main.yml
  when: "'rabbitmq' in group_names"

# PostgreSQL 설치
- name: Install PostgreSQL
  import_playbook: roles/postgresql/tasks/main.yml
  when: "'postgresql' in group_names"

# Redis 설치
- name: Install Redis
  import_playbook: roles/redis/tasks/main.yml
  when: "'redis' in group_names"

# ArgoCD Application 배포
- name: Deploy ArgoCD Application
  hosts: masters
  become: yes
  tasks:
    - name: Apply ArgoCD Application
      shell: kubectl apply -f /root/argocd/application.yaml
      args:
        chdir: /root
    
    - name: Get ArgoCD Application status
      shell: kubectl get applications -n argocd
      register: app_status
    
    - name: Display ArgoCD status
      debug:
        var: app_status.stdout_lines

# 최종 확인
- name: Verify Cluster Status
  hosts: masters
  become: yes
  tasks:
    - name: Get all nodes
      shell: kubectl get nodes -o wide
      register: nodes
    
    - name: Get all namespaces
      shell: kubectl get ns
      register: namespaces
    
    - name: Get all pods
      shell: kubectl get pods --all-namespaces
      register: pods
    
    - name: Display cluster status
      debug:
        msg:
          - "=== NODES ==="
          - "{{ nodes.stdout_lines }}"
          - ""
          - "=== NAMESPACES ==="
          - "{{ namespaces.stdout_lines }}"
          - ""
          - "=== PODS ==="
          - "{{ pods.stdout_lines }}"
