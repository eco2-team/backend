# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 10-namespaces.yml - 도메인별 네임스페이스 생성
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

---
- name: 도메인별 네임스페이스 생성
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  gather_facts: no
  
  vars:
    kube_config: "/home/{{ kubectl_user }}/.kube/config"
  
  tasks:
    - name: 네임스페이스 YAML 복사
      copy:
        src: ../../k8s/namespaces/domain-based.yaml
        dest: /tmp/domain-namespaces.yaml
        mode: '0644'
    
    - name: 네임스페이스 생성
      command: kubectl apply -f /tmp/domain-namespaces.yaml --kubeconfig={{ kube_config }}
      register: namespace_result
      changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"
    
    - name: 생성된 네임스페이스 확인
      command: kubectl get namespaces -l app.kubernetes.io/part-of=ecoeco-backend --kubeconfig={{ kube_config }}
      register: ns_list
    
    - name: 결과 출력
      debug:
        msg: |
          ✅ 도메인별 네임스페이스 생성 완료
          {{ ns_list.stdout }}
    
    - name: NetworkPolicy YAML 복사
      copy:
        src: ../../k8s/networkpolicies/domain-isolation.yaml
        dest: /tmp/network-policies.yaml
        mode: '0644'
    
    - name: NetworkPolicy 적용
      command: kubectl apply -f /tmp/network-policies.yaml --kubeconfig={{ kube_config }}
      register: netpol_result
      changed_when: "'created' in netpol_result.stdout or 'configured' in netpol_result.stdout"
    
    - name: NetworkPolicy 확인
      command: kubectl get networkpolicies --all-namespaces --kubeconfig={{ kube_config }}
      register: netpol_list
    
    - name: NetworkPolicy 결과 출력
      debug:
        msg: |
          ✅ NetworkPolicy 적용 완료
          {{ netpol_list.stdout }}
    
    - name: ServiceMonitor YAML 복사 (도메인별 네임스페이스)
      copy:
        src: ../../k8s/monitoring/servicemonitors-domain-ns.yaml
        dest: /tmp/servicemonitors-domain-ns.yaml
        mode: '0644'

    - name: ServiceMonitor CRD 확인
      command: kubectl get crd servicemonitors.monitoring.coreos.com --kubeconfig={{ kube_config }}
      register: servicemonitor_crd_check
      failed_when: false
      changed_when: false
    
    - name: ServiceMonitor 적용
      command: kubectl apply -f /tmp/servicemonitors-domain-ns.yaml --kubeconfig={{ kube_config }}
      register: sm_result
      changed_when: "'created' in sm_result.stdout or 'configured' in sm_result.stdout"
      when: servicemonitor_crd_check.rc == 0
    
    - name: ServiceMonitor 확인
      command: kubectl get servicemonitors -n monitoring --kubeconfig={{ kube_config }}
      register: sm_list
      when: servicemonitor_crd_check.rc == 0
    
    - name: ServiceMonitor 결과 출력
      debug:
        msg: |
          ✅ ServiceMonitor 적용 완료 (네임스페이스 기반 메트릭 수집)
          {{ sm_list.stdout }}
      when: servicemonitor_crd_check.rc == 0

    - name: ServiceMonitor CRD 미존재 안내
      debug:
        msg: |
          ⚠️ ServiceMonitor CRD가 아직 설치되지 않아 ServiceMonitor 리소스 적용을 건너뜁니다.
          Prometheus Operator 설치 이후 다시 실행해주세요.
      when: servicemonitor_crd_check.rc != 0

