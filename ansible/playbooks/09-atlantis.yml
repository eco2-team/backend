# Atlantis â€“ Helm/ArgoCD ì•ˆë‚´ í”Œë¡œìš°
---
- name: Atlantis Secret ë° ArgoCD ë°°í¬ ì•ˆë‚´
  hosts: masters
  become: yes
  become_user: "{{ kubectl_user }}"
  gather_facts: false
  tasks:
    - name: "Atlantis namespace ì¤€ë¹„"
      shell: |
        kubectl create namespace atlantis --dry-run=client -o yaml | kubectl apply -f -
      register: atlantis_namespace
      changed_when: "'created' in atlantis_namespace.stdout"

    - name: "Atlantis Secret ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
      shell: |
        kubectl get secret atlantis-secrets -n atlantis 2>/dev/null || echo "NOT_FOUND"
      register: atlantis_secret_check
      changed_when: false

    - name: "Atlantis Secret ìƒì„± ì•ˆë‚´"
      debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "Atlantis Helm Chart(charts/platform/atlantis)ëŠ” atlantis-secretsê°€ í•„ìš”í•©ë‹ˆë‹¤."
          - ""
          - "kubectl create secret generic atlantis-secrets -n atlantis \\"
          - "  --from-literal=github-token='YOUR_GITHUB_TOKEN' \\"
          - "  --from-literal=github-webhook-secret='YOUR_WEBHOOK_SECRET' \\"
          - "  --from-literal=aws-access-key-id='YOUR_AWS_ACCESS_KEY_ID' \\"
          - "  --from-literal=aws-secret-access-key='YOUR_AWS_SECRET_ACCESS_KEY'"
      when: atlantis_secret_check.stdout == "NOT_FOUND"

    - name: "ArgoCD Application ë™ê¸°í™” ì•ˆë‚´"
      debug:
        msg:
          - "AtlantisëŠ” ArgoCD Application(gitops-tools)ì—ì„œ Helm Chartë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤."
          - ""
          - "ë™ê¸°í™” ì ˆì°¨:"
          - "  kubectl apply -f argocd/apps/70-gitops-tools.yaml"
          - "  argocd app sync gitops-tools"
          - ""
          - "Helm Chart ê²½ë¡œ: charts/platform/atlantis"
          - "ì„¸ë¶€ ì ˆì°¨: docs/architecture/gitops/ATLANTIS_TERRAFORM_FLOW.md ì°¸ê³ "

          - "í•„ìš”í•œ Secret:"
          - "  1. github-token: GitHub Personal Access Token"
          - "     - ê¶Œí•œ: repo, admin:repo_hook"
          - "     - ìƒì„±: GitHub Settings â†’ Developer settings â†’ Personal access tokens"
          - ""
          - "  2. github-webhook-secret: Webhook Secret (ëœë¤ ë¬¸ìì—´)"
          - "     - ìƒì„±: openssl rand -hex 20"
          - ""
          - "  3. aws-access-key-id: AWS Access Key ID"
          - "  4. aws-secret-access-key: AWS Secret Access Key"
          - ""
          - "Secret ìƒì„± ëª…ë ¹ì–´:"
          - "  kubectl create secret generic atlantis-secrets -n atlantis \\"
          - "    --from-literal=github-token='YOUR_GITHUB_TOKEN' \\"
          - "    --from-literal=github-webhook-secret='YOUR_WEBHOOK_SECRET' \\"
          - "    --from-literal=aws-access-key-id='YOUR_AWS_ACCESS_KEY_ID' \\"
          - "    --from-literal=aws-secret-access-key='YOUR_AWS_SECRET_ACCESS_KEY'"
          - ""
          - "ë˜ëŠ” íŒŒì¼ì—ì„œ ìƒì„±:"
          - "  kubectl create secret generic atlantis-secrets -n atlantis \\"
          - "    --from-file=github-token=/path/to/github-token.txt \\"
          - "    --from-file=github-webhook-secret=/path/to/webhook-secret.txt \\"
          - "    --from-file=aws-access-key-id=/path/to/aws-access-key-id.txt \\"
          - "    --from-file=aws-secret-access-key=/path/to/aws-secret-access-key.txt"
      when: atlantis_secret_check.stdout == "NOT_FOUND"

    - name: "Atlantis ConfigMap ìƒì„±"
      shell: |
        kubectl create configmap atlantis-config -n atlantis \
          --from-literal=AWS_REGION=ap-northeast-2 \
          --dry-run=client -o yaml | kubectl apply -f -
      register: atlantis_configmap

    - name: "Atlantis Server-side Repo Config ìƒì„±"
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: atlantis-repo-config
          namespace: atlantis
        data:
          atlantis.yaml: |
            repos:
              - id: github.com/SeSACTHON/.*
                workflow: infrastructure-workflow
                apply_requirements:
                  - approved
                  - mergeable
                allow_custom_workflows: true
            workflows:
              infrastructure-workflow:
                plan:
                  steps:
                    - env:
                        name: SETUP_ENV
                        command: 'echo "Setting up environment..."'
                    - init
                    - run: terraform validate
                    - plan:
                        extra_args:
                          - -lock-timeout=5m
                          - -var-file=terraform.tfvars
                    - run: |
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "âœ… Terraform Plan Complete"
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                apply:
                  steps:
                    - env:
                        name: SETUP_ENV
                        command: 'echo "Setting up environment..."'
                    - init
                    - apply:
                        extra_args:
                          - -lock-timeout=5m
                          - -var-file=terraform.tfvars
                    - run: |
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "ğŸ“Š Exporting Terraform Outputs (Phase 3)..."
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        terraform output -json > /tmp/tf-outputs.json
                        terraform output -raw ansible_inventory > /tmp/ansible-inventory.ini
                        if command -v kubectl &> /dev/null; then
                            kubectl get namespace argocd &>/dev/null || kubectl create namespace argocd
                            kubectl create configmap terraform-outputs \
                              --from-file=tf-outputs.json=/tmp/tf-outputs.json \
                              --from-file=ansible-inventory.ini=/tmp/ansible-inventory.ini \
                              --namespace=argocd \
                              --dry-run=client -o yaml | kubectl apply -f -
                            echo "âœ… Terraform Outputs saved to ConfigMap (namespace: argocd)"
                            kubectl get configmap terraform-outputs -n argocd
                            echo "ğŸ”„ ArgoCD PreSync Hookì´ ì´ ConfigMapì„ ì½ì–´ì„œ Ansibleì„ ì‹¤í–‰í•©ë‹ˆë‹¤"
                        else
                            echo "âš ï¸  kubectl not found, skipping ConfigMap creation"
                    - run: |
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "ğŸ”— Triggering Post-Apply Actions..."
                        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                        echo "Terraform Apply Complete!"
        EOF
      register: atlantis_repo_config

        - atlantis_deployment is defined and atlantis_deployment.changed
        - atlantis_pod_status != "Running"

    - name: "Atlantis Serviceë¥¼ NodePortë¡œ ë³€ê²½ (ALB target-type: instance í•„ìˆ˜)"
      shell: |
        kubectl patch svc atlantis -n atlantis -p '{"spec":{"type":"NodePort","ports":[{"name":"http","port":80,"protocol":"TCP","targetPort":4141,"nodePort":{{ atlantis_node_port }}}]}}'
      register: atlantis_service_patch
      changed_when: "'patched' in atlantis_service_patch.stdout or 'unchanged' in atlantis_service_patch.stdout"
      when: atlantis_deployment is defined and atlantis_deployment.changed

    - name: "Atlantis Service í™•ì¸"
      shell: |
        kubectl get svc atlantis -n atlantis
      register: atlantis_service
      changed_when: false
      when: atlantis_secret_check.stdout != "NOT_FOUND"

    - name: "Atlantis Ingress í™•ì¸ (14-nodes-ingress.yamlì— í¬í•¨ë¨)"
      shell: |
        kubectl get ingress atlantis-ingress -n atlantis 2>/dev/null || echo "Ingress ì—†ìŒ (07-ingress-resources.ymlì—ì„œ ìƒì„± ì˜ˆì •)"
      register: atlantis_ingress_check
      changed_when: false
      when: atlantis_secret_check.stdout != "NOT_FOUND"

    - name: "Phase 3: RBAC ê¶Œí•œ í™•ì¸"
      shell: |
        kubectl get clusterrole atlantis-configmap-creator 2>/dev/null && \
        kubectl get clusterrolebinding atlantis-configmap-creator 2>/dev/null && \
        echo "âœ… RBAC ê¶Œí•œ ì„¤ì • ì™„ë£Œ" || echo "âš ï¸  RBAC ê¶Œí•œ í™•ì¸ í•„ìš”"
      register: rbac_check
      changed_when: false
      when: atlantis_deployment is defined and atlantis_deployment.changed

    - name: "Phase 3: SSH Key Secret ìƒì„± ì•ˆë‚´"
      debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "ğŸ” Phase 3: SSH Key Secret ìƒì„± í•„ìš”"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ArgoCD Hooksì—ì„œ Ansibleì´ SSHë¡œ ì ‘ì†í•˜ê¸° ìœ„í•´ Secretì´ í•„ìš”í•©ë‹ˆë‹¤:"
          - ""
          - "ìƒì„± ëª…ë ¹ì–´:"
          - "  ./scripts/utilities/create-ssh-key-secret.sh"
          - ""
          - "ë˜ëŠ” ìˆ˜ë™ ìƒì„±:"
          - "  kubectl create secret generic k8s-cluster-ssh-key \\"
          - "    --from-file=ssh-privatekey=~/.ssh/id_rsa \\"
          - "    --namespace=argocd"
      when: atlantis_deployment is defined and atlantis_deployment.changed

    - name: "Atlantis ì •ë³´ ì¶œë ¥"
      debug:
        msg:
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - "âœ… Atlantis ë°°í¬ ì™„ë£Œ (Phase 3)"
          - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          - ""
          - "ğŸ“ ë°°í¬ ìœ„ì¹˜:"
          - "  - Namespace: atlantis"
          - "  - Node: k8s-monitoring (ì •í™•í•œ ë…¸ë“œ ì§€ì •: nodeAffinity)"
          - "  - Pod: atlantis-0"
          - ""
          - "ğŸŒ ì ‘ì† ì •ë³´:"
          - "  - URL: https://atlantis.growbin.app"
          - "  - Health Check: https://atlantis.growbin.app/healthz"
          - ""
          - "ğŸ”§ Phase 3 ê¸°ëŠ¥:"
          - "  - âœ… kubectl ì„¤ì¹˜ (Init Container)"
          - "  - âœ… RBAC ê¶Œí•œ (ConfigMap ìƒì„±)"
          - "  - âœ… Terraform Outputs â†’ ConfigMap ìë™ ì €ì¥"
          - "  - âœ… ArgoCD Hooks ì—°ê³„ ì¤€ë¹„ ì™„ë£Œ"
          - ""
          - "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
          - "  1. SSH Key Secret ìƒì„±:"
          - "     ./scripts/utilities/create-ssh-key-secret.sh"
          - ""
          - "  2. GitHub Webhook ì„¤ì •:"
          - "     - Repository Settings â†’ Webhooks â†’ Add webhook"
          - "     - Payload URL: https://atlantis.growbin.app/events"
          - "     - Content type: application/json"
          - "     - SSL verification: âœ… Enable SSL verification"
          - "     - Secret: (ìœ„ì—ì„œ ìƒì„±í•œ github-webhook-secret)"
          - "     - Events: Pull requests, Pushes"
          - ""
          - "  3. ArgoCD Application ë°°í¬:"
          - "     kubectl apply -f argocd/application-14nodes-with-hooks.yaml"
          - ""
          - "  4. í…ŒìŠ¤íŠ¸ PR ìƒì„±:"
          - "     - terraform/ ë””ë ‰í† ë¦¬ ìˆ˜ì •"
          - "     - PR ìƒì„± â†’ ìë™ìœ¼ë¡œ 'atlantis plan' ì‹¤í–‰"
          - "     - PR ì½”ë©˜íŠ¸ì— 'atlantis apply' ì…ë ¥ â†’ Apply ì‹¤í–‰"
          - "     - ConfigMap ìë™ ìƒì„± í™•ì¸"
          - "     - ArgoCD Sync â†’ PreSync Hook (Ansible) ìë™ ì‹¤í–‰"
          - ""
          - "{{ atlantis_service.stdout_lines }}"
      when: atlantis_deployment is defined and atlantis_deployment.changed
