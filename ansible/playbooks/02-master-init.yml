# Master 노드 초기화
---
- name: 클러스터 초기화 여부 확인
  stat:
    path: /etc/kubernetes/admin.conf
  register: kubeadm_init_stat

- name: kubeadm init 실행
  command: >
    kubeadm init
    --pod-network-cidr={{ pod_network_cidr }}
    --service-cidr={{ service_cidr }}
    --apiserver-advertise-address={{ private_ip }}
    --node-name={{ inventory_hostname }}
  register: kubeadm_init_output
  when: not kubeadm_init_stat.stat.exists

- name: .kube 디렉토리 생성
  file:
    path: "{{ kubectl_home }}/.kube"
    state: directory
    owner: "{{ kubectl_user }}"
    group: "{{ kubectl_user }}"
    mode: '0755'

- name: kubeconfig 복사
  copy:
    src: /etc/kubernetes/admin.conf
    dest: "{{ kubectl_home }}/.kube/config"
    owner: "{{ kubectl_user }}"
    group: "{{ kubectl_user }}"
    mode: '0644'
    remote_src: yes

- name: API 서버가 준비될 때까지 대기
  command: kubectl get nodes
  register: api_ready
  until: api_ready.rc == 0
  retries: 30
  delay: 10
  become_user: "{{ kubectl_user }}"
  changed_when: false

- name: kubeadm join 명령어 추출
  shell: kubeadm token create --print-join-command
  register: join_command
  changed_when: false
  retries: 3
  delay: 5
  until: join_command.rc == 0

- name: join 명령어 저장
  copy:
    content: |
      #!/bin/bash
      {{ join_command.stdout }}
    dest: "/tmp/kubeadm_join_command.sh"
    mode: '0755'
  delegate_to: localhost
  become: no

- name: 클러스터 정보 확인
  command: kubectl get nodes
  become_user: "{{ kubectl_user }}"
  register: nodes_output
  changed_when: false

- name: 노드 정보 출력
  debug:
    msg: "{{ nodes_output.stdout_lines }}"

