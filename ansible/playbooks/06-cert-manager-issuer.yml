# Cert-manager ClusterIssuer ì„¤ì • (Let's Encrypt)
---
- name: Wait for cert-manager deployments to be ready
  command: kubectl wait --for=condition=available --timeout=300s deployment/{{ item }} -n cert-manager
  loop:
    - cert-manager
    - cert-manager-webhook
    - cert-manager-cainjector
  changed_when: false

- name: Wait for cert-manager webhook service
  shell: |
    for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30; do
      if kubectl get svc cert-manager-webhook -n cert-manager &>/dev/null; then
        echo "Webhook service ready"
        exit 0
      fi
      echo "Waiting for webhook service... ($i/30)"
      sleep 5
    done
  changed_when: false

- name: Wait for cert-manager webhook endpoints
  shell: |
    for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30; do
      ENDPOINTS=$(kubectl get endpoints cert-manager-webhook -n cert-manager -o jsonpath='{.subsets[*].addresses[*].ip}' 2>/dev/null)
      if [ -n "$ENDPOINTS" ]; then
        echo "Webhook endpoints ready: $ENDPOINTS"
        exit 0
      fi
      echo "Waiting for webhook endpoints... ($i/30)"
      sleep 5
    done
  changed_when: false

- name: cert-manager webhook Pod ì™„ì „ ì•ˆì •í™” ëŒ€ê¸°
  shell: |
    echo "â³ cert-manager webhook ì•ˆì •í™” ëŒ€ê¸° (60ì´ˆ)..."
    sleep 60
    
    # Podê°€ ì‹¤ì œë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
    for i in 1 2 3 4 5 6 7 8 9 10; do
      WEBHOOK_POD=$(kubectl get pods -n cert-manager -l app.kubernetes.io/name=webhook -o name 2>/dev/null | head -1)
      if [ -n "$WEBHOOK_POD" ]; then
        POD_READY=$(kubectl get $WEBHOOK_POD -n cert-manager -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null)
        POD_RESTARTS=$(kubectl get $WEBHOOK_POD -n cert-manager -o jsonpath='{.status.containerStatuses[0].restartCount}' 2>/dev/null)
        
        echo "Webhook Pod: Ready=$POD_READY, Restarts=$POD_RESTARTS (check $i/10)"
        
        if [ "$POD_READY" == "True" ] && [ "$POD_RESTARTS" -lt 3 ]; then
          echo "âœ… Webhook ì•ˆì •í™” ì™„ë£Œ!"
          exit 0
        fi
      fi
      
      sleep 10
    done
    
    echo "âš ï¸ Webhook ì™„ì „íˆ ì•ˆì •í™” ì•ˆ ë¨, ê³„ì† ì§„í–‰ (ì¬ì‹œë„ ê°€ëŠ¥)"
    exit 0
  changed_when: false

# âš ï¸ Let's Encrypt ClusterIssuer ì œê±°
# ì´ìœ : ALBì—ì„œ AWS ACM ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë¶ˆí•„ìš”
# Cert-managerëŠ” Kubernetes ë‚´ë¶€ ì¸ì¦ì„œ ê´€ë¦¬ìš©ìœ¼ë¡œë§Œ ìœ ì§€

- name: Cert-manager ì¤€ë¹„ ì™„ë£Œ í™•ì¸
  debug:
    msg:
      - "âœ… Cert-manager ì„¤ì¹˜ ì™„ë£Œ"
      - "ğŸ“ SSL/TLSëŠ” AWS ACMìœ¼ë¡œ ì²˜ë¦¬ë¨ (ALBì—ì„œ ì‚¬ìš©)"
      - "ğŸ”§ Cert-managerëŠ” ë‚´ë¶€ ì¸ì¦ì„œ ê´€ë¦¬ìš©ìœ¼ë¡œ ëŒ€ê¸° ì¤‘"

