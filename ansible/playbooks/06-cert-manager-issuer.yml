# Cert-manager ClusterIssuer 설정 (Let's Encrypt)
---
- name: Wait for cert-manager deployments to be ready
  command: kubectl wait --for=condition=available --timeout=300s deployment/{{ item }} -n cert-manager
  loop:
    - cert-manager
    - cert-manager-webhook
    - cert-manager-cainjector
  changed_when: false

- name: Wait for cert-manager webhook service
  shell: |
    for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30; do
      if kubectl get svc cert-manager-webhook -n cert-manager &>/dev/null; then
        echo "Webhook service ready"
        exit 0
      fi
      echo "Waiting for webhook service... ($i/30)"
      sleep 5
    done
  changed_when: false

- name: Wait for cert-manager webhook endpoints
  shell: |
    for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30; do
      ENDPOINTS=$(kubectl get endpoints cert-manager-webhook -n cert-manager -o jsonpath='{.subsets[*].addresses[*].ip}' 2>/dev/null)
      if [ -n "$ENDPOINTS" ]; then
        echo "Webhook endpoints ready: $ENDPOINTS"
        exit 0
      fi
      echo "Waiting for webhook endpoints... ($i/30)"
      sleep 5
    done
  changed_when: false

- name: cert-manager webhook Pod 완전 안정화 대기
  shell: |
    echo "⏳ cert-manager webhook 안정화 대기 (60초)..."
    sleep 60
    
    # Pod가 실제로 요청을 처리할 수 있는지 확인
    for i in 1 2 3 4 5 6 7 8 9 10; do
      WEBHOOK_POD=$(kubectl get pods -n cert-manager -l app.kubernetes.io/name=webhook -o name 2>/dev/null | head -1)
      if [ -n "$WEBHOOK_POD" ]; then
        POD_READY=$(kubectl get $WEBHOOK_POD -n cert-manager -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null)
        POD_RESTARTS=$(kubectl get $WEBHOOK_POD -n cert-manager -o jsonpath='{.status.containerStatuses[0].restartCount}' 2>/dev/null)
        
        echo "Webhook Pod: Ready=$POD_READY, Restarts=$POD_RESTARTS (check $i/10)"
        
        if [ "$POD_READY" == "True" ] && [ "$POD_RESTARTS" -lt 3 ]; then
          echo "✅ Webhook 안정화 완료!"
          exit 0
        fi
      fi
      
      sleep 10
    done
    
    echo "⚠️ Webhook 완전히 안정화 안 됨, 계속 진행 (재시도 가능)"
    exit 0
  changed_when: false

- name: Create Let's Encrypt ClusterIssuer (Production) - with retry
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-prod
    spec:
      acme:
        server: https://acme-v02.api.letsencrypt.org/directory
        email: {{ letsencrypt_email }}
        privateKeySecretRef:
          name: letsencrypt-prod
        solvers:
        - http01:
            ingress:
              class: nginx
    EOF
  register: clusterissuer_prod
  retries: 5
  delay: 30
  until: clusterissuer_prod.rc == 0
  register: letsencrypt_prod
  changed_when: "'created' in letsencrypt_prod.stdout or 'configured' in letsencrypt_prod.stdout"

- name: Create Let's Encrypt ClusterIssuer (Staging for testing) - with retry
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: cert-manager.io/v1
    kind: ClusterIssuer
    metadata:
      name: letsencrypt-staging
    spec:
      acme:
        server: https://acme-staging-v02.api.letsencrypt.org/directory
        email: {{ letsencrypt_email }}
        privateKeySecretRef:
          name: letsencrypt-staging
        solvers:
        - http01:
            ingress:
              class: nginx
    EOF
  register: clusterissuer_staging
  retries: 5
  delay: 30
  until: clusterissuer_staging.rc == 0
  register: letsencrypt_staging
  changed_when: "'created' in letsencrypt_staging.stdout or 'configured' in letsencrypt_staging.stdout"

- name: ClusterIssuer 확인
  command: kubectl get clusterissuer
  register: issuers
  changed_when: false

- name: ClusterIssuer 목록 출력
  debug:
    msg: "{{ issuers.stdout_lines }}"

