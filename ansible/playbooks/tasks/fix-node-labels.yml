---
- name: "노드 라벨/테인트 교정 및 kubelet drop-in 갱신"
  vars:
    node_labels:
      k8s-api-auth: "--node-labels=kubernetes.io/node-role=api,kubernetes.io/service=auth,workload=api,domain=auth,tier=business-logic,phase=1 --register-with-taints=domain=auth:NoSchedule"
      k8s-api-my: "--node-labels=kubernetes.io/node-role=api,kubernetes.io/service=my,workload=api,domain=my,tier=business-logic,phase=1 --register-with-taints=domain=my:NoSchedule"
      k8s-api-scan: "--node-labels=kubernetes.io/node-role=api,kubernetes.io/service=scan,workload=api,domain=scan,tier=business-logic,phase=2 --register-with-taints=domain=scan:NoSchedule"
      k8s-api-character: "--node-labels=kubernetes.io/node-role=api,kubernetes.io/service=character,workload=api,domain=character,tier=business-logic,phase=2 --register-with-taints=domain=character:NoSchedule"
      k8s-api-location: "--node-labels=kubernetes.io/node-role=api,kubernetes.io/service=location,workload=api,domain=location,tier=business-logic,phase=2 --register-with-taints=domain=location:NoSchedule"
      k8s-api-info: "--node-labels=kubernetes.io/node-role=api,kubernetes.io/service=info,workload=api,domain=info,tier=business-logic,phase=3 --register-with-taints=domain=info:NoSchedule"
      k8s-api-chat: "--node-labels=kubernetes.io/node-role=api,kubernetes.io/service=chat,workload=api,domain=chat,tier=business-logic,phase=3 --register-with-taints=domain=chat:NoSchedule"
      k8s-worker-storage: "--node-labels=kubernetes.io/node-role=worker,kubernetes.io/worker-type=storage,workload=worker-storage,worker-type=io-bound,tier=worker,phase=4"
      k8s-worker-ai: "--node-labels=kubernetes.io/node-role=worker,kubernetes.io/worker-type=ai,workload=worker-ai,worker-type=network-bound,tier=worker,phase=4"
      k8s-rabbitmq: "--node-labels=kubernetes.io/node-role=infrastructure,kubernetes.io/infra-type=rabbitmq,workload=message-queue,tier=platform,phase=4 --register-with-taints=kubernetes.io/infrastructure=true:NoSchedule"
      k8s-postgresql: "--node-labels=kubernetes.io/node-role=infrastructure,kubernetes.io/infra-type=postgresql,workload=database,tier=data,phase=1 --register-with-taints=kubernetes.io/infrastructure=true:NoSchedule"
      k8s-redis: "--node-labels=kubernetes.io/node-role=infrastructure,kubernetes.io/infra-type=redis,workload=cache,tier=data,phase=1 --register-with-taints=kubernetes.io/infrastructure=true:NoSchedule"
      k8s-monitoring: "--node-labels=kubernetes.io/node-role=infrastructure,kubernetes.io/infra-type=monitoring,workload=monitoring,tier=observability,phase=4 --register-with-taints=kubernetes.io/infrastructure=true:NoSchedule"
  block:
    - name: "{{ inventory_hostname }} → 예상 라벨"
      ansible.builtin.debug:
        msg: "{{ node_labels[inventory_hostname] | default('라벨 없음') }}"

    - name: 기존 kubelet 라벨 설정 파일 백업
      ansible.builtin.copy:
        src: /etc/systemd/system/kubelet.service.d/10-node-labels.conf
        dest: /etc/systemd/system/kubelet.service.d/10-node-labels.conf.bak
        remote_src: yes
      failed_when: false

    - name: 올바른 노드 라벨로 kubelet drop-in 갱신
      ansible.builtin.copy:
        content: |
          [Service]
          Environment="KUBELET_EXTRA_ARGS={{ node_labels[inventory_hostname] }}"
        dest: /etc/systemd/system/kubelet.service.d/10-node-labels.conf
        mode: '0644'
      when: node_labels[inventory_hostname] is defined
      register: labels_updated

    - name: kubelet 재조인을 위한 설정 정리
      when:
        - labels_updated is defined
        - labels_updated.changed
      block:
        - name: kubelet 중지
          ansible.builtin.systemd:
            name: kubelet
            state: stopped

        - name: kubeadm reset
          ansible.builtin.command: kubeadm reset -f --cri-socket=unix:///run/containerd/containerd.sock
          register: reset_result

        - name: Reset 결과 출력
          ansible.builtin.debug:
            msg: "{{ reset_result.stdout_lines }}"

        - name: Kubernetes 설정 디렉터리 제거
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - /etc/kubernetes
            - /var/lib/kubelet
            - /etc/cni/net.d

        - name: systemd daemon-reload
          ansible.builtin.systemd:
            daemon_reload: yes

        - name: containerd 재시작
          ansible.builtin.systemd:
            name: containerd
            state: restarted

        - name: containerd 시작 대기
          ansible.builtin.pause:
            seconds: 5

    - name: 라벨 교정 완료 메시지
      ansible.builtin.debug:
        msg: "✅ {{ inventory_hostname }} 라벨 교정 완료"
  when: migrate_node_labels | default(false)
  tags:
    - node-labels

