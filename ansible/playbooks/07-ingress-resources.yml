# Ingress 리소스 생성 (ALB 기반, 경로 라우팅)
# ArgoCD, Grafana 등을 ALB를 통해 외부 노출
---
- name: ArgoCD Ingress 생성 (ALB + ACM)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: argocd
      namespace: argocd
      annotations:
        # ALB 설정
        kubernetes.io/ingress.class: alb
        alb.ingress.kubernetes.io/scheme: internet-facing
        alb.ingress.kubernetes.io/target-type: ip
        
        # SSL/TLS (ACM)
        alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
        alb.ingress.kubernetes.io/ssl-redirect: '443'
        alb.ingress.kubernetes.io/certificate-arn: {{ acm_certificate_arn }}
        
        # Backend protocol
        alb.ingress.kubernetes.io/backend-protocol: HTTPS
        alb.ingress.kubernetes.io/healthcheck-protocol: HTTPS
        alb.ingress.kubernetes.io/healthcheck-path: /healthz
        
        # 그룹 설정 (하나의 ALB 공유)
        alb.ingress.kubernetes.io/group.name: growbin-alb
        alb.ingress.kubernetes.io/group.order: '10'
    spec:
      rules:
      - host: argocd.{{ domain_name }}
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: argocd-server
                port:
                  number: 443
    EOF
  register: argocd_ingress

- name: Grafana Ingress 생성 (ALB 공유)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: grafana
      namespace: {{ monitoring_namespace }}
      annotations:
        kubernetes.io/ingress.class: alb
        alb.ingress.kubernetes.io/scheme: internet-facing
        alb.ingress.kubernetes.io/target-type: ip
        alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
        alb.ingress.kubernetes.io/ssl-redirect: '443'
        alb.ingress.kubernetes.io/certificate-arn: {{ acm_certificate_arn }}
        alb.ingress.kubernetes.io/backend-protocol: HTTP
        alb.ingress.kubernetes.io/healthcheck-path: /api/health
        
        # 같은 ALB 공유
        alb.ingress.kubernetes.io/group.name: growbin-alb
        alb.ingress.kubernetes.io/group.order: '20'
    spec:
      rules:
      - host: grafana.{{ domain_name }}
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus-grafana
                port:
                  number: 80
    EOF
  register: grafana_ingress
  ignore_errors: yes

- name: API Ingress 생성 (미래 백엔드용, Placeholder)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: api-placeholder
      namespace: default
      annotations:
        kubernetes.io/ingress.class: alb
        alb.ingress.kubernetes.io/scheme: internet-facing
        alb.ingress.kubernetes.io/target-type: ip
        alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
        alb.ingress.kubernetes.io/ssl-redirect: '443'
        alb.ingress.kubernetes.io/certificate-arn: {{ acm_certificate_arn }}
        
        # 같은 ALB 공유
        alb.ingress.kubernetes.io/group.name: growbin-alb
        alb.ingress.kubernetes.io/group.order: '30'
        
        # 경로 기반 라우팅 준비
        alb.ingress.kubernetes.io/actions.default-backend: |
          {"type":"fixed-response","fixedResponseConfig":{"contentType":"text/plain","statusCode":"503","messageBody":"Backend not deployed yet"}}
    spec:
      rules:
      - host: api.{{ domain_name }}
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: default-backend
                port:
                  name: use-annotation
    EOF
  register: api_ingress
  ignore_errors: yes

- name: ALB DNS 이름 조회
  shell: |
    # ALB가 생성될 때까지 대기 (최대 5분)
    for i in {1..30}; do
      ALB_DNS=$(kubectl get ingress -n argocd argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null)
      if [ -n "$ALB_DNS" ]; then
        echo "ALB DNS: $ALB_DNS"
        exit 0
      fi
      echo "ALB 생성 대기... ($i/30)"
      sleep 10
    done
    echo "⚠️ ALB DNS 조회 실패 (수동 확인 필요)"
    exit 0
  register: alb_dns_output
  changed_when: false

- name: Ingress 정보 출력
  debug:
    msg:
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "✅ Ingress 리소스 생성 완료"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - ""
      - "ALB 정보:"
      - "{{ alb_dns_output.stdout_lines }}"
      - ""
      - "도메인 매핑:"
      - "  argocd.{{ domain_name }} → ALB → ArgoCD"
      - "  grafana.{{ domain_name }} → ALB → Grafana"
      - "  api.{{ domain_name }} → ALB → (백엔드 배포 시 연결)"
      - ""
      - "다음 단계:"
      - "1. Route53 레코드를 ALB Alias로 변경:"
      - "   - Terraform 또는 AWS Console"
      - "   - A Record Alias → ALB DNS"
      - ""
      - "2. 브라우저 접속:"
      - "   https://argocd.{{ domain_name }}"
      - "   https://grafana.{{ domain_name }}"
      - ""
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"


