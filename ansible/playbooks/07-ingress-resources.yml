# Ingress 리소스 생성 (Path-based routing)
# 단일 도메인에서 경로로 서비스 분기
---
- name: Main Ingress 생성 (Path-based routing)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: main-ingress
      namespace: default
      annotations:
        # ALB 설정
        kubernetes.io/ingress.class: alb
        alb.ingress.kubernetes.io/scheme: internet-facing
        alb.ingress.kubernetes.io/target-type: ip
        
        # SSL/TLS (ACM)
        alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
        alb.ingress.kubernetes.io/ssl-redirect: '443'
        alb.ingress.kubernetes.io/certificate-arn: {{ acm_certificate_arn }}
        
        # ALB 그룹
        alb.ingress.kubernetes.io/group.name: growbin-alb
        alb.ingress.kubernetes.io/group.order: '1'
        
        # 경로 재작성 (Strip prefix)
        alb.ingress.kubernetes.io/actions.argocd-rewrite: |
          {"type":"redirect","redirectConfig":{"protocol":"HTTPS","port":"443","statusCode":"HTTP_301"}}
    spec:
      rules:
      - host: {{ domain_name }}
        http:
          paths:
          # ArgoCD - /argocd/*
          - path: /argocd
            pathType: Prefix
            backend:
              service:
                name: argocd-server
                namespace: argocd
                port:
                  number: 443
          
          # Grafana - /grafana/*
          - path: /grafana
            pathType: Prefix
            backend:
              service:
                name: prometheus-grafana
                namespace: {{ monitoring_namespace }}
                port:
                  number: 80
          
          # API Gateway - /api/*
          - path: /api/v1/auth
            pathType: Prefix
            backend:
              service:
                name: auth-service
                namespace: default
                port:
                  number: 8000
          
          - path: /api/v1/users
            pathType: Prefix
            backend:
              service:
                name: users-service
                namespace: default
                port:
                  number: 8000
          
          - path: /api/v1/waste
            pathType: Prefix
            backend:
              service:
                name: waste-service
                namespace: default
                port:
                  number: 8000
          
          - path: /api/v1/recycling
            pathType: Prefix
            backend:
              service:
                name: recycling-service
                namespace: default
                port:
                  number: 8000
          
          - path: /api/v1/locations
            pathType: Prefix
            backend:
              service:
                name: locations-service
                namespace: default
                port:
                  number: 8000
          
          # Root - Default
          - path: /
            pathType: Prefix
            backend:
              service:
                name: default-backend
                namespace: default
                port:
                  number: 80
    EOF
  register: main_ingress

- name: Default Backend 생성 (404 처리)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: v1
    kind: Service
    metadata:
      name: default-backend
      namespace: default
    spec:
      type: ClusterIP
      ports:
      - port: 80
        targetPort: 8080
      selector:
        app: default-backend
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: default-backend
      namespace: default
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: default-backend
      template:
        metadata:
          labels:
            app: default-backend
        spec:
          containers:
          - name: default-backend
            image: registry.k8s.io/defaultbackend-amd64:1.5
            ports:
            - containerPort: 8080
    EOF
  register: default_backend
  ignore_errors: yes

- name: ALB DNS 이름 조회
  shell: |
    # ALB가 생성될 때까지 대기 (최대 5분)
    for i in {1..30}; do
      ALB_DNS=$(kubectl get ingress -n argocd argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null)
      if [ -n "$ALB_DNS" ]; then
        echo "ALB DNS: $ALB_DNS"
        exit 0
      fi
      echo "ALB 생성 대기... ($i/30)"
      sleep 10
    done
    echo "⚠️ ALB DNS 조회 실패 (수동 확인 필요)"
    exit 0
  register: alb_dns_output
  changed_when: false

- name: Ingress 정보 출력
  debug:
    msg:
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "✅ Path-based Ingress 생성 완료"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - ""
      - "ALB 정보:"
      - "{{ alb_dns_output.stdout_lines }}"
      - ""
      - "경로 기반 라우팅:"
      - "  https://{{ domain_name }}/argocd     → ArgoCD"
      - "  https://{{ domain_name }}/grafana    → Grafana"
      - "  https://{{ domain_name }}/api/v1/auth     → auth-service"
      - "  https://{{ domain_name }}/api/v1/users    → users-service"
      - "  https://{{ domain_name }}/api/v1/waste    → waste-service"
      - "  https://{{ domain_name }}/api/v1/recycling → recycling-service"
      - "  https://{{ domain_name }}/api/v1/locations → locations-service"
      - ""
      - "단일 ALB로 모든 서비스 라우팅!"
      - "Host header 불필요, Path만으로 분기"
      - ""
      - "다음 단계:"
      - "1. Route53 레코드를 ALB Alias로 변경:"
      - "   {{ domain_name }} (apex) → ALB DNS"
      - ""
      - "2. 브라우저 접속:"
      - "   https://{{ domain_name }}/argocd"
      - "   https://{{ domain_name }}/grafana"
      - "   https://{{ domain_name }}/api/v1/..."
      - ""
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"


