# etcd 백업 설정 (프로덕션 필수)
---
- name: etcd 버전 확인 (etcdctl 다운로드용)
  shell: kubectl version --short 2>/dev/null | grep Server | awk '{print $3}' || echo "v1.28.0"
  register: k8s_version
  changed_when: false

- name: etcdctl 다운로드
  get_url:
    url: "https://github.com/etcd-io/etcd/releases/download/v3.5.9/etcd-v3.5.9-linux-amd64.tar.gz"
    dest: /tmp/etcd.tar.gz
    mode: '0644'

- name: etcdctl 압축 해제
  unarchive:
    src: /tmp/etcd.tar.gz
    dest: /tmp/
    remote_src: yes

- name: etcdctl 바이너리 설치
  copy:
    src: /tmp/etcd-v3.5.9-linux-amd64/etcdctl
    dest: /usr/local/bin/etcdctl
    mode: '0755'
    remote_src: yes

- name: 임시 파일 정리
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/etcd.tar.gz
    - /tmp/etcd-v3.5.9-linux-amd64

- name: etcd 백업 디렉토리 생성
  file:
    path: /var/backups/etcd
    state: directory
    mode: '0700'
    owner: root
    group: root

- name: etcd 백업 스크립트 생성
  copy:
    dest: /usr/local/bin/backup-etcd.sh
    mode: '0755'
    content: |
      #!/bin/bash
      # etcd 백업 스크립트
      
      BACKUP_DIR="/var/backups/etcd"
      ETCD_ENDPOINTS="https://127.0.0.1:2379"
      ETCD_CACERT="/etc/kubernetes/pki/etcd/ca.crt"
      ETCD_CERT="/etc/kubernetes/pki/etcd/server.crt"
      ETCD_KEY="/etc/kubernetes/pki/etcd/server.key"
      
      DATE=$(date +%Y%m%d-%H%M%S)
      BACKUP_FILE="$BACKUP_DIR/etcd-snapshot-$DATE.db"
      
      # Snapshot 생성
      ETCDCTL_API=3 etcdctl snapshot save "$BACKUP_FILE" \
        --endpoints="$ETCD_ENDPOINTS" \
        --cacert="$ETCD_CACERT" \
        --cert="$ETCD_CERT" \
        --key="$ETCD_KEY"
      
      if [ $? -eq 0 ]; then
        echo "✅ Backup successful: $BACKUP_FILE"
        
        # 7일 이상 된 백업 삭제
        find "$BACKUP_DIR" -name "etcd-snapshot-*.db" -mtime +7 -delete
        
        # 백업 파일 목록
        ls -lh "$BACKUP_DIR"
      else
        echo "❌ Backup failed!"
        exit 1
      fi

- name: etcd 백업 cron job 설정 (매일 03:00)
  cron:
    name: "etcd daily backup"
    minute: "0"
    hour: "3"
    job: "/usr/local/bin/backup-etcd.sh >> /var/log/etcd-backup.log 2>&1"
    user: root
    state: present

- name: 첫 백업 실행
  command: /usr/local/bin/backup-etcd.sh
  register: first_backup
  changed_when: false

- name: 백업 결과 출력
  debug:
    msg: "{{ first_backup.stdout_lines }}"


