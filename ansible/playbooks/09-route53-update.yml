---
# Route53 A ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (ALB ì—°ê²°)
# ALB ìƒì„± í›„ ìë™ìœ¼ë¡œ Route53ë¥¼ ALBë¡œ ì—°ê²°

- name: "ALB DNS ì´ë¦„ ê°€ì ¸ì˜¤ê¸°"
  shell: kubectl get ingress argocd-ingress -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].hostname}'
  register: alb_dns_result
  retries: 10
  delay: 30
  until: alb_dns_result.stdout != ""
  failed_when: false
  changed_when: false

- name: "ALB DNS í™•ì¸"
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ğŸ” ALB DNS í™•ì¸"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ALB DNS: {{ alb_dns_result.stdout }}"
  when: alb_dns_result.stdout != ""

- name: "ALB Hosted Zone ID ê°€ì ¸ì˜¤ê¸°"
  shell: |
    aws elbv2 describe-load-balancers \
      --region {{ aws_region }} \
      --query "LoadBalancers[?DNSName=='{{ alb_dns_result.stdout }}'].CanonicalHostedZoneId | [0]" \
      --output text
  register: alb_zone_id_result
  when: alb_dns_result.stdout != ""
  delegate_to: localhost
  changed_when: false

- name: "Hosted Zone ID ê°€ì ¸ì˜¤ê¸°"
  shell: |
    aws route53 list-hosted-zones-by-name \
      --dns-name {{ domain_name }} \
      --query "HostedZones[?Name=='{{ domain_name }}.'].Id | [0]" \
      --output text | sed 's|/hostedzone/||'
  register: hosted_zone_id_result
  when: alb_dns_result.stdout != "" and domain_name != ""
  delegate_to: localhost
  changed_when: false

- name: "Route53 A ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (Apex - ecoeco.app)"
  shell: |
    aws route53 change-resource-record-sets \
      --hosted-zone-id {{ hosted_zone_id_result.stdout }} \
      --change-batch '{
        "Changes": [{
          "Action": "UPSERT",
          "ResourceRecordSet": {
            "Name": "{{ domain_name }}",
            "Type": "A",
            "AliasTarget": {
              "HostedZoneId": "{{ alb_zone_id_result.stdout }}",
              "DNSName": "{{ alb_dns_result.stdout }}",
              "EvaluateTargetHealth": true
            }
          }
        }]
      }'
  register: apex_record_update
  when: 
    - alb_dns_result.stdout != ""
    - domain_name != ""
    - hosted_zone_id_result.stdout != ""
  delegate_to: localhost
  changed_when: "'PENDING' in apex_record_update.stdout"

- name: "Route53 A ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (www.ecoeco.app)"
  shell: |
    aws route53 change-resource-record-sets \
      --hosted-zone-id {{ hosted_zone_id_result.stdout }} \
      --change-batch '{
        "Changes": [{
          "Action": "UPSERT",
          "ResourceRecordSet": {
            "Name": "www.{{ domain_name }}",
            "Type": "A",
            "AliasTarget": {
              "HostedZoneId": "{{ alb_zone_id_result.stdout }}",
              "DNSName": "{{ alb_dns_result.stdout }}",
              "EvaluateTargetHealth": true
            }
          }
        }]
      }'
  register: www_record_update
  when: 
    - alb_dns_result.stdout != ""
    - domain_name != ""
    - hosted_zone_id_result.stdout != ""
  delegate_to: localhost
  changed_when: "'PENDING' in www_record_update.stdout"

- name: "Route53 A ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (api.ecoeco.app)"
  shell: |
    aws route53 change-resource-record-sets \
      --hosted-zone-id {{ hosted_zone_id_result.stdout }} \
      --change-batch '{
        "Changes": [{
          "Action": "UPSERT",
          "ResourceRecordSet": {
            "Name": "api.{{ domain_name }}",
            "Type": "A",
            "AliasTarget": {
              "HostedZoneId": "{{ alb_zone_id_result.stdout }}",
              "DNSName": "{{ alb_dns_result.stdout }}",
              "EvaluateTargetHealth": true
            }
          }
        }]
      }'
  register: api_record_update
  when: 
    - alb_dns_result.stdout != ""
    - domain_name != ""
    - hosted_zone_id_result.stdout != ""
  delegate_to: localhost
  changed_when: "'PENDING' in api_record_update.stdout"

- name: "Route53 A ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (argocd.ecoeco.app)"
  shell: |
    aws route53 change-resource-record-sets \
      --hosted-zone-id {{ hosted_zone_id_result.stdout }} \
      --change-batch '{
        "Changes": [{
          "Action": "UPSERT",
          "ResourceRecordSet": {
            "Name": "argocd.{{ domain_name }}",
            "Type": "A",
            "AliasTarget": {
              "HostedZoneId": "{{ alb_zone_id_result.stdout }}",
              "DNSName": "{{ alb_dns_result.stdout }}",
              "EvaluateTargetHealth": true
            }
          }
        }]
      }'
  register: argocd_record_update
  when: 
    - alb_dns_result.stdout != ""
    - domain_name != ""
    - hosted_zone_id_result.stdout != ""
  delegate_to: localhost
  changed_when: "'PENDING' in argocd_record_update.stdout"

- name: "Route53 A ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (grafana.ecoeco.app)"
  shell: |
    aws route53 change-resource-record-sets \
      --hosted-zone-id {{ hosted_zone_id_result.stdout }} \
      --change-batch '{
        "Changes": [{
          "Action": "UPSERT",
          "ResourceRecordSet": {
            "Name": "grafana.{{ domain_name }}",
            "Type": "A",
            "AliasTarget": {
              "HostedZoneId": "{{ alb_zone_id_result.stdout }}",
              "DNSName": "{{ alb_dns_result.stdout }}",
              "EvaluateTargetHealth": true
            }
          }
        }]
      }'
  register: grafana_record_update
  when: 
    - alb_dns_result.stdout != ""
    - domain_name != ""
    - hosted_zone_id_result.stdout != ""
  delegate_to: localhost
  changed_when: "'PENDING' in grafana_record_update.stdout"

- name: "Route53 A ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ (atlantis.growbin.app)"
  shell: |
    aws route53 change-resource-record-sets \
      --hosted-zone-id {{ hosted_zone_id_result.stdout }} \
      --change-batch '{
        "Changes": [{
          "Action": "UPSERT",
          "ResourceRecordSet": {
            "Name": "atlantis.{{ domain_name }}",
            "Type": "A",
            "AliasTarget": {
              "HostedZoneId": "{{ alb_zone_id_result.stdout }}",
              "DNSName": "{{ alb_dns_result.stdout }}",
              "EvaluateTargetHealth": true
            }
          }
        }]
      }'
  register: atlantis_record_update
  when: 
    - alb_dns_result.stdout != ""
    - domain_name != ""
    - hosted_zone_id_result.stdout != ""
  delegate_to: localhost
  changed_when: "'PENDING' in atlantis_record_update.stdout"

- name: "Route53 ì—…ë°ì´íŠ¸ ì™„ë£Œ ì •ë³´ ì¶œë ¥"
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… Route53 A ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ALB DNS: {{ alb_dns_result.stdout }}"
      - "ALB Hosted Zone ID: {{ alb_zone_id_result.stdout }}"
      - "Route53 Hosted Zone ID: {{ hosted_zone_id_result.stdout }}"
      - ""
      - "ì—…ë°ì´íŠ¸ëœ ë„ë©”ì¸:"
      - "  âœ… {{ domain_name }} â†’ ALB"
      - "  âœ… www.{{ domain_name }} â†’ ALB"
      - "  âœ… api.{{ domain_name }} â†’ ALB"
      - "  âœ… argocd.{{ domain_name }} â†’ ALB"
      - "  âœ… grafana.{{ domain_name }} â†’ ALB"
      - "  âœ… atlantis.{{ domain_name }} â†’ ALB"
      - ""
      - "â³ DNS ì „íŒŒ ëŒ€ê¸° (1-5ë¶„):"
      - "  dig {{ domain_name }}"
      - "  dig www.{{ domain_name }}"
      - ""
      - "ì ‘ì† URL:"
      - "  ğŸŒ https://{{ domain_name }}/argocd"
      - "  ğŸŒ https://{{ domain_name }}/grafana"
      - "  ğŸŒ https://{{ domain_name }}/api/v1/*"
      - ""
      - "â„¹ï¸  Path-based Routing:"
      - "  - /argocd â†’ ArgoCD (namespace: argocd)"
      - "  - /grafana â†’ Grafana (namespace: monitoring)"
      - "  - /api/v1/* â†’ API Services (namespace: default)"
  when: alb_dns_result.stdout != ""

- name: "âš ï¸ ALB DNSë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âš ï¸ ALB DNSë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ì›ì¸:"
      - "  1. ALB Controllerê°€ ì•„ì§ ALBë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŒ"
      - "  2. Ingress ë¦¬ì†ŒìŠ¤ì— ë¬¸ì œê°€ ìˆìŒ"
      - "  3. IAM ê¶Œí•œ ë¬¸ì œ"
      - ""
      - "í™•ì¸ ëª…ë ¹:"
      - "  kubectl get ingress -A"
      - "  kubectl describe ingress argocd-ingress -n argocd"
      - "  kubectl logs -n kube-system deployment/aws-load-balancer-controller"
      - ""
      - "ìˆ˜ë™ í™•ì¸:"
      - "  AWS Console â†’ EC2 â†’ Load Balancers"
  when: alb_dns_result.stdout == ""

