# Worker ë…¸ë“œ Provider ID ì„¤ì • (Master ë…¸ë“œì—ì„œ kubectl patch ì‹¤í–‰)
# ALB Controllerê°€ Worker ë…¸ë“œë¥¼ Target Groupì— ë“±ë¡í•˜ê¸° ìœ„í•´ í•„ìˆ˜
# SSH ëŒ€ì‹  AWS CLIë¡œ Instance ì •ë³´ ì¡°íšŒ

---
- name: AWS CLIë¡œ Worker ë…¸ë“œ ì •ë³´ ìˆ˜ì§‘
  block:
    - name: "ëª¨ë“  k8s Worker ë…¸ë“œ ì •ë³´ ì¡°íšŒ (AWS CLI) - 14 Nodes (Phase 1&2 8 nodes)"
      shell: |
        aws ec2 describe-instances \
          --region {{ aws_region | default('ap-northeast-2') }} \
          --filters "Name=tag:Name,Values=k8s-api-*,k8s-worker-*,k8s-rabbitmq,k8s-postgresql,k8s-redis,k8s-monitoring" \
                    "Name=instance-state-name,Values=running" \
          --query 'Reservations[*].Instances[*].{Name:Tags[?Key==`Name`].Value|[0],InstanceId:InstanceId,AZ:Placement.AvailabilityZone}' \
          --output json
      register: worker_instances_raw
      changed_when: false
      delegate_to: localhost
      become: no

    - name: Worker ë…¸ë“œ ì •ë³´ íŒŒì‹±
      set_fact:
        worker_instances: "{{ worker_instances_raw.stdout | from_json | flatten }}"

- name: Provider ID ì„¤ì •
  block:
    - name: Worker ë…¸ë“œë³„ Provider ID ì„¤ì •
      command: >
        kubectl patch node {{ item.Name }}
        -p '{"spec":{"providerID":"aws:///{{ item.AZ }}/{{ item.InstanceId }}"}}'
      loop: "{{ worker_instances }}"
      register: patch_results
      changed_when: "'patched' in patch_results.stdout or 'no change' not in patch_results.stdout"
      failed_when: patch_results.rc != 0 and 'not found' not in patch_results.stderr

- name: Provider ID ì„¤ì • í™•ì¸
  command: kubectl get nodes -o custom-columns=NAME:.metadata.name,PROVIDER_ID:.spec.providerID --no-headers
  register: provider_ids
  changed_when: false

- name: Provider ID ì„¤ì • ê²°ê³¼ ì¶œë ¥
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… Provider ID ì„¤ì • ì™„ë£Œ!"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "{{ provider_ids.stdout_lines }}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - ""
      - "ğŸ’¡ ALB Controllerê°€ ì´ì œ Worker ë…¸ë“œë¥¼ Target Groupì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
      - "   Ingress ìƒì„± í›„ 2-3ë¶„ ë‚´ì— Targetì´ healthy ìƒíƒœê°€ ë©ë‹ˆë‹¤."

