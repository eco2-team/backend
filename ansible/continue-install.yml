---
# 나머지 설치 작업 계속 진행
---
- name: AWS EBS CSI Driver 및 StorageClass 설정
  hosts: masters
  become: yes
  become_user: '{{ kubectl_user }}'
  tasks:
  - import_tasks: playbooks/05-1-ebs-csi-driver.yml

- name: Monitoring 설치 (Prometheus Operator - ServiceMonitor CRD 제공)
  hosts: masters
  become: yes
  become_user: '{{ kubectl_user }}'
  tasks:
  - import_tasks: playbooks/08-monitoring.yml

- name: 'RabbitMQ 설치 (Tier 3: Message Queue)'
  hosts: masters
  become: yes
  become_user: '{{ kubectl_user }}'
  roles:
  - rabbitmq

- name: 'Redis 설치 (Tier 4: Persistence - Cache & State)'
  hosts: masters
  become: yes
  become_user: '{{ kubectl_user }}'
  roles:
  - redis

- name: Ingress 리소스 생성 (ALB 자동 생성)
  hosts: masters
  become: yes
  become_user: '{{ kubectl_user }}'
  tasks:
  - import_tasks: playbooks/07-ingress-resources.yml

- name: etcd 백업 설정
  hosts: masters
  become: yes
  tasks:
  - import_tasks: playbooks/09-etcd-backup.yml

- name: 클러스터 정보 출력
  hosts: masters
  become: yes
  become_user: '{{ kubectl_user }}'
  tasks:
  - name: Get nodes
    command: kubectl get nodes -o wide
    register: nodes_output

  - name: Display nodes
    debug:
      msg: '{{ nodes_output.stdout_lines }}'

  - name: Get ArgoCD initial password
    shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
    register: argocd_password
    ignore_errors: yes

  - name: Display ArgoCD info
    debug:
      msg:
      - 'ArgoCD URL: https://{{ ansible_host }}:8080'
      - 'Username: admin'
      - 'Password: {{ argocd_password.stdout }}'
    when: argocd_password is succeeded
