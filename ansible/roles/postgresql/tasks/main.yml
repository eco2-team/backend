---
# PostgreSQL ì„¤ì¹˜ (Tier 4: Persistence - Database)
# Storage ë…¸ë“œì— ë°°í¬ (workload=storage)

- name: "PostgreSQL namespace ìƒì„±"
  shell: |
    kubectl get namespace {{ postgres_namespace }} || kubectl create namespace {{ postgres_namespace }}
  register: ns_create

- name: "PostgreSQL ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸"
  shell: kubectl get statefulset -n {{ postgres_namespace }} postgres 2>/dev/null
  register: postgres_check
  failed_when: false
  changed_when: false

- name: "PostgreSQL ë¹„ë°€ë²ˆí˜¸ Secret ìƒì„±"
  shell: |
    kubectl create secret generic postgres-secret \
      -n {{ postgres_namespace }} \
      --from-literal=postgres-password='{{ postgres_password }}' \
      --dry-run=client -o yaml | kubectl apply -f -
  when: postgres_check.rc != 0
  register: postgres_secret

- name: "PostgreSQL StatefulSet ìƒì„±"
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: postgres
      namespace: {{ postgres_namespace }}
    spec:
      serviceName: postgres
      replicas: 1
      selector:
        matchLabels:
          app: postgres
      template:
        metadata:
          labels:
            app: postgres
            tier: database
        spec:
          nodeSelector:
            workload: database  # PostgreSQL ë…¸ë“œì— ë°°í¬
          containers:
          - name: postgres
            image: postgres:{{ postgres_version }}-alpine
            ports:
            - containerPort: 5432
              name: postgres
            env:
            - name: POSTGRES_DB
              value: {{ postgres_database }}
            - name: POSTGRES_USER
              value: {{ postgres_username }}
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: postgres-password
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
            volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
            resources:
              requests:
                memory: "1Gi"
                cpu: "500m"
              limits:
                memory: "2Gi"
                cpu: "1000m"
            livenessProbe:
              exec:
                command:
                - pg_isready
                - -U
                - {{ postgres_username }}
              initialDelaySeconds: 30
              periodSeconds: 10
            readinessProbe:
              exec:
                command:
                - pg_isready
                - -U
                - {{ postgres_username }}
              initialDelaySeconds: 5
              periodSeconds: 5
      volumeClaimTemplates:
      - metadata:
          name: postgres-storage
        spec:
          accessModes: [ "ReadWriteOnce" ]
          storageClassName: gp3
          resources:
            requests:
              storage: {{ postgres_persistence_size }}
    EOF
  when: postgres_check.rc != 0
  register: postgres_statefulset

- name: "PostgreSQL Service ìƒì„±"
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: v1
    kind: Service
    metadata:
      name: postgres
      namespace: {{ postgres_namespace }}
      labels:
        app: postgres
    spec:
      type: ClusterIP
      ports:
      - port: 5432
        targetPort: 5432
        protocol: TCP
        name: postgres
      selector:
        app: postgres
    EOF
  when: postgres_check.rc != 0
  register: postgres_service

- name: "PostgreSQL Pod ìƒíƒœ í™•ì¸ (ìµœëŒ€ 5ë¶„ ëŒ€ê¸°)"
  shell: |
    kubectl wait --for=condition=ready pod \
      -l app=postgres \
      -n {{ postgres_namespace }} \
      --timeout=300s
  register: postgres_ready
  failed_when: false
  changed_when: false

- name: "PostgreSQL ì—°ê²° í…ŒìŠ¤íŠ¸"
  shell: |
    kubectl exec -n {{ postgres_namespace }} statefulset/postgres -- \
      psql -U {{ postgres_username }} -d {{ postgres_database }} -c "SELECT version();"
  register: postgres_test
  retries: 3
  delay: 10
  until: postgres_test.rc == 0
  failed_when: false
  changed_when: false
  when: postgres_ready.rc == 0

- name: "PostgreSQL ì •ë³´ ì¶œë ¥"
  debug:
    msg:
      - "âœ… PostgreSQL ì„¤ì¹˜ ì™„ë£Œ (Tier 4: Persistence)"
      - "ì—­í• : ì£¼ìš” ë°ì´í„°ë² ì´ìŠ¤"
      - "ë²„ì „: PostgreSQL {{ postgres_version }}"
      - "ë°ì´í„°ë² ì´ìŠ¤: {{ postgres_database }}"
      - ""
      - "ì—°ê²° ì •ë³´:"
      - "  Host: postgres.{{ postgres_namespace }}.svc.cluster.local"
      - "  Port: 5432"
      - "  Database: {{ postgres_database }}"
      - "  Username: {{ postgres_username }}"
      - "  Password: (Secretì— ì €ì¥ë¨)"
      - ""
      - "Storage: {{ postgres_persistence_size }} (gp3)"
      - "Node: PostgreSQL (workload=database)"
      - ""
      - "âš ï¸ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ë°±ì—… ì„¤ì • í•„ìˆ˜!"
      - "âš ï¸ DB ìƒì„±ì€ ë³„ë„ë¡œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤."
      - ""
      - "ğŸ“¡ í´ëŸ¬ìŠ¤í„° ì „ë°˜ ì ‘ê·¼:"
      - "  Host: postgres.{{ postgres_namespace }}.svc.cluster.local:5432"
  when: postgres_ready is defined

