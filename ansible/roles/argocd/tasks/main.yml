# ArgoCD ì„¤ì¹˜
---
- name: ArgoCD namespace ìƒì„±
  command: kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml
  register: ns_yaml
  changed_when: false

- name: ArgoCD namespace apply
  shell: echo "{{ ns_yaml.stdout }}" | kubectl apply -f -
  changed_when: "'created' in ns_apply.stdout or 'configured' in ns_apply.stdout"
  register: ns_apply

- name: ArgoCD ì„¤ì¹˜
  command: kubectl apply -n {{ argocd_namespace }} -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml
  register: argocd_install
  changed_when: "'created' in argocd_install.stdout or 'configured' in argocd_install.stdout"

- name: ArgoCD Podê°€ Ready ë  ë•Œê¹Œì§€ ëŒ€ê¸°
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n {{ argocd_namespace }} --timeout=600s
  when: argocd_install.changed

- name: ArgoCD Serviceë¥¼ NodePortë¡œ ë³€ê²½
  shell: >
    kubectl patch svc argocd-server -n {{ argocd_namespace }}
    -p '{"spec":{"type":"NodePort","ports":[{"name":"http","port":80,"protocol":"TCP","targetPort":8080,"nodePort":{{ argocd_http_node_port }}},{"name":"https","port":443,"protocol":"TCP","targetPort":8080,"nodePort":{{ argocd_https_node_port }}}]}}'
  register: argocd_service_patch
  changed_when: "'patched' in argocd_service_patch.stdout or 'configured' in argocd_service_patch.stdout"
  when: argocd_install is succeeded

- name: ArgoCD Service ìƒíƒœ í™•ì¸
  command: kubectl get svc argocd-server -n {{ argocd_namespace }}
  register: argocd_service_info
  changed_when: false
  when: argocd_install is succeeded

- name: ArgoCD ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒ
  shell: kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_initial_password
  changed_when: false
  ignore_errors: yes

- name: ArgoCD ì •ë³´ ì¶œë ¥
  debug:
    msg:
      - "ArgoCDê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."
      - "ì ‘ì†: kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "Username: admin"
      - "Password: {{ argocd_initial_password.stdout }}"
  when: argocd_initial_password is succeeded

- name: root-app.yaml ë³µì‚¬ (Master ë…¸ë“œë¡œ)
  copy:
    src: "{{ playbook_dir }}/../../argocd/root-app.yaml"
    dest: /tmp/root-app.yaml
    mode: '0644'

- name: ArgoCD Root App ë°°í¬
  command: kubectl apply -f /tmp/root-app.yaml
  register: root_app_deploy
  changed_when: "'created' in root_app_deploy.stdout or 'configured' in root_app_deploy.stdout"

- name: ArgoCD Root App ìƒíƒœ í™•ì¸
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… ArgoCD Root App ë°°í¬ ì™„ë£Œ (App of Apps)"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - ""
      - "ğŸ“ ë°°í¬ëœ Application:"
      - "  - root-app (argocd/components/* ê´€ë¦¬)"
      - ""
      - "ğŸ”„ ìë™ ë°°í¬ ìˆœì„œ:"
      - "  Wave -1: Foundations (CRDs, Namespaces)"
      - "  Wave  0: Infrastructure (NetworkPolicies)"
      - "  Wave 10: Platform (ALB Controller, Cert-Manager)"
      - "  Wave 20: Monitoring (Prometheus, Grafana)"
      - "  Wave 25: Data Operators (PostgreSQL, Redis, RabbitMQ)"
      - "  Wave 30: Data Clusters (PostgreSQL, Redis, RabbitMQ CR)"
      - "  Wave 50: GitOps Tools (Atlantis)"
      - "  Wave 60: Applications (API Services + Workers)"
      - ""
      - "ğŸŒ ArgoCD WebUIì—ì„œ í™•ì¸:"
      - "  kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "  https://localhost:8080"
      - ""
      - "ğŸ“‹ Application ëª©ë¡ í™•ì¸:"
      - "  kubectl get applications -n argocd"

