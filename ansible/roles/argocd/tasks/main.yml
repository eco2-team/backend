# ArgoCD ì„¤ì¹˜
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 1. CNI Pre-check (ìˆœí™˜ ì˜ì¡´ì„± ë°©ì§€)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: CNI í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
  shell: kubectl get pods -n kube-system -l k8s-app=calico-node --no-headers 2>/dev/null | wc -l
  register: calico_count
  changed_when: false
  failed_when: false

- name: Calico CNI ìˆ˜ë™ ì„¤ì¹˜ (ë¯¸ì„¤ì¹˜ ì‹œ)
  command: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
  when: calico_count.stdout | int == 0
  register: calico_installed

- name: Calico Pod Ready ëŒ€ê¸°
  command: kubectl wait --for=condition=ready pod -l k8s-app=calico-node -n kube-system --timeout=120s --all
  when: calico_installed.changed

- name: ë…¸ë“œ Ready ìƒíƒœ í™•ì¸
  shell: kubectl get nodes --no-headers | grep -v " Ready " | wc -l
  register: notready_nodes
  changed_when: false
  failed_when: notready_nodes.stdout | int > 0
  retries: 6
  delay: 10

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 2. ArgoCD ì„¤ì¹˜
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: ArgoCD namespace ìƒì„±
  command: kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml
  register: ns_yaml
  changed_when: false

- name: ArgoCD namespace apply
  shell: echo "{{ ns_yaml.stdout }}" | kubectl apply -f -
  changed_when: "'created' in ns_apply.stdout or 'configured' in ns_apply.stdout"
  register: ns_apply

- name: ArgoCD ì„¤ì¹˜
  command: kubectl apply -n {{ argocd_namespace }} -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml
  register: argocd_install
  changed_when: "'created' in argocd_install.stdout or 'configured' in argocd_install.stdout"

- name: ArgoCD Podê°€ Ready ë  ë•Œê¹Œì§€ ëŒ€ê¸°
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n {{ argocd_namespace }} --timeout=600s
  when: argocd_install.changed

- name: ArgoCD Serviceë¥¼ NodePort(HTTP ë‹¨ì¼ í¬íŠ¸)ë¡œ ë³€ê²½
  shell: >
    kubectl patch svc argocd-server -n {{ argocd_namespace }}
    -p '{"spec":{"type":"NodePort","ports":[{"name":"http","port":80,"protocol":"TCP","targetPort":8080,"nodePort":{{ argocd_http_node_port }}}]}}'
  register: argocd_service_patch
  changed_when: "'patched' in argocd_service_patch.stdout or 'configured' in argocd_service_patch.stdout"
  when: argocd_install is succeeded

- name: ArgoCD Service ìƒíƒœ í™•ì¸
  command: kubectl get svc argocd-server -n {{ argocd_namespace }}
  register: argocd_service_info
  changed_when: false
  when: argocd_install is succeeded

- name: ArgoCD ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒ
  shell: kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_initial_password
  changed_when: false
  ignore_errors: yes

- name: ArgoCD ì •ë³´ ì¶œë ¥
  debug:
    msg:
      - "ArgoCDê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."
      - "ì ‘ì†: kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "Username: admin"
      - "Password: {{ argocd_initial_password.stdout }}"
  when: argocd_initial_password is succeeded

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 3. ArgoCD ì„¤ì • (NetworkPolicy ì œê±°, AppProject ìƒì„±)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: ArgoCD ê¸°ë³¸ NetworkPolicy ì‚­ì œ (í†µì‹  ì°¨ë‹¨ ë°©ì§€)
  command: kubectl delete networkpolicy --all -n {{ argocd_namespace }}
  register: netpol_deleted
  changed_when: "'deleted' in netpol_deleted.stdout"
  failed_when: false

- name: ArgoCD AppProject ìƒì„± (dev)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: argoproj.io/v1alpha1
    kind: AppProject
    metadata:
      name: dev
      namespace: {{ argocd_namespace }}
    spec:
      description: Development Environment
      sourceRepos:
        - '*'
      destinations:
        - namespace: '*'
          server: '*'
      clusterResourceWhitelist:
        - group: '*'
          kind: '*'
      namespaceResourceWhitelist:
        - group: '*'
          kind: '*'
    EOF
  register: appproject_created
  changed_when: "'created' in appproject_created.stdout or 'configured' in appproject_created.stdout"

- name: ArgoCD AppProject ìƒì„± (prod)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: argoproj.io/v1alpha1
    kind: AppProject
    metadata:
      name: prod
      namespace: {{ argocd_namespace }}
    spec:
      description: Production Environment
      sourceRepos:
        - '*'
      destinations:
        - namespace: '*'
          server: '*'
      clusterResourceWhitelist:
        - group: '*'
          kind: '*'
      namespaceResourceWhitelist:
        - group: '*'
          kind: '*'
    EOF
  register: appproject_prod_created
  changed_when: "'created' in appproject_prod_created.stdout or 'configured' in appproject_prod_created.stdout"

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 4. Root App ë°°í¬
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: root-app.yaml ë³µì‚¬ (Master ë…¸ë“œë¡œ)
  copy:
    src: "{{ playbook_dir }}/../../clusters/dev/root-app.yaml"
    dest: /tmp/root-app.yaml
    mode: '0644'

- name: ArgoCD Root App ë°°í¬
  command: kubectl apply -f /tmp/root-app.yaml
  register: root_app_deploy
  changed_when: "'created' in root_app_deploy.stdout or 'configured' in root_app_deploy.stdout"

- name: ArgoCD Root App ìƒíƒœ í™•ì¸
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… ArgoCD Root App ë°°í¬ ì™„ë£Œ (App of Apps)"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - ""
      - "ğŸ“ ë°°í¬ëœ Application:"
      - "  - root-app (argocd/apps/* ê´€ë¦¬)"
      - ""
      - "ğŸ”„ ìë™ ë°°í¬ ìˆœì„œ:"
      - "  Wave -1: Foundations (CRDs, Namespaces)"
      - "  Wave  0: Infrastructure (NetworkPolicy, Metrics Server)"
      - "  Wave 20: AWS Load Balancer Controller (Helm)"
      - "  Wave 30: Platform (Node Lifecycle/External Secrets â€“ reserved)"
      - "  Wave 40: Monitoring (Helm â€“ kube-prometheus-stack)"
      - "  Wave 50: Data Operators (PostgreSQL/Redis/RabbitMQ CRD)"
      - "  Wave 60: Data Clusters (Helm â€“ databases umbrella)"
      - "  Wave 70: GitOps Tools (Helm â€“ Atlantis)"
      - "  Wave 80: API ApplicationSet (auth/my/scan/character/location/info/chat)"
      - ""
      - "ğŸŒ ArgoCD WebUIì—ì„œ í™•ì¸:"
      - "  kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "  https://localhost:8080"
      - ""
      - "ğŸ“‹ Application ëª©ë¡ í™•ì¸:"
      - "  kubectl get applications -n argocd"

