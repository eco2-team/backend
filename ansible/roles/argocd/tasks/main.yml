# ArgoCD ì„¤ì¹˜
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 1. CNI Pre-check (Helmê³¼ ë™ì¼í•œ Calico êµ¬ì„± ë³´ì¥)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: Calico DaemonSet í™•ì¸
  command: kubectl get daemonset calico-node -n calico-system
  register: calico_daemonset_check
  changed_when: false

- name: Calico DaemonSet ì—†ìœ¼ë©´ ì¤‘ë‹¨
  fail:
    msg: "Calico DaemonSetì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ansible/playbooks/04-cni-install.yml ë‹¨ê³„ì—ì„œ Tigera Operator ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."
  when: calico_daemonset_check.rc != 0

- name: Calico Pod Ready ëŒ€ê¸°
  command: kubectl wait --for=condition=ready pod -l k8s-app=calico-node -n calico-system --timeout=300s --all

- name: ë…¸ë“œ Ready ìƒíƒœ í™•ì¸
  shell: kubectl get nodes --no-headers | grep -v " Ready " | wc -l
  register: notready_nodes
  changed_when: false
  failed_when: notready_nodes.stdout | int > 0
  retries: 6
  delay: 10

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 2. ArgoCD ì„¤ì¹˜
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: ArgoCD namespace ìƒì„± ë° ì ìš©
  shell: |
    set -euo pipefail
    kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml \
      | kubectl apply -f -
  register: ns_apply
  changed_when: "'created' in ns_apply.stdout or 'configured' in ns_apply.stdout"
  args:
    executable: /bin/bash

- name: ArgoCD ì„¤ì¹˜
  command: kubectl apply -n {{ argocd_namespace }} -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml
  register: argocd_install
  changed_when: "'created' in argocd_install.stdout or 'configured' in argocd_install.stdout"

- name: ArgoCD Podê°€ Ready ë  ë•Œê¹Œì§€ ëŒ€ê¸°
  command: kubectl wait --for=condition=ready pod -l app.sesacthon.io/name=argocd-server -n {{ argocd_namespace }} --timeout=600s
  when: argocd_install.changed

- name: ArgoCD Serviceë¥¼ NodePort(HTTP ë‹¨ì¼ í¬íŠ¸)ë¡œ ë³€ê²½
  shell: >
    kubectl patch svc argocd-server -n {{ argocd_namespace }}
    -p '{"spec":{"type":"NodePort","ports":[{"name":"http","port":80,"protocol":"TCP","targetPort":8080,"nodePort":{{ argocd_http_node_port }}}]}}'
  register: argocd_service_patch
  changed_when: "'patched' in argocd_service_patch.stdout or 'configured' in argocd_service_patch.stdout"
  when: argocd_install is succeeded

- name: ArgoCD Service ìƒíƒœ í™•ì¸
  command: kubectl get svc argocd-server -n {{ argocd_namespace }}
  register: argocd_service_info
  changed_when: false
  when: argocd_install is succeeded

- name: ArgoCD ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒ
  shell: kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_initial_password
  changed_when: false
  ignore_errors: yes

- name: ArgoCD ì •ë³´ ì¶œë ¥
  debug:
    msg:
      - "ArgoCDê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."
      - "ì ‘ì†: kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "Username: admin"
      - "Password: {{ argocd_initial_password.stdout }}"
  when: argocd_initial_password is succeeded

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 3. ArgoCD ì„¤ì • (NetworkPolicy ì œê±°, AppProject ìƒì„±)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: ArgoCD ê¸°ë³¸ NetworkPolicy ì‚­ì œ (í†µì‹  ì°¨ë‹¨ ë°©ì§€)
  command: kubectl delete networkpolicy --all -n {{ argocd_namespace }}
  register: netpol_deleted
  changed_when: "'deleted' in netpol_deleted.stdout"
  failed_when: false

- name: ArgoCD AppProject ìƒì„± (dev)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: argoproj.io/v1alpha1
    kind: AppProject
    metadata:
      name: dev
      namespace: {{ argocd_namespace }}
    spec:
      description: Development Environment
      sourceRepos:
        - '*'
      destinations:
        - namespace: '*'
          server: '*'
      clusterResourceWhitelist:
        - group: '*'
          kind: '*'
      namespaceResourceWhitelist:
        - group: '*'
          kind: '*'
    EOF
  register: appproject_created
  changed_when: "'created' in appproject_created.stdout or 'configured' in appproject_created.stdout"

- name: ArgoCD AppProject ìƒì„± (prod)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: argoproj.io/v1alpha1
    kind: AppProject
    metadata:
      name: prod
      namespace: {{ argocd_namespace }}
    spec:
      description: Production Environment
      sourceRepos:
        - '*'
      destinations:
        - namespace: '*'
          server: '*'
      clusterResourceWhitelist:
        - group: '*'
          kind: '*'
      namespaceResourceWhitelist:
        - group: '*'
          kind: '*'
    EOF
  register: appproject_prod_created
  changed_when: "'created' in appproject_prod_created.stdout or 'configured' in appproject_prod_created.stdout"

- block:
    - name: AWS Access Key ID ì…ë ¥
      pause:
        prompt: "AWS Access Key IDë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      register: aws_access_key_id_prompt
      when: aws_access_key_id is not defined
      no_log: true
      run_once: true

    - name: AWS Access Key ID ì„¤ì •
      set_fact:
        aws_access_key_id: "{{ aws_access_key_id_prompt.user_input }}"
      when: aws_access_key_id is not defined
      no_log: true
      run_once: true

    - name: AWS Secret Access Key ì…ë ¥
      pause:
        prompt: "AWS Secret Access Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        echo: no
      register: aws_secret_access_key_prompt
      when: aws_secret_access_key is not defined
      no_log: true
      run_once: true

    - name: AWS Secret Access Key ì„¤ì •
      set_fact:
        aws_secret_access_key: "{{ aws_secret_access_key_prompt.user_input }}"
      when: aws_secret_access_key is not defined
      no_log: true
      run_once: true

    - name: aws-global-credentials Secret ìƒì„±
      become_user: "{{ kubectl_user }}"
      shell: |
        set -euo pipefail
        cat <<'EOF' | kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: aws-global-credentials
          namespace: {{ item }}
        type: Opaque
        data:
          aws_access_key_id: {{ aws_access_key_id | b64encode }}
          aws_secret_access_key: {{ aws_secret_access_key | b64encode }}
        EOF
      loop:
        - kube-system
        - platform-system
      no_log: true
      run_once: true
  when: create_aws_credentials_secret | default(true)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 4. Root App ë°°í¬
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: root-app.yaml ë³µì‚¬ (Master ë…¸ë“œë¡œ)
  copy:
    src: "{{ playbook_dir }}/../../clusters/dev/root-app.yaml"
    dest: /tmp/root-app.yaml
    mode: '0644'

- name: ArgoCD Root App ë°°í¬
  command: kubectl apply -f /tmp/root-app.yaml
  register: root_app_deploy
  changed_when: "'created' in root_app_deploy.stdout or 'configured' in root_app_deploy.stdout"

- name: ArgoCD Root App ìƒíƒœ í™•ì¸
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… ArgoCD Root App ë°°í¬ ì™„ë£Œ (App of Apps)"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - ""
      - "ğŸ“ ë°°í¬ëœ Application:"
      - "  - root-app (argocd/apps/* ê´€ë¦¬)"
      - ""
      - "ğŸ”„ ìë™ ë°°í¬ ìˆœì„œ:"
      - "  Wave -1: Foundations (CRDs, Namespaces)"
      - "  Wave  0: Infrastructure (NetworkPolicy, Metrics Server)"
      - "  Wave 20: AWS Load Balancer Controller (Helm)"
      - "  Wave 30: Platform (Node Lifecycle/External Secrets â€“ reserved)"
      - "  Wave 40: Monitoring (Helm â€“ kube-prometheus-stack)"
      - "  Wave 50: Data Operators (PostgreSQL/Redis/RabbitMQ CRD)"
      - "  Wave 60: Data Clusters (Helm â€“ databases umbrella)"
      - "  Wave 70: GitOps Tools (Helm â€“ Atlantis)"
      - "  Wave 80: API ApplicationSet (auth/my/scan/character/location/info/chat)"
      - ""
      - "ğŸŒ ArgoCD WebUIì—ì„œ í™•ì¸:"
      - "  kubectl port-forward svc/argocd-server -n argocd 8080:443"
      - "  https://localhost:8080"
      - ""
      - "ğŸ“‹ Application ëª©ë¡ í™•ì¸:"
      - "  kubectl get applications -n argocd"

