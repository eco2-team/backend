---
# ArgoCD ì„¤ì¹˜
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 1. ArgoCD ì„¤ì¹˜
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: ArgoCD namespace ìƒì„± ë° ì ìš©
  shell: |
    set -euo pipefail
    cat <<'EOF' | kubectl apply -f -
    apiVersion: v1
    kind: Namespace
    metadata:
      name: {{ argocd_namespace }}
      labels:
        kubernetes.io/metadata.name: {{ argocd_namespace }}
        app.kubernetes.io/name: argocd
        app.kubernetes.io/managed-by: ansible
        app.kubernetes.io/part-of: ecoeco-platform
        environment: {{ argocd_root_env }}
        tier: platform
        role: gitops
        workload: gitops
    EOF
  register: ns_apply
  changed_when: "'created' in ns_apply.stdout or 'configured' in ns_apply.stdout"
  args:
    executable: /bin/bash

- name: ArgoCD ì„¤ì¹˜
  command: kubectl apply -n {{ argocd_namespace }} -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml
  register: argocd_install
  changed_when: "'created' in argocd_install.stdout or 'configured' in argocd_install.stdout"

- name: ArgoCD Podê°€ Ready ë  ë•Œê¹Œì§€ ëŒ€ê¸°
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n {{ argocd_namespace }} --timeout=600s
  when: argocd_install.changed

- name: ArgoCD ì›Œí¬ë¡œë“œë¥¼ control-plane ë…¸ë“œì— ê³ ì • ë° ì„¤ì •
  vars:
    argocd_control_plane_patch:
      spec:
        template:
          spec:
            nodeSelector:
              role: control-plane
            tolerations:
            - key: node-role.kubernetes.io/control-plane
              operator: Exists
              effect: NoSchedule
            - key: role
              operator: Equal
              value: control-plane
              effect: NoSchedule
  command: >
    kubectl -n {{ argocd_namespace }}
    patch {{ item.kind }} {{ item.name }}
    --type merge
    -p '{{ argocd_control_plane_patch | to_json }}'
  loop:
  - {kind: deployment, name: argocd-server}
  - {kind: deployment, name: argocd-repo-server}
  - {kind: deployment, name: argocd-dex-server}
  - {kind: deployment, name: argocd-redis}
  - {kind: deployment, name: argocd-notifications-controller}
  - {kind: statefulset, name: argocd-application-controller}
  register: argocd_control_plane_result
  changed_when: "'patched' in argocd_control_plane_result.stdout"
  failed_when: >
    argocd_control_plane_result.rc != 0 and
    'NotFound' not in argocd_control_plane_result.stderr
  when: argocd_install is succeeded

- name: ArgoCD cmd-params ConfigMap ì¡´ì¬ í™•ì¸
  command: kubectl get configmap argocd-cmd-params-cm -n {{ argocd_namespace }}
  register: configmap_check
  failed_when: false
  changed_when: false
  when: argocd_install is succeeded

- name: ArgoCD cmd-params ConfigMap ìƒì„± (ì—†ì„ ê²½ìš°)
  shell: |
    kubectl create configmap argocd-cmd-params-cm -n {{ argocd_namespace }} \
      --from-literal=server.insecure=true
  register: configmap_create
  changed_when: "'created' in configmap_create.stdout"
  when:
  - argocd_install is succeeded
  - configmap_check.rc != 0

- name: ArgoCD Serverë¥¼ insecure ëª¨ë“œë¡œ ì„¤ì • (ALB HTTPS ì¢…ë£Œ ëŒ€ì‘)
  command: >
    kubectl -n {{ argocd_namespace }}
    patch configmap argocd-cmd-params-cm
    --type merge
    -p '{"data":{"server.insecure":"true"}}'
  register: argocd_insecure_result
  changed_when: "'patched' in argocd_insecure_result.stdout or 'configured' in argocd_insecure_result.stdout"
  when:
  - argocd_install is succeeded
  - configmap_check.rc == 0

- name: ArgoCD Server íŒŒë“œ ì¬ì‹œì‘ (insecure ëª¨ë“œ ì ìš©)
  command: kubectl rollout restart deployment argocd-server -n {{ argocd_namespace }}
  when: argocd_insecure_result is changed or configmap_create is changed

- name: ArgoCD Server íŒŒë“œ ì¬ì‹œì‘ ëŒ€ê¸° (insecure ëª¨ë“œ ì ìš©)
  command: kubectl rollout status deployment argocd-server -n {{ argocd_namespace }} --timeout=300s
  when: argocd_insecure_result is changed or configmap_create is changed

- name: ArgoCD insecure ëª¨ë“œ ì„¤ì • ê²€ì¦
  shell: |
    kubectl get configmap argocd-cmd-params-cm -n {{ argocd_namespace }} -o jsonpath='{.data.server\.insecure}'
  register: insecure_verify
  changed_when: false
  failed_when: insecure_verify.stdout != "true"
  when: argocd_install is succeeded

- name: ArgoCD Serviceë¥¼ NodePort(HTTP ë‹¨ì¼ í¬íŠ¸)ë¡œ ë³€ê²½
  shell: >
    kubectl patch svc argocd-server -n {{ argocd_namespace }}
    -p '{"spec":{"type":"NodePort","ports":[{"name":"http","port":80,"protocol":"TCP","targetPort":8080,"nodePort":{{ argocd_http_node_port }}}]}}'
  register: argocd_service_patch
  changed_when: "'patched' in argocd_service_patch.stdout or 'configured' in argocd_service_patch.stdout"
  when: argocd_install is succeeded

- name: ArgoCD Service ìƒíƒœ í™•ì¸
  command: kubectl get svc argocd-server -n {{ argocd_namespace }}
  register: argocd_service_info
  changed_when: false
  when: argocd_install is succeeded

- name: ArgoCD ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì¡°íšŒ
  shell: kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  register: argocd_initial_password
  changed_when: false
  ignore_errors: yes

- name: ArgoCD ì •ë³´ ì¶œë ¥
  debug:
    msg:
    - ArgoCDê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.
    - 'ì ‘ì†: kubectl port-forward svc/argocd-server -n argocd 8080:443'
    - 'Username: admin'
    - 'Password: {{ argocd_initial_password.stdout }}'
  when: argocd_initial_password is succeeded

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 3. ArgoCD ì„¤ì • (NetworkPolicy ì œê±°, AppProject ìƒì„±)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: ArgoCD ê¸°ë³¸ NetworkPolicy ì‚­ì œ (í†µì‹  ì°¨ë‹¨ ë°©ì§€)
  command: kubectl delete networkpolicy --all -n {{ argocd_namespace }}
  register: netpol_deleted
  changed_when: "'deleted' in netpol_deleted.stdout"
  failed_when: false

- name: ArgoCD AppProject ìƒì„± (dev)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: argoproj.io/v1alpha1
    kind: AppProject
    metadata:
      name: dev
      namespace: {{ argocd_namespace }}
    spec:
      description: Development Environment
      sourceRepos:
        - '*'
      destinations:
        - namespace: '*'
          server: '*'
      clusterResourceWhitelist:
        - group: '*'
          kind: '*'
      namespaceResourceWhitelist:
        - group: '*'
          kind: '*'
    EOF
  register: appproject_created
  changed_when: "'created' in appproject_created.stdout or 'configured' in appproject_created.stdout"

- name: ArgoCD AppProject ìƒì„± (prod)
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: argoproj.io/v1alpha1
    kind: AppProject
    metadata:
      name: prod
      namespace: {{ argocd_namespace }}
    spec:
      description: Production Environment
      sourceRepos:
        - '*'
      destinations:
        - namespace: '*'
          server: '*'
      clusterResourceWhitelist:
        - group: '*'
          kind: '*'
      namespaceResourceWhitelist:
        - group: '*'
          kind: '*'
    EOF
  register: appproject_prod_created
  changed_when: "'created' in appproject_prod_created.stdout or 'configured' in appproject_prod_created.stdout"

- block:
  - name: AWS Access Key ID ì…ë ¥
    pause:
      prompt: AWS Access Key IDë¥¼ ì…ë ¥í•˜ì„¸ìš”
    register: aws_access_key_id_prompt
    when: aws_access_key_id is not defined
    no_log: true
    run_once: true

  - name: AWS Access Key ID ì„¤ì •
    set_fact:
      aws_access_key_id: '{{ aws_access_key_id_prompt.user_input }}'
    when: aws_access_key_id is not defined
    no_log: true
    run_once: true

  - name: AWS Secret Access Key ì…ë ¥
    pause:
      prompt: AWS Secret Access Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”
      echo: no
    register: aws_secret_access_key_prompt
    when: aws_secret_access_key is not defined
    no_log: true
    run_once: true

  - name: AWS Secret Access Key ì„¤ì •
    set_fact:
      aws_secret_access_key: '{{ aws_secret_access_key_prompt.user_input }}'
    when: aws_secret_access_key is not defined
    no_log: true
    run_once: true

  - name: aws-global-credentials Secretìš© platform-system Namespace ìƒì„±
    become_user: '{{ kubectl_user }}'
    shell: |
      set -euo pipefail
      if ! kubectl get namespace platform-system >/dev/null 2>&1; then
        kubectl create namespace platform-system
      fi
    args:
      executable: /bin/bash
    register: platform_system_namespace
    changed_when: "'created' in (platform_system_namespace.stdout | default(''))"
    run_once: true

  - name: aws-global-credentials Secret ìƒì„±
    become_user: '{{ kubectl_user }}'
    shell: |
      set -euo pipefail
      cat <<'EOF' | kubectl apply -f -
      apiVersion: v1
      kind: Secret
      metadata:
        name: aws-global-credentials
        namespace: {{ item }}
      type: Opaque
      data:
        aws_access_key_id: {{ aws_access_key_id | b64encode }}
        aws_secret_access_key: {{ aws_secret_access_key | b64encode }}
      EOF
    loop:
    - kube-system
    - platform-system
    no_log: true
    run_once: true
    args:
      executable: /bin/bash
  when: create_aws_credentials_secret | default(true)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 4. Root App ë°°í¬
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- name: Root App ê²½ë¡œ ê³„ì‚°
  set_fact:
    argocd_root_app_file: '{{ playbook_dir }}/../clusters/{{ argocd_root_env }}/root-app.yaml'

- name: root-app.yaml ë³µì‚¬ (ì„ íƒì )
  copy:
    src: '{{ argocd_root_app_file }}'
    dest: /tmp/root-app.yaml

- name: ArgoCD Root App ë°°í¬
  command: kubectl apply -f /tmp/root-app.yaml
  register: root_app_deploy
  changed_when: "'created' in root_app_deploy.stdout or 'configured' in root_app_deploy.stdout"

- name: ArgoCD Root App ìƒíƒœ í™•ì¸
  debug:
    msg:
    - â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    - âœ… ArgoCD Root App ë°°í¬ ì™„ë£Œ (App of Apps)
    - â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    - ''
    - 'ğŸ“ ë°°í¬ëœ Application:'
    - '  - root-app (argocd/apps/* ê´€ë¦¬)'
    - ''
    - 'ğŸ”„ ìë™ ë°°í¬ ìˆœì„œ (Sync Wave v0.7.4):'
    - '  Wave  0 : CRD Seed (00-crds)'
    - '  Wave  2 : Namespaces (02-namespaces)'
    - '  Wave  3 : RBAC & Storage (03-rbac-storage)'
    - '  Wave  5 : CNI - Calico (05-calico)'
    - '  Wave  6 : NetworkPolicy (06-network-policies)'
    - '  Wave 10 : External Secrets Operator (10-secrets-operator)'
    - '  Wave 11 : ExternalSecret CR (11-secrets-cr)'
    - '  Wave 15 : AWS Load Balancer Controller (15-alb-controller)'
    - '  Wave 16 : ExternalDNS (16-external-dns)'
    - '  Wave 20 : Monitoring Operator (20-monitoring-operator)'
    - '  Wave 21 : Grafana (21-grafana)'
    - '  Wave 25 : Data Operators (25-data-operators)'
    - '  Wave 35 : Data Instances (35-data-cr)'
    - '  Wave 60 : API ApplicationSet (60-apis-appset)'
    - '  Wave 70 : Ingress / Edge Routing (70-ingress)'
    - ''
    - 'ğŸŒ ArgoCD WebUIì—ì„œ í™•ì¸:'
    - '  kubectl port-forward svc/argocd-server -n argocd 8080:443'
    - '  https://localhost:8080'
    - ''
    - 'ğŸ“‹ Application ëª©ë¡ í™•ì¸:'
    - '  kubectl get applications -n argocd'
