# RabbitMQ 설치 (Helm)
---
- name: Helm 설치 여부 확인
  command: which helm
  register: helm_check
  failed_when: false
  changed_when: false

- name: Helm 설치
  shell: |
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  when: helm_check.rc != 0

- name: Bitnami Helm repository 추가
  command: helm repo add bitnami https://charts.bitnami.com/bitnami
  changed_when: false

- name: Helm repository 업데이트
  command: helm repo update
  changed_when: false

- name: RabbitMQ namespace 생성
  command: kubectl create namespace {{ rabbitmq_namespace }} --dry-run=client -o yaml | kubectl apply -f -

- name: RabbitMQ 설치 여부 확인
  command: helm list -n {{ rabbitmq_namespace }}
  register: rabbitmq_check
  changed_when: false

- name: RabbitMQ Helm Chart 설치
  command: >
    helm install rabbitmq bitnami/rabbitmq
    --namespace {{ rabbitmq_namespace }}
    --set auth.username={{ rabbitmq_username }}
    --set auth.password={{ rabbitmq_password }}
    --set persistence.enabled=true
    --set persistence.size={{ rabbitmq_persistence_size }}
    --set resources.requests.cpu=200m
    --set resources.requests.memory=256Mi
    --set resources.limits.cpu=500m
    --set resources.limits.memory=512Mi
    --set nodeSelector.kubernetes\\.io/hostname=k8s-master
  when: "'rabbitmq' not in rabbitmq_check.stdout"

- name: RabbitMQ Pod 대기
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=rabbitmq -n {{ rabbitmq_namespace }} --timeout=300s

- name: RabbitMQ 접속 정보
  debug:
    msg:
      - "RabbitMQ가 설치되었습니다."
      - "Management UI: kubectl port-forward -n {{ rabbitmq_namespace }} svc/rabbitmq 15672:15672"
      - "AMQP: amqp://{{ rabbitmq_username }}:{{ rabbitmq_password }}@rabbitmq.{{ rabbitmq_namespace }}:5672/"
      - "Username: {{ rabbitmq_username }}"
      - "Password: {{ rabbitmq_password }}"

