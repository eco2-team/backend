# RabbitMQ ì„¤ì¹˜ (Cluster Operator - ê³µì‹)
---
- name: RabbitMQ namespace ìƒì„±
  shell: kubectl create namespace {{ rabbitmq_namespace }} --dry-run=client -o yaml | kubectl apply -f -

- name: RabbitMQ Operator ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
  command: kubectl get crd rabbitmqclusters.rabbitmq.com 2>/dev/null || echo "not_found"
  register: rabbitmq_crd_check
  changed_when: false
  failed_when: false

- name: RabbitMQ Cluster Operator ì„¤ì¹˜
  when: "'not_found' in rabbitmq_crd_check.stdout"
  block:
    - name: RabbitMQ Cluster Operator CRD ì„¤ì¹˜
      shell: |
        kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
      register: operator_install
      changed_when: "'created' in operator_install.stdout or 'configured' in operator_install.stdout"
    
    - name: RabbitMQ Cluster Operator ë°°í¬ ëŒ€ê¸°
      shell: |
        echo "â³ RabbitMQ Cluster Operator ë°°í¬ ëŒ€ê¸°..."
        for i in {1..60}; do
          if kubectl get deployment rabbitmq-cluster-operator -n rabbitmq-system >/dev/null 2>&1; then
            if kubectl wait --for=condition=available deployment/rabbitmq-cluster-operator -n rabbitmq-system --timeout=300s 2>/dev/null; then
              echo "âœ… RabbitMQ Cluster Operator ì¤€ë¹„ ì™„ë£Œ"
              exit 0
            fi
          fi
          echo "ëŒ€ê¸° ì¤‘... ($i/60)"
          sleep 5
        done
        echo "âš ï¸  Operator ë°°í¬ ì‹œê°„ ì´ˆê³¼ (ê³„ì† ì§„í–‰)"
      changed_when: false
      failed_when: false

- name: RabbitMQ Cluster ë°°í¬ ì—¬ë¶€ í™•ì¸
  command: kubectl get rabbitmqcluster rabbitmq -n {{ rabbitmq_namespace }} 2>/dev/null || echo "not_found"
  register: rabbitmq_cluster_check
  changed_when: false
  failed_when: false

- name: RabbitMQ Cluster ë°°í¬ (ê³µì‹ ì´ë¯¸ì§€ ì‚¬ìš©)
  when: "'not_found' in rabbitmq_cluster_check.stdout"
  block:
    - name: RabbitMQ Cluster ë¦¬ì†ŒìŠ¤ ìƒì„±
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: rabbitmq.com/v1beta1
        kind: RabbitmqCluster
        metadata:
          name: rabbitmq
          namespace: {{ rabbitmq_namespace }}
        spec:
          replicas: {{ rabbitmq_replicas }}
          image: rabbitmq:3.13-management
          persistence:
            storageClassName: gp3
            storage: {{ rabbitmq_persistence_size }}
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 2Gi
          affinity:
            nodeAffinity:
              # Storage ë…¸ë“œì—ë§Œ ë°°ì¹˜
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                - matchExpressions:
                  - key: workload
                    operator: In
                    values:
                    - storage
          service:
            type: ClusterIP
          rabbitmq:
            additionalConfig: |
              # Enable Management Plugin
              management.tcp.port = 15672
              management.tcp.ip = 0.0.0.0
              
          defaultUser:
            tags: administrator
            secretReference:
              name: rabbitmq-default-user
        EOF
      register: cluster_create
      changed_when: "'created' in cluster_create.stdout or 'configured' in cluster_create.stdout"
    
    - name: RabbitMQ ê¸°ë³¸ ì‚¬ìš©ì Secret ìƒì„±
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: rabbitmq-default-user
          namespace: {{ rabbitmq_namespace }}
        type: Opaque
        stringData:
          username: {{ rabbitmq_username }}
          password: {{ rabbitmq_password }}
        EOF
      register: secret_create
      changed_when: "'created' in secret_create.stdout or 'configured' in secret_create.stdout"
    
    - name: RabbitMQ Cluster ë°°í¬ ëŒ€ê¸°
      shell: |
        echo "â³ RabbitMQ Cluster ë°°í¬ ëŒ€ê¸°..."
        sleep 30
        for i in {1..60}; do
          READY=$(kubectl get rabbitmqcluster rabbitmq -n {{ rabbitmq_namespace }} -o jsonpath='{.status.conditions[?(@.type=="AllReplicasReady")].status}' 2>/dev/null || echo "")
          if [ "$READY" == "True" ]; then
            echo "âœ… RabbitMQ Cluster ì¤€ë¹„ ì™„ë£Œ"
            exit 0
          fi
          echo "ëŒ€ê¸° ì¤‘... ($i/60)"
          sleep 10
        done
        echo "âš ï¸  Cluster ë°°í¬ ì‹œê°„ ì´ˆê³¼ (ìƒíƒœ í™•ì¸ í•„ìš”)"
      changed_when: false
      failed_when: false

- name: RabbitMQ Pod Ready ëŒ€ê¸°
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=rabbitmq -n {{ rabbitmq_namespace }} --timeout=600s
  ignore_errors: yes
  register: rabbitmq_wait

- name: RabbitMQ Pod ë¬¸ì œ í™•ì¸ ë° ë¡œê·¸ ì¶œë ¥
  when: rabbitmq_wait.rc != 0
  block:
    - name: RabbitMQ Pod ìƒíƒœ í™•ì¸ (ëª¨ë“  ë ˆì´ë¸” ì‹œë„)
      shell: |
        echo "=== Pod í™•ì¸ (app.kubernetes.io/name=rabbitmq) ==="
        kubectl get pods -n {{ rabbitmq_namespace }} -l app.kubernetes.io/name=rabbitmq || echo "ì—†ìŒ"
        echo ""
        echo "=== Pod í™•ì¸ (app.kubernetes.io/part-of=rabbitmq) ==="
        kubectl get pods -n {{ rabbitmq_namespace }} -l app.kubernetes.io/part-of=rabbitmq || echo "ì—†ìŒ"
        echo ""
        echo "=== Pod í™•ì¸ (rabbitmq.com/cluster=rabbitmq) ==="
        kubectl get pods -n {{ rabbitmq_namespace }} -l rabbitmq.com/cluster=rabbitmq || echo "ì—†ìŒ"
        echo ""
        echo "=== ëª¨ë“  Pod (messaging namespace) ==="
        kubectl get pods -n {{ rabbitmq_namespace }}
      register: rabbitmq_status
      changed_when: false
    
    - name: RabbitMQ Pod ìƒíƒœ ì¶œë ¥
      debug:
        msg: "{{ rabbitmq_status.stdout_lines }}"
    
    - name: RabbitMQ Pod ì´ë²¤íŠ¸ í™•ì¸
      shell: |
        # ì—¬ëŸ¬ ë ˆì´ë¸”ë¡œ Pod ì°¾ê¸°
        POD_NAME=$(kubectl get pods -n {{ rabbitmq_namespace }} -l rabbitmq.com/cluster=rabbitmq -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -z "$POD_NAME" ]; then
          POD_NAME=$(kubectl get pods -n {{ rabbitmq_namespace }} -l app.kubernetes.io/name=rabbitmq -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        fi
        if [ -z "$POD_NAME" ]; then
          # ì´ë¦„ íŒ¨í„´ìœ¼ë¡œ ì°¾ê¸° (rabbitmq-rabbitmq-server-0)
          POD_NAME=$(kubectl get pods -n {{ rabbitmq_namespace }} -o jsonpath='{.items[?(@.metadata.name=~"rabbitmq.*")].metadata.name}' 2>/dev/null | awk '{print $1}' || echo "")
        fi
        
        if [ -n "$POD_NAME" ]; then
          echo "=== Pod: $POD_NAME ==="
          echo "=== Pod ì´ë²¤íŠ¸ ==="
          kubectl describe pod "$POD_NAME" -n {{ rabbitmq_namespace }} | tail -30
          echo ""
          echo "=== ì»¨í…Œì´ë„ˆ ë¡œê·¸ ==="
          kubectl logs "$POD_NAME" -n {{ rabbitmq_namespace }} --tail=50 2>/dev/null || echo "ë¡œê·¸ ì—†ìŒ"
        else
          echo "Podë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          echo ""
          echo "=== RabbitmqCluster ìƒíƒœ ==="
          kubectl get rabbitmqcluster -n {{ rabbitmq_namespace }}
          echo ""
          echo "=== RabbitmqCluster ìƒì„¸ ì •ë³´ ==="
          kubectl describe rabbitmqcluster rabbitmq -n {{ rabbitmq_namespace }} | tail -50
        fi
      register: rabbitmq_diagnosis
      changed_when: false
      failed_when: false
    
    - name: RabbitMQ ì§„ë‹¨ ì •ë³´ ì¶œë ¥
      debug:
        msg: "{{ rabbitmq_diagnosis.stdout_lines }}"
    
    - name: RabbitMQ Cluster ìƒíƒœ í™•ì¸
      command: kubectl get rabbitmqcluster rabbitmq -n {{ rabbitmq_namespace }} -o yaml
      register: rabbitmq_cluster_status
      changed_when: false
      failed_when: false
    
    - name: RabbitMQ Cluster ìƒíƒœ ì¶œë ¥
      debug:
        msg: "{{ rabbitmq_cluster_status.stdout_lines }}"

- name: RabbitMQ Pod ìƒíƒœ í™•ì¸
  shell: |
    echo "=== ëª¨ë“  Pod (messaging namespace) ==="
    kubectl get pods -n {{ rabbitmq_namespace }}
    echo ""
    echo "=== RabbitmqCluster ìƒíƒœ ==="
    kubectl get rabbitmqcluster -n {{ rabbitmq_namespace }}
  register: rabbitmq_pods
  changed_when: false

- name: RabbitMQ Pod ìƒíƒœ ì¶œë ¥
  debug:
    msg: "{{ rabbitmq_pods.stdout_lines }}"

- name: RabbitMQ Cluster ìƒíƒœ í™•ì¸
  shell: |
    # ì—¬ëŸ¬ ë ˆì´ë¸”ë¡œ Pod ì°¾ê¸°
    POD_NAME=$(kubectl get pods -n {{ rabbitmq_namespace }} -l rabbitmq.com/cluster=rabbitmq -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
    if [ -z "$POD_NAME" ]; then
      POD_NAME=$(kubectl get pods -n {{ rabbitmq_namespace }} -o jsonpath='{.items[?(@.metadata.name=~"rabbitmq.*server.*")].metadata.name}' 2>/dev/null | awk '{print $1}' || echo "")
    fi
    
    if [ -n "$POD_NAME" ]; then
      echo "Pod: $POD_NAME"
      kubectl exec -n {{ rabbitmq_namespace }} "$POD_NAME" -- rabbitmqctl cluster_status
    else
      echo "âš ï¸  Podë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
      echo "RabbitmqCluster ìƒíƒœ í™•ì¸:"
      kubectl get rabbitmqcluster rabbitmq -n {{ rabbitmq_namespace }} -o yaml | grep -A 20 "status:"
    fi
  register: rabbitmq_cluster
  failed_when: false
  changed_when: false
  when: rabbitmq_wait is succeeded

- name: RabbitMQ ì ‘ì† ì •ë³´
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… RabbitMQ ì„¤ì¹˜ ì™„ë£Œ (Tier 3: Message Queue)"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ë°©ì‹: RabbitMQ Cluster Operator (ê³µì‹)"
      - "ì´ë¯¸ì§€: rabbitmq:3.13-management (ê³µì‹ Docker Hub)"
      - "ì—­í• : Task Queue Middleware"
      - "êµ¬ì„±: ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ({{ rabbitmq_replicas }} Pod)"
      - "Queues: 5ê°œ (q.ai, q.batch, q.api, q.sched, q.dlq)"
      - ""
      - "ì—°ê²° ì •ë³´:"
      - "  AMQP: amqp://{{ rabbitmq_username }}:{{ rabbitmq_password }}@rabbitmq.{{ rabbitmq_namespace }}.svc.cluster.local:5672/"
      - "  Management UI: kubectl port-forward -n {{ rabbitmq_namespace }} svc/rabbitmq 15672:15672"
      - "  Username: {{ rabbitmq_username }}"
      - "  Password: {{ rabbitmq_password }}"
      - ""
      - "Storage: {{ rabbitmq_persistence_size }}"
      - "Node: Storage (workload=storage)"
      - ""
      - "âš ï¸ RabbitMQëŠ” ë©”ì‹œì§€ ì „ë‹¬ë§Œ ë‹´ë‹¹!"
      - "âš ï¸ Progress Trackingì€ Redis (Tier 4) ì‚¬ìš©!"
      - "ğŸ“Œ HA êµ¬ì„±ì€ í–¥í›„ ê°œë°œ ì§„ì²™ì— ë”°ë¼ ë³´ê°• ì˜ˆì •"
