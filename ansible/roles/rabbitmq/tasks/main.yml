# RabbitMQ 설치 (Helm)
---
- name: Helm 설치 여부 확인
  command: which helm
  register: helm_check
  failed_when: false
  changed_when: false

- name: Helm 설치
  shell: |
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  when: helm_check.rc != 0

- name: Bitnami Helm repository 추가
  command: helm repo add bitnami https://charts.bitnami.com/bitnami
  changed_when: false

- name: Helm repository 업데이트
  command: helm repo update
  changed_when: false

- name: RabbitMQ namespace 생성
  shell: kubectl create namespace {{ rabbitmq_namespace }} --dry-run=client -o yaml | kubectl apply -f -

- name: RabbitMQ 설치 여부 확인
  command: helm list -n {{ rabbitmq_namespace }}
  register: rabbitmq_check
  changed_when: false

- name: RabbitMQ Helm Chart 설치 (Tier 3, HA 3-node, Storage 노드)
  command: >
    helm install rabbitmq bitnami/rabbitmq
    --namespace {{ rabbitmq_namespace }}
    --set auth.username={{ rabbitmq_username }}
    --set auth.password={{ rabbitmq_password }}
    --set replicaCount={{ rabbitmq_replicas }}
    --set image.repository=rabbitmq
    --set image.tag=3.13-management
    --set persistence.enabled=true
    --set persistence.size={{ rabbitmq_persistence_size }}
    --set persistence.storageClass=gp3
    --set resources.requests.cpu=500m
    --set resources.requests.memory=1Gi
    --set resources.limits.cpu=2000m
    --set resources.limits.memory=2Gi
    --set nodeSelector.workload=storage
    --set clustering.enabled=true
    --set clustering.addressType=hostname
    --set clustering.rebalance=true
    --set metrics.enabled=true
    --set metrics.serviceMonitor.enabled=true
  when: "'rabbitmq' not in rabbitmq_check.stdout"

- name: RabbitMQ StatefulSet 생성 대기 (60초)
  shell: |
    echo "⏳ RabbitMQ StatefulSet 생성 대기..."
    sleep 60
  changed_when: false

- name: RabbitMQ Pod 생성 확인
  shell: |
    for i in {1..30}; do
      POD_COUNT=$(kubectl get pods -n {{ rabbitmq_namespace }} -l app.kubernetes.io/name=rabbitmq --no-headers 2>/dev/null | wc -l)
      if [ "$POD_COUNT" -gt 0 ]; then
        echo "✅ RabbitMQ Pod 생성됨 ($POD_COUNT개)"
        exit 0
      fi
      echo "대기 중... ($i/30)"
      sleep 10
    done
  changed_when: false

- name: RabbitMQ Pod Ready 대기
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=rabbitmq -n {{ rabbitmq_namespace }} --timeout=600s
  ignore_errors: yes
  register: rabbitmq_wait
  
- name: RabbitMQ Pod 문제 확인 및 로그 출력
  when: rabbitmq_wait.rc != 0
  block:
    - name: RabbitMQ Pod 상태 확인
      command: kubectl get pods -n {{ rabbitmq_namespace }} -l app.kubernetes.io/name=rabbitmq
      register: rabbitmq_status
      changed_when: false
    
    - name: RabbitMQ Pod 상태 출력
      debug:
        msg: "{{ rabbitmq_status.stdout_lines }}"
    
    - name: RabbitMQ Pod 이벤트 확인
      shell: |
        POD_NAME=$(kubectl get pods -n {{ rabbitmq_namespace }} -l app.kubernetes.io/name=rabbitmq -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
        if [ -n "$POD_NAME" ]; then
          echo "=== Pod 이벤트 ==="
          kubectl describe pod "$POD_NAME" -n {{ rabbitmq_namespace }} | tail -30
          echo ""
          echo "=== Init Container 로그 ==="
          kubectl logs "$POD_NAME" -n {{ rabbitmq_namespace }} --all-containers=true --tail=50 2>/dev/null || echo "로그 없음"
        fi
      register: rabbitmq_diagnosis
      changed_when: false
      failed_when: false
    
    - name: RabbitMQ 진단 정보 출력
      debug:
        msg: "{{ rabbitmq_diagnosis.stdout_lines }}"
    
    - name: RabbitMQ PVC 상태 확인
      command: kubectl get pvc -n {{ rabbitmq_namespace }}
      register: rabbitmq_pvc
      changed_when: false
      failed_when: false
    
    - name: RabbitMQ PVC 상태 출력
      debug:
        msg: "{{ rabbitmq_pvc.stdout_lines }}"

- name: RabbitMQ Pod 상태 확인
  command: kubectl get pods -n {{ rabbitmq_namespace }}
  register: rabbitmq_pods
  changed_when: false

- name: RabbitMQ Pod 상태 출력
  debug:
    msg: "{{ rabbitmq_pods.stdout_lines }}"

- name: RabbitMQ Cluster 상태 확인
  shell: |
    kubectl exec -n {{ rabbitmq_namespace }} rabbitmq-0 -- rabbitmqctl cluster_status
  register: rabbitmq_cluster
  failed_when: false
  changed_when: false
  when: rabbitmq_wait is succeeded

- name: RabbitMQ 접속 정보
  debug:
    msg:
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "✅ RabbitMQ HA Cluster 설치 완료 (Tier 3: Message Queue)"
      - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      - "역할: Task Queue Middleware"
      - "구성: {{ rabbitmq_replicas }}-node HA Cluster"
      - "Queues: 5개 (q.ai, q.batch, q.api, q.sched, q.dlq)"
      - ""
      - "연결 정보:"
      - "  AMQP: amqp://{{ rabbitmq_username }}:{{ rabbitmq_password }}@rabbitmq.{{ rabbitmq_namespace }}:5672/"
      - "  Management UI: kubectl port-forward -n {{ rabbitmq_namespace }} svc/rabbitmq 15672:15672"
      - "  Username: {{ rabbitmq_username }}"
      - "  Password: {{ rabbitmq_password }}"
      - ""
      - "Storage: {{ rabbitmq_persistence_size }} × {{ rabbitmq_replicas }} nodes"
      - "Node: Storage (workload=storage)"
      - ""
      - "⚠️ RabbitMQ는 메시지 전달만 담당!"
      - "⚠️ Progress Tracking은 Redis (Tier 4) 사용!"

