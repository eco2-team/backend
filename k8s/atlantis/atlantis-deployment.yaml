---
apiVersion: v1
kind: Namespace
metadata:
  name: atlantis
  labels:
    name: atlantis
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis Secrets
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: v1
kind: Secret
metadata:
  name: atlantis-secrets
  namespace: atlantis
type: Opaque
stringData:
  # GitHub Personal Access Token (repo, admin:repo_hook ê¶Œí•œ í•„ìš”)
  github-token: "REPLACE_WITH_YOUR_GITHUB_TOKEN"
  
  # GitHub Webhook Secret (ëœë¤ ë¬¸ìì—´ ìƒì„±: openssl rand -hex 20)
  github-webhook-secret: "REPLACE_WITH_YOUR_WEBHOOK_SECRET"
  
  # AWS Credentials
  aws-access-key-id: "REPLACE_WITH_YOUR_AWS_ACCESS_KEY_ID"
  aws-secret-access-key: "REPLACE_WITH_YOUR_AWS_SECRET_ACCESS_KEY"
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis ConfigMap (í™˜ê²½ ë³€ìˆ˜)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: v1
kind: ConfigMap
metadata:
  name: atlantis-config
  namespace: atlantis
data:
  AWS_REGION: "ap-northeast-2"
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis Repo Config (atlantis.yaml íŒŒì¼)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: v1
kind: ConfigMap
metadata:
  name: atlantis-repo-config
  namespace: atlantis
data:
  atlantis.yaml: |
    version: 3
    automerge: true
    delete_source_branch_on_merge: true
    parallel_plan: true
    parallel_apply: false
    
    projects:
      - name: infrastructure
        dir: terraform
        workspace: production
        terraform_version: v1.5.0
        workflow: infrastructure-workflow
        apply_requirements:
          - approved
          - mergeable
        autoplan:
          enabled: true
          when_modified:
            - "*.tf"
            - "*.tfvars"
            - "terraform.tfvars"
            - "**/*.tf"
        allowed_overrides:
          - apply_requirements
          - workflow
        allow_custom_workflows: true
    
    workflows:
      infrastructure-workflow:
        plan:
          steps:
            - env:
                name: SETUP_ENV
                command: 'echo "Setting up environment..."'
            - init
            - run: terraform validate
            - plan:
                extra_args:
                  - -lock-timeout=5m
                  - -var-file=terraform.tfvars
            - run: |
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âœ… Terraform Plan Complete"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        apply:
          steps:
            - env:
                name: SETUP_ENV
                command: 'echo "Setting up environment..."'
            - init
            - apply:
                extra_args:
                  - -lock-timeout=5m
                  - -var-file=terraform.tfvars
            - run: |
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ“Š Exporting Terraform Outputs (Phase 3)..."
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                
                terraform output -json > /tmp/tf-outputs.json
                terraform output -raw ansible_inventory > /tmp/ansible-inventory.ini
                
                if command -v kubectl &> /dev/null; then
                    kubectl get namespace argocd &>/dev/null || kubectl create namespace argocd
                    
                    kubectl create configmap terraform-outputs \
                      --from-file=tf-outputs.json=/tmp/tf-outputs.json \
                      --from-file=ansible-inventory.ini=/tmp/ansible-inventory.ini \
                      --namespace=argocd \
                      --dry-run=client -o yaml | kubectl apply -f -
                    
                    echo "âœ… Terraform Outputs saved to ConfigMap (namespace: argocd)"
                    kubectl get configmap terraform-outputs -n argocd
                    echo "ğŸ”„ ArgoCD PreSync Hookì´ ì´ ConfigMapì„ ì½ì–´ì„œ Ansibleì„ ì‹¤í–‰í•©ë‹ˆë‹¤"
                else
                    echo "âš ï¸  kubectl not found, skipping ConfigMap creation"
                fi
            - run: |
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ”— Triggering Post-Apply Actions..."
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "Terraform Apply Complete!"
    
    hide_prev_plan_comments: true
    silence_whitelist_errors: false
    silence_vcs_status_no_plans: false
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis StatefulSet (ë°ì´í„° ì˜ì†ì„± í•„ìš”)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: atlantis
  namespace: atlantis
  labels:
    app: atlantis
spec:
  serviceName: atlantis
  replicas: 1  # AtlantisëŠ” ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ ê¶Œì¥ (Lock ê´€ë¦¬)
  
  selector:
    matchLabels:
      app: atlantis
  
  template:
    metadata:
      labels:
        app: atlantis
        tier: infrastructure
        component: gitops
    spec:
      serviceAccountName: atlantis
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Phase 3: Init Container - kubectl ì„¤ì¹˜
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      initContainers:
        - name: install-kubectl
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              # ë””ë ‰í† ë¦¬ ìƒì„±
              mkdir -p /shared/usr/local/bin
              
              # kubectl ë°”ì´ë„ˆë¦¬ ë³µì‚¬
              cp /opt/bitnami/kubectl/bin/kubectl /shared/usr/local/bin/kubectl
              chmod +x /shared/usr/local/bin/kubectl
              
              # ë²„ì „ í™•ì¸
              /shared/usr/local/bin/kubectl version --client
              
              echo "âœ… kubectl installed to /shared/usr/local/bin/kubectl"
          volumeMounts:
            - name: kubectl
              mountPath: /shared
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # SecurityContext (PersistentVolume ê¶Œí•œ ë¬¸ì œ í•´ê²°)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsGroup: 1000
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # 14-Node ì•„í‚¤í…ì²˜: Monitoring ë…¸ë“œì— ë°°í¬ (ì •í™•í•œ ë…¸ë“œ ì§€ì •)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                - k8s-monitoring
      
      tolerations:
        - key: node-role.kubernetes.io/infrastructure
          operator: Equal
          value: "true"
          effect: NoSchedule
      
      containers:
        - name: atlantis
          image: ghcr.io/runatlantis/atlantis:v0.27.0
          
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # Atlantis ì‹¤í–‰ ì¸ì
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # commandëŠ” ì œê±° (ì´ë¯¸ì§€ì˜ ê¸°ë³¸ ENTRYPOINT ì‚¬ìš©)
          # /usr/local/binì´ kubectl ë³¼ë¥¨ìœ¼ë¡œ ë§ˆìš´íŠ¸ë˜ì–´ atlantis ì‹¤í–‰ íŒŒì¼ì´ ê°€ë ¤ì§
          # ë”°ë¼ì„œ ì´ë¯¸ì§€ì˜ ê¸°ë³¸ ENTRYPOINTë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
          args:
            - server
            - --atlantis-url=https://atlantis.growbin.app  # ì™¸ë¶€ ì ‘ì† URL (HTTPS)
            - --repo-allowlist=github.com/SeSACTHON/*        # í—ˆìš©í•  Repository
            - --gh-user=SeSACTHON                             # GitHub Organization
            - --hide-prev-plan-comments                       # ì´ì „ Plan ì½”ë©˜íŠ¸ ìˆ¨ê¹€
            - --port=4141                                     # í¬íŠ¸ ëª…ì‹œì  ì„¤ì • (ê¶Œí•œ ë¬¸ì œ í•´ê²°)
          
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # í™˜ê²½ ë³€ìˆ˜
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          env:
            # GitHub Token
            - name: ATLANTIS_GH_TOKEN
              valueFrom:
                secretKeyRef:
                  name: atlantis-secrets
                  key: github-token
            
            # GitHub Webhook Secret
            - name: ATLANTIS_GH_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  name: atlantis-secrets
                  key: github-webhook-secret
            
            # AWS Credentials
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: atlantis-secrets
                  key: aws-access-key-id
            
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: atlantis-secrets
                  key: aws-secret-access-key
            
            - name: AWS_REGION
              valueFrom:
                configMapKeyRef:
                  name: atlantis-config
                  key: AWS_REGION
            
            # Atlantis ì„¤ì •
            - name: ATLANTIS_DATA_DIR
              value: /atlantis-data
            
            # Phase 3: PATHì— kubectl ê²½ë¡œ ì¶”ê°€ (/shared/binì— kubectlì´ ìˆìŒ)
            - name: PATH
              value: "/usr/local/bin:/usr/local/sbin:/shared/bin:/usr/sbin:/usr/bin:/sbin:/bin"
            
            # Atlantis ì„¤ì • íŒŒì¼ ê²½ë¡œ (ConfigMapì—ì„œ ë§ˆìš´íŠ¸)
            - name: ATLANTIS_REPO_CONFIG
              value: /etc/atlantis/atlantis.yaml
          
          
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # í¬íŠ¸
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ports:
            - name: http
              containerPort: 4141
              protocol: TCP
          
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # Health Check
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          livenessProbe:
            httpGet:
              path: /healthz
              port: 4141
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          
          readinessProbe:
            httpGet:
              path: /healthz
              port: 4141
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
          
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # ë¦¬ì†ŒìŠ¤
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          # ë³¼ë¥¨ ë§ˆìš´íŠ¸
          # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          volumeMounts:
            - name: atlantis-data
              mountPath: /atlantis-data
            # Phase 3: kubectl ë°”ì´ë„ˆë¦¬ (Init Containerì—ì„œ ì„¤ì¹˜)
            # /shared/usr/local/binì„ /shared/binì— ë§ˆìš´íŠ¸í•˜ì—¬ PATHì— í¬í•¨
            # /usr/local/binì„ ë§ˆìš´íŠ¸í•˜ë©´ atlantis ì‹¤í–‰ íŒŒì¼ì´ ê°€ë ¤ì§€ë¯€ë¡œ ë‹¤ë¥¸ ê²½ë¡œ ì‚¬ìš©
            - name: kubectl
              mountPath: /shared/bin
              subPath: usr/local/bin
              readOnly: true
            # Atlantis ì„¤ì • íŒŒì¼ (ConfigMap)
            - name: atlantis-config-file
              mountPath: /etc/atlantis
              readOnly: true
      
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Phase 3: Volumes
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      volumes:
        # kubectl ë°”ì´ë„ˆë¦¬ (Init Containerì—ì„œ ì„¤ì¹˜)
        - name: kubectl
          emptyDir: {}
        # Atlantis ì„¤ì • íŒŒì¼ (atlantis.yaml)
        - name: atlantis-config-file
          configMap:
            name: atlantis-repo-config
  
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # PersistentVolumeClaim
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  volumeClaimTemplates:
    - metadata:
        name: atlantis-data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: gp3  # AWS EBS gp3 (ë˜ëŠ” í´ëŸ¬ìŠ¤í„° ê¸°ë³¸ê°’)
        resources:
          requests:
            storage: 20Gi
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis Service
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: v1
kind: Service
metadata:
  name: atlantis
  namespace: atlantis
  labels:
    app: atlantis
spec:
  type: NodePort  # ALB Ingress ì‚¬ìš© ì‹œ NodePort í•„ìš” (target-type: instance)
  selector:
    app: atlantis
  ports:
    - name: http
      port: 80
      targetPort: 4141
      protocol: TCP
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis ServiceAccount (Terraform State ì ‘ê·¼ ê¶Œí•œ)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: v1
kind: ServiceAccount
metadata:
  name: atlantis
  namespace: atlantis
  labels:
    app: atlantis
  annotations:
    # IRSA (IAM Role for Service Account) - ì„ íƒì‚¬í•­
    # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/atlantis-role
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Phase 3: RBAC - ConfigMap ìƒì„± ê¶Œí•œ (ArgoCD ì—°ê³„)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: atlantis-configmap-creator
  labels:
    app: atlantis
rules:
  # ConfigMap ìƒì„±/ì—…ë°ì´íŠ¸ ê¶Œí•œ (argocd namespace)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["create", "update", "patch", "get", "list"]
  # Namespace í™•ì¸ ê¶Œí•œ
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: atlantis-configmap-creator
  labels:
    app: atlantis
subjects:
  - kind: ServiceAccount
    name: atlantis
    namespace: atlantis
roleRef:
  kind: ClusterRole
  name: atlantis-configmap-creator
  apiGroup: rbac.authorization.k8s.io
---
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis Ingress (ì„ íƒì‚¬í•­ - ALB Controller ì‚¬ìš© ì‹œ)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis IngressëŠ” k8s/ingress/14-nodes-ingress.yamlì— í†µí•©ë¨
# ì´ íŒŒì¼ì€ ì°¸ê³ ìš©ìœ¼ë¡œ ë‚¨ê²¨ë‘  (ì‹¤ì œë¡œëŠ” 14-nodes-ingress.yaml ì‚¬ìš©)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: atlantis
#   namespace: atlantis
#   annotations:
#     alb.ingress.kubernetes.io/scheme: internet-facing
#     alb.ingress.kubernetes.io/target-type: instance  # Calico CNI ì‚¬ìš© ì‹œ instance í•„ìˆ˜
#     alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
#     alb.ingress.kubernetes.io/ssl-redirect: '443'
#     alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:ACCOUNT_ID:certificate/CERT_ID
#     alb.ingress.kubernetes.io/group.name: ecoeco-main
#     alb.ingress.kubernetes.io/group.order: '20'
#     alb.ingress.kubernetes.io/backend-protocol: HTTP
#     alb.ingress.kubernetes.io/healthcheck-path: /healthz
#     alb.ingress.kubernetes.io/backend-protocol-timeout: '300'  # 5ë¶„ (GitHub Webhook)
# spec:
#   ingressClassName: alb
#   rules:
#     - host: atlantis.growbin.app
#       http:
#         paths:
#           - path: /
#             pathType: Prefix
#             backend:
#               service:
#                 name: atlantis
#                 port:
#                   number: 80

