# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ServiceMonitor for 14-Node Architecture
# Prometheus 자동 발견 설정 (7 APIs + 2 Workers + 4 Infrastructure)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 전체 API 서비스 자동 발견 (Label Selector)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: api-services-all
  namespace: monitoring
  labels:
    app: ecoeco
    component: api
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      tier: api  # 모든 API 서비스 자동 발견
  endpoints:
    - port: http
      interval: 30s
      path: /metrics
      scheme: http
      relabelings:
        # domain label 추가
        - sourceLabels: [__meta_kubernetes_pod_label_domain]
          targetLabel: domain
        # phase label 추가
        - sourceLabels: [__meta_kubernetes_pod_label_phase]
          targetLabel: phase
        # node label 추가
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
  namespaceSelector:
    matchNames:
      - api

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Phase 1: Core APIs (auth, my, scan)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# API-1: Auth (JWT Blacklist)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: auth-api-monitor
  namespace: monitoring
  labels:
    app: auth-api
    domain: auth
    phase: "1"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: auth-api
      domain: auth
  endpoints:
    - port: http
      interval: 15s  # 인증은 더 자주 체크
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - api

---
# API-2: My
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: my-api-monitor
  namespace: monitoring
  labels:
    app: my-api
    domain: my
    phase: "1"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: my-api
      domain: my
  endpoints:
    - port: http
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - api

---
# API-3: Scan (고트래픽)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: scan-api-monitor
  namespace: monitoring
  labels:
    app: scan-api
    domain: scan
    phase: "1"
    high-traffic: "true"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: scan-api
      domain: scan
  endpoints:
    - port: http
      interval: 15s  # 고트래픽이므로 자주 체크
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - api

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Phase 2: Extended APIs (character, location)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# API-4: Character
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: character-api-monitor
  namespace: monitoring
  labels:
    app: character-api
    domain: character
    phase: "2"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: character-api
      domain: character
  endpoints:
    - port: http
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - api

---
# API-5: Location
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: location-api-monitor
  namespace: monitoring
  labels:
    app: location-api
    domain: location
    phase: "2"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: location-api
      domain: location
  endpoints:
    - port: http
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - api

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Phase 3: Advanced APIs (info, chat)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# API-6: Info
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: info-api-monitor
  namespace: monitoring
  labels:
    app: info-api
    domain: info
    phase: "3"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: info-api
      domain: info
  endpoints:
    - port: http
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - api

---
# API-7: Chat (WebSocket Streaming)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: chat-api-monitor
  namespace: monitoring
  labels:
    app: chat-api
    domain: chat
    phase: "3"
    streaming: "true"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: chat-api
      domain: chat
  endpoints:
    - port: http
      interval: 20s  # WebSocket 연결 모니터링
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - api

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Phase 4: Worker Services (storage, ai)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 전체 Worker 자동 발견
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: worker-services-all
  namespace: monitoring
  labels:
    app: ecoeco
    component: worker
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      tier: worker  # 모든 Worker 서비스 자동 발견
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      relabelings:
        # worker-type label 추가
        - sourceLabels: [__meta_kubernetes_pod_label_worker_type]
          targetLabel: worker_type
        # pool-type label 추가
        - sourceLabels: [__meta_kubernetes_pod_label_pool_type]
          targetLabel: pool_type
        # domain label 추가
        - sourceLabels: [__meta_kubernetes_pod_label_domain]
          targetLabel: domain
        # node label 추가
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
  namespaceSelector:
    matchNames:
      - workers

---
# Worker-1: Storage (I/O Bound - Eventlet)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: storage-worker-monitor
  namespace: monitoring
  labels:
    app: storage-worker
    worker-type: io-bound
    phase: "4"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: storage-worker
      worker-type: io-bound
  endpoints:
    - port: metrics
      interval: 20s  # I/O 작업 자주 체크
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - workers

---
# Worker-2: AI (Network Bound - Prefork)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: ai-worker-monitor
  namespace: monitoring
  labels:
    app: ai-worker
    worker-type: network-bound
    phase: "4"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: ai-worker
      worker-type: network-bound
  endpoints:
    - port: metrics
      interval: 20s  # AI 작업 자주 체크
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - workers

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Infrastructure Services (postgresql, redis, rabbitmq)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# PostgreSQL Exporter
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgresql-monitor
  namespace: monitoring
  labels:
    app: postgresql
    tier: infrastructure
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app: postgresql-exporter
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - data

---
# Redis Exporter
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: redis-monitor
  namespace: monitoring
  labels:
    app: redis
    tier: infrastructure
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app: redis-exporter
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - data

---
# RabbitMQ Exporter
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rabbitmq-monitor
  namespace: monitoring
  labels:
    app: rabbitmq
    tier: infrastructure
    phase: "4"
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app: rabbitmq-exporter
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - messaging

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Node Exporter (전체 노드 모니터링)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: node-exporter-monitor
  namespace: monitoring
  labels:
    app: node-exporter
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app: node-exporter
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      relabelings:
        # 노드 정보 추가
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
        - sourceLabels: [__meta_kubernetes_node_label_workload]
          targetLabel: workload
        - sourceLabels: [__meta_kubernetes_node_label_domain]
          targetLabel: domain
        - sourceLabels: [__meta_kubernetes_node_label_phase]
          targetLabel: phase
  namespaceSelector:
    matchNames:
      - monitoring

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Prometheus 자체 모니터링
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: prometheus-self-monitor
  namespace: monitoring
  labels:
    app: prometheus
    monitoring: prometheus
spec:
  selector:
    matchLabels:
      app: prometheus
  endpoints:
    - port: web
      interval: 30s
      path: /metrics
      scheme: http
  namespaceSelector:
    matchNames:
      - monitoring

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ServiceMonitor Summary (14-Node Architecture)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# 총 18개 ServiceMonitor:
#   1. API Services (자동 발견): tier=api
#   2-8. Individual APIs: auth, my, scan, character, location, info, chat
#   9. Worker Services (자동 발견): tier=worker
#   10-11. Individual Workers: storage, ai
#   12-14. Infrastructure: postgresql, redis, rabbitmq
#   15. Node Exporter: 전체 노드
#   16. Prometheus: 자체 모니터링
#
# Label 기반 자동 발견:
#   - tier: api | worker | infrastructure
#   - domain: auth | my | scan | character | location | info | chat
#   - phase: 1 | 2 | 3 | 4
#   - workload: api | worker-storage | worker-ai | postgresql | redis | rabbitmq | monitoring
#
# Relabeling:
#   - 자동으로 domain, phase, node, workload label 추가
#   - Grafana에서 필터링 가능

