# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Prometheus Alert Rules for 14-Node Architecture
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules-14nodes
  namespace: monitoring
  labels:
    app: prometheus
    component: rules
data:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 1. Node Health Rules
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  node-health.rules: |
    groups:
      - name: node_health
        interval: 30s
        rules:
          # 노드 다운
          - alert: NodeDown
            expr: up{job="node-exporter"} == 0
            for: 2m
            labels:
              severity: critical
              component: infrastructure
            annotations:
              summary: "Node {{ $labels.node }} is down"
              description: "Node {{ $labels.node }} (workload: {{ $labels.workload }}) has been down for more than 2 minutes"
          
          # CPU 사용률 높음
          - alert: NodeHighCPU
            expr: |
              (100 - (avg by (node) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)) > 80
            for: 5m
            labels:
              severity: warning
              component: infrastructure
            annotations:
              summary: "High CPU usage on {{ $labels.node }}"
              description: "CPU usage is {{ $value }}% on {{ $labels.node }}"
          
          # 메모리 사용률 높음
          - alert: NodeHighMemory
            expr: |
              (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 < 20
            for: 5m
            labels:
              severity: warning
              component: infrastructure
            annotations:
              summary: "Low memory on {{ $labels.node }}"
              description: "Available memory is {{ $value }}% on {{ $labels.node }}"
          
          # 디스크 사용률 높음
          - alert: NodeHighDisk
            expr: |
              (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
            for: 10m
            labels:
              severity: warning
              component: infrastructure
            annotations:
              summary: "Low disk space on {{ $labels.node }}"
              description: "Available disk is {{ $value }}% on {{ $labels.node }}"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 2. API Services Rules
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  api-services.rules: |
    groups:
      - name: api_services
        interval: 15s
        rules:
          # API 서비스 다운
          - alert: APIServiceDown
            expr: up{tier="api"} == 0
            for: 1m
            labels:
              severity: critical
              component: api
            annotations:
              summary: "API service {{ $labels.domain }} is down"
              description: "API {{ $labels.domain }} (phase {{ $labels.phase }}) has been down for 1 minute"
          
          # High Latency (P95 > 1초)
          - alert: APIHighLatency
            expr: |
              histogram_quantile(0.95, 
                rate(http_request_duration_seconds_bucket{tier="api"}[5m])
              ) > 1
            for: 5m
            labels:
              severity: warning
              component: api
            annotations:
              summary: "High latency on {{ $labels.domain }} API"
              description: "P95 latency is {{ $value }}s on {{ $labels.domain }} (threshold: 1s)"
          
          # High Error Rate (5xx > 5%)
          - alert: APIHighErrorRate
            expr: |
              (sum by (domain) (rate(http_requests_total{tier="api",status=~"5.."}[5m])) 
              / 
              sum by (domain) (rate(http_requests_total{tier="api"}[5m]))) * 100 > 5
            for: 5m
            labels:
              severity: warning
              component: api
            annotations:
              summary: "High error rate on {{ $labels.domain }} API"
              description: "Error rate is {{ $value }}% on {{ $labels.domain }} (threshold: 5%)"
          
          # Auth API - High Request Rate (로그인 폭주)
          - alert: AuthAPIHighRequestRate
            expr: |
              rate(http_requests_total{domain="auth"}[1m]) > 100
            for: 2m
            labels:
              severity: info
              component: api
              domain: auth
            annotations:
              summary: "High request rate on Auth API"
              description: "Auth API is receiving {{ $value }} req/s (threshold: 100)"
          
          # Scan API - High Request Rate (이미지 분류 폭주)
          - alert: ScanAPIHighRequestRate
            expr: |
              rate(http_requests_total{domain="scan"}[1m]) > 50
            for: 2m
            labels:
              severity: info
              component: api
              domain: scan
            annotations:
              summary: "High request rate on Scan API"
              description: "Scan API is receiving {{ $value }} req/s (threshold: 50)"
          
          # Chat API - WebSocket Connection Spike
          - alert: ChatAPIHighConnections
            expr: |
              websocket_connections_active{domain="chat"} > 100
            for: 5m
            labels:
              severity: info
              component: api
              domain: chat
            annotations:
              summary: "High WebSocket connections on Chat API"
              description: "Chat API has {{ $value }} active WebSocket connections"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 3. Worker Services Rules
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  worker-services.rules: |
    groups:
      - name: worker_services
        interval: 30s
        rules:
          # Worker 서비스 다운
          - alert: WorkerServiceDown
            expr: up{tier="worker"} == 0
            for: 2m
            labels:
              severity: critical
              component: worker
            annotations:
              summary: "Worker {{ $labels.worker_type }} is down"
              description: "Worker {{ $labels.worker_type }} (pool: {{ $labels.pool_type }}) has been down for 2 minutes"
          
          # Queue Backlog (큐 적체)
          - alert: WorkerQueueBacklog
            expr: |
              rabbitmq_queue_messages_ready > 1000
            for: 10m
            labels:
              severity: warning
              component: worker
            annotations:
              summary: "High queue backlog for {{ $labels.queue }}"
              description: "Queue {{ $labels.queue }} has {{ $value }} pending messages (threshold: 1000)"
          
          # Storage Worker - High I/O Wait
          - alert: StorageWorkerHighIOWait
            expr: |
              rate(celery_task_duration_seconds_sum{worker_type="io-bound"}[5m]) 
              / 
              rate(celery_task_duration_seconds_count{worker_type="io-bound"}[5m]) > 5
            for: 5m
            labels:
              severity: warning
              component: worker
              worker_type: storage
            annotations:
              summary: "High I/O wait on Storage Worker"
              description: "Average task duration is {{ $value }}s on Storage Worker"
          
          # AI Worker - High Task Failure Rate
          - alert: AIWorkerHighFailureRate
            expr: |
              (rate(celery_task_failed_total{worker_type="network-bound"}[5m]) 
              / 
              rate(celery_task_total{worker_type="network-bound"}[5m])) * 100 > 10
            for: 5m
            labels:
              severity: warning
              component: worker
              worker_type: ai
            annotations:
              summary: "High task failure rate on AI Worker"
              description: "Task failure rate is {{ $value }}% on AI Worker (threshold: 10%)"
          
          # SQLite WAL 동기화 지연
          - alert: WALSyncDelayed
            expr: |
              time() - wal_last_sync_timestamp_seconds{worker_type="io-bound"} > 60
            for: 5m
            labels:
              severity: warning
              component: worker
              feature: wal
            annotations:
              summary: "WAL sync delayed on Storage Worker"
              description: "WAL has not been synced for {{ $value }} seconds (threshold: 60s)"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 4. Infrastructure Rules (PostgreSQL, Redis, RabbitMQ)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  infrastructure.rules: |
    groups:
      - name: infrastructure
        interval: 30s
        rules:
          # PostgreSQL 다운
          - alert: PostgreSQLDown
            expr: up{app="postgresql-exporter"} == 0
            for: 1m
            labels:
              severity: critical
              component: database
            annotations:
              summary: "PostgreSQL is down"
              description: "PostgreSQL has been down for 1 minute"
          
          # PostgreSQL Connection Pool 고갈
          - alert: PostgreSQLHighConnections
            expr: |
              (pg_stat_activity_count / pg_settings_max_connections) * 100 > 80
            for: 5m
            labels:
              severity: warning
              component: database
            annotations:
              summary: "PostgreSQL connection pool nearly exhausted"
              description: "Connection usage is {{ $value }}% (threshold: 80%)"
          
          # Redis 다운
          - alert: RedisDown
            expr: up{app="redis-exporter"} == 0
            for: 1m
            labels:
              severity: critical
              component: cache
            annotations:
              summary: "Redis is down"
              description: "Redis has been down for 1 minute"
          
          # Redis 메모리 사용률 높음
          - alert: RedisHighMemory
            expr: |
              (redis_memory_used_bytes / redis_memory_max_bytes) * 100 > 80
            for: 5m
            labels:
              severity: warning
              component: cache
            annotations:
              summary: "Redis memory usage high"
              description: "Redis memory usage is {{ $value }}% (threshold: 80%)"
          
          # Redis - JWT Blacklist DB 크기 증가
          - alert: RedisJWTBlacklistGrowing
            expr: |
              redis_db_keys{db="0"} > 10000
            for: 10m
            labels:
              severity: info
              component: cache
              feature: jwt-blacklist
            annotations:
              summary: "JWT Blacklist growing"
              description: "JWT Blacklist has {{ $value }} keys in Redis DB 0"
          
          # RabbitMQ 다운
          - alert: RabbitMQDown
            expr: up{app="rabbitmq-exporter"} == 0
            for: 1m
            labels:
              severity: critical
              component: messaging
            annotations:
              summary: "RabbitMQ is down"
              description: "RabbitMQ has been down for 1 minute"
          
          # RabbitMQ Connection 급증
          - alert: RabbitMQHighConnections
            expr: |
              rabbitmq_connections > 100
            for: 5m
            labels:
              severity: warning
              component: messaging
            annotations:
              summary: "High number of RabbitMQ connections"
              description: "RabbitMQ has {{ $value }} connections (threshold: 100)"
          
          # RabbitMQ Disk Space 부족
          - alert: RabbitMQLowDiskSpace
            expr: |
              rabbitmq_node_disk_free_bytes < 1073741824  # 1GB
            for: 5m
            labels:
              severity: warning
              component: messaging
            annotations:
              summary: "RabbitMQ low disk space"
              description: "RabbitMQ has {{ $value | humanize }}B free disk space"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 5. HPA (Horizontal Pod Autoscaler) Rules
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  hpa.rules: |
    groups:
      - name: hpa
        interval: 30s
        rules:
          # HPA Max Replicas 도달
          - alert: HPAMaxReplicasReached
            expr: |
              kube_horizontalpodautoscaler_status_current_replicas 
              >= 
              kube_horizontalpodautoscaler_spec_max_replicas
            for: 10m
            labels:
              severity: warning
              component: hpa
            annotations:
              summary: "HPA {{ $labels.horizontalpodautoscaler }} at max replicas"
              description: "HPA {{ $labels.horizontalpodautoscaler }} has reached max replicas ({{ $value }})"
          
          # API HPA - Scan (고트래픽)
          - alert: ScanAPIScalingFrequently
            expr: |
              changes(kube_horizontalpodautoscaler_status_current_replicas{horizontalpodautoscaler="scan-api-hpa"}[30m]) > 5
            for: 5m
            labels:
              severity: info
              component: hpa
              domain: scan
            annotations:
              summary: "Scan API HPA scaling frequently"
              description: "Scan API HPA scaled {{ $value }} times in 30 minutes"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 6. Recording Rules (성능 최적화를 위한 사전 계산)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  recording.rules: |
    groups:
      - name: recording_rules
        interval: 30s
        rules:
          # API Request Rate (per domain)
          - record: api:http_requests_per_second:rate5m
            expr: |
              sum by (domain, phase) (rate(http_requests_total{tier="api"}[5m]))
          
          # API Error Rate (per domain)
          - record: api:http_errors_per_second:rate5m
            expr: |
              sum by (domain, phase) (rate(http_requests_total{tier="api",status=~"5.."}[5m]))
          
          # API P95 Latency (per domain)
          - record: api:http_request_duration_seconds:p95
            expr: |
              histogram_quantile(0.95, 
                sum by (domain, phase, le) (rate(http_request_duration_seconds_bucket{tier="api"}[5m]))
              )
          
          # Worker Task Rate (per worker type)
          - record: worker:celery_tasks_per_second:rate5m
            expr: |
              sum by (worker_type, pool_type) (rate(celery_task_total{tier="worker"}[5m]))
          
          # Worker Task Failure Rate (per worker type)
          - record: worker:celery_task_failure_rate:rate5m
            expr: |
              sum by (worker_type) (rate(celery_task_failed_total{tier="worker"}[5m])) 
              / 
              sum by (worker_type) (rate(celery_task_total{tier="worker"}[5m]))
          
          # Queue Length (per queue)
          - record: queue:rabbitmq_messages_ready:total
            expr: |
              sum by (queue) (rabbitmq_queue_messages_ready)
          
          # Node CPU Usage (per node)
          - record: node:cpu_usage:percent
            expr: |
              100 - (avg by (node, workload, phase) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          
          # Node Memory Usage (per node)
          - record: node:memory_usage:percent
            expr: |
              (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Prometheus Rules Summary (14-Node Architecture)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# 총 6개 Rule Groups:
#   1. node_health: 노드 헬스 체크 (4 alerts)
#   2. api_services: API 서비스 모니터링 (6 alerts)
#   3. worker_services: Worker 모니터링 (5 alerts)
#   4. infrastructure: 인프라 모니터링 (9 alerts)
#   5. hpa: HPA 모니터링 (2 alerts)
#   6. recording_rules: 성능 최적화 (8 rules)
#
# Alert Severity:
#   - critical: 서비스 다운 (즉시 대응 필요)
#   - warning: 임계치 초과 (주의 필요)
#   - info: 정보성 알림
#
# 14-Node 특화 Alert:
#   - Phase별 API 모니터링 (phase: 1|2|3)
#   - Worker Type별 모니터링 (io-bound, network-bound)
#   - JWT Blacklist 크기 모니터링
#   - WAL 동기화 지연 감지
#   - WebSocket 연결 수 모니터링

