# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 도메인별 Ingress 리소스 (Domain-based Namespace Strategy)
# ALB Group을 통한 단일 ALB 공유
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 1. Auth API Ingress (Phase 1)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: auth-ingress
  namespace: auth
  labels:
    app: ecoeco-api
    domain: auth
    component: ingress
    tier: business-logic
    layer: "2"
  annotations:
    # ALB 기본 설정
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    
    # Health Check
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    
    # SSL Certificate (ACM)
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:721622471953:certificate/f8d33998-1a75-4c7d-92e1-6cd48b90f8a7
    
    # ALB Group (단일 ALB로 통합)
    alb.ingress.kubernetes.io/group.name: ecoeco-main
    alb.ingress.kubernetes.io/group.order: '10'
    
    # Tags
    alb.ingress.kubernetes.io/tags: Environment=production,Service=platform,Architecture=14-nodes
spec:
  ingressClassName: alb
  rules:
    - host: api.growbin.app
      http:
        paths:
          - path: /api/v1/auth
            pathType: Prefix
            backend:
              service:
                name: auth-api
                port:
                  number: 8000

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 2. My API Ingress (Phase 1)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  namespace: my
  labels:
    app: ecoeco-api
    domain: my
    component: ingress
    tier: business-logic
    layer: "2"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:721622471953:certificate/f8d33998-1a75-4c7d-92e1-6cd48b90f8a7
    alb.ingress.kubernetes.io/group.name: ecoeco-main
    alb.ingress.kubernetes.io/group.order: '11'
    alb.ingress.kubernetes.io/tags: Environment=production,Service=platform,Architecture=14-nodes
spec:
  ingressClassName: alb
  rules:
    - host: api.growbin.app
      http:
        paths:
          - path: /api/v1/my
            pathType: Prefix
            backend:
              service:
                name: my-api
                port:
                  number: 8000

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 3. Scan API Ingress (Phase 1)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: scan-ingress
  namespace: scan
  labels:
    app: ecoeco-api
    domain: scan
    component: ingress
    tier: business-logic
    layer: "2"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:721622471953:certificate/f8d33998-1a75-4c7d-92e1-6cd48b90f8a7
    alb.ingress.kubernetes.io/group.name: ecoeco-main
    alb.ingress.kubernetes.io/group.order: '12'
    alb.ingress.kubernetes.io/tags: Environment=production,Service=platform,Architecture=14-nodes
spec:
  ingressClassName: alb
  rules:
    - host: api.growbin.app
      http:
        paths:
          - path: /api/v1/scan
            pathType: Prefix
            backend:
              service:
                name: scan-api
                port:
                  number: 8000

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 4. Character API Ingress (Phase 2)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: character-ingress
  namespace: character
  labels:
    app: ecoeco-api
    domain: character
    component: ingress
    tier: business-logic
    layer: "2"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:721622471953:certificate/f8d33998-1a75-4c7d-92e1-6cd48b90f8a7
    alb.ingress.kubernetes.io/group.name: ecoeco-main
    alb.ingress.kubernetes.io/group.order: '13'
    alb.ingress.kubernetes.io/tags: Environment=production,Service=platform,Architecture=14-nodes
spec:
  ingressClassName: alb
  rules:
    - host: api.growbin.app
      http:
        paths:
          - path: /api/v1/character
            pathType: Prefix
            backend:
              service:
                name: character-api
                port:
                  number: 8000

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 5. Location API Ingress (Phase 2)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: location-ingress
  namespace: location
  labels:
    app: ecoeco-api
    domain: location
    component: ingress
    tier: business-logic
    layer: "2"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:721622471953:certificate/f8d33998-1a75-4c7d-92e1-6cd48b90f8a7
    alb.ingress.kubernetes.io/group.name: ecoeco-main
    alb.ingress.kubernetes.io/group.order: '14'
    alb.ingress.kubernetes.io/tags: Environment=production,Service=platform,Architecture=14-nodes
spec:
  ingressClassName: alb
  rules:
    - host: api.growbin.app
      http:
        paths:
          - path: /api/v1/location
            pathType: Prefix
            backend:
              service:
                name: location-api
                port:
                  number: 8000

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 6. Info API Ingress (Phase 3)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: info-ingress
  namespace: info
  labels:
    app: ecoeco-api
    domain: info
    component: ingress
    tier: business-logic
    layer: "2"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:721622471953:certificate/f8d33998-1a75-4c7d-92e1-6cd48b90f8a7
    alb.ingress.kubernetes.io/group.name: ecoeco-main
    alb.ingress.kubernetes.io/group.order: '15'
    alb.ingress.kubernetes.io/tags: Environment=production,Service=platform,Architecture=14-nodes
spec:
  ingressClassName: alb
  rules:
    - host: api.growbin.app
      http:
        paths:
          - path: /api/v1/info
            pathType: Prefix
            backend:
              service:
                name: info-api
                port:
                  number: 8000

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 7. Chat API Ingress (Phase 3)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: chat-ingress
  namespace: chat
  labels:
    app: ecoeco-api
    domain: chat
    component: ingress
    tier: business-logic
    layer: "2"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '3'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:721622471953:certificate/f8d33998-1a75-4c7d-92e1-6cd48b90f8a7
    alb.ingress.kubernetes.io/group.name: ecoeco-main
    alb.ingress.kubernetes.io/group.order: '16'
    alb.ingress.kubernetes.io/tags: Environment=production,Service=platform,Architecture=14-nodes
spec:
  ingressClassName: alb
  rules:
    - host: api.growbin.app
      http:
        paths:
          - path: /api/v1/chat
            pathType: Prefix
            backend:
              service:
                name: chat-api
                port:
                  number: 8000

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# Health Check Ingress (공통)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: health-ingress
  namespace: auth  # 아무 네임스페이스나 사용 (auth 선택)
  labels:
    app: ecoeco-api
    component: health-check
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: instance
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: '443'
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-northeast-2:721622471953:certificate/f8d33998-1a75-4c7d-92e1-6cd48b90f8a7
    alb.ingress.kubernetes.io/group.name: ecoeco-main
    alb.ingress.kubernetes.io/group.order: '9'  # 가장 낮은 우선순위
    alb.ingress.kubernetes.io/tags: Environment=production,Service=platform,Architecture=14-nodes
spec:
  ingressClassName: alb
  rules:
    - host: api.growbin.app
      http:
        paths:
          - path: /health
            pathType: Exact
            backend:
              service:
                name: auth-api
                port:
                  number: 8000

---
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 설명
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# 도메인별 Ingress 분리 전략:
#   - 각 API 서비스가 자신의 네임스페이스에 Ingress 보유
#   - Ingress와 Service가 동일 네임스페이스 (Kubernetes 권장)
#   - ALB Group (ecoeco-main)으로 단일 ALB 공유
#   - group.order로 라우팅 우선순위 제어
#
# ALB 통합 방식:
#   - alb.ingress.kubernetes.io/group.name: ecoeco-main
#   - 모든 Ingress가 동일한 Group Name 사용
#   - AWS Load Balancer Controller가 자동으로 단일 ALB 생성
#   - 7개 Ingress → 1개 ALB (비용 절감)
#
# 라우팅 우선순위:
#   - group.order: 9 (health-check)
#   - group.order: 10-16 (auth, my, scan, character, location, info, chat)
#   - group.order: 20+ (atlantis, argocd, grafana, prometheus)
#
# 배포 방법:
#   kubectl apply -f k8s/ingress/domain-based-api-ingress.yaml
#
# 검증 방법:
#   kubectl get ingress -A
#   kubectl describe ingress auth-ingress -n auth
#   kubectl get ingress -A -o jsonpath='{range .items[*]}{.metadata.namespace}{"\t"}{.metadata.name}{"\t"}{.metadata.annotations.alb\.ingress\.kubernetes\.io/group\.name}{"\n"}{end}'
#
# ALB 확인:
#   aws elbv2 describe-load-balancers --region ap-northeast-2 --query 'LoadBalancers[?contains(LoadBalancerName, `ecoeco-main`)]'
#

