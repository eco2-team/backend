apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmq-cluster
  namespace: rabbitmq
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/part-of: ecoeco-backend
    tier: integration
    role: messaging
spec:
  secretBackend:
    externalSecret:
      name: rabbitmq-default-user
  rabbitmq:
    additionalPlugins:
      - rabbitmq_prometheus
    additionalConfig: |
      cluster_partition_handling = pause_minority
      disk_free_limit.relative = 1.0
      vm_memory_high_watermark.relative = 0.6
  service:
    type: ClusterIP
  override:
    statefulSet:
      spec:
        template:
          metadata:
            labels:
              workload: message-queue
              tier: integration
          spec:
            containers:
              - name: rabbitmq # Required by CRD to modify pod spec fields
            nodeSelector:
              infra-type: rabbitmq
            tolerations:
              - key: domain
                operator: Equal
                value: integration
                effect: NoSchedule
            affinity:
              podAntiAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 100
                    podAffinityTerm:
                      labelSelector:
                        matchLabels:
                          app.kubernetes.io/name: rabbitmq-main
                      topologyKey: kubernetes.io/hostname
            topologySpreadConstraints:
              - maxSkew: 1
                topologyKey: topology.kubernetes.io/zone
                whenUnsatisfiable: DoNotSchedule
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: rabbitmq-main


