# ============================================================================
# Spotahome Redis Operator (Production)
# ============================================================================
# GitHub: https://github.com/spotahome/redis-operator
# Helm Repo: https://spotahome.github.io/redis-operator
# CRD: RedisFailover (databases.spotahome.com/v1)
# Sync Wave 27: PostgreSQL(24) 이후, Redis Cluster CR(28) 이전
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: prod-redis-operator
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: '27'
  labels:
    env: prod
    tier: platform
    component: redis-operator
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: prod
  source:
    repoURL: https://spotahome.github.io/redis-operator
    chart: redis-operator
    targetRevision: 3.3.0
    helm:
      values: |
        # Operator 설정
        replicaCount: 1

        image:
          repository: quay.io/spotahome/redis-operator
          tag: v1.3.0
          pullPolicy: IfNotPresent

        # 리소스 제한 (Prod는 더 여유있게)
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 300m
            memory: 512Mi

        # Control Plane 노드에 배치
        nodeSelector:
          role: control-plane

        tolerations:
          - key: role
            operator: Equal
            value: control-plane
            effect: NoSchedule
          - key: node-role.kubernetes.io/control-plane
            operator: Exists
            effect: NoSchedule

        # RBAC
        rbac:
          create: true

        # ServiceAccount
        serviceAccount:
          create: true

        # Prometheus Metrics
        serviceMonitor:
          enabled: true
          namespace: prometheus

  destination:
    server: https://kubernetes.default.svc
    namespace: redis-operator
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
    - ServerSideApply=true    # CRD 충돌 방지
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
