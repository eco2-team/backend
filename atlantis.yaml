# Atlantis ì„¤ì • íŒŒì¼ (í”„ë¡œì íŠ¸ ë£¨íŠ¸)
version: 3

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ìë™ ë³‘í•© ì„¤ì •
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
automerge: true  # Apply ì„±ê³µ ì‹œ ìë™ Merge (ì„ íƒì‚¬í•­)
delete_source_branch_on_merge: true  # Merge í›„ ë¸Œëœì¹˜ ì‚­ì œ

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ë³‘ë ¬ ì‹¤í–‰ ì„¤ì •
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
parallel_plan: true  # ì—¬ëŸ¬ í”„ë¡œì íŠ¸ ë™ì‹œ Plan
parallel_apply: false  # ApplyëŠ” ìˆœì°¨ ì‹¤í–‰ (ì•ˆì „ì„±)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# í”„ë¡œì íŠ¸ ì •ì˜
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
projects:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # í”„ë¡œì íŠ¸ 1: ì¸í”„ë¼ (Terraform)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  - name: infrastructure
    dir: terraform
    workspace: production
    terraform_version: v1.5.0
    
    # Workflow ì»¤ìŠ¤í„°ë§ˆì´ì§•
    workflow: infrastructure-workflow
    
    # Apply ìŠ¹ì¸ ìš”êµ¬ì‚¬í•­
    apply_requirements:
      - approved  # PR ìŠ¹ì¸ í•„ìˆ˜
      - mergeable  # Conflict ì—†ì–´ì•¼ í•¨
    
    # ìë™ Plan íŠ¸ë¦¬ê±°
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "*.tfvars"
        - "terraform.tfvars"
        - "**/*.tf"
    
    # í—ˆìš©ëœ Override
    allowed_overrides:
      - apply_requirements
      - workflow
    
    allow_custom_workflows: true

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ì»¤ìŠ¤í…€ Workflow ì •ì˜
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
workflows:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Infrastructure Workflow
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  infrastructure-workflow:
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Plan Stage
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    plan:
      steps:
        # 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        - env:
            name: SETUP_ENV
            command: 'echo "Setting up environment..."'
        
        # 2. Terraform Init
        - init
        
        # 3. Terraform Validate
        - run: terraform validate
        
        # 4. Terraform Plan
        - plan:
            extra_args:
              - -lock-timeout=5m
              - -var-file=terraform.tfvars
        
        # 5. Plan ê²°ê³¼ ì €ì¥
        - run: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Terraform Plan Complete"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Apply Stage
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    apply:
      steps:
        # 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        - env:
            name: SETUP_ENV
            command: 'echo "Setting up environment..."'
        
        # 2. Terraform Init
        - init
        
        # 3. Terraform Apply
        - apply:
            extra_args:
              - -lock-timeout=5m
              - -var-file=terraform.tfvars
        
        # 4. Terraform Outputs ì €ì¥ (ConfigMap) - Phase 3: ArgoCD ì—°ê³„
        - run: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Exporting Terraform Outputs (Phase 3)..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥
            terraform output -json > /tmp/tf-outputs.json
            
            # Ansible Inventory ì €ì¥
            terraform output -raw ansible_inventory > /tmp/ansible-inventory.ini
            
            # kubectlì´ ìˆë‹¤ë©´ ConfigMapì— ì €ì¥ (ArgoCDê°€ ì½ì„ ìˆ˜ ìˆë„ë¡)
            if command -v kubectl &> /dev/null; then
                # argocd namespace í™•ì¸/ìƒì„±
                kubectl get namespace argocd &>/dev/null || kubectl create namespace argocd
                
                # ConfigMap ìƒì„±/ì—…ë°ì´íŠ¸ (argocd namespace)
                kubectl create configmap terraform-outputs \
                  --from-file=tf-outputs.json=/tmp/tf-outputs.json \
                  --from-file=ansible-inventory.ini=/tmp/ansible-inventory.ini \
                  --namespace=argocd \
                  --dry-run=client -o yaml | kubectl apply -f -
                
                echo "âœ… Terraform Outputs saved to ConfigMap (namespace: argocd)"
                echo "   - ConfigMap: terraform-outputs"
                echo "   - Namespace: argocd"
                echo "   - Files: tf-outputs.json, ansible-inventory.ini"
                
                # ConfigMap í™•ì¸
                kubectl get configmap terraform-outputs -n argocd
                
                echo ""
                echo "ğŸ”„ ArgoCD PreSync Hookì´ ì´ ConfigMapì„ ì½ì–´ì„œ Ansibleì„ ì‹¤í–‰í•©ë‹ˆë‹¤"
            else
                echo "âš ï¸  kubectl not found, skipping ConfigMap creation"
                echo "   Please run manually:"
                echo "   kubectl create configmap terraform-outputs \\"
                echo "     --from-file=tf-outputs.json=/tmp/tf-outputs.json \\"
                echo "     --from-file=ansible-inventory.ini=/tmp/ansible-inventory.ini \\"
                echo "     --namespace=argocd"
            fi
        
        # 5. Trigger Ansible (ì„ íƒì‚¬í•­ - GitHub Actionsë¡œ ìœ„ì„ ê°€ëŠ¥)
        - run: |
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”— Triggering Post-Apply Actions..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Terraform Apply Complete!"
            echo "Next: Run Ansible Bootstrap manually or via GitHub Actions"
            echo ""
            echo "Quick Start:"
            echo "  cd ansible"
            echo "  cp /tmp/ansible-inventory.ini inventory/hosts.ini"
            echo "  ansible-playbook site.yml"

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# í—ˆìš©ëœ Repository ëª©ë¡
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ì£¼ì˜: ì´ ì„¤ì •ì€ atlantis-deployment.yamlì˜ --repo-allowlistë¡œ ê´€ë¦¬ë¨
# allowed_regexp_prefixes:
#   - github.com/SeSACTHON/

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# PR ìš”êµ¬ì‚¬í•­
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
policy_check:
  enabled: false  # Conftest/OPA Policy Check (ì„ íƒì‚¬í•­)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Atlantis ì½”ë©˜íŠ¸ ì„¤ì •
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
hide_prev_plan_comments: true  # ì´ì „ Plan ì½”ë©˜íŠ¸ ìˆ¨ê¹€
silence_whitelist_errors: false  # Allowlist ì˜¤ë¥˜ í‘œì‹œ
silence_vcs_status_no_plans: false  # Plan ì—†ì„ ë•Œ ìƒíƒœ í‘œì‹œ

